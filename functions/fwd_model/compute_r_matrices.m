function [Rx,Ry,Rz] = compute_r_matrices(fmdl)
    
    if size(fmdl.nodes,2) == 2
        % [Rx,Ry,Rz] = compute_r_matrices_2d(fmdl);

        [Rx,Ry,Rz] = compute_r_matrices_fast_2d(fmdl);
    elseif size(fmdl.nodes,2) == 3
        % [Rx,Ry,Rz] = compute_r_matrices_3d(fmdl);
        % [Rx,Ry,Rz] = compute_r_matrices_fast_3d(fmdl);

        [Rx,Ry,Rz] = compute_r_matrices_fast_3d_v2(fmdl);
    else
        error('Unexpected error')
    end

end



function [Rx,Ry,Rz] = compute_r_matrices_fast_3d_v2(fmdl)
nodes    = fmdl.nodes;      % N×3
elements = fmdl.elems;      % Ntets×4
sensors  = fmdl.sensors;
n_elem    = size(elements,1);
n_sensors = length(sensors);

Rx = zeros(n_sensors,n_elem);
Ry = zeros(n_sensors,n_elem);
Rz = zeros(n_sensors,n_elem);

% % KEAST7 rule, order 24, from:
% % https://people.sc.fsu.edu/~jburkardt/datasets/quadrature_rules_tet/quadrature_rules_tet.html#:~:text=A%20quadrature%20rule%20is%20a%20set%20of%20n,tetrahedron%20whose%20vertices%20are%20%280%2C0%2C0%29%2C%20%281%2C0%2C0%29%2C%20%280%2C1%2C0%29%2C%20%280%2C0%2C1%29.
% 
% quad_l = [ ...
%     0.3561913862225449  0.2146028712591517  0.2146028712591517;
%   0.2146028712591517  0.2146028712591517  0.2146028712591517;
%   0.2146028712591517  0.2146028712591517  0.3561913862225449;
%   0.2146028712591517  0.3561913862225449  0.2146028712591517;
%   0.8779781243961660  0.0406739585346113  0.0406739585346113;
%   0.0406739585346113  0.0406739585346113  0.0406739585346113;
%   0.0406739585346113  0.0406739585346113  0.8779781243961660;
%   0.0406739585346113  0.8779781243961660  0.0406739585346113;
%   0.0329863295731731  0.3223378901422757  0.3223378901422757;
%   0.3223378901422757  0.3223378901422757  0.3223378901422757;
%   0.3223378901422757  0.3223378901422757  0.0329863295731731;
%   0.3223378901422757  0.0329863295731731  0.3223378901422757;
%   0.2696723314583159  0.0636610018750175  0.0636610018750175;
%   0.0636610018750175  0.2696723314583159  0.0636610018750175;
%   0.0636610018750175  0.0636610018750175  0.2696723314583159;
%   0.6030056647916491  0.0636610018750175  0.0636610018750175;
%   0.0636610018750175  0.6030056647916491  0.0636610018750175;
%   0.0636610018750175  0.0636610018750175  0.6030056647916491;
%   0.0636610018750175  0.2696723314583159  0.6030056647916491;
%   0.2696723314583159  0.6030056647916491  0.0636610018750175;
%   0.6030056647916491  0.0636610018750175  0.2696723314583159;
%   0.0636610018750175  0.6030056647916491  0.2696723314583159;
%   0.2696723314583159  0.0636610018750175  0.6030056647916491;
%   0.6030056647916491  0.2696723314583159  0.0636610018750175];
% 
% quad_w = [  
%     0.0399227502581679
%   0.0399227502581679
%   0.0399227502581679
%   0.0399227502581679
%   0.0100772110553207
%   0.0100772110553207
%   0.0100772110553207
%   0.0100772110553207
%   0.0553571815436544
%   0.0553571815436544
%   0.0553571815436544
%   0.0553571815436544
%   0.0482142857142857
%   0.0482142857142857
%   0.0482142857142857
%   0.0482142857142857
%   0.0482142857142857
%   0.0482142857142857
%   0.0482142857142857
%   0.0482142857142857
%   0.0482142857142857
%   0.0482142857142857
%   0.0482142857142857
%   0.0482142857142857];

quad_l = [ ...
  0.1000000000000000  0.1000000000000000  0.1000000000000000;
  0.1000000000000000  0.1000000000000000  0.7000000000000000;
  0.1000000000000000  0.7000000000000000  0.1000000000000000;
  0.7000000000000000  0.1000000000000000  0.1000000000000000;
  0.1000000000000000  0.1000000000000000  0.6000000000000000;
  0.1000000000000000  0.1000000000000000  0.2000000000000000;
  0.1000000000000000  0.6000000000000000  0.1000000000000000;
  0.1000000000000000  0.6000000000000000  0.2000000000000000;
  0.1000000000000000  0.2000000000000000  0.1000000000000000;
  0.1000000000000000  0.2000000000000000  0.6000000000000000;
  0.6000000000000000  0.1000000000000000  0.1000000000000000;
  0.6000000000000000  0.1000000000000000  0.2000000000000000;
  0.6000000000000000  0.2000000000000000  0.1000000000000000;
  0.2000000000000000  0.1000000000000000  0.1000000000000000;
  0.2000000000000000  0.1000000000000000  0.6000000000000000;
  0.2000000000000000  0.6000000000000000  0.1000000000000000;
  0.1000000000000000  0.1000000000000000  0.5000000000000000;
  0.1000000000000000  0.1000000000000000  0.3000000000000000;
  0.1000000000000000  0.5000000000000000  0.1000000000000000;
  0.1000000000000000  0.5000000000000000  0.3000000000000000;
  0.1000000000000000  0.3000000000000000  0.1000000000000000;
  0.1000000000000000  0.3000000000000000  0.5000000000000000;
  0.5000000000000000  0.1000000000000000  0.1000000000000000;
  0.5000000000000000  0.1000000000000000  0.3000000000000000;
  0.5000000000000000  0.3000000000000000  0.1000000000000000;
  0.3000000000000000  0.1000000000000000  0.1000000000000000;
  0.3000000000000000  0.1000000000000000  0.5000000000000000;
  0.3000000000000000  0.5000000000000000  0.1000000000000000;
  0.2000000000000000  0.2000000000000000  0.1000000000000000;
  0.2000000000000000  0.2000000000000000  0.5000000000000000;
  0.2000000000000000  0.1000000000000000  0.2000000000000000;
  0.2000000000000000  0.1000000000000000  0.5000000000000000;
  0.2000000000000000  0.5000000000000000  0.2000000000000000;
  0.2000000000000000  0.5000000000000000  0.1000000000000000;
  0.1000000000000000  0.2000000000000000  0.2000000000000000;
  0.1000000000000000  0.2000000000000000  0.5000000000000000;
  0.1000000000000000  0.5000000000000000  0.2000000000000000;
  0.5000000000000000  0.2000000000000000  0.2000000000000000;
  0.5000000000000000  0.2000000000000000  0.1000000000000000;
  0.5000000000000000  0.1000000000000000  0.2000000000000000;
  0.4000000000000000  0.4000000000000000  0.1000000000000000;
  0.4000000000000000  0.1000000000000000  0.4000000000000000;
  0.4000000000000000  0.1000000000000000  0.1000000000000000;
  0.1000000000000000  0.4000000000000000  0.4000000000000000;
  0.1000000000000000  0.4000000000000000  0.1000000000000000;
  0.1000000000000000  0.1000000000000000  0.4000000000000000;
  0.4000000000000000  0.3000000000000000  0.2000000000000000;
  0.4000000000000000  0.3000000000000000  0.1000000000000000;
  0.4000000000000000  0.2000000000000000  0.3000000000000000;
  0.4000000000000000  0.2000000000000000  0.1000000000000000;
  0.4000000000000000  0.1000000000000000  0.3000000000000000;
  0.4000000000000000  0.1000000000000000  0.2000000000000000;
  0.3000000000000000  0.4000000000000000  0.2000000000000000;
  0.3000000000000000  0.4000000000000000  0.1000000000000000;
  0.3000000000000000  0.2000000000000000  0.4000000000000000;
  0.3000000000000000  0.2000000000000000  0.1000000000000000;
  0.3000000000000000  0.1000000000000000  0.4000000000000000;
  0.3000000000000000  0.1000000000000000  0.2000000000000000;
  0.2000000000000000  0.4000000000000000  0.3000000000000000;
  0.2000000000000000  0.4000000000000000  0.1000000000000000;
  0.2000000000000000  0.3000000000000000  0.4000000000000000;
  0.2000000000000000  0.3000000000000000  0.1000000000000000;
  0.2000000000000000  0.1000000000000000  0.4000000000000000;
  0.2000000000000000  0.1000000000000000  0.3000000000000000;
  0.1000000000000000  0.4000000000000000  0.3000000000000000;
  0.1000000000000000  0.4000000000000000  0.2000000000000000;
  0.1000000000000000  0.3000000000000000  0.4000000000000000;
  0.1000000000000000  0.3000000000000000  0.2000000000000000;
  0.1000000000000000  0.2000000000000000  0.4000000000000000;
  0.1000000000000000  0.2000000000000000  0.3000000000000000;
  0.2000000000000000  0.2000000000000000  0.2000000000000000;
  0.2000000000000000  0.2000000000000000  0.4000000000000000;
  0.2000000000000000  0.4000000000000000  0.2000000000000000;
  0.4000000000000000  0.2000000000000000  0.2000000000000000;
  0.3000000000000000  0.3000000000000000  0.3000000000000000;
  0.3000000000000000  0.3000000000000000  0.1000000000000000;
  0.3000000000000000  0.1000000000000000  0.3000000000000000;
  0.1000000000000000  0.3000000000000000  0.3000000000000000;
  0.3000000000000000  0.3000000000000000  0.2000000000000000;
  0.3000000000000000  0.2000000000000000  0.3000000000000000;
  0.3000000000000000  0.2000000000000000  0.2000000000000000;
  0.2000000000000000  0.3000000000000000  0.3000000000000000;
  0.2000000000000000  0.3000000000000000  0.2000000000000000;
  0.2000000000000000  0.2000000000000000  0.3000000000000000;
] ;

quad_w = [  
  0.2843915343915344
  0.2843915343915344
  0.2843915343915344
  0.2843915343915344
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
 -0.8584656084656085
 -0.8584656084656085
 -0.8584656084656085
 -0.8584656084656085
 -0.8584656084656085
 -0.8584656084656085
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
  0.0145502645502645
  0.0145502645502645
  0.0145502645502645
  0.0145502645502645
  1.0165343915343916
  1.0165343915343916
  1.0165343915343916
  1.0165343915343916
 -0.0251322751322751
 -0.0251322751322751
 -0.0251322751322751
 -0.0251322751322751
 -0.0251322751322751
 -0.0251322751322751];

nq = size(quad_l,1);

% Precompute physical quadrature points
elem_J = zeros(1,n_elem);
elem_p = zeros(nq,3,n_elem);

for k = 1:n_elem
    v = nodes(elements(k,:),:);

    A  = v(1,:);
    BA = (v(2,:) - A).';
    CA = (v(3,:) - A).';
    DA = (v(4,:) - A).';

    elem_J(k) = abs(det([BA CA DA])) / 6;

    % Vectorized barycentric mapping
    l2 = quad_l(:,1);
    l3 = quad_l(:,2);
    l4 = quad_l(:,3);
    l1 = 1 - l2 - l3 - l4;

    elem_p(:,:,k) = ...
        l1*A + l2*v(2,:) + l3*v(3,:) + l4*v(4,:);
end

parfor m = 1:n_sensors
    c   = sensors(m).position(:).';
    ax1 = sensors(m).axes.axis1(:).';
    ax2 = sensors(m).axes.axis2(:).';
    ax3 = sensors(m).axes.axis3(:).';

    % dx,dy,dz : nq × n_elem
    dx = c(1) - squeeze(elem_p(:,1,:));
    dy = c(2) - squeeze(elem_p(:,2,:));
    dz = c(3) - squeeze(elem_p(:,3,:));

    r2 = dx.^2 + dy.^2 + dz.^2;
    r3 = r2 .* sqrt(r2);

    Ix = (quad_w.' * (dx ./ r3)) .* elem_J;
    Iy = (quad_w.' * (dy ./ r3)) .* elem_J;
    Iz = (quad_w.' * (dz ./ r3)) .* elem_J;

    I = [Ix; Iy; Iz];   % 3 × n_elem

    Rx(m,:) = ax1 * I;
    Ry(m,:) = ax2 * I;
    Rz(m,:) = ax3 * I;
end

end

function [Rx,Ry,Rz] = compute_r_matrices_fast_3d(fmdl)

nodes    = fmdl.nodes;      % N×3
elements = fmdl.elems;      % Ntets×4
sensors  = fmdl.sensors;
n_elem    = size(elements,1);
n_sensors = length(sensors);

Rx = zeros(n_sensors,n_elem);
Ry = zeros(n_sensors,n_elem);
Rz = zeros(n_sensors,n_elem);

% Newton Cotes Open Rule, order 84, from:
% https://people.sc.fsu.edu/~jburkardt/datasets/quadrature_rules_tet/quadrature_rules_tet.html#:~:text=A%20quadrature%20rule%20is%20a%20set%20of%20n,tetrahedron%20whose%20vertices%20are%20%280%2C0%2C0%29%2C%20%281%2C0%2C0%29%2C%20%280%2C1%2C0%29%2C%20%280%2C0%2C1%29.

quad_l = [ ...
  0.1000000000000000  0.1000000000000000  0.1000000000000000;
  0.1000000000000000  0.1000000000000000  0.7000000000000000;
  0.1000000000000000  0.7000000000000000  0.1000000000000000;
  0.7000000000000000  0.1000000000000000  0.1000000000000000;
  0.1000000000000000  0.1000000000000000  0.6000000000000000;
  0.1000000000000000  0.1000000000000000  0.2000000000000000;
  0.1000000000000000  0.6000000000000000  0.1000000000000000;
  0.1000000000000000  0.6000000000000000  0.2000000000000000;
  0.1000000000000000  0.2000000000000000  0.1000000000000000;
  0.1000000000000000  0.2000000000000000  0.6000000000000000;
  0.6000000000000000  0.1000000000000000  0.1000000000000000;
  0.6000000000000000  0.1000000000000000  0.2000000000000000;
  0.6000000000000000  0.2000000000000000  0.1000000000000000;
  0.2000000000000000  0.1000000000000000  0.1000000000000000;
  0.2000000000000000  0.1000000000000000  0.6000000000000000;
  0.2000000000000000  0.6000000000000000  0.1000000000000000;
  0.1000000000000000  0.1000000000000000  0.5000000000000000;
  0.1000000000000000  0.1000000000000000  0.3000000000000000;
  0.1000000000000000  0.5000000000000000  0.1000000000000000;
  0.1000000000000000  0.5000000000000000  0.3000000000000000;
  0.1000000000000000  0.3000000000000000  0.1000000000000000;
  0.1000000000000000  0.3000000000000000  0.5000000000000000;
  0.5000000000000000  0.1000000000000000  0.1000000000000000;
  0.5000000000000000  0.1000000000000000  0.3000000000000000;
  0.5000000000000000  0.3000000000000000  0.1000000000000000;
  0.3000000000000000  0.1000000000000000  0.1000000000000000;
  0.3000000000000000  0.1000000000000000  0.5000000000000000;
  0.3000000000000000  0.5000000000000000  0.1000000000000000;
  0.2000000000000000  0.2000000000000000  0.1000000000000000;
  0.2000000000000000  0.2000000000000000  0.5000000000000000;
  0.2000000000000000  0.1000000000000000  0.2000000000000000;
  0.2000000000000000  0.1000000000000000  0.5000000000000000;
  0.2000000000000000  0.5000000000000000  0.2000000000000000;
  0.2000000000000000  0.5000000000000000  0.1000000000000000;
  0.1000000000000000  0.2000000000000000  0.2000000000000000;
  0.1000000000000000  0.2000000000000000  0.5000000000000000;
  0.1000000000000000  0.5000000000000000  0.2000000000000000;
  0.5000000000000000  0.2000000000000000  0.2000000000000000;
  0.5000000000000000  0.2000000000000000  0.1000000000000000;
  0.5000000000000000  0.1000000000000000  0.2000000000000000;
  0.4000000000000000  0.4000000000000000  0.1000000000000000;
  0.4000000000000000  0.1000000000000000  0.4000000000000000;
  0.4000000000000000  0.1000000000000000  0.1000000000000000;
  0.1000000000000000  0.4000000000000000  0.4000000000000000;
  0.1000000000000000  0.4000000000000000  0.1000000000000000;
  0.1000000000000000  0.1000000000000000  0.4000000000000000;
  0.4000000000000000  0.3000000000000000  0.2000000000000000;
  0.4000000000000000  0.3000000000000000  0.1000000000000000;
  0.4000000000000000  0.2000000000000000  0.3000000000000000;
  0.4000000000000000  0.2000000000000000  0.1000000000000000;
  0.4000000000000000  0.1000000000000000  0.3000000000000000;
  0.4000000000000000  0.1000000000000000  0.2000000000000000;
  0.3000000000000000  0.4000000000000000  0.2000000000000000;
  0.3000000000000000  0.4000000000000000  0.1000000000000000;
  0.3000000000000000  0.2000000000000000  0.4000000000000000;
  0.3000000000000000  0.2000000000000000  0.1000000000000000;
  0.3000000000000000  0.1000000000000000  0.4000000000000000;
  0.3000000000000000  0.1000000000000000  0.2000000000000000;
  0.2000000000000000  0.4000000000000000  0.3000000000000000;
  0.2000000000000000  0.4000000000000000  0.1000000000000000;
  0.2000000000000000  0.3000000000000000  0.4000000000000000;
  0.2000000000000000  0.3000000000000000  0.1000000000000000;
  0.2000000000000000  0.1000000000000000  0.4000000000000000;
  0.2000000000000000  0.1000000000000000  0.3000000000000000;
  0.1000000000000000  0.4000000000000000  0.3000000000000000;
  0.1000000000000000  0.4000000000000000  0.2000000000000000;
  0.1000000000000000  0.3000000000000000  0.4000000000000000;
  0.1000000000000000  0.3000000000000000  0.2000000000000000;
  0.1000000000000000  0.2000000000000000  0.4000000000000000;
  0.1000000000000000  0.2000000000000000  0.3000000000000000;
  0.2000000000000000  0.2000000000000000  0.2000000000000000;
  0.2000000000000000  0.2000000000000000  0.4000000000000000;
  0.2000000000000000  0.4000000000000000  0.2000000000000000;
  0.4000000000000000  0.2000000000000000  0.2000000000000000;
  0.3000000000000000  0.3000000000000000  0.3000000000000000;
  0.3000000000000000  0.3000000000000000  0.1000000000000000;
  0.3000000000000000  0.1000000000000000  0.3000000000000000;
  0.1000000000000000  0.3000000000000000  0.3000000000000000;
  0.3000000000000000  0.3000000000000000  0.2000000000000000;
  0.3000000000000000  0.2000000000000000  0.3000000000000000;
  0.3000000000000000  0.2000000000000000  0.2000000000000000;
  0.2000000000000000  0.3000000000000000  0.3000000000000000;
  0.2000000000000000  0.3000000000000000  0.2000000000000000;
  0.2000000000000000  0.2000000000000000  0.3000000000000000;
] ;

quad_w = [  
  0.2843915343915344
  0.2843915343915344
  0.2843915343915344
  0.2843915343915344
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
 -0.3882275132275133
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.8776455026455027
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
  0.1236772486772487
 -0.8584656084656085
 -0.8584656084656085
 -0.8584656084656085
 -0.8584656084656085
 -0.8584656084656085
 -0.8584656084656085
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
 -0.2632275132275133
  0.0145502645502645
  0.0145502645502645
  0.0145502645502645
  0.0145502645502645
  1.0165343915343916
  1.0165343915343916
  1.0165343915343916
  1.0165343915343916
 -0.0251322751322751
 -0.0251322751322751
 -0.0251322751322751
 -0.0251322751322751
 -0.0251322751322751
 -0.0251322751322751];

nq = size(quad_l,1);

% Precompute quadrature point coordinates & Jacobians
elem_p = cell(n_elem,1);   % cell{elem} = nq×3 physical quad points
elem_J = zeros(n_elem,1);  % |det(B)|  where x = A + B * (ref coords)

for k = 1:n_elem
    % Physical vertices of tetrahedron
    v = nodes(elements(k,:),:);   % 4×3 matrix
    
    A  = v(1,:);
    Bv = v(2,:);
    Cv = v(3,:);
    Dv = v(4,:);

    BA = (Bv - A).';
    CA = (Cv - A).';
    DA = (Dv - A).';

    J = abs(det([BA CA DA]));
    elem_J(k) = J/6; 

    % Precompute physical quadrature points
    P = zeros(nq,3);
    for q = 1:nq
        l2 = quad_l(q,1);
        l3 = quad_l(q,2);
        l4 = quad_l(q,3);
        l1 = 1 - l2 - l3 - l4;

        P(q,:) = ...
            l1*A + l2*Bv + l3*Cv + l4*Dv;
    end
    elem_p{k} = P;
end

% Loop over sensors
for m = 1:n_sensors

    c   = sensors(m).position(:).';
    ax1 = sensors(m).axes.axis1(:).';
    ax2 = sensors(m).axes.axis2(:).';
    ax3 = sensors(m).axes.axis3(:).';

    rx_row = zeros(1,n_elem);
    ry_row = zeros(1,n_elem);
    rz_row = zeros(1,n_elem);

    for k = 1:n_elem
        P = elem_p{k};   % nq×3

        dx = c(1) - P(:,1);
        dy = c(2) - P(:,2);
        dz = c(3) - P(:,3);

        r3 = (dx.^2 + dy.^2 + dz.^2).^(3/2);

        fx = dx ./ r3;
        fy = dy ./ r3;
        fz = dz ./ r3;

        % Multiply by physical Jacobian (volume scaling)
        fx = fx * elem_J(k);
        fy = fy * elem_J(k);
        fz = fz * elem_J(k);

        % Integrals
        Ix = sum(quad_w .* fx);
        Iy = sum(quad_w .* fy);
        Iz = sum(quad_w .* fz);

        I = [Ix Iy Iz];

        % Project onto sensor axes
        rx_row(k) = dot(I, ax1);
        ry_row(k) = dot(I, ax2);
        rz_row(k) = dot(I, ax3);
    end

    Rx(m,:) = rx_row;
    Ry(m,:) = ry_row;
    Rz(m,:) = rz_row;
end

end


%% Function 
function [Rx,Ry,Rz] = compute_r_matrices_3d(fmdl)

numElements = size(fmdl.elems,1);
numSensors = length(fmdl.sensors);

Rx = zeros(numSensors,numElements);
Ry = zeros(numSensors,numElements);
Rz = zeros(numSensors,numElements);

sensors = fmdl.sensors;

elements = fmdl.elems;
nodes = fmdl.nodes;

parfor m = 1:numSensors
    sensorCenter = [...
        sensors(m).position(1),...
        sensors(m).position(2),...
        sensors(m).position(3)];

    for k = 1:numElements

        element_ids = elements(k,:);

        vertices = nodes(element_ids,:);

        [L,n] = computeIntegralAndNormalsInTetrahedron(vertices,sensorCenter);

        S = zeros(3,1);
        for j = 1:4
            S = S + L(j)*n(:,j);
        end

        Rx(m,k) = dot(S,sensors(m).axes.axis1);
        Ry(m,k) = dot(S,sensors(m).axes.axis2);
        Rz(m,k) = dot(S,sensors(m).axes.axis3);
    end

end

end



%% Function 
function [Rx,Ry,Rz] = compute_r_matrices_2d(fmdl)

n_elem = size(fmdl.elems,1);
n_sensors = length(fmdl.sensors);

Rx = zeros(n_sensors,n_elem);
Ry = zeros(n_sensors,n_elem);
Rz = zeros(n_sensors,n_elem);

sensors = fmdl.sensors;

elements = fmdl.elems;
nodes = fmdl.nodes;

r = @(x,y) [x,y,0];

parfor m = 1:n_sensors
    sensor_center = [...
        sensors(m).position(1),...
        sensors(m).position(2),...
        sensors(m).position(3)];
    
    fx = @(x,y) ...
        (sensor_center(1) - x) ./...
        ((sensor_center(1)-x).^2 + (sensor_center(2)-y).^2 + sensor_center(3).^2).^(3/2);
    fy = @(x,y) ...
        (sensor_center(2) - y) ./...
        ((sensor_center(1)-x).^2 + (sensor_center(2)-y).^2 + sensor_center(3).^2).^(3/2);
    fz = @(x,y) ...
        (sensor_center(3) - 0) ./...
        ((sensor_center(1)-x).^2 + (sensor_center(2)-y).^2 + sensor_center(3).^2).^(3/2);

    for k = 1:n_elem
        
        vertices = nodes(elements(k,:),:);
        
        A = vertices(1,:);
        B = vertices(2,:);
        C = vertices(3,:);

        % Jacobian determinant
        J = abs(det([B - A; C - A]));

        % Map (xi, eta) -> (x, y)
        xmap = @(xi,eta) A(1) + (B(1)-A(1)).*xi + (C(1)-A(1)).*eta;
        ymap = @(xi,eta) A(2) + (B(2)-A(2)).*xi + (C(2)-A(2)).*eta;

        % Integrands on reference triangle
        integrand_x = @(xi,eta) fx(xmap(xi,eta), ymap(xi,eta)) .* J;
        integrand_y = @(xi,eta) fy(xmap(xi,eta), ymap(xi,eta)) .* J;
        integrand_z = @(xi,eta) fz(xmap(xi,eta), ymap(xi,eta)) .* J;
        
        
        % Perform integration over reference triangle
        Ix = integral2(integrand_x, 0, 1, 0, @(xi) 1 - xi);
        Iy = integral2(integrand_y, 0, 1, 0, @(xi) 1 - xi);
        Iz = integral2(integrand_z, 0, 1, 0, @(xi) 1 - xi);
         
        % % DEBUG:
        % % This should be equal to the area of the triangle: J/2
        % f = @(x,y) ones(size(x));
        % integrand =  @(xi,eta) f(xmap(xi,eta), ymap(xi,eta)).*J;
        % A = integral2(integrand, 0, 1, 0, @(xi) 1 - xi);

        I_vector = [Ix,Iy,Iz];

        Rx(m,k) = dot(I_vector,sensors(m).axes.axis1);
        Ry(m,k) = dot(I_vector,sensors(m).axes.axis2);
        Rz(m,k) = dot(I_vector,sensors(m).axes.axis3);
    end

end

end

%% FUNCITON: GENERATED BY CHAT GPT, 
% but changed the quadrature rule to TOMS706_37
% found in https://people.sc.fsu.edu/~jburkardt/datasets/quadrature_rules_tri/quadrature_rules_tri.html
function [Rx,Ry,Rz] = compute_r_matrices_fast_2d(fmdl)

nodes    = fmdl.nodes;
elements = fmdl.elems;
sensors  = fmdl.sensors;

n_elem    = size(elements,1);
n_sensors = length(sensors);

Rx = zeros(n_sensors,n_elem);
Ry = zeros(n_sensors,n_elem);
Rz = zeros(n_sensors,n_elem);

%% 1. Precompute geometric data and quadrature points
quad_xy = [  
  0.333333333333333333333333333333  0.333333333333333333333333333333;
  0.950275662924105565450352089520  0.024862168537947217274823955239;
  0.024862168537947217274823955239  0.950275662924105565450352089520;
  0.024862168537947217274823955239  0.024862168537947217274823955239;
  0.171614914923835347556304795551  0.414192542538082326221847602214;
  0.414192542538082326221847602214  0.171614914923835347556304795551;
  0.414192542538082326221847602214  0.414192542538082326221847602214;
  0.539412243677190440263092985511  0.230293878161404779868453507244;
  0.230293878161404779868453507244  0.539412243677190440263092985511;
  0.230293878161404779868453507244  0.230293878161404779868453507244;
  0.772160036676532561750285570113  0.113919981661733719124857214943;
  0.113919981661733719124857214943  0.772160036676532561750285570113;
  0.113919981661733719124857214943  0.113919981661733719124857214943;
  0.009085399949835353883572964740  0.495457300025082323058213517632;
  0.495457300025082323058213517632  0.009085399949835353883572964740;
  0.495457300025082323058213517632  0.495457300025082323058213517632;
  0.062277290305886993497083640527  0.468861354847056503251458179727;
  0.468861354847056503251458179727  0.062277290305886993497083640527;
  0.468861354847056503251458179727  0.468861354847056503251458179727;
  0.022076289653624405142446876931  0.851306504174348550389457672223;
  0.022076289653624405142446876931  0.126617206172027096933163647918;
  0.851306504174348550389457672223  0.022076289653624405142446876931;
  0.851306504174348550389457672223  0.126617206172027096933163647918;
  0.126617206172027096933163647918  0.022076289653624405142446876931;
  0.126617206172027096933163647918  0.851306504174348550389457672223;
  0.018620522802520968955913511549  0.689441970728591295496647976487;
  0.018620522802520968955913511549  0.291937506468887771754472382212;
  0.689441970728591295496647976487  0.018620522802520968955913511549;
  0.689441970728591295496647976487  0.291937506468887771754472382212;
  0.291937506468887771754472382212  0.018620522802520968955913511549;
  0.291937506468887771754472382212  0.689441970728591295496647976487;
  0.096506481292159228736516560903  0.635867859433872768286976979827;
  0.096506481292159228736516560903  0.267625659273967961282458816185;
  0.635867859433872768286976979827  0.096506481292159228736516560903;
  0.635867859433872768286976979827  0.267625659273967961282458816185;
  0.267625659273967961282458816185  0.096506481292159228736516560903;
  0.267625659273967961282458816185  0.635867859433872768286976979827];

quad_w  = [ 
  0.051739766065744133555179145422
  0.008007799555564801597804123460
  0.008007799555564801597804123460
  0.008007799555564801597804123460
  0.046868898981821644823226732071
  0.046868898981821644823226732071
  0.046868898981821644823226732071
  0.046590940183976487960361770070
  0.046590940183976487960361770070
  0.046590940183976487960361770070
  0.031016943313796381407646220131
  0.031016943313796381407646220131
  0.031016943313796381407646220131
  0.010791612736631273623178240136
  0.010791612736631273623178240136
  0.010791612736631273623178240136
  0.032195534242431618819414482205
  0.032195534242431618819414482205
  0.032195534242431618819414482205
  0.015445834210701583817692900053
  0.015445834210701583817692900053
  0.015445834210701583817692900053
  0.015445834210701583817692900053
  0.015445834210701583817692900053
  0.015445834210701583817692900053
  0.017822989923178661888748319485
  0.017822989923178661888748319485
  0.017822989923178661888748319485
  0.017822989923178661888748319485
  0.017822989923178661888748319485
  0.017822989923178661888748319485
  0.037038683681384627918546472190
  0.037038683681384627918546472190
  0.037038683681384627918546472190
  0.037038683681384627918546472190
  0.037038683681384627918546472190
  0.037038683681384627918546472190];  % all weights = area/6 in reference triangle

% Preallocate
elem_p = cell(n_elem,1);   % n_quad_points×2 coords for each element’s quad points
elem_J = zeros(n_elem,1);  % Jacobian (2 * area)

for k = 1:n_elem
    v = nodes(elements(k,:),:);    % A,B,C
    A = v(1,:); B = v(2,:); C = v(3,:);
    
    J = abs(det([B-A; C-A]));
    elem_J(k) = J;
    
    % Map quadrature points
    P = zeros(size(quad_w,1),2);
    for q = 1:size(quad_w,1)
        xi  = quad_xy(q,1);
        eta = quad_xy(q,2);
        P(q,:) = A + xi*(B-A) + eta*(C-A);
    end
    elem_p{k} = P;
end

%% 2. Loop over sensors
parfor m = 1:n_sensors
    c = sensors(m).position;       % sensor center
    ax1 = sensors(m).axes.axis1;
    ax2 = sensors(m).axes.axis2;
    ax3 = sensors(m).axes.axis3;

    rx_row = zeros(1,n_elem);
    ry_row = zeros(1,n_elem);
    rz_row = zeros(1,n_elem);

    for k = 1:n_elem
        P = elem_p{k};    % 3×2 array of quadrature points
        
        % Vector from sensor to each quad point
        dx = c(1) - P(:,1);
        dy = c(2) - P(:,2);
        dz = c(3);        % triangle is in z=0 plane

        r3 = (dx.^2 + dy.^2 + dz.^2).^(3/2);

        fx = (dx ./ r3) * elem_J(k);
        fy = (dy ./ r3) * elem_J(k);
        fz = (dz ./ r3) * elem_J(k);

        Ix = 0.5*quad_w' * fx;  % Ensure sizes match
        Iy = 0.5*quad_w' * fy;
        Iz = 0.5*quad_w' * fz;

        I = [Ix Iy Iz];
        
        rx_row(k) = dot(I, ax1);
        ry_row(k) = dot(I, ax2);
        rz_row(k) = dot(I, ax3);
    end

    Rx(m,:) = rx_row;
    Ry(m,:) = ry_row;
    Rz(m,:) = rz_row;
end

end
