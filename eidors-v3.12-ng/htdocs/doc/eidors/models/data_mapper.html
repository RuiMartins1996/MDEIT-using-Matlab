<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of data_mapper</title>
  <meta name="keywords" content="data_mapper">
  <meta name="description" content="DATA_MAPPER maps img.params data to elem or node data">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">eidors</a> &gt; <a href="index.html">models</a> &gt; data_mapper.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/models&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>data_mapper
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>DATA_MAPPER maps img.params data to elem or node data</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function img = data_mapper(img, reverse) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">DATA_MAPPER maps img.params data to elem or node data
 img = data_mapper(img) will only work if there is only a single
 params data field on the img, throwing an error otherwise.
 For multi-parametrization images, img.data_mapper must be specified. It
 can be either a name of the appropriate parametrization data field on the img, or
 a function that will handle the data differently.

 To avoid confusion, the parametrization currently in use by image data will be
 specified in a descriptive string tag img.current_params

 img = data_mapper(img, TRUE) will reverse the process updating
 the current parametrization with the data from img.elem_data or img.node_data.

 Examples:
  imdl = mk_common_model('a2c2',8);
  c = 3*ones(length(imdl.fwd_model.elems),1);
  img = eidors_obj('image','fwd_model',imdl.fwd_model);
  img.conductivity.elem_data = c;
  img = data_mapper(img);

  img.resistivity.elem_data = 1./c;
  img.data_mapper = 'resistivity';
  img = data_mapper(img);

  img.data_mapper = 'some_function_that_takes_an_image';
  img = data_mapper(img);

 KNOWN ISSUES:
   - doesn't fully support image arrays

 See also: <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">MK_IMAGE</a>, <a href="supported_params.html" class="code" title="function list = supported_params">SUPPORTED_PARAMS</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG eidors progress and status messages</li><li><a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>	EIDORS_OBJ: maintains EIDORS internals</li><li><a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>	DATA_MAPPER maps img.params data to elem or node data</li><li><a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>	MK_IMAGE: create eidors image object</li><li><a href="supported_params.html" class="code" title="function list = supported_params">supported_params</a>	</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/graphics/matlab/calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>	calc_slices (img, levels, clim  ) show slices at levels of an</li><li><a href="../../eidors/graphics/matlab/calc_voxels.html" class="code" title="function [V, rimg] = calc_voxels(img, opt, level)">calc_voxels</a>	CALC_VOXELS Calculate volumetric data from an image</li><li><a href="../../eidors/graphics/matlab/show_3d_slices.html" class="code" title="function h = show_3d_slices(img, varargin);">show_3d_slices</a>	show_3d_slices(img, z_cuts, x_cuts, y_cuts, any_cuts)</li><li><a href="../../eidors/graphics/matlab/show_fem_move.html" class="code" title="function [hf,hh] = show_fem_move( img, move, scale, options )">show_fem_move</a>	SHOW_FEM_MOVE   Plot EIT finite element model (FEM) and movement</li><li><a href="convert_img_units.html" class="code" title="function y = convert_img_units(img,arg1,arg2)">convert_img_units</a>	CONVERT_IMG_UNITS change image data units</li><li><a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>	DATA_MAPPER maps img.params data to elem or node data</li><li><a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>	MK_IMAGE: create eidors image object</li><li><a href="../../eidors/solvers/calc_jacobian.html" class="code" title="function J = calc_jacobian( fwd_model, img)">calc_jacobian</a>	CALC_JACOBIAN: calculate jacobian from an inv_model</li><li><a href="../../eidors/solvers/forward/fwd_solve_1st_order.html" class="code" title="function data =fwd_solve_1st_order(fwd_model, img)">fwd_solve_1st_order</a>	FWD_SOLVE_1ST_ORDER: data= fwd_solve_1st_order( img)</li><li><a href="../../eidors/solvers/forward/fwd_solve_2p5d_1st_order.html" class="code" title="function data =fwd_solve_2p5d_1st_order(fwd_model, img)">fwd_solve_2p5d_1st_order</a>	FWD_SOLVE_2P5D_1ST_ORDER: data= fwd_solve_2p5d_1st_order( img)</li><li><a href="../../eidors/solvers/forward/fwd_solve_halfspace.html" class="code" title="function data = fwd_solve_halfspace(fwd_model, img)">fwd_solve_halfspace</a>	FWD_SOLVE_HALFSPACE: data = fwd_solve_halfspace(img)</li><li><a href="../../eidors/solvers/forward/jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>	JACOBIAN_ADJOINT: J= jacobian_adjoint( img )</li><li><a href="../../eidors/solvers/forward/jacobian_adjoint_2p5d_1st_order.html" class="code" title="function J= jacobian_adjoint_2p5d_1st_order( fwd_model, img)">jacobian_adjoint_2p5d_1st_order</a>	JACOBIAN_ADJOINT_2P5D: J= jacobian_adjoint_2p5d_1st_order( img )</li><li><a href="../../eidors/solvers/forward/jacobian_movement_2p5d_1st_order.html" class="code" title="function J = jacobian_movement_2p5d_1st_order( fwd_model, img)">jacobian_movement_2p5d_1st_order</a>	JACOBIAN_MOVEMENT_2P5D: J = jacobian_movement_2p5d_1st_order( img )</li><li><a href="../../eidors/solvers/forward/jacobian_perturb.html" class="code" title="function J= jacobian_perturb( fwd_model, img)">jacobian_perturb</a>	JACOBIAN_PERTURB: J= jacobian_perturb( fwd_model, img)</li><li><a href="../../eidors/solvers/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>	GET_IMG_DATA: get parameter data from eidors image object</li><li><a href="../../eidors/solvers/inverse/calc_noise_figure.html" class="code" title="function [NF,SE] = calc_noise_figure( inv_model, hp, iterations, extraparam)">calc_noise_figure</a>	CALC_NOISE_FIGURE: calculate the noise amplification (NF) of an algorithm</li><li><a href="../../eidors/solvers/inverse/calc_solution_error.html" class="code" title="function [e res] = calc_solution_error(imgc, imdl, vh, vi)">calc_solution_error</a>	CALC_SOLUTION_ERROR Calculate residuals for a solution</li><li><a href="../../eidors/solvers/inverse/inv_solve_core.html" class="code" title="function img= inv_solve_core( inv_model, data0, data1);">inv_solve_core</a>	INV_SOLVE_CORE Solver using a generic iterative algorithm</li><li><a href="../../eidors/solvers/inverse/inv_solve_diff_GN_one_step.html" class="code" title="function img= inv_solve_diff_GN_one_step( inv_model, data1, data2)">inv_solve_diff_GN_one_step</a>	INV_SOLVE_DIFF_GN_ONE_STEP inverse solver using approach of Adler&Guardo 1996</li><li><a href="../../eidors/solvers/inverse/line_optimize.html" class="code" title="function [img fmin res] = line_optimize(imgk, dx, data0, opt)">line_optimize</a>	LINE_OPTIMIZE Cheap line optimizer</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function img = pack_params(img);</a></li><li><a href="#_sub2" class="code">function img = pack_params_using_params_str(img, prms)</a></li><li><a href="#_sub3" class="code">function n = calc_num_elems(fmdl)</a></li><li><a href="#_sub4" class="code">function img = copy_data_to_params(img, prms)</a></li><li><a href="#_sub5" class="code">function img = unpack_params(img)</a></li><li><a href="#_sub6" class="code">function pass = do_unit_test</a></li><li><a href="#_sub7" class="code">function pass = do_unit_test_legacy</a></li><li><a href="#_sub8" class="code">function img = unit_test_passthrough(img1,rev)</a></li><li><a href="#_sub9" class="code">function pass = do_unit_test_undo</a></li><li><a href="#_sub10" class="code">function pass = test_undo(img, d, dl)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function img = data_mapper(img, reverse)</a>
0002 <span class="comment">%DATA_MAPPER maps img.params data to elem or node data</span>
0003 <span class="comment">% img = data_mapper(img) will only work if there is only a single</span>
0004 <span class="comment">% params data field on the img, throwing an error otherwise.</span>
0005 <span class="comment">% For multi-parametrization images, img.data_mapper must be specified. It</span>
0006 <span class="comment">% can be either a name of the appropriate parametrization data field on the img, or</span>
0007 <span class="comment">% a function that will handle the data differently.</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% To avoid confusion, the parametrization currently in use by image data will be</span>
0010 <span class="comment">% specified in a descriptive string tag img.current_params</span>
0011 <span class="comment">%</span>
0012 <span class="comment">% img = data_mapper(img, TRUE) will reverse the process updating</span>
0013 <span class="comment">% the current parametrization with the data from img.elem_data or img.node_data.</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% Examples:</span>
0016 <span class="comment">%  imdl = mk_common_model('a2c2',8);</span>
0017 <span class="comment">%  c = 3*ones(length(imdl.fwd_model.elems),1);</span>
0018 <span class="comment">%  img = eidors_obj('image','fwd_model',imdl.fwd_model);</span>
0019 <span class="comment">%  img.conductivity.elem_data = c;</span>
0020 <span class="comment">%  img = data_mapper(img);</span>
0021 <span class="comment">%</span>
0022 <span class="comment">%  img.resistivity.elem_data = 1./c;</span>
0023 <span class="comment">%  img.data_mapper = 'resistivity';</span>
0024 <span class="comment">%  img = data_mapper(img);</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%  img.data_mapper = 'some_function_that_takes_an_image';</span>
0027 <span class="comment">%  img = data_mapper(img);</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% KNOWN ISSUES:</span>
0030 <span class="comment">%   - doesn't fully support image arrays</span>
0031 <span class="comment">%</span>
0032 <span class="comment">% See also: MK_IMAGE, SUPPORTED_PARAMS</span>
0033 
0034 <span class="comment">% (C) 2012 Bartlomiej Grychtol.</span>
0035 <span class="comment">% Licenced under GPL version 2 or 3</span>
0036 <span class="comment">% $Id: data_mapper.m 6926 2024-05-31 15:34:13Z bgrychtol $</span>
0037 
0038 <span class="keyword">if</span> ischar(img) &amp;&amp; strcmp(img,<span class="string">'UNIT_TEST'</span>); img = <a href="#_sub6" class="code" title="subfunction pass = do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0039 
0040 <span class="keyword">if</span> nargin &lt; 2
0041    reverse = false;
0042 <span class="keyword">elseif</span> ischar(reverse) &amp;&amp; strcmpi(reverse, <span class="string">'pack'</span>)
0043    reverse = false;
0044 <span class="keyword">else</span> <span class="comment">% 'unpack'</span>
0045    reverse = true;
0046 <span class="keyword">end</span>
0047 <span class="comment">% need to handle image arrays</span>
0048 <span class="keyword">for</span> i = 1:length(img)
0049    <span class="keyword">if</span> reverse
0050       tmp(i) = <a href="#_sub5" class="code" title="subfunction img = unpack_params(img)">unpack_params</a>(img(i));
0051    <span class="keyword">else</span>
0052       tmp(i) = <a href="#_sub1" class="code" title="subfunction img = pack_params(img);">pack_params</a>(img(i));
0053    <span class="keyword">end</span>
0054    tmp(i) = <a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>(<span class="string">'image'</span>,tmp(i));
0055 <span class="keyword">end</span>
0056 img = tmp;
0057 <span class="keyword">end</span>
0058 
0059 <a name="_sub1" href="#_subfunctions" class="code">function img = pack_params(img);</a>
0060 
0061 flds = fieldnames(img);
0062 prms = ismember(flds, <a href="supported_params.html" class="code" title="function list = supported_params">supported_params</a>);
0063 
0064 <span class="keyword">switch</span> sum(prms)
0065    <span class="keyword">case</span> 0
0066       <span class="comment">% no params found, check for elem_data or node_data</span>
0067       <span class="keyword">if</span> ~( isfield(img,<span class="string">'elem_data'</span>) || isfield(img,<span class="string">'node_data'</span>))
0068          error(<span class="string">'No params, elem_data or node_data found on img'</span>);
0069       <span class="keyword">else</span>
0070          <span class="keyword">if</span> isfield(img,<span class="string">'current_params'</span>) &amp;&amp; ~isempty(img.current_params)
0071                 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@@ Careful! Image already mapped. Doing nothing'</span>,4);
0072            <span class="keyword">return</span>;
0073          <span class="keyword">end</span>
0074 
0075          <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@@ No params present on img. Assuming conductivity'</span>,4);
0076 <span class="comment">% STUPID MATLAB CAN'T KEEP SYNTAX STRAIGHT BETWEEN VERSIONS</span>
0077 <span class="comment">%        img = setfield(img,{},'current_params', 'conductivity');</span>
0078 <span class="comment">% NEED TO DO THIS, UGLY INEFFICIENT CODE</span>
0079          <span class="keyword">for</span> i=1:length(img)
0080             img(i).current_params = <span class="string">'conductivity'</span>;
0081          <span class="keyword">end</span>
0082       <span class="keyword">end</span>
0083       <span class="keyword">return</span>      <span class="comment">% returns img</span>
0084    <span class="keyword">case</span> 1
0085       ph = find(prms);
0086       <span class="keyword">if</span> isfield(img.(flds{ph}),<span class="string">'func'</span>)
0087          <span class="comment">% let the function handle the whole process</span>
0088          img = feval(img.(flds{ph}).func, img);
0089          <span class="keyword">return</span>
0090       <span class="keyword">else</span>
0091          img = <a href="#_sub2" class="code" title="subfunction img = pack_params_using_params_str(img, prms)">pack_params_using_params_str</a>(img, flds{ph});
0092       <span class="keyword">end</span>
0093    <span class="keyword">otherwise</span>
0094       <span class="comment">% multiple params</span>
0095       <span class="keyword">try</span>
0096          prms_fun = img.data_mapper;
0097       <span class="keyword">catch</span>
0098          error(<span class="string">'Multiple params found on img require: img.data_mapper = function or {&quot;string&quot;,&quot;array&quot;}'</span>);
0099       <span class="keyword">end</span>
0100       <span class="keyword">if</span> ~isa(prms_fun, <span class="string">'function_handle'</span>) &amp;&amp; ismember(prms_fun,flds);
0101          img = <a href="#_sub2" class="code" title="subfunction img = pack_params_using_params_str(img, prms)">pack_params_using_params_str</a>(img, prms_fun); <span class="comment">% assume a string array</span>
0102       <span class="keyword">else</span>
0103          <span class="keyword">try</span>
0104             img = feval(prms_fun,img);
0105          <span class="keyword">catch</span>
0106             error(<span class="string">'img.data_mapper not understood'</span>);
0107          <span class="keyword">end</span>
0108       <span class="keyword">end</span>
0109 
0110 <span class="keyword">end</span>
0111 <span class="keyword">end</span>
0112 
0113 <a name="_sub2" href="#_subfunctions" class="code">function img = pack_params_using_params_str(img, prms)</a>
0114 
0115 prms_flds = fieldnames(img.(prms));
0116 <span class="keyword">for</span> i = 1:length(prms_flds)
0117    <span class="keyword">if</span> isfield(img, prms_flds{i})
0118       <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@@ Overwriting img.%s'</span>,prms_flds{i},4);
0119       warning(<span class="string">'EIDORS:OverwritingData'</span>, <span class="string">'Overwriting img.%s'</span>,prms_flds{i});
0120    <span class="keyword">end</span>
0121    <span class="comment">% allow elem_data/node_data to be scalar</span>
0122    <span class="keyword">if</span> strcmp(prms_flds{i},<span class="string">'elem_data'</span>) &amp;&amp; numel(img.(prms).elem_data) == 1
0123       n_elem = <a href="#_sub3" class="code" title="subfunction n = calc_num_elems(fmdl)">calc_num_elems</a>(img.fwd_model);
0124       img.elem_data = ones(n_elem,1);
0125       img.elem_data(:) = img.(prms).elem_data;
0126    <span class="keyword">elseif</span> strcmp(prms_flds{i},<span class="string">'node_data'</span>)
0127       img.node_data = ones(size(img.fwd_model.nodes,1),1);
0128       img.node_data(:) = img.(prms).node_data;
0129    <span class="keyword">else</span>
0130       img.(prms_flds{i}) = img.(prms).(prms_flds{i});
0131    <span class="keyword">end</span>
0132 <span class="keyword">end</span>
0133 img.current_params = prms;
0134 <span class="keyword">end</span>
0135 
0136 <a name="_sub3" href="#_subfunctions" class="code">function n = calc_num_elems(fmdl)</a>
0137 <span class="keyword">if</span> isfield(fmdl, <span class="string">'coarse2fine'</span>)
0138    n = size(fmdl.coarse2fine,2);
0139 <span class="keyword">else</span>
0140    n = length(fmdl.elems);
0141 <span class="keyword">end</span>
0142 <span class="keyword">end</span>
0143 
0144 <a name="_sub4" href="#_subfunctions" class="code">function img = copy_data_to_params(img, prms)</a>
0145 prms_flds = fieldnames(img.(prms));
0146 <span class="keyword">try</span>
0147    <span class="keyword">for</span> i = 1:length(prms_flds)
0148       img.(prms).(prms_flds{i}) = img.(prms_flds{i});
0149       img = rmfield(img, prms_flds{i});
0150    <span class="keyword">end</span>
0151    img = rmfield(img, <span class="string">'current_params'</span>);
0152 <span class="keyword">catch</span>
0153    error(<span class="string">'Fields specified by img.%s missing from img.'</span>,prms);
0154 <span class="keyword">end</span>
0155 <span class="keyword">end</span>
0156 
0157 <a name="_sub5" href="#_subfunctions" class="code">function img = unpack_params(img)</a>
0158 <span class="keyword">try</span>
0159    curprms = img.current_params;
0160 <span class="keyword">catch</span>
0161    <span class="keyword">if</span> isfield(img,<span class="string">'elem_data'</span>) || isfield(img, <span class="string">'node_data'</span>)
0162       <span class="keyword">return</span> <span class="comment">% old type image, nothing to do</span>
0163    <span class="keyword">else</span>
0164       error(<span class="string">'img.current_params required'</span>);
0165    <span class="keyword">end</span>
0166 <span class="keyword">end</span>
0167 <span class="keyword">if</span> ismember(curprms, fieldnames(img))
0168    img = <a href="#_sub4" class="code" title="subfunction img = copy_data_to_params(img, prms)">copy_data_to_params</a>(img,curprms);
0169 <span class="keyword">elseif</span> strcmp(curprms,<span class="string">'conductivity'</span>)
0170    <span class="comment">% current_params is conductivity, but there's no img.conductivity</span>
0171    <span class="keyword">if</span> ~any(ismember(fieldnames(img),<a href="supported_params.html" class="code" title="function list = supported_params">supported_params</a>))
0172       <span class="comment">% we're dealing with an old params-oblivious image</span>
0173       <span class="comment">% nothing to do</span>
0174       img = rmfield(img, <span class="string">'current_params'</span>);
0175    <span class="keyword">else</span>
0176       error(<span class="string">'Cannot reverse %s mapping'</span>,curprms);
0177    <span class="keyword">end</span>
0178 <span class="keyword">else</span>
0179    <span class="keyword">try</span>
0180       <span class="comment">% user-provided data_mapper must provide the reverse</span>
0181       img = feval(curprms,img,1);
0182    <span class="keyword">catch</span>
0183       error(<span class="string">'data_mapper %s failed to reverse'</span>, curprms);
0184    <span class="keyword">end</span>
0185 <span class="keyword">end</span>
0186 <span class="keyword">end</span>
0187 
0188 <a name="_sub6" href="#_subfunctions" class="code">function pass = do_unit_test</a>
0189    pass = 1;
0190    pass = <a href="#_sub7" class="code" title="subfunction pass = do_unit_test_legacy">do_unit_test_legacy</a>() &amp;&amp; pass;
0191    pass = <a href="#_sub9" class="code" title="subfunction pass = do_unit_test_undo">do_unit_test_undo</a>()   &amp;&amp; pass;
0192    disp(<span class="string">''</span>);
0193    <span class="keyword">if</span> pass
0194       disp(<span class="string">'TEST: overall PASS'</span>);
0195    <span class="keyword">else</span>
0196       error(<span class="string">'TEST: overall FAIL'</span>);
0197    <span class="keyword">end</span>
0198 <span class="keyword">end</span>
0199 
0200 <a name="_sub7" href="#_subfunctions" class="code">function pass = do_unit_test_legacy</a>
0201    pass = 1;
0202    ll = <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>);
0203    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>,3);
0204 
0205    imdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c2'</span>,8);
0206    c = 3*ones(length(imdl.fwd_model.elems),1);
0207    img = <a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>(<span class="string">'image'</span>,<span class="string">'test_image'</span>,<span class="string">'fwd_model'</span>,imdl.fwd_model);
0208    img.conductivity.elem_data = c;
0209 
0210    fprintf(<span class="string">'TEST: mv img.conductivity.elem_data to img.elem_data\n'</span>);
0211    imgi = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img, <span class="string">'pack'</span>);
0212    <span class="keyword">if</span> ~isfield(imgi, <span class="string">'elem_data'</span>)
0213      imgi
0214      disp(<span class="string">'TEST FAIL: missing elem_data'</span>);
0215      pass = 0;
0216    <span class="keyword">end</span>
0217 
0218    imgi2 = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img, <span class="string">'pack'</span>); <span class="comment">% give a msg at log_level 3</span>
0219 
0220    imgii = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(imgi,<span class="string">'unpack'</span>); <span class="comment">% unpack</span>
0221    <span class="keyword">if</span> ~isequaln(imgii, img)
0222       img
0223       imgii
0224       fprintf(<span class="string">'TEST FAIL: pack to unpack returned different result\n'</span>);
0225       pass = 0;
0226    <span class="keyword">end</span>
0227 
0228    img.resistivity.elem_data = 1./c;
0229    img.data_mapper = <span class="string">'resistivity'</span>;
0230    img = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img);
0231    <span class="keyword">if</span> abs(img.elem_data(1) - 1/3) &gt; 1e-4
0232       img.elem_data(1)
0233       pass = 0;
0234       disp(<span class="string">'TEST FAIL: expected img.elem_data to be ~1/3'</span>);
0235    <span class="keyword">end</span>
0236 
0237    img.data_mapper = @<a href="#_sub8" class="code" title="subfunction img = unit_test_passthrough(img1,rev)">unit_test_passthrough</a>; <span class="comment">% some function that takes an image</span>
0238    imgf = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img);
0239    <span class="comment">% if this works without failing, then we are happy</span>
0240    <span class="keyword">if</span> ~isequaln(imgf, img)
0241       img
0242       imgf
0243       fprintf(<span class="string">'TEST FAIL: pass-through function failed\n'</span>);
0244       pass = 0;
0245    <span class="keyword">end</span>
0246 
0247    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>,ll);
0248    <span class="keyword">if</span> ~pass
0249       disp(<span class="string">'TEST: ---------------------------------------'</span>);
0250    <span class="keyword">end</span>
0251 <span class="keyword">end</span>
0252 
0253 <a name="_sub8" href="#_subfunctions" class="code">function img = unit_test_passthrough(img1,rev)</a>
0254   img = img1;
0255 <span class="keyword">end</span>
0256 
0257 <a name="_sub9" href="#_subfunctions" class="code">function pass = do_unit_test_undo</a>
0258    pass = 1;
0259 
0260    imdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'c2c'</span>, 16);
0261    img = <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(imdl);
0262    d = img.elem_data;
0263    img0 = rmfield(img, <span class="string">'elem_data'</span>);
0264 
0265    disp(<span class="string">'TEST: img.elem_data'</span>);
0266    img = img0; img.elem_data = d;
0267    pass = <a href="#_sub10" class="code" title="subfunction pass = test_undo(img, d, dl)">test_undo</a>(img, d, <span class="string">'elem_data'</span>) &amp;&amp; pass;
0268 
0269    disp(<span class="string">'TEST: img.node_data'</span>);
0270    img = img0; img.node_data = d;
0271    pass = <a href="#_sub10" class="code" title="subfunction pass = test_undo(img, d, dl)">test_undo</a>(img, d, <span class="string">'node_data'</span>) &amp;&amp; pass;
0272 
0273    disp(<span class="string">'TEST: img.conductivity.elem_data'</span>);
0274    img = img0; img.conductivity.elem_data = d;
0275    pass = <a href="#_sub10" class="code" title="subfunction pass = test_undo(img, d, dl)">test_undo</a>(img, d, <span class="string">'elem_data'</span>) &amp;&amp; pass;
0276 <span class="comment">% TODO AB below here blows up</span>
0277 <span class="comment">%   disp('TEST: img.conductivity.node_data');</span>
0278 <span class="comment">%   img = img0; img.conductivity.node_data = d;</span>
0279 <span class="comment">%   pass = test_undo(img, d) &amp;&amp; pass;</span>
0280 
0281 <span class="comment">%   disp('TEST: img.resistivity.node_data');</span>
0282 <span class="comment">%   img = img0; img.resistivity.node_data = d;</span>
0283 <span class="comment">%   pass = test_undo(img, d) &amp;&amp; pass;</span>
0284 
0285 <span class="comment">%   disp('TEST: img.conductivity');</span>
0286 <span class="comment">%   img = img0; img.conductivity = d; img.params_mapper = 'conductivity';</span>
0287 <span class="comment">%   pass = test_undo(img, d) &amp;&amp; pass;</span>
0288 <span class="keyword">end</span>
0289 
0290 <span class="comment">% img, d=data, dl=data location (once packed)</span>
0291 <a name="_sub10" href="#_subfunctions" class="code">function pass = test_undo(img, d, dl)</a>
0292    pass = 1;
0293    imgp = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img);
0294    imgup = <a href="data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(imgp,<span class="string">'unpack'</span>);
0295    <span class="keyword">if</span> ~isequaln(img, imgup)
0296       img
0297       imgp
0298       imgup
0299       disp(<span class="string">'TEST FAIL: the initial image and the image after being packed, then unpacked differ'</span>);
0300       pass = 0;
0301    <span class="keyword">end</span>
0302    <span class="keyword">if</span> ~isequaln(imgp.(dl), d)
0303       disp([<span class="string">'TEST FAIL: the packed data imgp.'</span> dl <span class="string">' seems broken'</span>]);
0304       pass = 0;
0305    <span class="keyword">end</span>
0306    <span class="keyword">if</span> ~pass
0307       disp(<span class="string">'TEST: ---------------------------------------'</span>);
0308    <span class="keyword">end</span>
0309 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Sun 29-Dec-2024 19:54:43 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>