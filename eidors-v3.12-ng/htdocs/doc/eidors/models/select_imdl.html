<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of select_imdl</title>
  <meta name="keywords" content="select_imdl">
  <meta name="description" content="SELECT_IMDL: select pre-packaged inverse model features">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">eidors</a> &gt; <a href="index.html">models</a> &gt; select_imdl.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/models&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>select_imdl
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>SELECT_IMDL: select pre-packaged inverse model features</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [inv_mdl,opt_out]= select_imdl( mdl, options ) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> SELECT_IMDL: select pre-packaged inverse model features
 inv_mdl= select_imdl( mdl, options )

   mdl - inv_model structure - parameters are replaced as specified
    OR
   mdl - fwd_model OR image

 OPTIONS =&gt; {'opt1','opt2'} options are processed in the order specified
 if OPTIONS is char, treated as first option

 Available options are:

 'Basic GN dif';   Basic GN one step difference solver with Laplace prior
 'Basic GN abs';   Basic Gauss-Newton absolute solver with Laplace prior
 'NOSER dif';      Basic GN one step difference solver with NOSER prior 
 'Nodal GN dif';   Basic GN solver, solves onto nodes
 'TV solve dif':   Total Variation PDIPM difference solver 
 'GREIT':          Algorithm of mk_GREIT_model
   parameters provided as select_imdl(fmdl,{'GREIT:NF=0.3 64x64 rad=0.25'});
   defaults NF=0.5 32x32 rad=0.2
 'GREIT':          3D GREIT if parameters:
     {'GREIT:NF=0.3 32x32x6'});   % default vrange=.2
     {'GREIT:NF=0.3 vrange=0.3 32x32x6'});
   Here 6 slices cover +/-vrange*max(diam) from verticle centre

 'Elec Move GN':   One step GN difference solver with compensation for
                   electrode movement. Conductivity prior, hyperparameter
                   and Jacobian will be preserved if specified in the
                   model
 'Choose NF=1.0';  Choose hyperparameter value appropriate for specified noise figure (NF)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG eidors progress and status messages</li><li><a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>	EIDORS_OBJ: maintains EIDORS internals</li><li><a href="../../eidors/graphics/matlab/show_slices.html" class="code" title="function out_img= show_slices( img, levels, vh )">show_slices</a>	out_img = show_slices (img, levels ) show slices at levels of an</li><li><a href="GREIT3D_distribution.html" class="code" title="function [imdl,distr] = GREIT3D_distribution(fmdl, vopt)">GREIT3D_distribution</a>	GREIT3D_distribution: create target distributions for 3D GREIT</li><li><a href="interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>	INTERP_MESH: calculate interpolation points onto mdl elements</li><li><a href="mk_GREIT_model.html" class="code" title="function [imdl, weight]= mk_GREIT_model( fmdl, radius, weight, options )">mk_GREIT_model</a>	MK_GREIT_MODEL: make EIDORS inverse models using the GREIT approach</li><li><a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>	MK_IMAGE: create eidors image object</li><li><a href="mk_library_model.html" class="code" title="function out = mk_library_model(shape,elec_pos,elec_shape,maxsz,nfft,scale)">mk_library_model</a>	MK_LIBRARY_MODEL - extruded FEM models based on curves in SHAPE_LIBRARY</li><li><a href="mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>	MK_STIM_PATTERNS: create an EIDORS stimulation pattern structure</li><li><a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>	SELECT_IMDL: select pre-packaged inverse model features</li><li><a href="simulate_movement.html" class="code" title="function [vh,vi,xyzr,c2f]= simulate_movement( img, xyzr, UNUSED );">simulate_movement</a>	SIMULATE_MOVEMENT simulate small conductivity perturbations</li><li><a href="valid_inv_model.html" class="code" title="function [pass, err_str] = valid_inv_model(imdl)">valid_inv_model</a>	[pass, err_str] = valid_fwd_model(imdl)</li><li><a href="../../eidors/solvers/forward/jacobian_movement.html" class="code" title="function J = jacobian_movement(fwd_model, img)">jacobian_movement</a>	JACOBIAN_MOVEMENT   Computes the Jacobian matrix for conductivity and</li><li><a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>	FWD_SOLVE: calculate data from a fwd_model object and an image</li><li><a href="../../eidors/solvers/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>	INV_SOLVE: calculate imag from an inv_model and data</li><li><a href="../../eidors/solvers/inverse/choose_noise_figure.html" class="code" title="function HP= choose_noise_figure( inv_model );">choose_noise_figure</a>	CHOOSE_NOISE_FIGURE: choose hyperparameter based on NF calculation</li><li><a href="../../eidors/solvers/inverse/inv_solve_TV_pdipm.html" class="code" title="function img= inv_solve_TV_pdipm( inv_model, data1, data2)">inv_solve_TV_pdipm</a>	INV_SOLVE_TV_PDIPM inverse solver for Andrea Borsic's</li><li><a href="../../eidors/solvers/inverse/inv_solve_diff_GN_one_step.html" class="code" title="function img= inv_solve_diff_GN_one_step( inv_model, data1, data2)">inv_solve_diff_GN_one_step</a>	INV_SOLVE_DIFF_GN_ONE_STEP inverse solver using approach of Adler&Guardo 1996</li><li><a href="../../eidors/solvers/inverse/inv_solve_gn.html" class="code" title="function img= inv_solve_gn( inv_model, data1, data2);">inv_solve_gn</a>	function img= inv_solve_gn( inv_model, data1);</li><li><a href="../../eidors/solvers/inverse/nodal_solve.html" class="code" title="function img= nodal_solve( inv_model, data1, data2)">nodal_solve</a>	NODAL_SOLVE inverse solver using approach of Adler&Guardo 1996</li><li><a href="../../eidors/solvers/inverse/prior_TV.html" class="code" title="function Reg= prior_TV( inv_model );">prior_TV</a>	PRIOR_TV calculate Total Variation image prior</li><li><a href="../../eidors/solvers/inverse/prior_laplace.html" class="code" title="function Reg= prior_laplace( inv_model )">prior_laplace</a>	PRIOR_LAPLACE calculate image prior</li><li><a href="../../eidors/solvers/inverse/prior_movement.html" class="code" title="function Reg= prior_movement( inv_model );">prior_movement</a>	PRIOR_MOVEMENT calculate image prior</li><li><a href="../../eidors/solvers/inverse/prior_noser.html" class="code" title="function Reg= prior_noser( inv_model );">prior_noser</a>	PRIOR_NOSER calculate image prior</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/interface/eidors_readdata.html" class="code" title="function [vv, auxdata, stim]= eidors_readdata( fname, format, frame_range, extra )">eidors_readdata</a>	EIDORS readdata - read data files from various EIT equipment</li><li><a href="../../eidors/meshing/gmsh/gmsh_write_mesh.html" class="code" title="function gmsh_write_mesh(mdl, data, outfile)">gmsh_write_mesh</a>	gmsh_read_mesh(mdl, [data,] outfile)</li><li><a href="GREIT3D_distribution.html" class="code" title="function [imdl,distr] = GREIT3D_distribution(fmdl, vopt)">GREIT3D_distribution</a>	GREIT3D_distribution: create target distributions for 3D GREIT</li><li><a href="GREIT_errors.html" class="code" title="function imdl= GREIT_errors(imdli, opts, data )">GREIT_errors</a>	GREIT_errors: Add Error Compensation to GREIT-type model</li><li><a href="define_ROIs.html" class="code" title="function [ROIs, imgR, imdl] = define_ROIs(imdl, varargin)">define_ROIs</a>	DEFINE_ROIS: define ROI regions in image</li><li><a href="mk_GN_model.html" class="code" title="function imdl = mk_GN_model(img, opt, lambda)">mk_GN_model</a>	MK_GN_MODEL: make EIDORS inverse models using the GREIT approach</li><li><a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>	SELECT_IMDL: select pre-packaged inverse model features</li><li><a href="../../eidors/solvers/forward/jacobian_movement.html" class="code" title="function J = jacobian_movement(fwd_model, img)">jacobian_movement</a>	JACOBIAN_MOVEMENT   Computes the Jacobian matrix for conductivity and</li><li><a href="../../eidors/solvers/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>	INV_SOLVE: calculate imag from an inv_model and data</li><li><a href="../../eidors/solvers/inverse/inv_solve_core.html" class="code" title="function img= inv_solve_core( inv_model, data0, data1);">inv_solve_core</a>	INV_SOLVE_CORE Solver using a generic iterative algorithm</li><li><a href="../../eidors/tools/test_performance.html" class="code" title="function [r, params] =  test_performance( imdls, fmdl );">test_performance</a>	TEST_PERFORMANCE: test of difference reconstruction algorithms</li><li><a href="../../eidors/tools/test_performance_img.html" class="code" title="function [params_img] =  test_performance_img( imdls, fmdl );">test_performance_img</a>	TEST_PERFORMANCE: test of difference reconstruction algorithms</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function imdl = basic_imdl( fmdl, elem_data );</a></li><li><a href="#_sub2" class="code">function imdl = NOSER_dif( imdl );</a></li><li><a href="#_sub3" class="code">function imdl = Basic_GN_Dif( imdl );</a></li><li><a href="#_sub4" class="code">function imdl = Basic_GN_Abs( imdl );</a></li><li><a href="#_sub5" class="code">function imdl = TV_solve_Dif( imdl );</a></li><li><a href="#_sub6" class="code">function imdl = Elec_Move_GN( imdl );</a></li><li><a href="#_sub7" class="code">function imdl = Nodal_GN_Dif( imdl );</a></li><li><a href="#_sub8" class="code">function [imdl,opt] = GREIT(inv_mdl, opts)</a></li><li><a href="#_sub9" class="code">function imdl = Choose_NF( imdl, NF_req );</a></li><li><a href="#_sub10" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [inv_mdl,opt_out]= select_imdl( mdl, options )</a>
0002 <span class="comment">% SELECT_IMDL: select pre-packaged inverse model features</span>
0003 <span class="comment">% inv_mdl= select_imdl( mdl, options )</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%   mdl - inv_model structure - parameters are replaced as specified</span>
0006 <span class="comment">%    OR</span>
0007 <span class="comment">%   mdl - fwd_model OR image</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% OPTIONS =&gt; {'opt1','opt2'} options are processed in the order specified</span>
0010 <span class="comment">% if OPTIONS is char, treated as first option</span>
0011 <span class="comment">%</span>
0012 <span class="comment">% Available options are:</span>
0013 <span class="comment">%</span>
0014 <span class="comment">% 'Basic GN dif';   Basic GN one step difference solver with Laplace prior</span>
0015 <span class="comment">% 'Basic GN abs';   Basic Gauss-Newton absolute solver with Laplace prior</span>
0016 <span class="comment">% 'NOSER dif';      Basic GN one step difference solver with NOSER prior</span>
0017 <span class="comment">% 'Nodal GN dif';   Basic GN solver, solves onto nodes</span>
0018 <span class="comment">% 'TV solve dif':   Total Variation PDIPM difference solver</span>
0019 <span class="comment">% 'GREIT':          Algorithm of mk_GREIT_model</span>
0020 <span class="comment">%   parameters provided as select_imdl(fmdl,{'GREIT:NF=0.3 64x64 rad=0.25'});</span>
0021 <span class="comment">%   defaults NF=0.5 32x32 rad=0.2</span>
0022 <span class="comment">% 'GREIT':          3D GREIT if parameters:</span>
0023 <span class="comment">%     {'GREIT:NF=0.3 32x32x6'});   % default vrange=.2</span>
0024 <span class="comment">%     {'GREIT:NF=0.3 vrange=0.3 32x32x6'});</span>
0025 <span class="comment">%   Here 6 slices cover +/-vrange*max(diam) from verticle centre</span>
0026 <span class="comment">%</span>
0027 <span class="comment">% 'Elec Move GN':   One step GN difference solver with compensation for</span>
0028 <span class="comment">%                   electrode movement. Conductivity prior, hyperparameter</span>
0029 <span class="comment">%                   and Jacobian will be preserved if specified in the</span>
0030 <span class="comment">%                   model</span>
0031 <span class="comment">% 'Choose NF=1.0';  Choose hyperparameter value appropriate for specified noise figure (NF)</span>
0032 
0033 <span class="comment">% (C) 2010-2024 Andy Adler. License: GPL version 2 or version 3</span>
0034 <span class="comment">% $Id: select_imdl.m 6972 2024-10-03 11:40:00Z aadler $</span>
0035 
0036 <span class="keyword">if</span> ischar(mdl) &amp;&amp; strcmp(mdl,<span class="string">'UNIT_TEST'</span>); <a href="#_sub10" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0037 
0038 <span class="keyword">if</span> nargin == 1; options = {}; <span class="keyword">end</span>
0039 
0040 <span class="keyword">switch</span> mdl.type
0041   <span class="keyword">case</span> <span class="string">'inv_model'</span>; inv_mdl = mdl;
0042   <span class="keyword">case</span> <span class="string">'fwd_model'</span>; inv_mdl = <a href="#_sub1" class="code" title="subfunction imdl = basic_imdl( fmdl, elem_data );">basic_imdl</a>( mdl );
0043   <span class="keyword">case</span> <span class="string">'image'</span>;     inv_mdl = <a href="#_sub1" class="code" title="subfunction imdl = basic_imdl( fmdl, elem_data );">basic_imdl</a>( mdl.fwd_model, mdl.elem_data );
0044   <span class="keyword">otherwise</span>;        error(<span class="string">'select_imdl: expects inv_model or fwd_model input'</span>);
0045 <span class="keyword">end</span>
0046 
0047 opt_out = struct(); <span class="comment">% default setting</span>
0048 <span class="keyword">if</span> ischar(options); options = {options}; <span class="keyword">end</span>
0049 <span class="keyword">for</span> i=1:length(options);
0050 <span class="comment">% Pre matlab v7 code</span>
0051 <span class="comment">% [s,f,tok]= regexp(options{i},'(.[^=:]*)[=:]?(.*)');</span>
0052 <span class="comment">% tok = tok{1};</span>
0053 <span class="comment">% for t=1:size(tok,1);</span>
0054 <span class="comment">%    opt{t} = options{i}(tok(t,1):tok(t,2));</span>
0055 <span class="comment">% end</span>
0056   <span class="comment">% split the option on an equals sign</span>
0057   opt= regexp(options{i},<span class="string">'(.[^=:]*)[=:]?(.*)'</span>,<span class="string">'tokens'</span>); opt= opt{1};
0058   <span class="keyword">switch</span> opt{1}
0059     <span class="keyword">case</span> <span class="string">'NOSER dif'</span>;       inv_mdl = <a href="#_sub2" class="code" title="subfunction imdl = NOSER_dif( imdl );">NOSER_dif</a>( inv_mdl );
0060     <span class="keyword">case</span> <span class="string">'Basic GN dif'</span>;    inv_mdl = <a href="#_sub3" class="code" title="subfunction imdl = Basic_GN_Dif( imdl );">Basic_GN_Dif</a>( inv_mdl );
0061     <span class="keyword">case</span> <span class="string">'Basic GN abs'</span>;    inv_mdl = <a href="#_sub4" class="code" title="subfunction imdl = Basic_GN_Abs( imdl );">Basic_GN_Abs</a>( inv_mdl );
0062     <span class="keyword">case</span> <span class="string">'Nodal GN dif'</span>;    inv_mdl = <a href="#_sub7" class="code" title="subfunction imdl = Nodal_GN_Dif( imdl );">Nodal_GN_Dif</a>( inv_mdl );
0063     <span class="keyword">case</span> <span class="string">'TV solve dif'</span>;    inv_mdl = <a href="#_sub5" class="code" title="subfunction imdl = TV_solve_Dif( imdl );">TV_solve_Dif</a>( inv_mdl );
0064     <span class="keyword">case</span> <span class="string">'Elec Move GN'</span>;    inv_mdl = <a href="#_sub6" class="code" title="subfunction imdl = Elec_Move_GN( imdl );">Elec_Move_GN</a>( inv_mdl );
0065     <span class="keyword">case</span> <span class="string">'Choose NF'</span>;       inv_mdl = <a href="#_sub9" class="code" title="subfunction imdl = Choose_NF( imdl, NF_req );">Choose_NF</a>( inv_mdl, str2num(opt{2}) );
0066     <span class="keyword">case</span> <span class="string">'GREIT'</span>;           [inv_mdl,opt_out] = <a href="#_sub8" class="code" title="subfunction [imdl,opt] = GREIT(inv_mdl, opts)">GREIT</a>(inv_mdl, opt{2});
0067     
0068     <span class="keyword">otherwise</span>; error(<span class="string">'option {%s} not understood'</span>, options{i});
0069   <span class="keyword">end</span>
0070 <span class="keyword">end</span>
0071 
0072 <span class="comment">% standard field order</span>
0073 inv_mdl = <a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>(<span class="string">'inv_model'</span>,inv_mdl);
0074 
0075 <span class="comment">% check we are giving back a good specimen</span>
0076 <a href="valid_inv_model.html" class="code" title="function [pass, err_str] = valid_inv_model(imdl)">valid_inv_model</a>(inv_mdl);
0077 
0078 
0079 <a name="_sub1" href="#_subfunctions" class="code">function imdl = basic_imdl( fmdl, elem_data );</a>
0080    <span class="keyword">if</span> nargin&lt;=1; elem_data = 1; <span class="keyword">end</span>
0081    imdl.name= <span class="string">'Basic imdl from select_imdl'</span>;
0082    imdl.type= <span class="string">'inv_model'</span>;
0083 
0084    imdl.solve= <span class="string">'eidors_default'</span>;
0085    imdl.hyperparameter.value = .01;
0086    imdl.RtR_prior = <span class="string">'eidors_default'</span>;
0087    imdl.jacobian_bkgnd.value = elem_data;
0088    imdl.reconst_type= <span class="string">'difference'</span>;
0089    imdl.fwd_model = fmdl;
0090 
0091 <a name="_sub2" href="#_subfunctions" class="code">function imdl = NOSER_dif( imdl );</a>
0092    imdl.RtR_prior = @<a href="../../eidors/solvers/inverse/prior_noser.html" class="code" title="function Reg= prior_noser( inv_model );">prior_noser</a>;
0093    <span class="keyword">try</span>; imdl = rmfield(imdl,<span class="string">'R_prior'</span>); <span class="keyword">end</span>
0094    imdl.hyperparameter.value = .03;
0095    imdl.solve= @<a href="../../eidors/solvers/inverse/inv_solve_diff_GN_one_step.html" class="code" title="function img= inv_solve_diff_GN_one_step( inv_model, data1, data2)">inv_solve_diff_GN_one_step</a>;
0096    imdl.reconst_type= <span class="string">'difference'</span>;
0097 
0098 <a name="_sub3" href="#_subfunctions" class="code">function imdl = Basic_GN_Dif( imdl );</a>
0099    imdl.RtR_prior = @<a href="../../eidors/solvers/inverse/prior_laplace.html" class="code" title="function Reg= prior_laplace( inv_model )">prior_laplace</a>;
0100    <span class="keyword">try</span>; imdl = rmfield(imdl,<span class="string">'R_prior'</span>); <span class="keyword">end</span>
0101    imdl.solve= @<a href="../../eidors/solvers/inverse/inv_solve_diff_GN_one_step.html" class="code" title="function img= inv_solve_diff_GN_one_step( inv_model, data1, data2)">inv_solve_diff_GN_one_step</a>;
0102    imdl.reconst_type= <span class="string">'difference'</span>;
0103 
0104 <a name="_sub4" href="#_subfunctions" class="code">function imdl = Basic_GN_Abs( imdl );</a>
0105    imdl.RtR_prior = @<a href="../../eidors/solvers/inverse/prior_laplace.html" class="code" title="function Reg= prior_laplace( inv_model )">prior_laplace</a>;
0106    <span class="keyword">try</span>; imdl = rmfield(imdl,<span class="string">'R_prior'</span>); <span class="keyword">end</span>
0107    imdl.solve= @<a href="../../eidors/solvers/inverse/inv_solve_gn.html" class="code" title="function img= inv_solve_gn( inv_model, data1, data2);">inv_solve_gn</a>;
0108    imdl.inv_solve_gn.max_iterations= 10;
0109    imdl.reconst_type= <span class="string">'absolute'</span>;
0110 
0111 <a name="_sub5" href="#_subfunctions" class="code">function imdl = TV_solve_Dif( imdl );</a>
0112    imdl.R_prior = @<a href="../../eidors/solvers/inverse/prior_TV.html" class="code" title="function Reg= prior_TV( inv_model );">prior_TV</a>;
0113    <span class="keyword">try</span>; imdl = rmfield(imdl,<span class="string">'RtR_prior'</span>); <span class="keyword">end</span>
0114    imdl.solve= @<a href="../../eidors/solvers/inverse/inv_solve_TV_pdipm.html" class="code" title="function img= inv_solve_TV_pdipm( inv_model, data1, data2)">inv_solve_TV_pdipm</a>;
0115    imdl.reconst_type= <span class="string">'difference'</span>;
0116    imdl.inv_solve.max_iterations= 15;
0117    imdl.hyperparameter.value = 1e-1;
0118    imdl.inv_solve.term_tolerance = 1e-3;
0119 
0120 <a name="_sub6" href="#_subfunctions" class="code">function imdl = Elec_Move_GN( imdl );</a>
0121    <span class="comment">% keep previous model as conductivity jacobian, so it should be ok</span>
0122    imdl.fwd_model.conductivity_jacobian = imdl.fwd_model.jacobian; 
0123    imdl.fwd_model.jacobian = @<a href="../../eidors/solvers/forward/jacobian_movement.html" class="code" title="function J = jacobian_movement(fwd_model, img)">jacobian_movement</a>;
0124    
0125    <span class="comment">% keep previous prior</span>
0126    <span class="keyword">try</span>
0127        imdl.prior_movement.RegC.func = imdl.RtR_prior;
0128    <span class="keyword">catch</span>
0129        imdl.prior_movement.RegC.func = @<a href="../../eidors/solvers/inverse/prior_laplace.html" class="code" title="function Reg= prior_laplace( inv_model )">prior_laplace</a>;
0130        <span class="comment">%  imdl.prior_movement.RegC.func = @prior_gaussian_HPF; % not OK for 3D</span>
0131    <span class="keyword">end</span>
0132    
0133    imdl.RtR_prior =          @<a href="../../eidors/solvers/inverse/prior_movement.html" class="code" title="function Reg= prior_movement( inv_model );">prior_movement</a>;
0134    MV_prior = 1./mean( std( imdl.fwd_model.nodes ));
0135    imdl.prior_movement.parameters = MV_prior;
0136    
0137    imdl.solve= @<a href="../../eidors/solvers/inverse/inv_solve_diff_GN_one_step.html" class="code" title="function img= inv_solve_diff_GN_one_step( inv_model, data1, data2)">inv_solve_diff_GN_one_step</a>;
0138    
0139    <span class="comment">% keep hyperparameter</span>
0140    <span class="keyword">try</span> 
0141        hp = imdl.hyperparameter.value;
0142    <span class="keyword">catch</span>
0143        hp = 0.03;
0144    <span class="keyword">end</span>
0145    imdl.hyperparameter.value = hp;
0146    
0147    <span class="keyword">try</span>
0148       n_elems = size(imdl.rec_model.coarse2fine,2);
0149    <span class="keyword">catch</span>
0150       n_elems = size(imdl.fwd_model.elems,1);
0151    <span class="keyword">end</span>
0152    imdl.inv_solve.select_parameters = 1:n_elems;
0153 
0154    imdl.prior_use_fwd_not_rec = 1; <span class="comment">% for c2f mapping</span>
0155 
0156 <a name="_sub7" href="#_subfunctions" class="code">function imdl = Nodal_GN_Dif( imdl );</a>
0157    imdl.solve = @<a href="../../eidors/solvers/inverse/nodal_solve.html" class="code" title="function img= nodal_solve( inv_model, data1, data2)">nodal_solve</a>;
0158 
0159 <a name="_sub8" href="#_subfunctions" class="code">function [imdl,opt] = GREIT(inv_mdl, opts)</a>
0160    opt.square_pixels = true;
0161    opt.noise_figure = 0.5;
0162    opt.imgsz = [32 32];
0163    <span class="comment">% Allow error compensation afterward</span>
0164    opt.keep_model_components = true;
0165    radius = 0.2;
0166 
0167    vrange = 0.2; <span class="comment">% TODO: add adjust</span>
0168    matches = regexp(opts,<span class="string">'\S+'</span>,<span class="string">'match'</span>);
0169    <span class="keyword">for</span> i=1:length(matches); mi = matches{i};
0170       tok= regexp(mi,<span class="string">'NF=([\d\.]+)'</span>,<span class="string">'tokens'</span>);
0171       <span class="keyword">if</span> ~isempty(tok);
0172          opt.noise_figure = str2num(tok{1}{1});
0173       <span class="keyword">end</span>
0174 
0175       tok= regexp(mi,<span class="string">'rad=([\d\.]+)'</span>,<span class="string">'tokens'</span>);
0176       <span class="keyword">if</span> ~isempty(tok);
0177          radius = str2num(tok{1}{1});
0178       <span class="keyword">end</span>
0179 
0180       tok= regexp(mi,<span class="string">'vrange=([\d\.]+)'</span>,<span class="string">'tokens'</span>);
0181       <span class="keyword">if</span> ~isempty(tok);
0182          vrange = str2num(tok{1}{1});
0183       <span class="keyword">end</span>
0184 
0185       tok= regexp(mi,<span class="string">'(\d+)x(\d+)'</span>,<span class="string">'tokens'</span>);
0186       <span class="keyword">if</span> ~isempty(tok);
0187          opt.imgsz = [str2num(tok{1}{1}), str2num(tok{1}{2})];
0188       <span class="keyword">end</span>
0189 
0190       <span class="comment">% 3D GREIT</span>
0191       tok= regexp(mi,<span class="string">'(\d+)x(\d+)x(\d+)'</span>,<span class="string">'tokens'</span>);
0192       <span class="keyword">if</span> ~isempty(tok);
0193          tokA=str2num(tok{1}{1});
0194          tokB=str2num(tok{1}{2});
0195          tokC=str2num(tok{1}{3});
0196          [minf,maxf] = bounds(inv_mdl.fwd_model.nodes);
0197          vctr = mean([minf(3),maxf(3)]);
0198          mrad = max( maxf(1:2) - minf(1:2) );
0199 
0200          vopt.imgsz = [tokA, tokB];
0201          vopt.square_pixels = true;
0202          vopt.zvec = linspace(-1,1,tokC+1)*mrad*vrange + vctr;
0203          vopt.save_memory = 2;
0204 
0205 <span class="comment">% GREIT 3D with a 1x32 electrode layout</span>
0206          [inv_mdl,opt.distr] = <a href="GREIT3D_distribution.html" class="code" title="function [imdl,distr] = GREIT3D_distribution(fmdl, vopt)">GREIT3D_distribution</a>(inv_mdl, vopt);
0207       <span class="keyword">end</span>
0208    <span class="keyword">end</span>
0209 
0210    imdl= <a href="mk_GREIT_model.html" class="code" title="function [imdl, weight]= mk_GREIT_model( fmdl, radius, weight, options )">mk_GREIT_model</a>(inv_mdl, radius, [], opt);
0211    
0212 
0213 <a name="_sub9" href="#_subfunctions" class="code">function imdl = Choose_NF( imdl, NF_req );</a>
0214    <span class="keyword">if</span> ~strcmp(imdl.reconst_type, <span class="string">'difference'</span>);
0215       error(<span class="string">'Choose NF only works for difference solvers right now'</span>);
0216    <span class="keyword">end</span>
0217 
0218 <span class="comment">% Find 4 elems in mesh ctr to be the NF target elems</span>
0219    xyz_elems = <a href="interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>( imdl.fwd_model );
0220    ctr_elems = mean(xyz_elems, 1);
0221    xyz_elems = xyz_elems - ones(size(xyz_elems,1),1)*ctr_elems;
0222    d_elems   = sqrt( sum( xyz_elems.^2, 2 ));
0223    [jnk, e_idx] = sort(d_elems);
0224 
0225    imdl.hyperparameter.tgt_elems = e_idx(1:4);
0226    imdl.hyperparameter.noise_figure = NF_req;
0227 
0228    sv_log = <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>); <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>, 1);
0229    HP = <a href="../../eidors/solvers/inverse/choose_noise_figure.html" class="code" title="function HP= choose_noise_figure( inv_model );">choose_noise_figure</a>( imdl );
0230    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>, sv_log);
0231 
0232    imdl.hyperparameter.value = HP;
0233 
0234 
0235 <a name="_sub10" href="#_subfunctions" class="code">function do_unit_test</a>
0236 <span class="comment">% Test difference solvers on lung images</span>
0237    load montreal_data_1995;
0238    imdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'b2t3'</span>,16); 
0239 
0240    i=0;<span class="keyword">while</span> true; i=i+1; <span class="comment">% Break when finished</span>
0241       vh = zc_resp(:,1); vi= zc_resp(:,23);
0242       fprintf(<span class="string">'solver #%d\n'</span>,i);
0243       <span class="keyword">switch</span> i
0244          <span class="keyword">case</span> 01;
0245             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl );
0246          <span class="keyword">case</span> 02;
0247             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl.fwd_model );
0248          <span class="keyword">case</span> 03;
0249             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl, {<span class="string">'NOSER dif'</span>} );
0250          <span class="keyword">case</span> 04;
0251             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl, {<span class="string">'NOSER dif'</span>,<span class="string">'Choose NF=1.1'</span>});
0252          <span class="keyword">case</span> 05;
0253             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl, {<span class="string">'Basic GN dif'</span>} );
0254          <span class="keyword">case</span> 06;
0255             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl, {<span class="string">'TV solve dif'</span>} );
0256          <span class="keyword">case</span> 07;
0257             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl.fwd_model, {<span class="string">'Basic GN dif'</span>,<span class="string">'Elec Move GN'</span>} );
0258          <span class="keyword">case</span> 08;
0259             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl.fwd_model, {<span class="string">'Basic GN dif'</span>,<span class="string">'Elec Move GN'</span>,<span class="string">'Choose NF=0.5'</span>} );
0260          <span class="keyword">case</span> 09;
0261             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl, {<span class="string">'Elec Move GN'</span>} );
0262          <span class="keyword">case</span> 10;
0263             imdl0 = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'b2C2'</span>,16); 
0264             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl0, {<span class="string">'Elec Move GN'</span>} );
0265          <span class="keyword">case</span> 11;
0266             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl, {<span class="string">'Nodal GN dif'</span>} );
0267          <span class="keyword">case</span> 12;
0268             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl, {<span class="string">'Nodal GN dif'</span>, <span class="string">'Choose NF=0.50'</span>} );
0269          <span class="keyword">case</span> 13;
0270             fmdl = <a href="mk_library_model.html" class="code" title="function out = mk_library_model(shape,elec_pos,elec_shape,maxsz,nfft,scale)">mk_library_model</a>(<span class="string">'adult_male_16el'</span>);
0271             [stim,msel] = <a href="mk_stim_patterns.html" class="code" title="function [stim, meas_sel]= mk_stim_patterns(n_elec, n_rings, inj, meas, options, amplitude)">mk_stim_patterns</a>(16,1,[0,1],[0,1],{},1);
0272             fmdl.stimulation = stim; 
0273             fmdl.meas_select = msel; 
0274             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( fmdl, <span class="string">'GREIT'</span>);
0275 
0276          <span class="keyword">case</span> 14;
0277             imdl0 = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'b2C2'</span>,16); 
0278             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl0, {<span class="string">'Basic GN dif'</span>, <span class="string">'TV solve dif'</span>} );
0279             imdl0.inv_solve.max_iterations= 2;
0280             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl0, {<span class="string">'Choose NF=0.8'</span>} );
0281             [vh,vi] = <a href="simulate_movement.html" class="code" title="function [vh,vi,xyzr,c2f]= simulate_movement( img, xyzr, UNUSED );">simulate_movement</a>(<a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(imdl0), [0;0.5;0.35]);
0282          <span class="keyword">case</span> 15;
0283             imdl0 = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'b2C2'</span>,16); 
0284             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl0, {<span class="string">'Nodal GN dif'</span>, <span class="string">'Choose NF=0.50'</span>} );
0285             [vh,vi] = <a href="simulate_movement.html" class="code" title="function [vh,vi,xyzr,c2f]= simulate_movement( img, xyzr, UNUSED );">simulate_movement</a>(<a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(imdl0), [0;0.5;0.05]);
0286          <span class="keyword">case</span> 16;
0287             imdl0 = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'b2C2'</span>,16); 
0288             imdl0 = <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>( imdl0, {<span class="string">'Basic GN abs'</span>} );
0289             [vh,vi] = <a href="simulate_movement.html" class="code" title="function [vh,vi,xyzr,c2f]= simulate_movement( img, xyzr, UNUSED );">simulate_movement</a>(<a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(imdl0), [0;0.5;0.05]);
0290          <span class="keyword">case</span> 17;
0291             imdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'n3r2'</span>,[16,2]); fmdl = imdl.fwd_model;
0292             fmdl.nodes(:,3) = fmdl.nodes(:,3) - 1.5;
0293             imdl0= <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>(fmdl,{<span class="string">'GREIT:NF=0.3 64x64 rad=0.25'</span>});
0294             img = <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(fmdl,1); vh = <a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>(img);
0295             img.elem_data(fmdl.demo_targ_elems.A) = 1.2;
0296             img.elem_data(fmdl.demo_targ_elems.B) = 0.8;
0297                                     vi = <a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>(img);
0298            
0299          <span class="keyword">case</span> 18;
0300             imdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'n3r2'</span>,[16,2]); fmdl = imdl.fwd_model;
0301             fmdl.nodes(:,3) = fmdl.nodes(:,3) - 1.5;
0302             imdl0= <a href="select_imdl.html" class="code" title="function [inv_mdl,opt_out]= select_imdl( mdl, options )">select_imdl</a>(fmdl,{<span class="string">'GREIT:NF=0.3 32x32 rad=0.25'</span>});
0303             img = <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(fmdl,1); vh = <a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>(img);
0304             img.elem_data(fmdl.demo_targ_elems.A) = 1.2;
0305             img.elem_data(fmdl.demo_targ_elems.B) = 0.8;
0306                                     vi = <a href="../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>(img);
0307             
0308          <span class="keyword">otherwise</span>; <span class="keyword">break</span>
0309       <span class="keyword">end</span>;
0310 
0311 <span class="comment">%     disp([i,imdl0.hyperparameter.value]);</span>
0312       <span class="keyword">if</span> strcmp( imdl0.reconst_type, <span class="string">'absolute'</span>)
0313          imgr = <a href="../../eidors/solvers/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( imdl0, vi);
0314       <span class="keyword">else</span>
0315          imgr = <a href="../../eidors/solvers/inv_solve.html" class="code" title="function img = inv_solve( inv_model, data1, data2)">inv_solve</a>( imdl0, vh, vi);
0316       <span class="keyword">end</span>
0317       subplot(4,5,i); <a href="../../eidors/graphics/matlab/show_slices.html" class="code" title="function out_img= show_slices( img, levels, vh )">show_slices</a>( imgr, [inf,inf,0] );
0318    <span class="keyword">end</span></pre></div>
<hr><address>Generated on Sun 29-Dec-2024 19:54:43 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>