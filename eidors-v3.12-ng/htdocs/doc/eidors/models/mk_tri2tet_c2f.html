<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of mk_tri2tet_c2f</title>
  <meta name="keywords" content="mk_tri2tet_c2f">
  <meta name="description" content="MK_TRI2TET_C2F - coarse2fine mapping between tri-based and tet-based models">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">eidors</a> &gt; <a href="index.html">models</a> &gt; mk_tri2tet_c2f.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/models&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>mk_tri2tet_c2f
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>MK_TRI2TET_C2F - coarse2fine mapping between tri-based and tet-based models</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function c2f = mk_tri2tet_c2f(fmdl,rmdl, opt) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">MK_TRI2TET_C2F - coarse2fine mapping between tri-based and tet-based models
 C2F = MK_TRI2TET_C2F(FMDL,RMDL) returns in C2F the fraction of volume of
 each element of the fine (tet-based) model contained in each element of
 the coarse (tri-based) model. Each triangle is extruded along the z-axis
 to form a prism.
 Uses CONVHULLN to calculate the volume defined by a set of intersection
 points between individual tet and vox elements.

 C2F = MK_TRI2TET_C2F(FMDL,RMDL,OPT) allows specifying options.
 
 Inputs:
   FMDL - an EIDORS (tet-based) 3D forward model
   RMDL - an EIDORS (tri-based) 2D forward model
   OPT  - an option structure with the following fields and defaults:
      .z_depth
      .do_not_scale  - set to true to prevent scaling the models to unit
                       cube before any calculations, including thresholds.
                       Default: false
      .tol_node2tri  - minimum value of a barycentric coordinate to 
                       decide a tet node is lying inside a triangle and 
                       not on its edge. Default: eps
      .tol_node2tet  - tolerance for determinant &lt;= 0 in testing for
                       points inside tets. Default: eps
      .tol_edge2edge - maximum distance between &quot;intersecting&quot; edges
                       Default: 6*sqrt(3)*eps(a), where a is
                       min(max(abs(fmdl.nodes(:))),max(abs(rmdl.nodes(:)))
      .tol_edge2tri  - minimum value of a barycentric coordinate to 
                       decide an edge-plane intersection point is lying 
                       inside a triangle. Default: eps
                       
 NOTE that for grid-based models, such as returned by MK_GRID_MODEL or
 MK_VOXEL_VOLUME, MK_GRID_C2F is much faster.

 Set eidors_msg 'log level' &lt; 2 to supress output to command line.
 
 See also <a href="mk_grid_c2f.html" class="code" title="function [c2f, m] = mk_grid_c2f(fmdl, rmdl, opt)">MK_GRID_C2F</a>, <a href="mk_tet_c2f.html" class="code" title="function [c2f] = mk_tet_c2f(fmdl, rmdl, opt)">MK_TET_C2F</a>, <a href="mk_tri_c2f.html" class="code" title="function c2f = mk_tri_c2f(fmdl,rmdl,opt)">MK_TRI_C2F</a>, <a href="mk_coarse_fine_mapping.html" class="code" title="function [mapping, outside] = mk_coarse_fine_mapping(varargin)">MK_COARSE_FINE_MAPPING</a>,
          <a href="find_edge2edge_intersections.html" class="code" title="function [pts,FE2CE,FE2pts,CE2pts] = find_edge2edge_intersections(FE,FN,CE,CN, epsilon)">FIND_EDGE2EDGE_INTERSECTIONS</a>, CONVHULLN, <a href="mk_approx_c2f.html" class="code" title="function [mapping, outside] = mk_approx_c2f( f_mdl, c_mdl );">MK_APPROX_C2F</a>,
          <a href="point_in_triangle.html" class="code" title="function out = point_in_triangle(P,E,V,epsilon, str)">POINT_IN_TRIANGLE</a>, EIDORS_MSG</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG eidors progress and status messages</li><li><a href="../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>	SHOW_FEM: show the EIDORS3D finite element model</li><li><a href="../../eidors/meshing/netgen/ng_mk_cyl_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_cyl_models(cyl_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_cyl_models</a>	NG_MAKE_CYL_MODELS: create cylindrical models using netgen</li><li><a href="convhulln_clean.html" class="code" title="function [K,V] = convhulln_clean(pts,p);">convhulln_clean</a>	CONVHULLN_CLEAN: run convhulln and catch errors</li><li><a href="find_edge2edge_intersections.html" class="code" title="function [pts,FE2CE,FE2pts,CE2pts] = find_edge2edge_intersections(FE,FN,CE,CN, epsilon)">find_edge2edge_intersections</a>	FIND_EDGE2EDGE_INTERSECTIONS intersections between edges of two models</li><li><a href="fix_model.html" class="code" title="function [mdl] = fix_model(mdl,opt)">fix_model</a>	FIX_MODEL: Add useful fields to a model</li><li><a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>	GET_ELEM_VOLUME: VOL = get_elem_volume(fwd_model, map_node )</li><li><a href="mk_approx_c2f.html" class="code" title="function [mapping, outside] = mk_approx_c2f( f_mdl, c_mdl );">mk_approx_c2f</a>	MK_APPROX_C2F: create a mapping matrix from coarse to fine FEM</li><li><a href="mk_coarse_fine_mapping.html" class="code" title="function [mapping, outside] = mk_coarse_fine_mapping(varargin)">mk_coarse_fine_mapping</a>	MK_COARSE_FINE_MAPPING: create a mapping matrix from coarse to fine FEM</li><li><a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="mk_grid_c2f.html" class="code" title="function [c2f, m] = mk_grid_c2f(fmdl, rmdl, opt)">mk_grid_c2f</a>	MK_GRID_C2F - calculate a coarse2fine mapping for grid coarse models.</li><li><a href="mk_grid_model.html" class="code" title="function [cmdl, c2f]= mk_grid_model(fmdl, xvec, yvec, zvec, removefn);">mk_grid_model</a>	MK_GRID_MODEL: Create reconstruction model on pixelated grid</li><li><a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>	MK_IMAGE: create eidors image object</li><li><a href="mk_tri2tet_c2f.html" class="code" title="function c2f = mk_tri2tet_c2f(fmdl,rmdl, opt)">mk_tri2tet_c2f</a>	MK_TRI2TET_C2F - coarse2fine mapping between tri-based and tet-based models</li><li><a href="point_in_tet.html" class="code" title="function point2tet = point_in_tet(fmdl,points, epsilon, exclude_nodes)">point_in_tet</a>	POINT_IN_TET test for points contained in elements</li><li><a href="point_in_triangle.html" class="code" title="function out = point_in_triangle(P,E,V,epsilon, str)">point_in_triangle</a>	POINT_IN_TRIANGLE tests points for membership in triangles</li><li><a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>	SPARSE Create sparse matrix (EIDORS overload for Matlab < R2020a / 9.8).</li><li><a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>	EIDORS_CACHE Control eidors caching</li><li><a href="../../eidors/tools/eidors_debug.html" class="code" title="function out = eidors_debug(command, fstr)">eidors_debug</a>	EIDORS_DEBUG Global managment of debug flags</li><li><a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>	PROGRESS_MSG Progress messages and timing.</li><li><a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="mk_analytic_c2f.html" class="code" title="function [mapping, outside] = mk_analytic_c2f( f_mdl, c_mdl, opt)">mk_analytic_c2f</a>	MK_ANALYTIC_C2F: create a mapping matrix from coarse to fine FEM</li><li><a href="mk_tri2tet_c2f.html" class="code" title="function c2f = mk_tri2tet_c2f(fmdl,rmdl, opt)">mk_tri2tet_c2f</a>	MK_TRI2TET_C2F - coarse2fine mapping between tri-based and tet-based models</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function c2f = do_mk_tri2tet_c2f(fmdl,rmdl,opt)</a></li><li><a href="#_sub2" class="code">function [intpts, tri2edge, tri2pts, edge2pts] = get_tet_intersection_pts(fmdl,rmdl,top,bot, epsilon)</a></li><li><a href="#_sub3" class="code">function [intpts, FE2CE, FE2pts, CE2pts] =</a></li><li><a href="#_sub4" class="code">function [top_node2tet, top_nodes, nodes_above, nodes_below] =</a></li><li><a href="#_sub5" class="code">function [intpts, edge2tri, edge2pts, tri2pts] =</a></li><li><a href="#_sub6" class="code">function   [intpts, tri2edge,tri2intpt,edge2intpt] =</a></li><li><a href="#_sub7" class="code">function [fmdl,rmdl, opt] = center_scale_models(fmdl,rmdl, opt)</a></li><li><a href="#_sub8" class="code">function [fmdl,rmdl,fmdl_idx,rmdl_idx] = crop_models(fmdl,rmdl, opt)</a></li><li><a href="#_sub9" class="code">function fmdl = prepare_tet_mdl(fmdl)</a></li><li><a href="#_sub10" class="code">function fmdl = prepare_tri_mdl(fmdl)</a></li><li><a href="#_sub11" class="code">function debug_plot(fmdl,rmdl,v,t, bot, top, pts)</a></li><li><a href="#_sub12" class="code">function opt = parse_opts(fmdl,rmdl, opt)</a></li><li><a href="#_sub13" class="code">function do_unit_test</a></li><li><a href="#_sub14" class="code">function do_inf_test</a></li><li><a href="#_sub15" class="code">function do_small_test</a></li><li><a href="#_sub16" class="code">function do_realistic_test</a></li><li><a href="#_sub17" class="code">function do_centre_slice;</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function c2f = mk_tri2tet_c2f(fmdl,rmdl, opt)</a>
0002 <span class="comment">%MK_TRI2TET_C2F - coarse2fine mapping between tri-based and tet-based models</span>
0003 <span class="comment">% C2F = MK_TRI2TET_C2F(FMDL,RMDL) returns in C2F the fraction of volume of</span>
0004 <span class="comment">% each element of the fine (tet-based) model contained in each element of</span>
0005 <span class="comment">% the coarse (tri-based) model. Each triangle is extruded along the z-axis</span>
0006 <span class="comment">% to form a prism.</span>
0007 <span class="comment">% Uses CONVHULLN to calculate the volume defined by a set of intersection</span>
0008 <span class="comment">% points between individual tet and vox elements.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% C2F = MK_TRI2TET_C2F(FMDL,RMDL,OPT) allows specifying options.</span>
0011 <span class="comment">%</span>
0012 <span class="comment">% Inputs:</span>
0013 <span class="comment">%   FMDL - an EIDORS (tet-based) 3D forward model</span>
0014 <span class="comment">%   RMDL - an EIDORS (tri-based) 2D forward model</span>
0015 <span class="comment">%   OPT  - an option structure with the following fields and defaults:</span>
0016 <span class="comment">%      .z_depth</span>
0017 <span class="comment">%      .do_not_scale  - set to true to prevent scaling the models to unit</span>
0018 <span class="comment">%                       cube before any calculations, including thresholds.</span>
0019 <span class="comment">%                       Default: false</span>
0020 <span class="comment">%      .tol_node2tri  - minimum value of a barycentric coordinate to</span>
0021 <span class="comment">%                       decide a tet node is lying inside a triangle and</span>
0022 <span class="comment">%                       not on its edge. Default: eps</span>
0023 <span class="comment">%      .tol_node2tet  - tolerance for determinant &lt;= 0 in testing for</span>
0024 <span class="comment">%                       points inside tets. Default: eps</span>
0025 <span class="comment">%      .tol_edge2edge - maximum distance between &quot;intersecting&quot; edges</span>
0026 <span class="comment">%                       Default: 6*sqrt(3)*eps(a), where a is</span>
0027 <span class="comment">%                       min(max(abs(fmdl.nodes(:))),max(abs(rmdl.nodes(:)))</span>
0028 <span class="comment">%      .tol_edge2tri  - minimum value of a barycentric coordinate to</span>
0029 <span class="comment">%                       decide an edge-plane intersection point is lying</span>
0030 <span class="comment">%                       inside a triangle. Default: eps</span>
0031 <span class="comment">%</span>
0032 <span class="comment">% NOTE that for grid-based models, such as returned by MK_GRID_MODEL or</span>
0033 <span class="comment">% MK_VOXEL_VOLUME, MK_GRID_C2F is much faster.</span>
0034 <span class="comment">%</span>
0035 <span class="comment">% Set eidors_msg 'log level' &lt; 2 to supress output to command line.</span>
0036 <span class="comment">%</span>
0037 <span class="comment">% See also MK_GRID_C2F, MK_TET_C2F, MK_TRI_C2F, MK_COARSE_FINE_MAPPING,</span>
0038 <span class="comment">%          FIND_EDGE2EDGE_INTERSECTIONS, CONVHULLN, MK_APPROX_C2F,</span>
0039 <span class="comment">%          POINT_IN_TRIANGLE, EIDORS_MSG</span>
0040 
0041 <span class="comment">% (C) 2015 Bartlomiej Grychtol</span>
0042 <span class="comment">% License: GPL version 2 or 3</span>
0043 <span class="comment">% $Id: mk_tri2tet_c2f.m 6923 2024-05-31 10:07:13Z bgrychtol $</span>
0044 
0045 
0046 <span class="keyword">if</span> nargin == 0 || (ischar(fmdl) &amp;&amp; strcmp(fmdl,<span class="string">'UNIT_TEST'</span>)) 
0047    <a href="#_sub13" class="code" title="subfunction do_unit_test">do_unit_test</a>; 
0048    <span class="keyword">return</span>; 
0049 <span class="keyword">end</span>
0050 <span class="keyword">if</span> nargin &lt; 3
0051    opt = struct();
0052 <span class="keyword">end</span>
0053 
0054 f_elems = size(fmdl.elems,1);
0055 r_elems = size(rmdl.elems,1);
0056 c2f = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(f_elems,r_elems);
0057 
0058 <span class="keyword">if</span> size(rmdl.nodes,2) == 2
0059    rmdl.nodes(:,3) = max(fmdl.nodes(:,3))/2 + min(fmdl.nodes(:,3))/2;
0060 <span class="keyword">end</span>
0061 
0062 [fmdl,rmdl,fmdl_idx,rmdl_idx] = <a href="#_sub8" class="code" title="subfunction [fmdl,rmdl,fmdl_idx,rmdl_idx] = crop_models(fmdl,rmdl, opt)">crop_models</a>(fmdl,rmdl, opt);
0063 
0064 <span class="keyword">if</span> ~(any(fmdl_idx) &amp;&amp; any(rmdl_idx))
0065    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@: models do not overlap, returning all-zeros'</span>);
0066    <span class="keyword">return</span>
0067 <span class="keyword">end</span>
0068 
0069 opt = <a href="#_sub12" class="code" title="subfunction opt = parse_opts(fmdl,rmdl, opt)">parse_opts</a>(fmdl,rmdl, opt);
0070 
0071 [fmdl,rmdl, opt] = <a href="#_sub7" class="code" title="subfunction [fmdl,rmdl, opt] = center_scale_models(fmdl,rmdl, opt)">center_scale_models</a>(fmdl,rmdl, opt);
0072 
0073 copt.fstr = <span class="string">'mk_tri2tet_c2f'</span>;
0074 c2f(fmdl_idx,rmdl_idx) = <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>(@<a href="#_sub1" class="code" title="subfunction c2f = do_mk_tri2tet_c2f(fmdl,rmdl,opt)">do_mk_tri2tet_c2f</a>,{fmdl,rmdl,opt},copt);
0075 <span class="comment">% c2f = eidors_cache(@do_mk_tri2tet_c2f,{fmdl,rmdl,opt},copt);</span>
0076 
0077 <span class="keyword">end</span>
0078 
0079 <a name="_sub1" href="#_subfunctions" class="code">function c2f = do_mk_tri2tet_c2f(fmdl,rmdl,opt)</a>
0080    p=struct();
0081    p.debug = <a href="../../eidors/tools/eidors_debug.html" class="code" title="function out = eidors_debug(command, fstr)">eidors_debug</a>(<span class="string">'query'</span>,<span class="string">'mk_tri2tet_c2f:convhulln'</span>);
0082 
0083    r_elems = size(rmdl.elems,1);
0084    f_elems = size(fmdl.elems,1);
0085  
0086    c2f = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(f_elems, r_elems);
0087    
0088    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Prepare tet model...'</span>);
0089    fmdl = <a href="#_sub9" class="code" title="subfunction fmdl = prepare_tet_mdl(fmdl)">prepare_tet_mdl</a>(fmdl);
0090    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(Inf);
0091    
0092    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Prepare tri model...'</span>);
0093    rmdl = <a href="#_sub10" class="code" title="subfunction fmdl = prepare_tri_mdl(fmdl)">prepare_tri_mdl</a>(rmdl);
0094    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(Inf);
0095 
0096    pmopt.final_msg = <span class="string">'none'</span>;
0097    <span class="keyword">if</span> ~isinf(opt.z_depth)
0098       <span class="comment">% tri nodes on top and bot planes inside tets</span>
0099       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find top cap nodes in tets...'</span>,-1,pmopt);
0100       [top_node2tet, top_nodes, top_nodes_above, top_nodes_below] = <span class="keyword">...</span>
0101          get_cap_nodes_in_tets(fmdl,rmdl,opt.top,opt.tol_node2tet);
0102       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>, nnz(top_node2tet)), Inf);
0103       
0104       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find bottom cap nodes in tets...'</span>,-1,pmopt);
0105       [bot_node2tet, bot_nodes, bot_nodes_above, bot_nodes_below] = <span class="keyword">...</span>
0106          get_cap_nodes_in_tets(fmdl,rmdl,opt.bot,opt.tol_node2tet);
0107       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>, nnz(bot_node2tet)), Inf);
0108       
0109       
0110       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find tet_face2tri_edge intersections (top) ...'</span>);
0111       [intpts4, top_tet_face2tri_edge,top_tet_face2intpt4,top_tri_edge2intpt4] = <span class="keyword">...</span>
0112          get_cap_tet_face2tri_edge_intersections( fmdl,rmdl,opt.top, <span class="keyword">...</span>
0113          top_nodes_above,top_nodes_below, opt.tol_edge2tri);
0114       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>, size(intpts4,1)),Inf);
0115       
0116       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find tet_face2tri_edge intersections (bot) ...'</span>);
0117       [intpts5, bot_tet_face2tri_edge,bot_tet_face2intpt5,bot_tri_edge2intpt5] = <span class="keyword">...</span>
0118          get_cap_tet_face2tri_edge_intersections( fmdl,rmdl,opt.bot, <span class="keyword">...</span>
0119          bot_nodes_above,bot_nodes_below, opt.tol_edge2tri);
0120       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>, size(intpts5,1)),Inf);
0121       
0122       <span class="comment">% find tet_edge2tri_face intersections</span>
0123       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find tet_edge2tri_face intersections (top) ...'</span>);
0124       [intpts6, top_tet_edge2tri_face, top_tet_edge2intpt6, tri2intpt6] = <span class="keyword">...</span>
0125          get_cap_tet_edge2tri_face_intersections(fmdl,rmdl,opt.top, <span class="keyword">...</span>
0126          top_nodes_above, top_nodes_below, opt.tol_edge2tri);
0127       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>, size(intpts6,1)),Inf);
0128       
0129       
0130       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find tet_edge2tri_face intersections (bot) ...'</span>);
0131       [intpts7, bot_tet_edge2tri_face, bot_tet_edge2intpt7, tri2intpt7] = <span class="keyword">...</span>
0132          get_cap_tet_edge2tri_face_intersections(fmdl,rmdl,opt.bot, <span class="keyword">...</span>
0133          bot_nodes_above, bot_nodes_below, opt.tol_edge2tri);
0134       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>, size(intpts6,1)),Inf);
0135       
0136       
0137       
0138       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find tet_edge2tri_edge intersections (top) ...'</span>,-1,pmopt);
0139       edgeidx = any(top_nodes_above(fmdl.edges),2) &amp; any(top_nodes_below(fmdl.edges),2);
0140       nodes = rmdl.nodes;
0141       nodes(:,3) = opt.top;
0142       top_tet_edge2tri_edge = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(size(fmdl.edges,1),size(rmdl.edges,1));
0143       [intpts8, top_tet_edge2tri_edge(edgeidx,:), top_tet_edge2intpt8(edgeidx,:), top_tri_edge2intpt8] = <span class="keyword">...</span>
0144          <a href="find_edge2edge_intersections.html" class="code" title="function [pts,FE2CE,FE2pts,CE2pts] = find_edge2edge_intersections(FE,FN,CE,CN, epsilon)">find_edge2edge_intersections</a>(fmdl.edges(edgeidx,:),fmdl.nodes, <span class="keyword">...</span>
0145          rmdl.edges,nodes, opt.tol_edge2edge);
0146       <span class="keyword">if</span> size(top_tet_edge2intpt8,1)~=size(fmdl.edges,1)
0147          <span class="keyword">if</span> ~isempty(intpts8)
0148             top_tet_edge2intpt8(size(fmdl.edges,1),1) = 0;
0149          <span class="keyword">else</span>
0150             top_tet_edge2intpt8 = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(size(fmdl.edges,1),0);
0151          <span class="keyword">end</span>
0152       <span class="keyword">end</span>
0153       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>, size(intpts8,1)),Inf);
0154       
0155       
0156       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find tet_edge2tri_edge intersections (bot) ...'</span>,-1,pmopt);
0157       edgeidx = any(bot_nodes_above(fmdl.edges),2) &amp; any(bot_nodes_below(fmdl.edges),2);
0158       nodes = rmdl.nodes;
0159       nodes(:,3) = opt.bot;
0160       bot_tet_edge2tri_edge = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(size(fmdl.edges,1),size(rmdl.edges,1));
0161       [intpts9, bot_tet_edge2tri_edge(edgeidx,:), <span class="keyword">...</span>
0162          bot_tet_edge2intpt9(edgeidx,:), bot_tri_edge2intpt9] = <span class="keyword">...</span>
0163          <a href="find_edge2edge_intersections.html" class="code" title="function [pts,FE2CE,FE2pts,CE2pts] = find_edge2edge_intersections(FE,FN,CE,CN, epsilon)">find_edge2edge_intersections</a>(fmdl.edges(edgeidx,:),fmdl.nodes, <span class="keyword">...</span>
0164          rmdl.edges,nodes, opt.tol_edge2edge);
0165       <span class="keyword">if</span> size(bot_tet_edge2intpt9,1)~=size(fmdl.edges,1)
0166          <span class="keyword">if</span> ~isempty(intpts9)
0167             bot_tet_edge2intpt9(size(fmdl.edges,1),1) = 0;
0168          <span class="keyword">else</span>
0169             bot_tet_edge2intpt9 = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(size(fmdl.edges,1),0);
0170          <span class="keyword">end</span>
0171       <span class="keyword">end</span>
0172       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>, size(intpts9,1)),Inf);
0173       
0174       <span class="comment">% tri contained in tet</span>
0175       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find tris contained in tet...'</span>)
0176       tri_in_tet = rmdl.node2elem' * (bot_node2tet + top_node2tet) == 6;
0177       <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>,nnz(tri_in_tet)), Inf);
0178    <span class="keyword">end</span>
0179 
0180    <span class="comment">% tet nodes inside triangles</span>
0181    <span class="comment">% positive tolerance to catch also points on the edges.</span>
0182    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find tet_nodes in tri_elems...'</span>);
0183    in = (fmdl.nodes(:,3) &gt;= opt.bot) &amp; (fmdl.nodes(:,3) &lt;= opt.top);
0184    tet_node2tri = spalloc(size(fmdl.nodes,1),size(rmdl.elems,1),nnz(in));
0185    tet_node2tri(in,:) = <a href="point_in_triangle.html" class="code" title="function out = point_in_triangle(P,E,V,epsilon, str)">point_in_triangle</a>(fmdl.nodes(in,1:2), <span class="keyword">...</span>
0186                                     rmdl.elems, <span class="keyword">...</span>
0187                                     rmdl.nodes(:,1:2), <span class="keyword">...</span>
0188                                     opt.tol_node2tri);      
0189    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>, nnz(tet_node2tri)), Inf);
0190   
0191    n_nodes = size(rmdl.nodes,1);
0192    vert_edges(:,1) = 1:n_nodes;
0193    vert_edges(:,2) = vert_edges(:,1) + n_nodes;
0194    
0195    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find tet_edge2vert_edge intersections...'</span>,-1,pmopt);
0196    <span class="keyword">if</span> isinf(opt.z_depth)
0197       bot_nodes = rmdl.nodes; bot_nodes(:,3) = opt.bot - 1;
0198       top_nodes = rmdl.nodes; top_nodes(:,3) = opt.top + 1;
0199    <span class="keyword">end</span>
0200    [intpts1,tet_edge2vert_edge,tet_edge2intpt1,vert_edge2intpt1] = <span class="keyword">...</span>
0201       <a href="find_edge2edge_intersections.html" class="code" title="function [pts,FE2CE,FE2pts,CE2pts] = find_edge2edge_intersections(FE,FN,CE,CN, epsilon)">find_edge2edge_intersections</a>( fmdl.edges, fmdl.nodes,<span class="keyword">...</span>
0202                                     vert_edges, [bot_nodes; top_nodes], <span class="keyword">...</span>
0203                                     opt.tol_edge2edge);
0204    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>,size(intpts1,1)),Inf);
0205    
0206    <span class="comment">% find tet_edges that cross the ractangular faces between the top and</span>
0207    <span class="comment">% bottom caps</span>
0208    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find tet_edge2vert_face intersections...'</span>);
0209    <span class="keyword">if</span> isinf(opt.z_depth)
0210       top = opt.top + 1;
0211       bot = opt.bot - 1;
0212    <span class="keyword">else</span>
0213       top = opt.top;
0214       bot = opt.bot;
0215    <span class="keyword">end</span>
0216    [intpts2,tet_edge2tri_edge,tet_edge2intpt2,tri_edge2intpt2] = <span class="keyword">...</span>
0217       find_edge2edge_intersections_2d( fmdl.edges, fmdl.nodes(:,1:3), <span class="keyword">...</span>
0218                                        rmdl.edges, rmdl.nodes(:,1:2), <span class="keyword">...</span>
0219                                        top, bot);
0220    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>,size(intpts2,1)),Inf);
0221 
0222    
0223    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find tet_face2vert_edge intersections...'</span>);
0224    [intpts3, tet_face2vert_edge, tet_face2intpt3, vert_edge2intpt3] = <span class="keyword">...</span>
0225       <a href="#_sub2" class="code" title="subfunction [intpts, tri2edge, tri2pts, edge2pts] = get_tet_intersection_pts(fmdl,rmdl,top,bot, epsilon)">get_tet_intersection_pts</a>(fmdl,rmdl,top,bot,opt.tol_edge2tri);
0226    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>,size(intpts3,1)),Inf);
0227    
0228       
0229    <span class="comment">% tet contained in tri</span>
0230    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find tets contained in tri...'</span>);
0231    tet_in_tri = (double(fmdl.node2elem') * tet_node2tri) == 4;
0232    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>,nnz(tet_in_tri)), Inf);
0233    
0234    <span class="comment">% tets and tris that intersect</span>
0235    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Find total tri v. tet intersections...'</span>);
0236    tri2intTet = double(rmdl.edge2elem') * tet_edge2tri_edge' * fmdl.edge2elem <span class="keyword">...</span>
0237       |double(rmdl.node2elem') * (tet_face2vert_edge&gt;0)' * fmdl.elem2face';
0238    <span class="keyword">if</span> ~isinf(opt.z_depth)
0239       tri2intTet = tri2intTet <span class="keyword">...</span>
0240       | double(rmdl.edge2elem') * (top_tet_face2tri_edge + bot_tet_face2tri_edge)' * fmdl.elem2face' <span class="keyword">...</span>
0241       | (top_tet_edge2tri_face + bot_tet_edge2tri_face)' * fmdl.edge2elem;
0242    <span class="keyword">end</span>
0243    <span class="comment">% exclude complete inclusion</span>
0244    tri2intTet = tri2intTet &amp; ~tet_in_tri';
0245    <span class="keyword">if</span> ~isinf(opt.z_depth)
0246       tri2intTet = tri2intTet &amp; ~tri_in_tet;
0247    <span class="keyword">end</span>
0248    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(sprintf(<span class="string">'Found %d'</span>,nnz(tri2intTet)), Inf);
0249    
0250    
0251    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Calculate intersection volumes...'</span>);
0252    <span class="comment">% sparse logical multiplication doesn't exist</span>
0253    tri2intpt1 = logical(rmdl.node2elem'*vert_edge2intpt1)';
0254    tet2intpt1 = logical(fmdl.edge2elem'* tet_edge2intpt1)';
0255    
0256    tet2intpt2 = logical(fmdl.edge2elem'*tet_edge2intpt2)';
0257    tri2intpt2 = logical(rmdl.edge2elem'*tri_edge2intpt2)';
0258    
0259    tet2intpt3 = logical(double(fmdl.elem2face)*tet_face2intpt3)';
0260    tri2intpt3 = logical(rmdl.node2elem'*vert_edge2intpt3)';
0261    <span class="keyword">if</span> ~isinf(opt.z_depth)
0262       tet2intpt4  = logical(double(fmdl.elem2face)*top_tet_face2intpt4)';
0263       tri2intpt4  = logical(rmdl.edge2elem'*top_tri_edge2intpt4)';
0264       
0265       tet2intpt5  = logical(double(fmdl.elem2face)*bot_tet_face2intpt5)';
0266       tri2intpt5  = logical(rmdl.edge2elem'*bot_tri_edge2intpt5)';
0267       
0268       tet2intpt6  = logical(fmdl.edge2elem'*top_tet_edge2intpt6)';
0269       tri2intpt6  = tri2intpt6';
0270       
0271       tet2intpt7  = logical(fmdl.edge2elem'*bot_tet_edge2intpt7)';
0272       tri2intpt7  = tri2intpt7';
0273    
0274       tet2intpt8  = logical(fmdl.edge2elem'*top_tet_edge2intpt8)';
0275       tri2intpt8  = logical(rmdl.edge2elem'*top_tri_edge2intpt8)';
0276       
0277       tet2intpt9  = logical(fmdl.edge2elem'*bot_tet_edge2intpt9)';
0278       tri2intpt9  = logical(rmdl.edge2elem'*bot_tri_edge2intpt9)';
0279    <span class="keyword">end</span>
0280    tri_todo = find(sum(tri2intTet,2)&gt;0);
0281    C = []; F = []; V = [];
0282    
0283    id = 0; lvox = length(tri_todo);
0284    mint = ceil(lvox/100);
0285    
0286    <span class="keyword">for</span> v = tri_todo'
0287       id = id+1;
0288       <span class="keyword">if</span> mod(id,mint)==0, <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(id/lvox); <span class="keyword">end</span>
0289       tet_todo = find(tri2intTet(v,:));
0290       common_intpts1 = bsxfun(@and,tri2intpt1(:,v), tet2intpt1(:,tet_todo));
0291       common_intpts2 = bsxfun(@and,tri2intpt2(:,v), tet2intpt2(:,tet_todo));
0292       common_intpts3 = bsxfun(@and,tri2intpt3(:,v), tet2intpt3(:,tet_todo));
0293       <span class="keyword">if</span> ~isinf(opt.z_depth)
0294          common_intpts4 = bsxfun(@and,tri2intpt4(:,v), tet2intpt4(:,tet_todo));
0295          common_intpts5 = bsxfun(@and,tri2intpt5(:,v), tet2intpt5(:,tet_todo));
0296          common_intpts6 = bsxfun(@and,tri2intpt6(:,v), tet2intpt6(:,tet_todo));
0297          common_intpts7 = bsxfun(@and,tri2intpt7(:,v), tet2intpt7(:,tet_todo));
0298          common_intpts8 = bsxfun(@and,tri2intpt8(:,v), tet2intpt8(:,tet_todo));
0299          common_intpts9 = bsxfun(@and,tri2intpt9(:,v), tet2intpt9(:,tet_todo));
0300          top_nodes_tet = bsxfun(@and,top_node2tet(:,tet_todo), rmdl.node2elem(:,v));
0301          bot_nodes_tet = bsxfun(@and,bot_node2tet(:,tet_todo), rmdl.node2elem(:,v));
0302       <span class="keyword">end</span>
0303       tet_nodes     = bsxfun(@and,tet_node2tri(:,v), fmdl.node2elem(:,tet_todo));
0304 
0305       C = [C; v*ones(numel(tet_todo),1)];
0306       F = [F; tet_todo'];
0307       last_v = numel(V);
0308       V = [V; zeros(numel(tet_todo),1)]; <span class="comment">% pre-allocate</span>
0309       <span class="keyword">for</span> t = 1:numel(tet_todo)
0310          pts = [  intpts1(common_intpts1(:,t),:);
0311                   intpts2(common_intpts2(:,t),:);
0312                   intpts3(common_intpts3(:,t),:);
0313                   fmdl.nodes(tet_nodes(:,t),:);];
0314          <span class="keyword">if</span> ~isinf(opt.z_depth) 
0315             pts = [ pts;
0316                   intpts4(common_intpts4(:,t),:);
0317                   intpts5(common_intpts5(:,t),:);
0318                   intpts6(common_intpts6(:,t),:);
0319                   intpts7(common_intpts7(:,t),:);
0320                   intpts8(common_intpts8(:,t),:);
0321                   intpts9(common_intpts9(:,t),:);
0322                   top_nodes(top_nodes_tet(:,t),:);
0323                   bot_nodes(bot_nodes_tet(:,t),:)];
0324          <span class="keyword">end</span>
0325          last_v = last_v + 1;
0326          <span class="keyword">if</span> p.debug
0327            p.fmdl = fmdl; p.rmdl = rmdl;
0328            p.v    = v;   p.t    = t;
0329            p.bot  = bot; p.top  = top; p.pts  = pts;
0330          <span class="keyword">end</span>
0331          [~,V(last_v)] = <a href="convhulln_clean.html" class="code" title="function [K,V] = convhulln_clean(pts,p);">convhulln_clean</a>(pts,p);
0332       <span class="keyword">end</span>
0333    <span class="keyword">end</span>
0334    <a href="../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(Inf);
0335    c2f = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(F,C,V,size(fmdl.elems,1),size(rmdl.elems,1));
0336    
0337    <span class="comment">% add rtri contained in ftet</span>
0338    <span class="keyword">if</span> ~isinf(opt.z_depth)
0339       <span class="keyword">try</span> rmdl = rmfield(rmdl,<span class="string">'coarse2fine'</span>); <span class="keyword">end</span> <span class="comment">% messes with volume</span>
0340       c2f = c2f + bsxfun(@times, <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(tri_in_tet), opt.height * <a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>(rmdl))';
0341    <span class="keyword">end</span>
0342    <span class="comment">% normalize to tet volume</span>
0343    vol = <a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>(fmdl);
0344    c2f = bsxfun(@rdivide,c2f,vol);
0345    
0346    <span class="comment">% add tets contained in vox</span>
0347    
0348    c2f = c2f + tet_in_tri;
0349    
0350 <span class="keyword">end</span>
0351 
0352 <a name="_sub2" href="#_subfunctions" class="code">function [intpts, tri2edge, tri2pts, edge2pts] = get_tet_intersection_pts(fmdl,rmdl,top,bot, epsilon)</a>
0353    intpts = [];
0354    pt_idx = unique(rmdl.elems);
0355    pts = rmdl.nodes(pt_idx,1:2);
0356    
0357    bb_min = min(<span class="keyword">...</span>
0358                 min(fmdl.nodes(fmdl.faces(:,1),1:2),<span class="keyword">...</span>
0359                     fmdl.nodes(fmdl.faces(:,2),1:2)),<span class="keyword">...</span>
0360                 fmdl.nodes(fmdl.faces(:,3),1:2));
0361    bb_max = max(<span class="keyword">...</span>
0362                 max(fmdl.nodes(fmdl.faces(:,1),1:2),<span class="keyword">...</span>
0363                     fmdl.nodes(fmdl.faces(:,2),1:2)),<span class="keyword">...</span>
0364                 fmdl.nodes(fmdl.faces(:,3),1:2));
0365    todo = ~(  bsxfun(@gt,bb_min(:,1),pts(:,1)') <span class="keyword">...</span>
0366             | bsxfun(@gt,bb_min(:,2),pts(:,2)') <span class="keyword">...</span>
0367             | bsxfun(@lt,bb_max(:,1),pts(:,1)') <span class="keyword">...</span>
0368             | bsxfun(@lt,bb_max(:,2),pts(:,2)')); 
0369    [F,P] = find(todo);
0370    P = unique(P);
0371    in = false(size(fmdl.faces,1),size(pts,1));
0372    in(F,P) = <a href="point_in_triangle.html" class="code" title="function out = point_in_triangle(P,E,V,epsilon, str)">point_in_triangle</a>(pts(P,:),fmdl.faces(F,:),fmdl.nodes(:,1:2),epsilon)';
0373    
0374    [F,P] = find(in);
0375 
0376    <span class="comment">% remove &quot;vertical&quot; faces</span>
0377    vf = fmdl.normals(F,3) == 0;
0378    F(vf) = [];
0379    P(vf) = [];
0380    
0381    <span class="comment">% project on faces</span>
0382    <span class="comment">% plane equation is ax+by+cz+d = 0, where d = -(ax0 + by0 + cz0)</span>
0383    z = sum(fmdl.normals(F,:) .* fmdl.nodes(fmdl.faces(F,1),:),2);
0384 <span class="comment">%    z = repmat(d,1,length(P));</span>
0385    <span class="keyword">for</span> j = 1:2
0386       z = z - fmdl.normals(F,j) .* pts(P,j);
0387    <span class="keyword">end</span>
0388    z = z ./ fmdl.normals(F,3);
0389    out = z&gt;top | z &lt; bot;
0390    F(out) = [];
0391    P(out) = [];
0392    z(out) = [];
0393    
0394    intpts = [pts(P,:) z];
0395    I = (1:size(intpts,1))';
0396    F = cast(F,<span class="string">'like'</span>,pt_idx); <span class="comment">% make sparse happy</span>
0397    tri2edge = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(F,pt_idx(P),I,size(fmdl.faces,1),size(rmdl.nodes,1));
0398    I = cast(I,<span class="string">'like'</span>,pt_idx); <span class="comment">% make sparse happy</span>
0399    tri2pts = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(F,I,ones(size(I,1),1),size(fmdl.faces,1),size(intpts,1));
0400    edge2pts = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(pt_idx(P),I,ones(size(I,1),1),size(rmdl.nodes,1),size(intpts,1));
0401    
0402 <span class="keyword">end</span>
0403 
0404 <a name="_sub3" href="#_subfunctions" class="code">function [intpts, FE2CE, FE2pts, CE2pts] = </a><span class="keyword">...</span>
0405    find_edge2edge_intersections_2d(FE, FN, CE, CN, top, bot)
0406 
0407    P1 = FN(FE(:,1),:);
0408    P2 = FN(FE(:,2),:);
0409    P3 = CN(CE(:,1),:);
0410    P4 = CN(CE(:,2),:);
0411 
0412    C_bb = zeros(size(P3,1),4);
0413    C_bb(:,[1 3]) = min(P3(:,1:2),P4(:,1:2));
0414    C_bb(:,[2 4]) = max(P3(:,1:2),P4(:,1:2));
0415 
0416    F_bb = zeros(size(P1,1),4);
0417    F_bb(:,[1 3]) = min(P1(:,1:2),P2(:,1:2));
0418    F_bb(:,[2 4]) = max(P1(:,1:2),P2(:,1:2));
0419 
0420 
0421    todo =   bsxfun(@gt, F_bb(:,1), C_bb(:,2)') <span class="keyword">...</span>
0422           | bsxfun(@lt, F_bb(:,2), C_bb(:,1)') <span class="keyword">...</span>
0423           | bsxfun(@gt, F_bb(:,3), C_bb(:,4)') <span class="keyword">...</span>
0424           | bsxfun(@lt, F_bb(:,4), C_bb(:,3)');
0425    todo = ~todo;
0426 
0427    [T, V] = find(todo);
0428    
0429    S1 = P2(T,:) - P1(T,:);
0430    S2 = P4(V,:) - P3(V,:);
0431    
0432    denom =    S2(:,2) .* S1(:,1) - S2(:,1) .* S1(:,2);
0433 
0434    P13 = P1(T,1:2) - P3(V,1:2);
0435 
0436    num_a =    S2(:,1) .* P13(:,2) <span class="keyword">...</span>
0437             - S2(:,2) .* P13(:,1);
0438    num_b =    S1(:,1) .* P13(:,2) <span class="keyword">...</span>
0439             - S1(:,2) .* P13(:,1);
0440    
0441    mua = num_a ./ denom;
0442    mub = num_b ./ denom;
0443    
0444    IN = mua&gt;0 &amp; mua&lt;1 &amp; mub&gt;0 &amp; mub&lt;1;
0445    T = T(IN);
0446    V = V(IN);
0447    intpts = P1(T,:) + bsxfun(@times, mua(IN), S1(IN,:));
0448    in = ~(intpts(:,3) &gt; top | intpts(:,3) &lt; bot);
0449    intpts = intpts(in,:);
0450    I = (1:size(intpts,1))';
0451    T = T(in);
0452    V = V(in);
0453    FE2CE = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(size(P1,1),size(P3,1));
0454    FE2CE(sub2ind(size(FE2CE),T,V)) = I;
0455    FE2pts = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(T,I,ones(size(I)),size(P1,1),size(I,1));
0456    CE2pts  = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(V,I,ones(size(I)),size(P3,1),size(I,1));
0457    
0458 <span class="keyword">end</span>
0459 
0460 <a name="_sub4" href="#_subfunctions" class="code">function [top_node2tet, top_nodes, nodes_above, nodes_below] = </a><span class="keyword">...</span>
0461    get_cap_nodes_in_tets(fmdl,rmdl,top,epsilon)
0462 
0463    top_nodes = rmdl.nodes;
0464    top_nodes(:,3) = top;
0465    nodes_above = fmdl.nodes(:,3) &gt;= top;
0466    nodes_below = fmdl.nodes(:,3) &lt;= top;
0467    
0468    <span class="comment">% nodes in tets</span>
0469    elidx = any(nodes_above(fmdl.elems),2) &amp; any(nodes_below(fmdl.elems),2);
0470    top_node2tet = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(size(rmdl.nodes,1),size(fmdl.elems,1));
0471    <span class="keyword">if</span> any(elidx)
0472       mdl = struct;
0473       mdl.nodes = fmdl.nodes;
0474       mdl.elems = fmdl.elems(elidx,:);
0475       top_node2tet(:,elidx) = <a href="point_in_tet.html" class="code" title="function point2tet = point_in_tet(fmdl,points, epsilon, exclude_nodes)">point_in_tet</a>(mdl,top_nodes,epsilon);
0476    <span class="keyword">end</span>
0477 <span class="keyword">end</span>
0478 
0479 <span class="comment">%-------------------------------------------------------------------------%</span>
0480 <span class="comment">% Intersections between tet edges and tri faces</span>
0481 <a name="_sub5" href="#_subfunctions" class="code">function [intpts, edge2tri, edge2pts, tri2pts] = </a><span class="keyword">...</span>
0482          get_cap_tet_edge2tri_face_intersections(fmdl,rmdl,top,<span class="keyword">...</span>
0483                                           nodes_above,nodes_below, epsilon)
0484    
0485    intpts = [];
0486    edge2tri = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(size(fmdl.edges,1),size(rmdl.elems,1));
0487    edge2pts = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(size(fmdl.edges,1),0);
0488    tri2pts  = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(size(rmdl.elems,1),0);
0489    
0490 
0491    <span class="comment">% tet_edge2tri_face</span>
0492    edgeidx = any(nodes_above(fmdl.edges),2) &amp; any(nodes_below(fmdl.edges),2);
0493    <span class="comment">% discard nodes on the plane</span>
0494    edgeidx(edgeidx) = fmdl.nodes(fmdl.edges(edgeidx,1),3) ~= <span class="keyword">...</span>
0495                       fmdl.nodes(fmdl.edges(edgeidx,2),3);
0496    
0497    v = fmdl.nodes(fmdl.edges(edgeidx,2),:) - <span class="keyword">...</span>
0498        fmdl.nodes(fmdl.edges(edgeidx,1),:);
0499    u = (top - fmdl.nodes(fmdl.edges(edgeidx,1),3))  ./ v(:,3);
0500    pts = fmdl.nodes(fmdl.edges(edgeidx,1),:) + bsxfun(@times,u, v);
0501    t = <a href="point_in_triangle.html" class="code" title="function out = point_in_triangle(P,E,V,epsilon, str)">point_in_triangle</a>(pts(:,1:2),rmdl.elems,rmdl.nodes(:,1:2),-epsilon);
0502    <span class="comment">% remove any edges that cross multiple faces -- they will be cought by</span>
0503    <span class="comment">% edge2edge intersections elsewhere</span>
0504    t(sum(t,2)&gt;1,:) = false;
0505    [E,T] = find(t);
0506    
0507    <span class="keyword">if</span> any(t(:))
0508       intpts = pts(E,:);
0509       N = size(intpts,1);
0510       I = (1:N)';
0511       emap = find(edgeidx);
0512       E = emap(E);
0513       edge2tri = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(E,T,I,size(fmdl.edges,1), size(rmdl.elems,1));
0514       edge2pts = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(E,I,ones(size(I)),size(fmdl.edges,1), N);
0515       tri2pts  = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(T,I,ones(size(I)),size(rmdl.elems,1), N);
0516    <span class="keyword">end</span>
0517    
0518 <span class="keyword">end</span>
0519 <span class="comment">%-------------------------------------------------------------------------%</span>
0520 <span class="comment">% Intersections between tet faces and tri edges</span>
0521 <a name="_sub6" href="#_subfunctions" class="code">function   [intpts, tri2edge,tri2intpt,edge2intpt] = </a><span class="keyword">...</span>
0522                            get_cap_tet_face2tri_edge_intersections( <span class="keyword">...</span>
0523                             fmdl,rmdl,top,nodes_above,nodes_below, epsilon)
0524    
0525    USE_POINT_IN_TRIANGLE = 0;
0526    
0527    intpts = [];
0528    tri2edge = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(size(fmdl.faces,1),size(rmdl.edges,1));
0529    tri2intpt = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(size(fmdl.faces,1),0);
0530    edge2intpt  = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(size(rmdl.edges,1),0);
0531 
0532                               
0533    <span class="comment">%faces that cross the cap</span>
0534    faceidx = any(nodes_above(fmdl.faces),2) &amp; any(nodes_below(fmdl.faces),2);
0535  
0536    faces = fmdl.faces(faceidx,:);
0537    normals = fmdl.normals(faceidx,:);
0538    
0539    N_edges = size(rmdl.edges,1);
0540    N_faces = size(faces,1);
0541    
0542   
0543    face_bb = zeros(N_faces,6);
0544    face_bb(:,1) = min(reshape(fmdl.nodes(faces,1),N_faces,3),[],2);
0545    face_bb(:,2) = max(reshape(fmdl.nodes(faces,1),N_faces,3),[],2);
0546    face_bb(:,3) = min(reshape(fmdl.nodes(faces,2),N_faces,3),[],2);
0547    face_bb(:,4) = max(reshape(fmdl.nodes(faces,2),N_faces,3),[],2);
0548    
0549    edge_bb = zeros(N_edges,6);
0550    edge_bb(:,1) = min(reshape(rmdl.nodes(rmdl.edges,1),N_edges,2),[],2);
0551    edge_bb(:,2) = max(reshape(rmdl.nodes(rmdl.edges,1),N_edges,2),[],2);
0552    edge_bb(:,3) = min(reshape(rmdl.nodes(rmdl.edges,2),N_edges,2),[],2);
0553    edge_bb(:,4) = max(reshape(rmdl.nodes(rmdl.edges,2),N_edges,2),[],2);
0554    
0555    todo =   bsxfun(@gt, face_bb(:,1), edge_bb(:,2)') <span class="keyword">...</span>
0556           | bsxfun(@lt, face_bb(:,2), edge_bb(:,1)') <span class="keyword">...</span>
0557           | bsxfun(@gt, face_bb(:,3), edge_bb(:,4)') <span class="keyword">...</span>
0558           | bsxfun(@lt, face_bb(:,4), edge_bb(:,3)');
0559    todo = ~todo;
0560    e_todo = any(todo,1);
0561    f_todo = any(todo,2);
0562    faceidx(faceidx) = f_todo;
0563    faces = faces(f_todo,:);
0564    normals = normals(f_todo,:);
0565    [F,E] = find(todo);
0566    emap = zeros(size(e_todo,2),1);
0567    emap(e_todo) = 1:nnz(e_todo);
0568    E = emap(E);
0569    fmap = zeros(size(f_todo,1),1);
0570    fmap(f_todo) = 1:nnz(f_todo);
0571    F = fmap(F);
0572    
0573    P1 = rmdl.nodes(rmdl.edges(e_todo,1),:);
0574    P12 = P1 - rmdl.nodes(rmdl.edges(e_todo,2),:);
0575    P1(:,3) = top;
0576    P12(:,3) = 0;
0577 
0578    d = sum(fmdl.normals(faceidx,:) .* fmdl.nodes(fmdl.faces(faceidx,1),:),2);
0579    
0580    <span class="keyword">if</span> ~USE_POINT_IN_TRIANGLE
0581       <span class="comment">% for point_in_triangle</span>
0582       nodes1 = fmdl.nodes(faces(:,1),:);
0583       v0 = fmdl.nodes(faces(:,3),:) - nodes1;
0584       v1 = fmdl.nodes(faces(:,2),:) - nodes1;
0585       dot00 = dot(v0, v0, 2);
0586       dot01 = dot(v0, v1, 2);
0587       <span class="comment">% dot02 = dot(v0, v2, 2);</span>
0588       dot11 = dot(v1, v1, 2);
0589       <span class="comment">% dot12 = dot(v1, v2, 2);</span>
0590       invDenom = 1 ./ (dot00 .* dot11 - dot01 .* dot01);
0591    <span class="keyword">end</span>
0592    
0593    <span class="comment">% find points of intersection between edges and face planes</span>
0594    num = -d(F) + sum(normals(F,:).*P1(E,:),2);
0595    den = sum(normals(F,:) .* P12(E,:),2);
0596    u = num ./ den;
0597    <span class="comment">% den == 0 =&gt; normal perpendicular to line</span>
0598    idx = u &gt;= 0 &amp; u &lt;= 1 &amp; abs(den) &gt;= eps;
0599    
0600    <span class="keyword">if</span> any(idx)      
0601       F = F(idx);
0602       E = E(idx);
0603       ipts = P1(E,:) - bsxfun(@times, u(idx), P12(E,:));
0604       <span class="keyword">if</span> USE_POINT_IN_TRIANGLE
0605          t = <a href="point_in_triangle.html" class="code" title="function out = point_in_triangle(P,E,V,epsilon, str)">point_in_triangle</a>(ipts,faces(F,:),fmdl.nodes,epsilon,<span class="string">'match'</span>);
0606       <span class="keyword">else</span>
0607          v2 = ipts - fmdl.nodes(faces(F,1),:);
0608          dot02 = dot(v0(F,:),v2,2);
0609          dot12 = dot(v1(F,:),v2,2);
0610          <span class="comment">% barycentric coordinates</span>
0611          dot01 = dot01(F);
0612          invDenom = invDenom(F);
0613          u = (dot11(F) .* dot02 - dot01 .* dot12) .* invDenom;
0614          v = (dot00(F) .* dot12 - dot01 .* dot02) .* invDenom;
0615          t = u &gt;= -epsilon &amp; v &gt;= -epsilon &amp; (u+v-epsilon) &lt;= 1;
0616       <span class="keyword">end</span>
0617       
0618       <span class="keyword">if</span> any(t)
0619          N = nnz(t);
0620          idv = (1:N)';
0621          intpts = ipts(t,:);
0622          I = idv;
0623          idx = find(faceidx); idx = idx(F);
0624          F = idx(t);
0625          eimap = find(emap); 
0626          E = eimap(E(t));
0627          
0628          tri2edge = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(F,E,I,size(fmdl.faces,1),size(rmdl.edges,1));
0629          tri2intpt = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(F,I,ones(size(I)),size(fmdl.faces,1),size(I,1));
0630          edge2intpt  = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(E,I,ones(size(I)),size(rmdl.edges,1),size(I,1));
0631       <span class="keyword">end</span>
0632    <span class="keyword">end</span>
0633 <span class="keyword">end</span>
0634 
0635 <span class="comment">%-------------------------------------------------------------------------%</span>
0636 <span class="comment">% Center scale models</span>
0637 <a name="_sub7" href="#_subfunctions" class="code">function [fmdl,rmdl, opt] = center_scale_models(fmdl,rmdl, opt)</a>
0638    ctr = mean([min(rmdl.nodes);max(rmdl.nodes)]);
0639    rmdl.nodes = bsxfun(@minus,rmdl.nodes,ctr);
0640    fmdl.nodes = bsxfun(@minus,fmdl.nodes,ctr);
0641    opt.top = opt.top - ctr(3);
0642    opt.bot = opt.bot - ctr(3);
0643    <span class="keyword">if</span> isfield(opt,<span class="string">'do_not_scale'</span>) &amp;&amp; opt.do_not_scale
0644       <span class="keyword">return</span>
0645    <span class="keyword">end</span>
0646    maxnode = min( max(abs(rmdl.nodes(:))), max(abs(fmdl.nodes(:))));
0647    scale = 1/maxnode;
0648    rmdl.nodes = scale*rmdl.nodes;
0649    fmdl.nodes = scale*fmdl.nodes;
0650    opt.top    = scale*opt.top;
0651    opt.bot    = scale*opt.bot;
0652    opt.height = scale*opt.height;
0653    opt.z_depth= scale*opt.z_depth;
0654    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@ models scaled by %g'</span>, scale,2);
0655 <span class="keyword">end</span>
0656 
0657 <span class="comment">%-------------------------------------------------------------------------%</span>
0658 <span class="comment">% Remove obviously non-overlapping parts of the models</span>
0659 <a name="_sub8" href="#_subfunctions" class="code">function [fmdl,rmdl,fmdl_idx,rmdl_idx] = crop_models(fmdl,rmdl, opt)</a>
0660    f_min = min(fmdl.nodes);
0661    f_max = max(fmdl.nodes);
0662    r_min = min(rmdl.nodes);
0663    r_max = max(rmdl.nodes);
0664    
0665    <span class="keyword">if</span> isfield(opt, <span class="string">'z_depth'</span>) &amp;&amp; ~isinf(opt.z_depth)
0666       lvl = mean(rmdl.nodes(:,3));
0667       r_max(3) = lvl + opt.z_depth;
0668       r_min(3) = lvl - opt.z_depth;
0669    <span class="keyword">else</span>
0670       r_max(3) = f_max(3);
0671       r_min(3) = f_min(3);
0672    <span class="keyword">end</span>
0673    
0674    <span class="comment">% nodes outside the bounding box of the other model</span>
0675    f_gt  = bsxfun(@gt, fmdl.nodes, r_max);
0676    f_lt  = bsxfun(@lt, fmdl.nodes, r_min);
0677    r_gt  = bsxfun(@gt, rmdl.nodes, f_max);
0678    r_lt  = bsxfun(@lt, rmdl.nodes, f_min);
0679    
0680    <span class="comment">% elems outside the bounding box of the other model</span>
0681    re_gt = any(reshape(all(reshape(r_gt(rmdl.elems',:),3,[])),[],3),2);
0682    re_lt = any(reshape(all(reshape(r_lt(rmdl.elems',:),3,[])),[],3),2);
0683    fe_gt = any(reshape(all(reshape(f_gt(fmdl.elems',:),4,[])),[],3),2);
0684    fe_lt = any(reshape(all(reshape(f_lt(fmdl.elems',:),4,[])),[],3),2);
0685    
0686    <span class="comment">% elems to keep</span>
0687    rmdl_idx = ~(re_gt | re_lt);
0688    fmdl_idx = ~(fe_gt | fe_lt);
0689    
0690    <span class="comment">% remove non-overlapping elems</span>
0691    rmdl.elems = rmdl.elems(rmdl_idx,:);
0692    fmdl.elems = fmdl.elems(fmdl_idx,:);
0693    
0694    <span class="comment">% remove unused nodes</span>
0695    [r_used_nodes,jnk,r_n] = unique(rmdl.elems(:));
0696    [f_used_nodes,jnk,f_n] = unique(fmdl.elems(:));
0697    
0698    r_idx = 1:numel(r_used_nodes);
0699    f_idx = 1:numel(f_used_nodes);
0700    
0701    rmdl.elems = reshape(r_idx(r_n),[],3);
0702    fmdl.elems = reshape(f_idx(f_n),[],4);
0703    
0704    rmdl.nodes = rmdl.nodes(r_used_nodes,:);
0705    fmdl.nodes = fmdl.nodes(f_used_nodes,:);
0706    
0707    <span class="comment">% for the benefit of any (debug) plots later on</span>
0708    <span class="keyword">try</span>, rmdl = rmfield(rmdl,<span class="string">'boundary'</span>); <span class="keyword">end</span>
0709    <span class="keyword">try</span>, fmdl = rmfield(fmdl,<span class="string">'boundary'</span>); <span class="keyword">end</span>
0710 <span class="keyword">end</span>
0711 
0712 <span class="comment">%-------------------------------------------------------------------------%</span>
0713 <span class="comment">% Prepare model</span>
0714 <a name="_sub9" href="#_subfunctions" class="code">function fmdl = prepare_tet_mdl(fmdl)</a>
0715    fmopt.elem2edge = true;
0716    fmopt.edge2elem = true;
0717    fmopt.face2elem = true;
0718    fmopt.node2elem = true;
0719    fmopt.normals   = true;
0720    ll = <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>,1);
0721    fmopt.linear_reorder = false; <span class="comment">% this is slow and not needed</span>
0722    fmdl = <a href="fix_model.html" class="code" title="function [mdl] = fix_model(mdl,opt)">fix_model</a>(fmdl,fmopt);
0723    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>,ll);
0724    fmdl.node2elem = logical(fmdl.node2elem);
0725    nElem = size(fmdl.elems,1);
0726    nFace = size(fmdl.faces,1);
0727    fmdl.elem2face = <a href="../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(repmat((1:nElem)',1,4),double(fmdl.elem2face),true,nElem,nFace);
0728 <span class="keyword">end</span>
0729 
0730 <span class="comment">%-------------------------------------------------------------------------%</span>
0731 <span class="comment">% Prepare model</span>
0732 <a name="_sub10" href="#_subfunctions" class="code">function fmdl = prepare_tri_mdl(fmdl)</a>
0733    fmopt.elem2edge = true;
0734    fmopt.edge2elem = true;
0735 <span class="comment">%    fmopt.face2elem = true;</span>
0736    fmopt.node2elem = true;
0737 <span class="comment">%    fmopt.normals   = true;</span>
0738    fmopt.linear_reorder = false; <span class="comment">% this is slow and not needed</span>
0739    ll = <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>,1);
0740    fmdl = <a href="fix_model.html" class="code" title="function [mdl] = fix_model(mdl,opt)">fix_model</a>(fmdl,fmopt);
0741    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'log_level'</span>,ll);
0742    fmdl.node2elem = logical(fmdl.node2elem);
0743 
0744 <span class="keyword">end</span>
0745 
0746 <span class="comment">%-------------------------------------------------------------------------%</span>
0747 <span class="comment">% Debug plot</span>
0748 <a name="_sub11" href="#_subfunctions" class="code">function debug_plot(fmdl,rmdl,v,t, bot, top, pts)</a>
0749    tet.nodes = fmdl.nodes;
0750    tri.nodes = repmat(rmdl.nodes(rmdl.elems(v,:),:),2,1);
0751    tri.nodes(:,3) = [repmat(bot,3,1); repmat(top,3,1)];
0752    tri.elems = [ 1 2 5 4
0753                  2 3 6 5
0754                  3 1 4 6];
0755    tri.boundary = tri.elems;
0756    tet.type = <span class="string">'fwd_model'</span>;
0757    tri.type = <span class="string">'fwd_model'</span>;
0758    tet.elems = fmdl.elems(t,:);
0759    clf
0760    <a href="../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(tri)
0761    hold on
0762    h = <a href="../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(tet);
0763    set(h,<span class="string">'EdgeColor'</span>,<span class="string">'b'</span>)
0764 <span class="comment">%    pts = bsxfun(@plus,pts*scale,ctr);</span>
0765    plot3(pts(:,1),pts(:,2),pts(:,3),<span class="string">'o'</span>);
0766    hold off
0767    axis auto
0768 <span class="keyword">end</span>
0769 
0770 <span class="comment">%-------------------------------------------------------------------------%</span>
0771 <span class="comment">% Parse option struct</span>
0772 <a name="_sub12" href="#_subfunctions" class="code">function opt = parse_opts(fmdl,rmdl, opt)</a>
0773 
0774    lvl = mean(rmdl.nodes(:,3));
0775    
0776    <span class="keyword">if</span> ~isfield(opt, <span class="string">'z_depth'</span>)
0777       opt.z_depth = Inf;
0778    <span class="keyword">end</span>
0779    <span class="keyword">if</span> isinf(opt.z_depth)
0780       opt.top = max(fmdl.nodes(:,3));
0781       opt.bot = min(fmdl.nodes(:,3));
0782       opt.height = opt.top - opt.bot;
0783    <span class="keyword">else</span>
0784       opt.top = lvl + opt.z_depth;
0785       opt.bot = lvl - opt.z_depth;
0786       opt.height = 2 * opt.z_depth;
0787    <span class="keyword">end</span>
0788    <span class="keyword">if</span> ~isfield(opt, <span class="string">'tol_node2tri'</span>);
0789       opt.tol_node2tri = eps; <span class="comment">% * max(rmdl_rng,fmdl_rng)^3;</span>
0790    <span class="keyword">end</span>
0791    <span class="keyword">if</span> ~isfield(opt, <span class="string">'tol_node2tet'</span>);
0792       opt.tol_node2tet = eps; <span class="comment">% * max(rmdl_rng,fmdl_rng)^3;</span>
0793    <span class="keyword">end</span>
0794    <span class="keyword">if</span> ~isfield(opt, <span class="string">'tol_edge2edge'</span>)
0795       opt.tol_edge2edge = 6*eps(min(max(abs(fmdl.nodes(:))),max(abs(rmdl.nodes(:)))));
0796    <span class="keyword">end</span>
0797    <span class="keyword">if</span> ~isfield(opt, <span class="string">'tol_edge2tri'</span>)
0798       opt.tol_edge2tri = eps; <span class="comment">%1e-10</span>
0799    <span class="keyword">end</span>
0800    <span class="comment">%     if ~isfield(opt, 'save_memory')</span>
0801    <span class="comment">%        opt.save_memory = 0;</span>
0802    <span class="comment">%     end</span>
0803    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@ node2tet  tolerance = %g'</span>, opt.tol_node2tet,2);
0804    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@ edge2edge tolerance = %g'</span>, opt.tol_edge2edge,2);
0805    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@ edge2tri  tolerance = %g'</span>, opt.tol_edge2tri,2);
0806  <span class="keyword">end</span>
0807  
0808  
0809 <a name="_sub13" href="#_subfunctions" class="code">function do_unit_test</a>
0810    <a href="#_sub15" class="code" title="subfunction do_small_test">do_small_test</a>
0811    <a href="#_sub14" class="code" title="subfunction do_inf_test">do_inf_test</a>
0812    <a href="#_sub16" class="code" title="subfunction do_realistic_test">do_realistic_test</a>
0813    do_centre_slice; <span class="comment">% failing code from tutorial</span>
0814 <span class="keyword">end</span>
0815 
0816 <a name="_sub14" href="#_subfunctions" class="code">function do_inf_test</a>
0817    jnk = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c'</span>,16);
0818    tri = jnk.fwd_model;
0819    tri.nodes = 1.1*tri.nodes;
0820    jnk = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'c3cr'</span>,16);
0821    tet = jnk.fwd_model;
0822 
0823    c2f_a = <a href="mk_tri2tet_c2f.html" class="code" title="function c2f = mk_tri2tet_c2f(fmdl,rmdl, opt)">mk_tri2tet_c2f</a>(tet,tri);
0824    c2f_n = <a href="mk_approx_c2f.html" class="code" title="function [mapping, outside] = mk_approx_c2f( f_mdl, c_mdl );">mk_approx_c2f</a>(tet,tri);
0825    
0826    prob = c2f_n ~= 0 &amp; c2f_a == 0;
0827    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'Assert no missing intersections'</span>, nnz(prob),0);
0828    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'mk_tri2tet_c2f v approximate'</span>, c2f_n,c2f_a, .5);
0829 <span class="keyword">end</span>
0830 
0831 
0832 <a name="_sub15" href="#_subfunctions" class="code">function do_small_test</a>
0833    jnk = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c'</span>,16);
0834    tri = jnk.fwd_model;
0835    tri.nodes = 1.1*tri.nodes;
0836    jnk = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'c3cr'</span>,16);
0837    tet = jnk.fwd_model;
0838 <span class="comment">%    tet.elems = tet.elems(8081,:);</span>
0839 <span class="comment">%    tri.elems = tri.elems(1,:);</span>
0840    opt.z_depth = 0.5;
0841    c2f = <a href="mk_tri2tet_c2f.html" class="code" title="function c2f = mk_tri2tet_c2f(fmdl,rmdl, opt)">mk_tri2tet_c2f</a>(tet,tri,opt);
0842  
0843    clf
0844    subplot(131)
0845    <a href="../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(tet);
0846    hold on
0847    <a href="../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(tri);
0848    view(2)
0849    subplot(132)
0850    img = <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(tet,1);
0851    img.elem_data = sum(c2f,2);
0852    img.calc_colours.clim = 1;
0853    img.calc_colours.ref_level = 0;
0854    <a href="../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img);
0855    subplot(133)
0856    img = <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(tri,1);
0857    img.elem_data = sum(bsxfun(@times,c2f,<a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>(tet)),1) ./ <a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>(tri)';
0858    img.calc_colours.clim = 1;
0859    img.calc_colours.ref_level = 0;
0860    <a href="../../eidors/graphics/matlab/show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img)
0861    
0862    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'Check C2F size  '</span>, size(c2f),[length(tet.elems), length(tri.elems)]);
0863    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'Check C2F max==1'</span>, max(c2f(:)), 1);
0864    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'Check C2F min==0'</span>, min(c2f(:)), 0);
0865    
0866    f2c = bsxfun(@rdivide, bsxfun(@times, c2f, <a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>(tet))', <a href="get_elem_volume.html" class="code" title="function VOL = get_elem_volume( fwd_model, map_node )">get_elem_volume</a>(tri));
0867    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'Check F2C max==1'</span>, max(sum(f2c,2)), 1, 1e-14);
0868    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'Check F2C min==0'</span>, min(f2c(:)), 0);
0869 <span class="keyword">end</span>
0870  
0871 
0872 <a name="_sub16" href="#_subfunctions" class="code">function do_realistic_test</a>
0873       
0874    fmdl= <a href="../../eidors/meshing/netgen/ng_mk_cyl_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_cyl_models(cyl_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_cyl_models</a>([2,2,.1],[16,1],[.1,0,.025]);
0875    xvec = -2:.5:2; <span class="comment">%[-1.5 -.5:.2:.5 1.5];</span>
0876    yvec = -2:.5:2; <span class="comment">%[-1.6 -1:.2:1 1.6];</span>
0877    zvec = [.5 1.5];
0878    grid2d = <a href="mk_grid_model.html" class="code" title="function [cmdl, c2f]= mk_grid_model(fmdl, xvec, yvec, zvec, removefn);">mk_grid_model</a>([],xvec,yvec);
0879    grid3d = <a href="mk_grid_model.html" class="code" title="function [cmdl, c2f]= mk_grid_model(fmdl, xvec, yvec, zvec, removefn);">mk_grid_model</a>([],xvec,yvec,zvec);
0880    <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a> clear
0881    tic
0882    opt.save_memory = 0;
0883    c2f_a = <a href="mk_grid_c2f.html" class="code" title="function [c2f, m] = mk_grid_c2f(fmdl, rmdl, opt)">mk_grid_c2f</a>(fmdl, grid3d,opt);
0884    t = toc;
0885    fprintf(<span class="string">'Voxel:\tt=%f s\n'</span>,t);
0886 
0887    opt.z_depth = .5;
0888    grid2d.nodes(:,3) = 1;
0889    <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a> clear
0890    tic
0891 <span class="comment">%    fmdl.elems = fmdl.elems(2764,:);</span>
0892 <span class="comment">%    grid2d.elems = grid2d.elems(4,:);</span>
0893    c2f_b = <a href="mk_tri2tet_c2f.html" class="code" title="function c2f = mk_tri2tet_c2f(fmdl,rmdl, opt)">mk_tri2tet_c2f</a>(fmdl, grid2d, opt);
0894    t = toc;
0895    fprintf(<span class="string">'tri2tet:\tt=%f \n'</span>,t);
0896    c2f_c = c2f_b * grid2d.coarse2fine;
0897    
0898    <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a> clear
0899 
0900    grid2d.mk_coarse_fine_mapping.z_depth = .5;
0901    grid2d.mk_coarse_fine_mapping.f2c_offset(3) = 1;
0902    grid2d = rmfield(grid2d,<span class="string">'coarse2fine'</span>);
0903    tic
0904    c2f_n = <a href="mk_approx_c2f.html" class="code" title="function [mapping, outside] = mk_approx_c2f( f_mdl, c_mdl );">mk_approx_c2f</a>(fmdl,grid2d);
0905    t = toc;
0906    fprintf(<span class="string">'Approximate: t=%f s\n'</span>,t);
0907    
0908    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'mk_tri2tet_c2f v mk_grid_c2f'</span>, c2f_c,c2f_a, 1e-5);
0909    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'mk_tri2tet_c2f v approximate'</span>, c2f_n,c2f_b, .5);
0910    prob = c2f_n ~= 0 &amp; c2f_b == 0;
0911    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'Assert no missing intersections'</span>, nnz(prob),0);
0912 <span class="comment">%    keyboard</span>
0913 <span class="comment">%    subplot(132)</span>
0914 <span class="comment">%    imagesc(c2f_c, [0 1]);</span>
0915 <span class="comment">%    subplot(133)</span>
0916 <span class="comment">%    imagesc(c2f_a, [0 1]);</span>
0917 <span class="comment">%    figure</span>
0918 <span class="comment">%    subplot(131)</span>
0919 <span class="comment">% show_fem(mk_image(fmdl,sum(c2f_a,2)));</span>
0920 <span class="comment">% img_a = mk_image(fmdl,sum(c2f_a,2));</span>
0921 <span class="comment">% img_a.calc_colours.ref_level = 0;</span>
0922 <span class="comment">% show_fem(img_a)</span>
0923 <span class="comment">% subplot(132)</span>
0924 <span class="comment">% img_c = mk_image(fmdl,sum(c2f_c,2));</span>
0925 <span class="comment">% img_c.calc_colours.ref_level = 0;</span>
0926 <span class="comment">% show_fem(img_c)</span>
0927 <span class="comment">% subplot(133)</span>
0928 <span class="comment">% img_n = mk_image(fmdl,sum(c2f_n,2));</span>
0929 <span class="comment">% img_n.calc_colours.ref_level = 0;</span>
0930 <span class="comment">% show_fem(img_n)</span>
0931 <span class="comment">%    keyboard</span>
0932 <span class="keyword">end</span>
0933  
0934  
0935 <a name="_sub17" href="#_subfunctions" class="code">function do_centre_slice; </a><span class="comment">% failing code from tutorial</span>
0936    imdl = <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'b3cr'</span>,[16,2]);
0937    f_mdl= imdl.fwd_model;
0938    imdl2d= <a href="mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'b2c2'</span>,16);
0939    c_mdl= imdl2d.fwd_model;
0940    c2f= <a href="mk_coarse_fine_mapping.html" class="code" title="function [mapping, outside] = mk_coarse_fine_mapping(varargin)">mk_coarse_fine_mapping</a>( f_mdl, c_mdl);
0941 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Sun 29-Dec-2024 19:54:43 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>