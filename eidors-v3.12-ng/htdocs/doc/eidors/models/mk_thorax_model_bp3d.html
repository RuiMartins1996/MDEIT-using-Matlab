<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of mk_thorax_model_bp3d</title>
  <meta name="keywords" content="mk_thorax_model_bp3d">
  <meta name="description" content="MK_THORAX_MODEL_BP3D Torso model based on BodyParts3D">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../index.html">Home</a> &gt;  <a href="../index.html">eidors</a> &gt; <a href="index.html">models</a> &gt; mk_thorax_model_bp3d.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../index.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/models&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>mk_thorax_model_bp3d
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>MK_THORAX_MODEL_BP3D Torso model based on BodyParts3D</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function out = mk_thorax_model_bp3d(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">MK_THORAX_MODEL_BP3D Torso model based on BodyParts3D

 FMDL = MK_THORAX_MODEL_BP3D() 
 Returns a torso fwd_model with no electrodes or organs

 FMDL = MK_THORAX_MODEL_BP3D(elec_pos, elec_shape)
 FMDL = MK_THORAX_MODEL_BP3D(elec_pos, elec_shape, maxh)
 Allows specifying electrode configuration, see PLACE_ELEC_ON_SURF

 FMDL = MK_THORAX_MODEL_BP3D(stimpat)
 A predefined model with round electrodes (radius 1 cm). Accepts a string 
 parameter to define a stim pattern:
    '2x16_planar'   - 2 rings of 16 electrodes, planar stimulation
    '2x16_odd-even' - 2 rings, each stimulation is cross-plane 
    '2x16_square'   - 2 rings, every second stimulation is cross-plane
    '2x16_adjacent' - like square, but with adjacent stimulation
    '1x32_ring'     - single ring of 32 electrodes

 IMG = MK_THORAX_MODEL_BP3D(... , organspec)
 Returns a torso model containing organ shapes as an image structure. Can
 be used with all the above electrode defintions. 
 ORGANSPEC must be one of:
    'fine'          - a relatively dense model, ~7 million elems
    'coarse'        - a coarser model, *NOT IMPLEMENTED YET*
 

 The 'fine' model contains the following materials:
    #   mat_names         Description
   -----------------------------------------------------------------------
     1    Body                 Volume between the skin and the internal organs
     2    LungLeft             Left lung
     3    LungRight            Right lung
     4    HeartWall            Heart wall
     5    Aorta                Aorta (wall)
     6    SVC                  Superior Vena Cava (wall)
     7    IVC                  Inferior Vena Cava (wall)
     8    PA                   Pulmonary Artery (wall)
     9    LSPV                 Left Superior Pulmonary Vein (wall)
    10    LIPV                 Left Inferior Pulmonary Vein (wall)
    11    RSPV                 Right Superior Pulmonary Vein (wall)
    12    RIPV                 Right Inferior Pulmonary Vein (wall)
    13    BloodHeartLeft       Blood in left atrium and left ventricle
    14    BloodHeartRight      Blood in right atrium and right ventricle
    15    BloodAorta           Aorta (lumen)
    16    BloodSVC             Superior Vena Cava (lumen)
    17    BloodIVC             Inferior Vena Cava (lumen)
    18    BloodPA              Pulmonary Artery (lumen)
    19    BloodLSPV            Left Superior Pulmonary Vein (lumen)
    20    BloodLIPV            Left Inferior Pulmonary Vein (lumen)
    21    BloodRSPV            Right Superior Pulmonary Vein (lumen)
    22    BloodRIPV            Right Inferior Pulmonary Vein (lumen)


 CITATION_REQUEST:
 AUTHOR: Grychtol B
 TITLE: Torso Organ Meshes
 JOURNAL: Zenodo 
 YEAR: 2024
 DOI: 10.5281/zenodo.11047831

 LICENSE INFORMATION:
 The model generated by this function is a derivative of the &lt;a href=
 &quot;matlab: web https://https://doi.org/10.5281/zenodo.11047830 -browser&quot;
 &gt;&quot;Torso Organ Meshes&quot;&lt;/a&gt; 
 by Bartłomiej Grychtol, itself a derivative of the &lt;a href=&quot;matlab: web 
 https://dbarchive.biosciencedbc.jp/en/bodyparts3d -browser&quot;&gt;BodyParts3D&lt;/a&gt; database by 
 &lt;a href=&quot;matlab: web https://biosciencedbc.jp/ -browser&quot;
 &gt;The Database Center for Life Science&lt;/a&gt;, used under the Creative Commons 
 Attribution-ShareAlike 2.1 Japan (&lt;a href=&quot;matlab: web 
 http://creativecommons.org/licenses/by-sa/2.1/jp/deed.en_US 
 -browser&quot;&gt;CC BY-SA 2.1 JP&lt;/a&gt;) license.
 The model must be licensed under CC BY-SA 2.1 JP and attributed
 correctly.

 See also <a href="mk_thorax_model.html" class="code" title="function out = mk_thorax_model(str, varargin)">MK_THORAX_MODEL</a>, <a href="place_elec_on_surf.html" class="code" title="function mdl2 = place_elec_on_surf(mdl,elec_pos, elec_spec,ng_opt_file, maxh)">PLACE_ELEC_ON_SURF</a>

 For usage examples: pubs/conferences/EIT2024/torso-mesh-bp3d/mk_figures.m</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG eidors progress and status messages</li><li><a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>	EIDORS_OBJ: maintains EIDORS internals</li><li><a href="../../eidors/interface/get_contrib_data.html" class="code" title="function p = get_contrib_data( contrib , file )">get_contrib_data</a>	GET_CONTRIB_DATA Get files from the EIDORS data_contrib repository</li><li><a href="../../eidors/meshing/gmsh/gmsh_stl2tet.html" class="code" title="function mdl = gmsh_stl2tet(stlfile, mesh_size, extra, nopt)">gmsh_stl2tet</a>	GMSH_STL2TET creates a tetrahedral mesh from an stl file</li><li><a href="../../eidors/meshing/remove_elems.html" class="code" title="function [fmdl, c2f_idx] = remove_elems(fmdl, idx, elec_opt)">remove_elems</a>	REMOVE_ELEMS   Remove nodes from a fwd_model.</li><li><a href="fix_boundary.html" class="code" title="function mdl = fix_boundary(mdl)">fix_boundary</a>	FIX_BOUNDARY Orient boundary triangles consistently</li><li><a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>	MERGE_MESHES - merges two meshes sharing only boundary nodes</li><li><a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>	MK_IMAGE: create eidors image object</li><li><a href="mk_thorax_model.html" class="code" title="function out = mk_thorax_model(str, varargin)">mk_thorax_model</a>	MK_THORAX_MODEL FEM models of the thorax</li><li><a href="mk_thorax_model_bp3d.html" class="code" title="function out = mk_thorax_model_bp3d(varargin)">mk_thorax_model_bp3d</a>	MK_THORAX_MODEL_BP3D Torso model based on BodyParts3D</li><li><a href="num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>	NUM_ELEMS: number of elemnts in a (fwd or inv model or image)</li><li><a href="num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>	NUM_NODES: number of elemnts in a (fwd or inv model or image)</li><li><a href="../../eidors/models/private/set_predef_stim.html" class="code" title="function mdl = set_predef_stim(mdl, stimpat)">set_predef_stim</a>	SET_PREDEF_STIM</li><li><a href="../../eidors/solvers/forward/find_boundary.html" class="code" title="function [srf, idx] = find_boundary(simp);">find_boundary</a>	[srf, idx] = find_boundary(simp);</li><li><a href="../../eidors/tools/citeme.html" class="code" title="function citeme(fname)">citeme</a>	CITEME Display citation requests</li><li><a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>	EIDORS_CACHE Control eidors caching</li><li><a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="mk_thorax_model.html" class="code" title="function out = mk_thorax_model(str, varargin)">mk_thorax_model</a>	MK_THORAX_MODEL FEM models of the thorax</li><li><a href="mk_thorax_model_bp3d.html" class="code" title="function out = mk_thorax_model_bp3d(varargin)">mk_thorax_model_bp3d</a>	MK_THORAX_MODEL_BP3D Torso model based on BodyParts3D</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function out = get_torso()</a></li><li><a href="#_sub2" class="code">function out = build_predef_elecs(stimpat, organspec)</a></li><li><a href="#_sub3" class="code">function out = mk_organ_image(out, organspec)</a></li><li><a href="#_sub4" class="code">function out = add_organs(torso, organs)</a></li><li><a href="#_sub5" class="code">function img = set_organ_values(torso)</a></li><li><a href="#_sub6" class="code">function mm = restore_electrodes(mm, electrode, z_contact, thresh)</a></li><li><a href="#_sub7" class="code">function organs = get_organ_models(organspec)</a></li><li><a href="#_sub8" class="code">function mdl = mk_fine_organs</a></li><li><a href="#_sub9" class="code">function mdl = assemble_organs(organs)</a></li><li><a href="#_sub10" class="code">function organs = mk_individual_organs</a></li><li><a href="#_sub11" class="code">function right = mk_blood_right_surf(srf)</a></li><li><a href="#_sub12" class="code">function left = mk_blood_left_surf(srf)</a></li><li><a href="#_sub13" class="code">function [heart, right, left] = mk_heart_surf(srf)</a></li><li><a href="#_sub14" class="code">function [V, B] = mk_vessel(vstruct)</a></li><li><a href="#_sub15" class="code">function mdl = flip_normals(mdl)</a></li><li><a href="#_sub16" class="code">function mdl = bd(mdl)</a></li><li><a href="#_sub17" class="code">function print_mdl_info(mdl, name)</a></li><li><a href="#_sub18" class="code">function out = get_cache_path</a></li><li><a href="#_sub19" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function out = mk_thorax_model_bp3d(varargin)</a>
0002 <span class="comment">%MK_THORAX_MODEL_BP3D Torso model based on BodyParts3D</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% FMDL = MK_THORAX_MODEL_BP3D()</span>
0005 <span class="comment">% Returns a torso fwd_model with no electrodes or organs</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% FMDL = MK_THORAX_MODEL_BP3D(elec_pos, elec_shape)</span>
0008 <span class="comment">% FMDL = MK_THORAX_MODEL_BP3D(elec_pos, elec_shape, maxh)</span>
0009 <span class="comment">% Allows specifying electrode configuration, see PLACE_ELEC_ON_SURF</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% FMDL = MK_THORAX_MODEL_BP3D(stimpat)</span>
0012 <span class="comment">% A predefined model with round electrodes (radius 1 cm). Accepts a string</span>
0013 <span class="comment">% parameter to define a stim pattern:</span>
0014 <span class="comment">%    '2x16_planar'   - 2 rings of 16 electrodes, planar stimulation</span>
0015 <span class="comment">%    '2x16_odd-even' - 2 rings, each stimulation is cross-plane</span>
0016 <span class="comment">%    '2x16_square'   - 2 rings, every second stimulation is cross-plane</span>
0017 <span class="comment">%    '2x16_adjacent' - like square, but with adjacent stimulation</span>
0018 <span class="comment">%    '1x32_ring'     - single ring of 32 electrodes</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% IMG = MK_THORAX_MODEL_BP3D(... , organspec)</span>
0021 <span class="comment">% Returns a torso model containing organ shapes as an image structure. Can</span>
0022 <span class="comment">% be used with all the above electrode defintions.</span>
0023 <span class="comment">% ORGANSPEC must be one of:</span>
0024 <span class="comment">%    'fine'          - a relatively dense model, ~7 million elems</span>
0025 <span class="comment">%    'coarse'        - a coarser model, *NOT IMPLEMENTED YET*</span>
0026 <span class="comment">%</span>
0027 <span class="comment">%</span>
0028 <span class="comment">% The 'fine' model contains the following materials:</span>
0029 <span class="comment">%    #   mat_names         Description</span>
0030 <span class="comment">%   -----------------------------------------------------------------------</span>
0031 <span class="comment">%     1    Body                 Volume between the skin and the internal organs</span>
0032 <span class="comment">%     2    LungLeft             Left lung</span>
0033 <span class="comment">%     3    LungRight            Right lung</span>
0034 <span class="comment">%     4    HeartWall            Heart wall</span>
0035 <span class="comment">%     5    Aorta                Aorta (wall)</span>
0036 <span class="comment">%     6    SVC                  Superior Vena Cava (wall)</span>
0037 <span class="comment">%     7    IVC                  Inferior Vena Cava (wall)</span>
0038 <span class="comment">%     8    PA                   Pulmonary Artery (wall)</span>
0039 <span class="comment">%     9    LSPV                 Left Superior Pulmonary Vein (wall)</span>
0040 <span class="comment">%    10    LIPV                 Left Inferior Pulmonary Vein (wall)</span>
0041 <span class="comment">%    11    RSPV                 Right Superior Pulmonary Vein (wall)</span>
0042 <span class="comment">%    12    RIPV                 Right Inferior Pulmonary Vein (wall)</span>
0043 <span class="comment">%    13    BloodHeartLeft       Blood in left atrium and left ventricle</span>
0044 <span class="comment">%    14    BloodHeartRight      Blood in right atrium and right ventricle</span>
0045 <span class="comment">%    15    BloodAorta           Aorta (lumen)</span>
0046 <span class="comment">%    16    BloodSVC             Superior Vena Cava (lumen)</span>
0047 <span class="comment">%    17    BloodIVC             Inferior Vena Cava (lumen)</span>
0048 <span class="comment">%    18    BloodPA              Pulmonary Artery (lumen)</span>
0049 <span class="comment">%    19    BloodLSPV            Left Superior Pulmonary Vein (lumen)</span>
0050 <span class="comment">%    20    BloodLIPV            Left Inferior Pulmonary Vein (lumen)</span>
0051 <span class="comment">%    21    BloodRSPV            Right Superior Pulmonary Vein (lumen)</span>
0052 <span class="comment">%    22    BloodRIPV            Right Inferior Pulmonary Vein (lumen)</span>
0053 <span class="comment">%</span>
0054 <span class="comment">%</span>
0055 <span class="comment">% CITATION_REQUEST:</span>
0056 <span class="comment">% AUTHOR: Grychtol B</span>
0057 <span class="comment">% TITLE: Torso Organ Meshes</span>
0058 <span class="comment">% JOURNAL: Zenodo</span>
0059 <span class="comment">% YEAR: 2024</span>
0060 <span class="comment">% DOI: 10.5281/zenodo.11047831</span>
0061 <span class="comment">%</span>
0062 <span class="comment">% LICENSE INFORMATION:</span>
0063 <span class="comment">% The model generated by this function is a derivative of the &lt;a href=</span>
0064 <span class="comment">% &quot;matlab: web https://https://doi.org/10.5281/zenodo.11047830 -browser&quot;</span>
0065 <span class="comment">% &gt;&quot;Torso Organ Meshes&quot;&lt;/a&gt;</span>
0066 <span class="comment">% by Bartłomiej Grychtol, itself a derivative of the &lt;a href=&quot;matlab: web</span>
0067 <span class="comment">% https://dbarchive.biosciencedbc.jp/en/bodyparts3d -browser&quot;&gt;BodyParts3D&lt;/a&gt; database by</span>
0068 <span class="comment">% &lt;a href=&quot;matlab: web https://biosciencedbc.jp/ -browser&quot;</span>
0069 <span class="comment">% &gt;The Database Center for Life Science&lt;/a&gt;, used under the Creative Commons</span>
0070 <span class="comment">% Attribution-ShareAlike 2.1 Japan (&lt;a href=&quot;matlab: web</span>
0071 <span class="comment">% http://creativecommons.org/licenses/by-sa/2.1/jp/deed.en_US</span>
0072 <span class="comment">% -browser&quot;&gt;CC BY-SA 2.1 JP&lt;/a&gt;) license.</span>
0073 <span class="comment">% The model must be licensed under CC BY-SA 2.1 JP and attributed</span>
0074 <span class="comment">% correctly.</span>
0075 <span class="comment">%</span>
0076 <span class="comment">% See also MK_THORAX_MODEL, PLACE_ELEC_ON_SURF</span>
0077 <span class="comment">%</span>
0078 <span class="comment">% For usage examples: pubs/conferences/EIT2024/torso-mesh-bp3d/mk_figures.m</span>
0079 
0080 <span class="comment">% (C) 2024 Bartek Grychtol. License: GPL v2 or v3</span>
0081 <span class="comment">% $Id: mk_thorax_model_bp3d.m 7137 2024-12-29 18:42:23Z aadler $</span>
0082 
0083 <span class="keyword">if</span> nargin&gt;=1 &amp;&amp; strcmp(varargin{1},<span class="string">'UNIT_TEST'</span>); <a href="#_sub19" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0084 
0085 <a href="../../eidors/tools/citeme.html" class="code" title="function citeme(fname)">citeme</a>(mfilename)
0086 
0087 <span class="keyword">if</span> nargin == 0 <span class="comment">% get a torso with no electrodes</span>
0088    out = <a href="#_sub1" class="code" title="subfunction out = get_torso()">get_torso</a>; 
0089 <span class="keyword">end</span>
0090 organspec = <span class="string">''</span>;
0091 copyright = <span class="string">''</span>;
0092 <span class="keyword">if</span> nargin &gt; 1 &amp;&amp; ischar(varargin{end})
0093    organspec = varargin{end};
0094    varargin(end) = [];
0095 <span class="keyword">end</span>
0096 
0097 <span class="keyword">switch</span> length(varargin)
0098    <span class="keyword">case</span> 0
0099       out = <a href="#_sub3" class="code" title="subfunction out = mk_organ_image(out, organspec)">mk_organ_image</a>(out, organspec); <span class="comment">% for the sake of completeness</span>
0100    <span class="keyword">case</span> 1
0101       <span class="keyword">if</span> isempty(varargin{1}) 
0102          out = <a href="#_sub1" class="code" title="subfunction out = get_torso()">get_torso</a>;
0103          <span class="keyword">if</span> ~isempty(organspec)
0104             out = <a href="#_sub3" class="code" title="subfunction out = mk_organ_image(out, organspec)">mk_organ_image</a>(out, organspec);
0105          <span class="keyword">end</span>
0106       <span class="keyword">elseif</span> ischar(varargin{1}) 
0107          copyright = <span class="string">'(C) EIDORS Project'</span>;
0108          out = <a href="#_sub2" class="code" title="subfunction out = build_predef_elecs(stimpat, organspec)">build_predef_elecs</a>(varargin{1}, organspec);
0109       <span class="keyword">else</span>
0110          error(<span class="string">'EIDORS:WrongInput'</span>,<span class="string">'Electrode specification not understood'</span>);
0111       <span class="keyword">end</span>
0112    <span class="keyword">case</span> {2,3}
0113       out = <a href="mk_thorax_model.html" class="code" title="function out = mk_thorax_model(str, varargin)">mk_thorax_model</a>(<span class="string">'bp3d'</span>,varargin{:});
0114       out = <a href="#_sub3" class="code" title="subfunction out = mk_organ_image(out, organspec)">mk_organ_image</a>(out, organspec);
0115    <span class="keyword">otherwise</span>
0116       error(<span class="string">'EIDORS:WrongInput'</span>, <span class="string">'Too many inputs'</span>);
0117 <span class="keyword">end</span>
0118 
0119 out = <a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>(<span class="string">'set'</span>, out); <span class="comment">% sort fields</span>
0120 
0121 <span class="keyword">if</span> ~isempty(copyright)
0122    out.copyright = copyright;
0123 <span class="keyword">end</span>
0124 
0125 out.attribution = <span class="keyword">...</span>
0126    [<span class="string">'Modified from &quot;Torso Organ Meshes&quot; '</span> <span class="keyword">...</span>
0127     <span class="string">'(https://doi.org/10.5281/zenodo.11047831) by Bartłomiej Grychtol '</span> <span class="keyword">...</span>
0128     <span class="string">'/ A derivative of &quot;BodyParts3D&quot; '</span><span class="keyword">...</span>
0129     <span class="string">'(https://dbarchive.biosciencedbc.jp/en/bodyparts3d) by '</span><span class="keyword">...</span>
0130     <span class="string">'The Database Center for Life Science.'</span>];
0131 
0132 out.license   =  [<span class="string">'Creative Commons Attribution-ShareAlike 2.1 Japan '</span><span class="keyword">...</span><span class="comment">;</span>
0133        <span class="string">'(http://creativecommons.org/licenses/by-sa/2.1/jp/deed.en_US)'</span>];
0134 
0135 <span class="keyword">if</span> strcmp(out.type, <span class="string">'image'</span>)
0136    <span class="keyword">try</span> out.fwd_model.copyright = out.copyright; <span class="keyword">end</span>
0137    out.fwd_model.attribution = out.attribution;
0138    out.fwd_model.license = out.license;
0139 <span class="keyword">end</span>
0140 
0141 ws = warning(<span class="string">'off'</span>, <span class="string">'backtrace'</span>);
0142 warning(<span class="string">'EIDORS:License'</span>, <span class="keyword">...</span>
0143    [<span class="string">'The bp3d torso model is licensed under CC BY-SA 2.1 JP.\n'</span> <span class="keyword">...</span>
0144     <span class="string">'Please make sure to attribute correctly. '</span> <span class="keyword">...</span>
0145     <span class="string">'See the attribution field for details.'</span>]);
0146 warning(ws.state, <span class="string">'backtrace'</span>);
0147 
0148 
0149 <a name="_sub1" href="#_subfunctions" class="code">function out = get_torso()</a>
0150 contrib = <span class="string">'bp3d-torso'</span>; file =  <span class="string">'bp3d_torso.mat'</span>;
0151 load(<a href="../../eidors/interface/get_contrib_data.html" class="code" title="function p = get_contrib_data( contrib , file )">get_contrib_data</a>(contrib,file),<span class="string">'torso'</span>);
0152 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Building bp3d body surface'</span>, 2);
0153 out = <a href="../../eidors/meshing/gmsh/gmsh_stl2tet.html" class="code" title="function mdl = gmsh_stl2tet(stlfile, mesh_size, extra, nopt)">gmsh_stl2tet</a>(torso);
0154 out = <a href="fix_boundary.html" class="code" title="function mdl = fix_boundary(mdl)">fix_boundary</a>(out);
0155 out.name = <span class="string">'BP3D Torso Model'</span>;
0156 
0157 
0158 <a name="_sub2" href="#_subfunctions" class="code">function out = build_predef_elecs(stimpat, organspec)</a>
0159 cache_path = <a href="#_sub18" class="code" title="subfunction out = get_cache_path">get_cache_path</a>;
0160 fname = <span class="string">'bp3d_predef_torso'</span>;
0161 suffix = <span class="string">''</span>;
0162 <span class="keyword">if</span> ~isempty(organspec)
0163    fname = [fname <span class="string">'_'</span> organspec];
0164    suffix = [<span class="string">' - '</span> organspec];
0165 <span class="keyword">end</span>
0166 name = [<span class="string">'BP3D Torso Model'</span> suffix];
0167 fpath = [cache_path filesep fname <span class="string">'.mat'</span>];
0168 <span class="keyword">if</span> exist(fpath,<span class="string">'file'</span>)
0169    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'@@ Using stored model.'</span>, 3);
0170    load(fpath, <span class="string">'out'</span>);
0171 <span class="keyword">else</span>
0172    eth16 = 360*cumsum([0.2 0.4*ones(1,7) 0.5 0.4*ones(1,7)])/6.5 - 90; eth16 = eth16';
0173    eth32 = 360*cumsum([0.1 0.2*ones(1,15) 0.25 0.2*ones(1,15)])/6.45 - 90; eth32 = eth32';
0174    ep = eth16; ep(:,2) = 1175;
0175    ep(17:48,1) = eth32; ep(17:48,2) = 1212.5;
0176    ep(49:64,1) = eth16; ep(49:64,2) = 1250;
0177    out = <a href="mk_thorax_model.html" class="code" title="function out = mk_thorax_model(str, varargin)">mk_thorax_model</a>(<span class="string">'bp3d'</span>,ep,[10 0 1],20);
0178    out.name = name;
0179    out = <a href="#_sub3" class="code" title="subfunction out = mk_organ_image(out, organspec)">mk_organ_image</a>(out, organspec);
0180    save(fpath,<span class="string">'out'</span>);
0181 <span class="keyword">end</span>
0182 out = <a href="../../eidors/models/private/set_predef_stim.html" class="code" title="function mdl = set_predef_stim(mdl, stimpat)">set_predef_stim</a>(out, stimpat);
0183 out.name = [out.name <span class="string">' - '</span> stimpat];
0184 
0185 
0186 <a name="_sub3" href="#_subfunctions" class="code">function out = mk_organ_image(out, organspec)</a>
0187 <span class="keyword">if</span> isempty(organspec), <span class="keyword">return</span>, <span class="keyword">end</span>
0188 organs = <a href="#_sub7" class="code" title="subfunction organs = get_organ_models(organspec)">get_organ_models</a>(organspec);
0189 out = <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>(@<a href="#_sub4" class="code" title="subfunction out = add_organs(torso, organs)">add_organs</a>,{out, organs});
0190 out = <a href="#_sub5" class="code" title="subfunction img = set_organ_values(torso)">set_organ_values</a>(out);
0191 out.name = <span class="string">'BP3D Torso Image'</span>;
0192 
0193 
0194 <a name="_sub4" href="#_subfunctions" class="code">function out = add_organs(torso, organs)</a>
0195 tri.vertices = torso.nodes;
0196 tri.faces = torso.boundary;
0197 N = size(tri.vertices, 1);
0198 tri.vertices = [tri.vertices; organs.nodes];
0199 tri.faces = [tri.faces; N + organs.boundary(:,[1 3 2])];
0200 
0201 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Re-meshing body volume'</span>, 2);
0202 shell = <a href="../../eidors/meshing/gmsh/gmsh_stl2tet.html" class="code" title="function mdl = gmsh_stl2tet(stlfile, mesh_size, extra, nopt)">gmsh_stl2tet</a>(tri,[],[],4); <span class="comment">% lots of optimization</span>
0203 <a href="#_sub17" class="code" title="subfunction print_mdl_info(mdl, name)">print_mdl_info</a>(shell, <span class="string">'Body'</span>);
0204 
0205 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Restoring electrodes'</span>, 2);
0206 <span class="keyword">if</span> isfield(torso, <span class="string">'electrode'</span>) &amp;&amp; ~isempty(torso.electrode)
0207    <span class="keyword">for</span> i = 1:numel(torso.electrode)
0208       electrode(i).nodes = torso.nodes(torso.electrode(i).nodes,:);
0209    <span class="keyword">end</span>
0210    shell = <a href="#_sub6" class="code" title="subfunction mm = restore_electrodes(mm, electrode, z_contact, thresh)">restore_electrodes</a>(shell, electrode, 0.01);
0211 <span class="keyword">end</span>
0212 organs.boundary = organs.show_boundary;
0213 organs = rmfield(organs, <span class="string">'show_boundary'</span>);
0214 
0215 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Merging body and organ volumes'</span>, 2);
0216 out = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(shell, organs);
0217 out.mat_names = [<span class="string">'Body'</span>; organs.mat_names];
0218  
0219 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Removing trachea'</span>, 2);
0220 idx = strcmp(out.mat_names,<span class="string">'Trachea'</span>);
0221 out = <a href="../../eidors/meshing/remove_elems.html" class="code" title="function [fmdl, c2f_idx] = remove_elems(fmdl, idx, elec_opt)">remove_elems</a>(out, out.mat_idx{idx});
0222 
0223 <span class="comment">% nicely re-order materials</span>
0224 idx = [1 5 10 2  17:2:21 15 6 8 11 13 3 4 18:2:22 16 7 9 12 14];
0225 out.mat_idx = out.mat_idx(idx);
0226 out.mat_names = out.mat_names(idx);
0227 
0228 out = <a href="../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>(<span class="string">'set'</span>, out); <span class="comment">% order fields</span>
0229 
0230 <a href="#_sub17" class="code" title="subfunction print_mdl_info(mdl, name)">print_mdl_info</a>(out, <span class="string">'Final model'</span>);
0231 
0232 <a name="_sub5" href="#_subfunctions" class="code">function img = set_organ_values(torso)</a>
0233 img = <a href="mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(torso, 1, <span class="string">'bp3d-torso'</span>);
0234 <span class="keyword">for</span> i = 2:numel(torso.mat_idx)
0235     <span class="keyword">if</span> strcmp(torso.mat_names{i},<span class="string">'HeartWall'</span>)
0236         img.elem_data(torso.mat_idx{i}) = 1.5;
0237 <span class="comment">%     elseif strcmp(torso.mat_names{i},'Trachea')</span>
0238 <span class="comment">%         img.elem_data(torso.mat_idx{i}) = NaN;</span>
0239     <span class="keyword">elseif</span> ~isempty(strfind(torso.mat_names{i}, <span class="string">'Blood'</span>))
0240         img.elem_data(torso.mat_idx{i}) = 2;
0241     <span class="keyword">elseif</span> ~isempty(strfind(torso.mat_names{i}, <span class="string">'Lung'</span>))
0242         img.elem_data(torso.mat_idx{i}) = .5;
0243     <span class="keyword">else</span> <span class="comment">% vessel</span>
0244         img.elem_data(torso.mat_idx{i}) = .8;
0245     <span class="keyword">end</span>
0246 <span class="keyword">end</span>
0247 img.calc_colours.ref_level = 1;
0248 
0249 <a name="_sub6" href="#_subfunctions" class="code">function mm = restore_electrodes(mm, electrode, z_contact, thresh)</a>
0250 <span class="keyword">if</span> nargin &lt; 4
0251    thresh = eps;
0252 <span class="keyword">end</span>
0253 surf_node_idx = unique(<a href="../../eidors/solvers/forward/find_boundary.html" class="code" title="function [srf, idx] = find_boundary(simp);">find_boundary</a>(mm));
0254 surf_nodes = mm.nodes(surf_node_idx,:);
0255 <span class="comment">% ignore nodes close to the bottom surface</span>
0256 rng = max(surf_nodes(:,3)) - min(surf_nodes(:,3));
0257 idx = surf_nodes(:,3) &gt; min(surf_nodes(:,3)) + 0.02 * rng;
0258 surf_node_idx = surf_node_idx(idx);
0259 surf_nodes = surf_nodes(idx,:);
0260 <span class="keyword">for</span> e = 1:numel(electrode)
0261    <span class="comment">% if we got this far, we should have enough memory for vectorized calcs</span>
0262    dist = (surf_nodes(:,1) - electrode(e).nodes(:,1)').^2;
0263    <span class="keyword">for</span> d = 2:3
0264       dist = dist + (surf_nodes(:,d) - electrode(e).nodes(:,d)').^2;
0265    <span class="keyword">end</span>
0266 <span class="comment">%    dist = sqrt(dist); % takes a long time and changes nothing</span>
0267    [val, pos] = min(dist);
0268    <span class="keyword">if</span> any(val &gt; thresh)
0269       warning(<span class="string">'Some nodes of electrode %d seem too far. Furthest distance: %f'</span>,e,sqrt(max(val)));
0270    <span class="keyword">end</span>
0271    mm.electrode(e).nodes = surf_node_idx(pos);
0272    mm.electrode(e).z_contact = z_contact;
0273 <span class="keyword">end</span>
0274 
0275 
0276 <a name="_sub7" href="#_subfunctions" class="code">function organs = get_organ_models(organspec)</a>
0277 <span class="keyword">switch</span> organspec
0278    <span class="keyword">case</span> <span class="string">'fine'</span>
0279       fhandle = @<a href="#_sub8" class="code" title="subfunction mdl = mk_fine_organs">mk_fine_organs</a>;
0280    <span class="keyword">case</span> <span class="string">'coarse'</span>
0281       error(<span class="string">'EIDORS:NotImplemented'</span>, [<span class="string">'Coarse organ model is not '</span><span class="keyword">...</span>
0282             <span class="string">'implemented yet.'</span>])
0283    <span class="keyword">otherwise</span>
0284       error(<span class="string">'EIDORS:WrongInput'</span>, <span class="string">'Organ specification not understood.'</span>);
0285 <span class="keyword">end</span>
0286 cache_path = <a href="#_sub18" class="code" title="subfunction out = get_cache_path">get_cache_path</a>;
0287 fname = sprintf(<span class="string">'bp3d_organs_%s.mat'</span>, organspec);
0288 fpath = [cache_path filesep fname];
0289 <span class="keyword">if</span> ~exist(fpath, <span class="string">'file'</span>)
0290    <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'This takes a REALLY long time'</span>);
0291    organs = feval(fhandle);
0292    save(fpath, <span class="string">'organs'</span>);
0293 <span class="keyword">else</span>
0294    load(fpath, <span class="string">'organs'</span>);
0295 <span class="keyword">end</span>
0296 
0297 
0298 <a name="_sub8" href="#_subfunctions" class="code">function mdl = mk_fine_organs</a>
0299 
0300 start_time = now(); 
0301 organs = <a href="#_sub10" class="code" title="subfunction organs = mk_individual_organs">mk_individual_organs</a>;
0302 mdl = <a href="#_sub9" class="code" title="subfunction mdl = assemble_organs(organs)">assemble_organs</a>(organs);
0303 mdl.show_boundary = mdl.boundary;
0304 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Recalculating boundary'</span>,2);
0305 mdl = <a href="fix_boundary.html" class="code" title="function mdl = fix_boundary(mdl)">fix_boundary</a>(mdl);
0306 
0307 <span class="comment">%  cashed results are not useful outside</span>
0308 <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>(<span class="string">'clear_old'</span>, start_time);
0309 
0310 
0311 <a name="_sub9" href="#_subfunctions" class="code">function mdl = assemble_organs(organs)</a>
0312 pcs = struct();
0313 
0314 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Merging vessels'</span>, 2);
0315 vessels = {<span class="string">'Aorta'</span>,<span class="string">'IVC'</span>,<span class="string">'SVC'</span>,<span class="string">'PA'</span>, <span class="string">'LSPV'</span>, <span class="string">'LIPV'</span>,<span class="string">'RSPV'</span>,<span class="string">'RIPV'</span>};
0316 <span class="keyword">for</span> i = 1:numel(vessels)
0317     v = vessels{i};
0318     disp(v)
0319     pcs.(v) = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(organs.(v), organs.([<span class="string">'Blood'</span> v]),1e-2);
0320     pcs.(v).mat_names = {v; [<span class="string">'Blood'</span> v]};
0321 <span class="keyword">end</span>
0322 
0323 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Merging left side'</span>, 2);
0324 left = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(organs.LungLeft, <span class="keyword">...</span><span class="comment">            </span>
0325                     pcs.LSPV, <span class="keyword">...</span>
0326                     pcs.LIPV, <span class="keyword">...</span>
0327                     1e-2);
0328 left.mat_names = vertcat({<span class="string">'LungLeft'</span>},pcs.LSPV.mat_names, pcs.LIPV.mat_names);
0329 
0330 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Merging right side'</span>, 2);
0331 right = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(organs.LungRight, <span class="keyword">...</span><span class="comment">            </span>
0332                      pcs.RSPV, <span class="keyword">...</span>
0333                      pcs.RIPV, <span class="keyword">...</span>
0334                      2e-1); <span class="comment">% need a larger threshold due to mesh mismatch</span>
0335 right.mat_names = vertcat({<span class="string">'LungRight'</span>},pcs.RSPV.mat_names, pcs.RIPV.mat_names);
0336 
0337 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Merging heart'</span>, 2);
0338 heart = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(organs.HeartWall, <span class="keyword">...</span>
0339                      organs.BloodLeftHeart, <span class="keyword">...</span>
0340                      organs.BloodRightHeart, <span class="keyword">...</span>
0341                      1e-2);
0342 heart.mat_names = {<span class="string">'HeartWall'</span>;<span class="string">'BloodHeartLeft'</span>; <span class="string">'BloodHeartRight'</span>};
0343 
0344 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Merging heart, left and right'</span>, 2);
0345 mdl = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(heart, left, right, 1e-2);
0346 mdl.mat_names = vertcat(heart.mat_names, left.mat_names, right.mat_names);
0347 
0348 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Merging remaining vessels'</span>, 2);
0349 mdl = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(mdl, <span class="keyword">...</span>
0350                   pcs.PA, <span class="keyword">...</span>
0351                   pcs.Aorta, <span class="keyword">...</span>
0352                   pcs.SVC, <span class="keyword">...</span>
0353                   pcs.IVC, <span class="keyword">...</span>
0354                   1e-2);
0355 mdl.mat_names = vertcat(mdl.mat_names, pcs.PA.mat_names,pcs.Aorta.mat_names, <span class="keyword">...</span>
0356                         pcs.SVC.mat_names, pcs.IVC.mat_names);
0357 
0358 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Merging trachea'</span>, 2);
0359 mdl = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(mdl, organs.Trachea, 5e-2);
0360 mdl.mat_names{end+1} = <span class="string">'Trachea'</span>;
0361 
0362 
0363 <a name="_sub10" href="#_subfunctions" class="code">function organs = mk_individual_organs</a>
0364 org_path = <a href="../../eidors/interface/get_contrib_data.html" class="code" title="function p = get_contrib_data( contrib , file )">get_contrib_data</a>(<span class="string">'bp3d-torso'</span>,<span class="string">'bp3d_organs.mat'</span>);
0365 srf = load(org_path);
0366 
0367 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Meshing vessels'</span>, 2);
0368 vessels = {<span class="string">'Aorta'</span>,<span class="string">'IVC'</span>,<span class="string">'SVC'</span>,<span class="string">'PA'</span>, <span class="string">'LSPV'</span>, <span class="string">'LIPV'</span>,<span class="string">'RSPV'</span>,<span class="string">'RIPV'</span>};
0369 <span class="keyword">for</span> i = 1:numel(vessels)
0370     v = vessels{i};
0371     disp(v)
0372     [vessel, blood] = <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>(@<a href="#_sub14" class="code" title="subfunction [V, B] = mk_vessel(vstruct)">mk_vessel</a>, srf.(v));
0373     organs.(v) = vessel;
0374     b = sprintf(<span class="string">'Blood%s'</span>, v);
0375     organs.(b) = blood;
0376     <a href="#_sub17" class="code" title="subfunction print_mdl_info(mdl, name)">print_mdl_info</a>(vessel, v);
0377     <a href="#_sub17" class="code" title="subfunction print_mdl_info(mdl, name)">print_mdl_info</a>(blood, b);
0378 <span class="keyword">end</span>
0379 
0380 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Meshing trachea and lungs'</span>, 2);
0381 organs.Trachea = <a href="../../eidors/meshing/gmsh/gmsh_stl2tet.html" class="code" title="function mdl = gmsh_stl2tet(stlfile, mesh_size, extra, nopt)">gmsh_stl2tet</a>(srf.Trachea,[],[],1);
0382 <a href="#_sub17" class="code" title="subfunction print_mdl_info(mdl, name)">print_mdl_info</a>(organs.Trachea, <span class="string">'Trachea'</span>);
0383 organs.LungLeft = <a href="../../eidors/meshing/gmsh/gmsh_stl2tet.html" class="code" title="function mdl = gmsh_stl2tet(stlfile, mesh_size, extra, nopt)">gmsh_stl2tet</a>(srf.LungLeft,[],[],2);
0384 <a href="#_sub17" class="code" title="subfunction print_mdl_info(mdl, name)">print_mdl_info</a>(organs.LungLeft, <span class="string">'LungLeft'</span>);
0385 organs.LungRight = <a href="../../eidors/meshing/gmsh/gmsh_stl2tet.html" class="code" title="function mdl = gmsh_stl2tet(stlfile, mesh_size, extra, nopt)">gmsh_stl2tet</a>(srf.LungRight,[],[],2);
0386 <a href="#_sub17" class="code" title="subfunction print_mdl_info(mdl, name)">print_mdl_info</a>(organs.LungRight, <span class="string">'LungRight'</span>);
0387 
0388 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Meshing left heart'</span>, 2);
0389 left = <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>(@<a href="#_sub12" class="code" title="subfunction left = mk_blood_left_surf(srf)">mk_blood_left_surf</a>,srf);
0390 organs.BloodLeftHeart = <a href="../../eidors/meshing/gmsh/gmsh_stl2tet.html" class="code" title="function mdl = gmsh_stl2tet(stlfile, mesh_size, extra, nopt)">gmsh_stl2tet</a>(left, [3, 20],[],4);
0391 <a href="#_sub17" class="code" title="subfunction print_mdl_info(mdl, name)">print_mdl_info</a>(organs.BloodLeftHeart, <span class="string">'BloodLeftHeart'</span>);
0392 
0393 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Meshing right heart'</span>, 2);
0394 right = <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>(@<a href="#_sub11" class="code" title="subfunction right = mk_blood_right_surf(srf)">mk_blood_right_surf</a>,srf);
0395 organs.BloodRightHeart = <a href="../../eidors/meshing/gmsh/gmsh_stl2tet.html" class="code" title="function mdl = gmsh_stl2tet(stlfile, mesh_size, extra, nopt)">gmsh_stl2tet</a>(right, [3, 20],[],4);
0396 <a href="#_sub17" class="code" title="subfunction print_mdl_info(mdl, name)">print_mdl_info</a>(organs.BloodRightHeart, <span class="string">'BloodRightHeart'</span>);
0397 
0398 <a href="../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Meshing heart wall'</span>, 2);
0399 heart = <a href="../../eidors/tools/eidors_cache.html" class="code" title="function varargout=eidors_cache( command, varargin )">eidors_cache</a>(@<a href="#_sub13" class="code" title="subfunction [heart, right, left] = mk_heart_surf(srf)">mk_heart_surf</a>, srf);
0400 organs.HeartWall = <a href="../../eidors/meshing/gmsh/gmsh_stl2tet.html" class="code" title="function mdl = gmsh_stl2tet(stlfile, mesh_size, extra, nopt)">gmsh_stl2tet</a>(heart,[],4);
0401 <a href="#_sub17" class="code" title="subfunction print_mdl_info(mdl, name)">print_mdl_info</a>(organs.HeartWall, <span class="string">'HeartWall'</span>);
0402 
0403 
0404 <a name="_sub11" href="#_subfunctions" class="code">function right = mk_blood_right_surf(srf)</a>
0405 fn = @(x) <a href="#_sub15" class="code" title="subfunction mdl = flip_normals(mdl)">flip_normals</a>(x);
0406 right = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(srf.BloodRight, <span class="keyword">...</span>
0407                      fn(srf.SVC.cap), <span class="keyword">...</span>
0408                      fn(srf.IVC.cap), <span class="keyword">...</span>
0409                      fn(srf.PA.cap));
0410 
0411 
0412 <a name="_sub12" href="#_subfunctions" class="code">function left = mk_blood_left_surf(srf)</a>
0413 fn = @(x) <a href="#_sub15" class="code" title="subfunction mdl = flip_normals(mdl)">flip_normals</a>(x);
0414 left = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(srf.BloodLeft, <span class="keyword">...</span>
0415                     fn(srf.Aorta.cap), <span class="keyword">...</span>
0416                     fn(srf.LSPV.cap), <span class="keyword">...</span>
0417                     fn(srf.LIPV.cap), <span class="keyword">...</span>
0418                     fn(srf.RSPV.cap), <span class="keyword">...</span>
0419                     fn(srf.RIPV.cap), <span class="keyword">...</span>
0420                     1e-2);
0421 
0422 
0423 <a name="_sub13" href="#_subfunctions" class="code">function [heart, right, left] = mk_heart_surf(srf)</a>
0424 right = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(srf.BloodRight, <span class="keyword">...</span>
0425                      srf.SVC.ring, <span class="keyword">...</span>
0426                      srf.IVC.ring, <span class="keyword">...</span>
0427                      srf.PA.ring, <span class="keyword">...</span>
0428                      1e-2);
0429 right = <a href="#_sub15" class="code" title="subfunction mdl = flip_normals(mdl)">flip_normals</a>(right);
0430 
0431 left = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(srf.BloodLeft, <span class="keyword">...</span>
0432                     srf.Aorta.ring, <span class="keyword">...</span>
0433                     srf.LSPV.ring, <span class="keyword">...</span>
0434                     srf.LIPV.ring, <span class="keyword">...</span>
0435                     srf.RSPV.ring, <span class="keyword">...</span>
0436                     srf.RIPV.ring, <span class="keyword">...</span>
0437                     1e-2);
0438 left = <a href="#_sub15" class="code" title="subfunction mdl = flip_normals(mdl)">flip_normals</a>(left);
0439 
0440 heart = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(<a href="#_sub16" class="code" title="subfunction mdl = bd(mdl)">bd</a>(left), <a href="#_sub16" class="code" title="subfunction mdl = bd(mdl)">bd</a>(right), <a href="#_sub16" class="code" title="subfunction mdl = bd(mdl)">bd</a>(srf.HeartShell));
0441 
0442 
0443 <a name="_sub14" href="#_subfunctions" class="code">function [V, B] = mk_vessel(vstruct)</a>
0444 msh = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(vstruct.outer, vstruct.ring, <span class="keyword">...</span>
0445                     <a href="#_sub15" class="code" title="subfunction mdl = flip_normals(mdl)">flip_normals</a>(vstruct.inner),1e-2);
0446 V = <a href="../../eidors/meshing/gmsh/gmsh_stl2tet.html" class="code" title="function mdl = gmsh_stl2tet(stlfile, mesh_size, extra, nopt)">gmsh_stl2tet</a>(msh, 1,[],3); <span class="comment">% max 1 mm edge (vessels are 2 mm thick</span>
0447 msh = <a href="merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>(vstruct.cap, vstruct.inner);
0448 B = <a href="../../eidors/meshing/gmsh/gmsh_stl2tet.html" class="code" title="function mdl = gmsh_stl2tet(stlfile, mesh_size, extra, nopt)">gmsh_stl2tet</a>(msh,[],1);
0449 
0450 
0451 <a name="_sub15" href="#_subfunctions" class="code">function mdl = flip_normals(mdl)</a>
0452 mdl.elems = mdl.elems(:,[1 3 2]);
0453 
0454 
0455 <a name="_sub16" href="#_subfunctions" class="code">function mdl = bd(mdl)</a>
0456 mdl.boundary = mdl.elems;
0457 
0458 
0459 <a name="_sub17" href="#_subfunctions" class="code">function print_mdl_info(mdl, name)</a>
0460 fprintf(<span class="string">'=&gt; %20s: %6d nodes, %7d elems\n'</span>,name, <a href="num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>(mdl), <a href="num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>(mdl));
0461 
0462 
0463 <a name="_sub18" href="#_subfunctions" class="code">function out = get_cache_path</a>
0464 <span class="keyword">global</span> eidors_objects
0465 out = [eidors_objects.model_cache filesep <span class="string">'bp3d-torso'</span>];
0466 <span class="keyword">if</span> ~exist(out, <span class="string">'dir'</span>)
0467    mkdir(out);
0468 <span class="keyword">end</span>
0469 
0470 <a name="_sub19" href="#_subfunctions" class="code">function do_unit_test</a>
0471    torso = <a href="mk_thorax_model_bp3d.html" class="code" title="function out = mk_thorax_model_bp3d(varargin)">mk_thorax_model_bp3d</a>(<span class="string">'2x16_odd-even'</span>,<span class="string">'fine'</span>);
0472    expect = [206.019760131836   45.109825134277   1641.201293945312];
0473    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'extent'</span>,max(torso.fwd_model.nodes), expect,1e-10);
0474    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'#elems'</span>, <a href="num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>(torso), 6894847);
0475    <a href="../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'#nodes'</span>, <a href="num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>(torso), 1193751);</pre></div>
<hr><address>Generated on Sun 29-Dec-2024 19:54:43 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>