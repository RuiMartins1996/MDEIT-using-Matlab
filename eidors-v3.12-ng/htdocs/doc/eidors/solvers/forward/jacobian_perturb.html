<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of jacobian_perturb</title>
  <meta name="keywords" content="jacobian_perturb">
  <meta name="description" content="JACOBIAN_PERTURB: J= jacobian_perturb( fwd_model, img)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">eidors</a> &gt; <a href="../index.html">solvers</a> &gt; <a href="index.html">forward</a> &gt; jacobian_perturb.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/solvers/forward&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>jacobian_perturb
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>JACOBIAN_PERTURB: J= jacobian_perturb( fwd_model, img)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function J= jacobian_perturb( fwd_model, img) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> JACOBIAN_PERTURB: J= jacobian_perturb( fwd_model, img)
 Calculate Jacobian Matrix, based on small perturbations
   in the forward model. This will tend to be slow, but
   should be best used to 'sanity check' other code

 J         = Jacobian matrix
 fwd_model = forward model
 fwd_model.jacobian_perturb.delta   - delta perturbation to use (default 1e-6)
 img = image background for jacobian calc</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/models/data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>	DATA_MAPPER maps img.params data to elem or node data</li><li><a href="../../../eidors/models/mdl_normalize.html" class="code" title="function out = mdl_normalize(mdl, val)">mdl_normalize</a>	MDL_NORMALIZE Check or set the normalize_measurements flag on a model.</li><li><a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="../../../eidors/solvers/calc_jacobian.html" class="code" title="function J = calc_jacobian( fwd_model, img)">calc_jacobian</a>	CALC_JACOBIAN: calculate jacobian from an inv_model</li><li><a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>	CALC_JACOBIAN_BKGND: calculate background image around</li><li><a href="fwd_solve_1st_order.html" class="code" title="function data =fwd_solve_1st_order(fwd_model, img)">fwd_solve_1st_order</a>	FWD_SOLVE_1ST_ORDER: data= fwd_solve_1st_order( img)</li><li><a href="jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>	JACOBIAN_ADJOINT: J= jacobian_adjoint( img )</li><li><a href="jacobian_perturb.html" class="code" title="function J= jacobian_perturb( fwd_model, img)">jacobian_perturb</a>	JACOBIAN_PERTURB: J= jacobian_perturb( fwd_model, img)</li><li><a href="system_mat_1st_order.html" class="code" title="function s_mat= system_mat_1st_order( fwd_model, img)">system_mat_1st_order</a>	SYSTEM_MAT_1ST_ORDER: SS= system_mat_1st_order( fwd_model, img)</li><li><a href="../../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>	FWD_SOLVE: calculate data from a fwd_model object and an image</li><li><a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/deprecated/perturb_jacobian.html" class="code" title="function J= perturb_jacobian( varargin )">perturb_jacobian</a>	PERTURB_JACOBIAN: J= perturb_jacobian( fwd_model, img)</li><li><a href="jacobian_movement_halfspace.html" class="code" title="function J= jacobian_movement_perturb( fwd_model, img)">jacobian_movement_halfspace</a>	JACOBIAN_MOVEMENT_PERTURB: J= jacobian_movement_perturb( img )</li><li><a href="jacobian_movement_perturb.html" class="code" title="function J= jacobian_movement_perturb( fwd_model, img)">jacobian_movement_perturb</a>	JACOBIAN_MOVEMENT_PERTURB: J= jacobian_movement_perturb( img )</li><li><a href="jacobian_perturb.html" class="code" title="function J= jacobian_perturb( fwd_model, img)">jacobian_perturb</a>	JACOBIAN_PERTURB: J= jacobian_perturb( fwd_model, img)</li><li><a href="../../../eidors/tests/test_2d_resistor.html" class="code" title="function test_2d_resistor(opt)">test_2d_resistor</a>	Create 2D model of a cylindrical resistor</li><li><a href="../../../eidors/tests/test_3d_resistor.html" class="code" title="function test_3d_resistor(opt)">test_3d_resistor</a>	Create 3D model of a Rectangular resistor</li><li><a href="../../../eidors/tests/test_c2f_jacobian.html" class="code" title="function test_c2f_jacobian">test_c2f_jacobian</a>	Test calc of jacobian given coarse to fine mapping</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function Jcol= perturb( img, i, delta, d0, curprms)</a></li><li><a href="#_sub2" class="code">function Jcol= perturb_c2f( img, i, delta, d0, curprms)</a></li><li><a href="#_sub3" class="code">function do_unit_test</a></li><li><a href="#_sub4" class="code">function display_jacobian_deltas(img, J);</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function J= jacobian_perturb( fwd_model, img)</a>
0002 <span class="comment">% JACOBIAN_PERTURB: J= jacobian_perturb( fwd_model, img)</span>
0003 <span class="comment">% Calculate Jacobian Matrix, based on small perturbations</span>
0004 <span class="comment">%   in the forward model. This will tend to be slow, but</span>
0005 <span class="comment">%   should be best used to 'sanity check' other code</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% J         = Jacobian matrix</span>
0008 <span class="comment">% fwd_model = forward model</span>
0009 <span class="comment">% fwd_model.jacobian_perturb.delta   - delta perturbation to use (default 1e-6)</span>
0010 <span class="comment">% img = image background for jacobian calc</span>
0011 
0012 <span class="comment">% (C) 2006 Andy Adler. License: GPL version 2 or version 3</span>
0013 <span class="comment">% $Id: jacobian_perturb.m 6721 2024-04-02 18:37:40Z aadler $</span>
0014 
0015 <span class="keyword">if</span> ischar(fwd_model) &amp;&amp; strcmp(fwd_model,<span class="string">'UNIT_TEST'</span>); <a href="#_sub3" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>;<span class="keyword">end</span>
0016 
0017 <span class="keyword">if</span> isfield(fwd_model,<span class="string">'jacobian_perturb'</span>)
0018    delta = fwd_model.jacobian_perturb.delta;
0019 <span class="keyword">else</span>
0020    delta= 1e-6; <span class="comment">% tests indicate this is a good value</span>
0021 <span class="keyword">end</span>
0022 
0023 n_elem = size(fwd_model.elems,1);
0024 <span class="comment">% force image to use provided fwd_model</span>
0025 img.fwd_model= fwd_model;
0026 
0027 jnk = <a href="../../../eidors/models/data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img);
0028 curprms = jnk.current_params;
0029 
0030 <span class="keyword">if</span> strcmp(curprms, <span class="string">'conductivity'</span>) &amp;&amp; ~isfield(img,<span class="string">'conductivity'</span>)
0031    curprms = <span class="string">''</span>;
0032 <span class="keyword">end</span>
0033 <span class="comment">% solve one time to get the size</span>
0034 d0= <a href="../../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>( img );
0035 
0036 <span class="keyword">if</span> isfield(img.fwd_model,<span class="string">'coarse2fine'</span>);
0037    Jcol= <a href="#_sub2" class="code" title="subfunction Jcol= perturb_c2f( img, i, delta, d0, curprms)">perturb_c2f</a>(img, 1, delta, d0, curprms);
0038    Jrows= size(img.fwd_model.coarse2fine,2);
0039    J= zeros(length(Jcol), Jrows );
0040    J(:,1)= Jcol;
0041    <span class="keyword">for</span> i=2:size(img.fwd_model.coarse2fine,2);
0042      J(:,i)= <a href="#_sub2" class="code" title="subfunction Jcol= perturb_c2f( img, i, delta, d0, curprms)">perturb_c2f</a>(img, i, delta, d0, curprms);
0043      <span class="keyword">if</span> rem(i,50)==0; fprintf(<span class="string">'+'</span>); <span class="keyword">end</span>
0044    <span class="keyword">end</span>
0045 <span class="keyword">else</span>
0046    Jcol= <a href="#_sub1" class="code" title="subfunction Jcol= perturb( img, i, delta, d0, curprms)">perturb</a>(img, 1, delta, d0, curprms);
0047 
0048    J= zeros(length(Jcol), n_elem);
0049    J(:,1)= Jcol;
0050 
0051    <span class="keyword">for</span> i=2:n_elem
0052      J(:,i)= <a href="#_sub1" class="code" title="subfunction Jcol= perturb( img, i, delta, d0, curprms)">perturb</a>(img, i, delta, d0, curprms);
0053    <span class="keyword">end</span>
0054 <span class="keyword">end</span>
0055 
0056 
0057 <a name="_sub1" href="#_subfunctions" class="code">function Jcol= perturb( img, i, delta, d0, curprms)</a>
0058    <span class="keyword">if</span> ~isempty(curprms)
0059       img.(curprms).elem_data(i)= img.(curprms).elem_data(i) + delta;
0060    <span class="keyword">else</span>
0061       img.elem_data(i)= img.elem_data(i) + delta;
0062    <span class="keyword">end</span>
0063    di= <a href="../../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>( img );
0064    Jcol = (1/delta) * (di.meas - d0.meas);
0065 
0066 <a name="_sub2" href="#_subfunctions" class="code">function Jcol= perturb_c2f( img, i, delta, d0, curprms)</a>
0067    <span class="keyword">if</span> ~isempty(curprms)
0068       img.(curprms).elem_data= img.(curprms).elem_data + delta*img.fwd_model.coarse2fine(:,i);
0069    <span class="keyword">else</span>
0070        img.elem_data(i)= img.elem_data(i) + delta; <span class="comment">%*img.fwd_model.coarse2fine(:,i);</span>
0071 <span class="comment">%       img.elem_data= img.fwd_model.coarse2fine*img.elem_data + delta*img.fwd_model.coarse2fine(:,i);</span>
0072    <span class="keyword">end</span>
0073    di= <a href="../../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>( img );
0074    Jcol = (1/delta) * (di.meas - d0.meas);
0075 
0076 
0077 <a name="_sub3" href="#_subfunctions" class="code">function do_unit_test</a>
0078 <span class="comment">% Perturbation Jacobians</span>
0079 <span class="comment">% $Id: jacobian_perturb.m 6721 2024-04-02 18:37:40Z aadler $</span>
0080 
0081   models ={<span class="string">'c2c2'</span>,<span class="string">'a3cr'</span>,<span class="string">'n3r2'</span>};
0082   <span class="keyword">for</span> delta = [1e-7,1e-6,1e-5,1e-4];
0083      fprintf(<span class="string">'Using delta = %6.3g\n'</span>,delta);
0084   <span class="keyword">for</span> i = 1:length(models);
0085      Nel = 16; <span class="keyword">if</span> i==3; Nel=[16,2]; <span class="keyword">end</span>
0086      imdl= <a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(models{i},Nel);
0087      imdl.fwd_model.nodes = imdl.fwd_model.nodes*.25;
0088      img= <a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(imdl);
0089 
0090      img.fwd_model = <a href="../../../eidors/models/mdl_normalize.html" class="code" title="function out = mdl_normalize(mdl, val)">mdl_normalize</a>(img.fwd_model, 0);
0091 
0092      img.fwd_model.jacobian=   @<a href="jacobian_adjoint.html" class="code" title="function J= jacobian_adjoint( fwd_model, img)">jacobian_adjoint</a>;
0093      img.fwd_model.system_mat= @<a href="system_mat_1st_order.html" class="code" title="function s_mat= system_mat_1st_order( fwd_model, img)">system_mat_1st_order</a>;
0094      img.fwd_model.solve=      @<a href="fwd_solve_1st_order.html" class="code" title="function data =fwd_solve_1st_order(fwd_model, img)">fwd_solve_1st_order</a>;
0095      J_aa= <a href="../../../eidors/solvers/calc_jacobian.html" class="code" title="function J = calc_jacobian( fwd_model, img)">calc_jacobian</a>( img );
0096 <span class="comment">%    display_jacobian_deltas(img, J_aa) % show perturbation size</span>
0097 
0098      img.fwd_model.jacobian=   @<a href="jacobian_perturb.html" class="code" title="function J= jacobian_perturb( fwd_model, img)">jacobian_perturb</a>;
0099      img.fwd_model.jacobian_perturb.delta = delta;
0100      J_aa_p= <a href="../../../eidors/solvers/calc_jacobian.html" class="code" title="function J = calc_jacobian( fwd_model, img)">calc_jacobian</a>( img );
0101 
0102      <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>([<span class="string">'J_ - J_p:'</span>, img.fwd_model.name] , J_aa, J_aa_p, 1e-4);
0103    <span class="keyword">end</span>
0104    <span class="keyword">end</span>
0105 
0106 
0107 <a name="_sub4" href="#_subfunctions" class="code">function display_jacobian_deltas(img, J);</a>
0108 <span class="comment">% Calculate the perturbation Jacobian</span>
0109   vh= <a href="../../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>(img);
0110 
0111   <span class="keyword">for</span> el= 1:50:size(img.fwd_model.elems,1);
0112      fprintf(<span class="string">'\nelem#%03d: '</span>,el);
0113      <span class="keyword">for</span> delta= [1e-4,1e-6,1e-8] <span class="comment">% delta is perturb</span>
0114         img_i = img;
0115         img_i.elem_data(el)= img_i.elem_data(el) + delta;
0116         vi= <a href="../../../eidors/solvers/fwd_solve.html" class="code" title="function data = fwd_solve(fwd_model, img)">fwd_solve</a>(img_i);
0117         J_p = (vi.meas - vh.meas)/delta; <span class="comment">% perturb Jacobian</span>
0118         fprintf(<span class="string">' %8.6f'</span>, norm(J_p - J(:,el))/norm(J(:,el)));
0119      <span class="keyword">end</span>
0120   <span class="keyword">end</span>
0121</pre></div>
<hr><address>Generated on Sun 29-Dec-2024 19:54:43 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>