<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of show_fem_enhanced</title>
  <meta name="keywords" content="show_fem_enhanced">
  <meta name="description" content="SHOW_FEM_ENHANCED: show the EIDORS3D finite element model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">eidors</a> &gt; <a href="#">graphics</a> &gt; <a href="index.html">matlab</a> &gt; show_fem_enhanced.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/graphics/matlab&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>show_fem_enhanced
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>SHOW_FEM_ENHANCED: show the EIDORS3D finite element model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function hh = show_fem_enhanced(mdl, options) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> SHOW_FEM_ENHANCED: show the EIDORS3D finite element model
 hh = show_fem(mdl, options)
 mdl is an EIDORS3D 'model' or 'image' structure
 hh = handle to the plotted model

 SHOW_FEM_ENHANCED('refresh') repaints the figure in current axis orientation 
   (only works if options.edge.significant.viewpoint_dependent.callback 
   is true)

 options may be specified by a list (for compatibility purposes)
 options may also be specified as
  fwd_model.show_fem_enhanced.field = value

 options specifies a set of options
   options(1) =&gt; show colourbar
   options(2) =&gt; show numbering on electrodes
   options(3) =&gt; number elements (==1) or nodes (==2);

 for detailed control of colours, use the following fields (default values
 are indicated in parenthesis)

     options.viewpoint.az (-37.5)
     options.viewpoint.el (30.0)

     options.body.triangle_alpha = 0.5 % transparency in body
 
     options.edge.color ([0 0 0])
     options.edge.width (0.5) =&gt; 0 means don't show edge
     options.edge.significant.show (true)
     options.edge.significant.color ([0 0 0])
     options.edge.significant.width (2)
     options.edge.significant.angle (45)
     options.edge.significant.viewpoint_dependent.show (true)
     options.edge.significant.viewpoint_dependent.color ([0 0 0])
     options.edge.significant.viewpoint_dependent.width (2)
     options.edge.significant.viewpoint_dependent.callback (true)
  
     options.colorbar.show (false)
 
     options.electrode.number.show (false)
     options.electrode.number.font_size (10)
     options.electrode.number.font_weight ('bold')
     options.electrode.number.color ([.6 0 0])
     options.electrode.number.background_color ('none')
     options.electrode.number.scale_position (1.15)
 
     options.element.number.show (false)
     options.element.number.font_size (7)
     options.element.number.font_weight ('normal')
     options.element.number.color ([0 0 0])
     options.element.number.background_color ('none')

     options.node.number.show (false)
     options.node.number.font_size (7)
     options.node.number.font_weight ('normal')
     options.node.number.color ([0 0 0.5])
     options.node.number.background_color ([1 1 1])

 EXAMPLES
   mdl = mk_common_model('c2C2',8);
   img = mk_image(mdl, linspace(-3,3,num_elems(mdl)));
   
 SET PARAMETERS
   img.show_fem.electrode.number.scale_position= 1.01;
   img.show_fem.electrode.number.show =1;
   show_fem(img)

 SET OPTIONS
   opts.colorbar.show = 1;
   show_fem(img.opts)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG eidors progress and status messages</li><li><a href="../../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>	EIDORS_OBJ: maintains EIDORS internals</li><li><a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>	[colours,scl_data]= calc_colours(img, set_value, do_colourbar)</li><li><a href="eidors_colourbar.html" class="code" title="function hh= eidors_colourbar(max_scale,ref_lev, cb_shrink_move, greyscale)">eidors_colourbar</a>	EIDORS_COLOURBAR - create an eidors colourbar with scaling to image</li><li><a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>	SHOW_FEM_ENHANCED: show the EIDORS3D finite element model</li><li><a href="../../../eidors/models/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>	INTERP_MESH: calculate interpolation points onto mdl elements</li><li><a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>	MDL_DIM: dimension of model space (are nodes in 2D or 3D space)</li><li><a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="../../../eidors/models/num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>	NUM_ELEMS: number of elemnts in a (fwd or inv model or image)</li><li><a href="../../../eidors/models/num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>	NUM_NODES: number of elemnts in a (fwd or inv model or image)</li><li><a href="../../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>	SPARSE Create sparse matrix (EIDORS overload for Matlab < R2020a / 9.8).</li><li><a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>	CALC_JACOBIAN_BKGND: calculate background image around</li><li><a href="../../../eidors/solvers/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>	GET_IMG_DATA: get parameter data from eidors image object</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>	SHOW_FEM_ENHANCED: show the EIDORS3D finite element model</li><li><a href="../../../eidors/meshing/netgen/ng_mk_geometric_models.html" class="code" title="function [fmdl, mat_idx] = ng_mk_geometric_models(body_geometry, electrode_geometry)">ng_mk_geometric_models</a>	NG_MK_GEOMETRIC_MODELS: create geometric mesh models using Netgen. Body</li><li><a href="../../../eidors/models/elec_rearrange.html" class="code" title="function [elec_idx, new_fmdl] = elec_rearrange( pattern, newarrange, fwd_model )">elec_rearrange</a>	ELEC_REARRANGE: rearrange electrodes for given pattern</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [img, mdl, opts] = proc_params(mdl, src_opts)</a></li><li><a href="#_sub2" class="code">function refresh_current_axis(obj, evd)</a></li><li><a href="#_sub3" class="code">function hh = draw_all(img, mdl, opts)</a></li><li><a href="#_sub4" class="code">function hh = draw_fem(img, mdl, opts)</a></li><li><a href="#_sub5" class="code">function hh = draw_numbers(positions, opts)</a></li><li><a href="#_sub6" class="code">function hh = draw_markers(points, colour, marker_size)</a></li><li><a href="#_sub7" class="code">function hh = draw_edges(edges, vertices, width_data, color_data)</a></li><li><a href="#_sub8" class="code">function hh = draw_triangles(faces, vertices, color_data, alpha_data,</a></li><li><a href="#_sub9" class="code">function colour = electr_colour(elec, e, colormap_width)</a></li><li><a href="#_sub10" class="code">function mdl = find_sub_elements(mdl)</a></li><li><a href="#_sub11" class="code">function dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)</a></li><li><a href="#_sub12" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function hh = show_fem_enhanced(mdl, options)</a>
0002 <span class="comment">% SHOW_FEM_ENHANCED: show the EIDORS3D finite element model</span>
0003 <span class="comment">% hh = show_fem(mdl, options)</span>
0004 <span class="comment">% mdl is an EIDORS3D 'model' or 'image' structure</span>
0005 <span class="comment">% hh = handle to the plotted model</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% SHOW_FEM_ENHANCED('refresh') repaints the figure in current axis orientation</span>
0008 <span class="comment">%   (only works if options.edge.significant.viewpoint_dependent.callback</span>
0009 <span class="comment">%   is true)</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% options may be specified by a list (for compatibility purposes)</span>
0012 <span class="comment">% options may also be specified as</span>
0013 <span class="comment">%  fwd_model.show_fem_enhanced.field = value</span>
0014 <span class="comment">%</span>
0015 <span class="comment">% options specifies a set of options</span>
0016 <span class="comment">%   options(1) =&gt; show colourbar</span>
0017 <span class="comment">%   options(2) =&gt; show numbering on electrodes</span>
0018 <span class="comment">%   options(3) =&gt; number elements (==1) or nodes (==2);</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% for detailed control of colours, use the following fields (default values</span>
0021 <span class="comment">% are indicated in parenthesis)</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%     options.viewpoint.az (-37.5)</span>
0024 <span class="comment">%     options.viewpoint.el (30.0)</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%     options.body.triangle_alpha = 0.5 % transparency in body</span>
0027 <span class="comment">%</span>
0028 <span class="comment">%     options.edge.color ([0 0 0])</span>
0029 <span class="comment">%     options.edge.width (0.5) =&gt; 0 means don't show edge</span>
0030 <span class="comment">%     options.edge.significant.show (true)</span>
0031 <span class="comment">%     options.edge.significant.color ([0 0 0])</span>
0032 <span class="comment">%     options.edge.significant.width (2)</span>
0033 <span class="comment">%     options.edge.significant.angle (45)</span>
0034 <span class="comment">%     options.edge.significant.viewpoint_dependent.show (true)</span>
0035 <span class="comment">%     options.edge.significant.viewpoint_dependent.color ([0 0 0])</span>
0036 <span class="comment">%     options.edge.significant.viewpoint_dependent.width (2)</span>
0037 <span class="comment">%     options.edge.significant.viewpoint_dependent.callback (true)</span>
0038 <span class="comment">%</span>
0039 <span class="comment">%     options.colorbar.show (false)</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%     options.electrode.number.show (false)</span>
0042 <span class="comment">%     options.electrode.number.font_size (10)</span>
0043 <span class="comment">%     options.electrode.number.font_weight ('bold')</span>
0044 <span class="comment">%     options.electrode.number.color ([.6 0 0])</span>
0045 <span class="comment">%     options.electrode.number.background_color ('none')</span>
0046 <span class="comment">%     options.electrode.number.scale_position (1.15)</span>
0047 <span class="comment">%</span>
0048 <span class="comment">%     options.element.number.show (false)</span>
0049 <span class="comment">%     options.element.number.font_size (7)</span>
0050 <span class="comment">%     options.element.number.font_weight ('normal')</span>
0051 <span class="comment">%     options.element.number.color ([0 0 0])</span>
0052 <span class="comment">%     options.element.number.background_color ('none')</span>
0053 <span class="comment">%</span>
0054 <span class="comment">%     options.node.number.show (false)</span>
0055 <span class="comment">%     options.node.number.font_size (7)</span>
0056 <span class="comment">%     options.node.number.font_weight ('normal')</span>
0057 <span class="comment">%     options.node.number.color ([0 0 0.5])</span>
0058 <span class="comment">%     options.node.number.background_color ([1 1 1])</span>
0059 <span class="comment">%</span>
0060 <span class="comment">% EXAMPLES</span>
0061 <span class="comment">%   mdl = mk_common_model('c2C2',8);</span>
0062 <span class="comment">%   img = mk_image(mdl, linspace(-3,3,num_elems(mdl)));</span>
0063 <span class="comment">%</span>
0064 <span class="comment">% SET PARAMETERS</span>
0065 <span class="comment">%   img.show_fem.electrode.number.scale_position= 1.01;</span>
0066 <span class="comment">%   img.show_fem.electrode.number.show =1;</span>
0067 <span class="comment">%   show_fem(img)</span>
0068 <span class="comment">%</span>
0069 <span class="comment">% SET OPTIONS</span>
0070 <span class="comment">%   opts.colorbar.show = 1;</span>
0071 <span class="comment">%   show_fem(img.opts)</span>
0072 
0073 <span class="comment">% (C) 2015 Herve Gagnon. License: GPL version 2 or version 3</span>
0074 <span class="comment">% $Id: show_fem_enhanced.m 6974 2024-10-29 19:43:09Z aadler $</span>
0075 
0076 <span class="comment">% TESTS</span>
0077 <span class="keyword">switch</span> nargin
0078     <span class="keyword">case</span> 0
0079         error(<span class="string">'Insufficient parameters for show_fem'</span>);
0080     <span class="keyword">case</span> 1
0081         <span class="keyword">if</span> ischar(mdl) &amp;&amp; strcmp(mdl,<span class="string">'UNIT_TEST'</span>)
0082             <a href="#_sub12" class="code" title="subfunction do_unit_test">do_unit_test</a>; 
0083             <span class="keyword">return</span>; 
0084         <span class="keyword">end</span>
0085         <span class="keyword">if</span> ischar(mdl) &amp;&amp; strcmp(mdl,<span class="string">'refresh'</span>)
0086             <a href="#_sub2" class="code" title="subfunction refresh_current_axis(obj, evd)">refresh_current_axis</a>; 
0087             <span class="keyword">return</span>; 
0088         <span class="keyword">end</span>
0089         options = [];
0090         <span class="comment">% overwrite options from field, if it exists</span>
0091         <span class="keyword">try</span> options = <span class="keyword">...</span>
0092             mdl.show_fem;
0093         <span class="keyword">end</span>
0094         <span class="keyword">try</span> options = <span class="keyword">...</span>
0095             mdl.show_fem_enhanced;
0096         <span class="keyword">end</span>
0097         <span class="keyword">try</span> options = <span class="keyword">...</span>
0098             mdl.fwd_model.show_fem;
0099         <span class="keyword">end</span>
0100         <span class="keyword">try</span> options = <span class="keyword">...</span>
0101             mdl.fwd_model.show_fem_enhanced;
0102         <span class="keyword">end</span>
0103     <span class="keyword">case</span> 2
0104         <span class="comment">% No special processing</span>
0105     <span class="keyword">otherwise</span>
0106         error(<span class="string">'Too many parameters for show_fem'</span>);
0107 <span class="keyword">end</span>
0108 
0109 [img, mdl, opts] = <a href="#_sub1" class="code" title="subfunction [img, mdl, opts] = proc_params(mdl, src_opts)">proc_params</a>(mdl, options);
0110 
0111 <span class="keyword">if</span> ~ishold
0112     cla;
0113 <span class="keyword">end</span>
0114 
0115 mdl = <a href="#_sub10" class="code" title="subfunction mdl = find_sub_elements(mdl)">find_sub_elements</a>(mdl);
0116 
0117 <span class="comment">% Convert nodes to 3D if necessary.</span>
0118 mdl.nodes = mdl.nodes*eye(size(mdl.nodes, 2), 3);
0119 
0120 hh = <a href="#_sub3" class="code" title="subfunction hh = draw_all(img, mdl, opts)">draw_all</a>(img, mdl, opts);
0121 
0122 <span class="comment">% Setup callback function.</span>
0123 <span class="keyword">if</span> (opts.edge.significant.viewpoint_dependent.callback)
0124     <span class="keyword">if</span> ~exist(<span class="string">'OCTAVE_VERSION'</span>); <span class="comment">%octave's not compativble (4.4.1)</span>
0125     h3d = rotate3d;
0126     set(gca, <span class="string">'UserData'</span>, struct(<span class="string">'name'</span>, <span class="string">'show_fem_data'</span>, <span class="string">'img'</span>, img, <span class="string">'mdl'</span>, mdl, <span class="string">'opts'</span>, opts, <span class="string">'handles'</span>, hh));
0127     set(h3d, <span class="string">'ActionPostCallback'</span> , @<a href="#_sub2" class="code" title="subfunction refresh_current_axis(obj, evd)">refresh_current_axis</a>)
0128     <span class="keyword">end</span>
0129 <span class="keyword">end</span>
0130 
0131 <span class="keyword">if</span> (nargout == 0)
0132     clear hh; 
0133 <span class="keyword">end</span>
0134 
0135 <a name="_sub1" href="#_subfunctions" class="code">function [img, mdl, opts] = proc_params(mdl, src_opts)</a>
0136 
0137     <span class="comment">% Assign default viewpoint option values.</span>
0138     opts.viewpoint.az = -37.5;
0139     opts.viewpoint.el =  30.0;
0140 
0141     opts.body.triangle_alpha = 0.5;
0142  
0143     <span class="comment">% Assign default edge option values.</span>
0144     opts.edge.color   = [0 0 0];
0145     opts.edge.width   = 0.5;
0146     opts.edge.significant.show  = true;
0147     opts.edge.significant.color = [0 0 0];
0148     opts.edge.significant.width = 2;
0149     opts.edge.significant.angle = 45;
0150     opts.edge.significant.viewpoint_dependent.show     = true;
0151     opts.edge.significant.viewpoint_dependent.color    = [0 0 0];
0152     opts.edge.significant.viewpoint_dependent.width    = 2;
0153     opts.edge.significant.viewpoint_dependent.callback = true;
0154  
0155     <span class="comment">% Assign default colorbar option values.</span>
0156     opts.colorbar.show = false;
0157 
0158     <span class="comment">% Assign default electrode option values.</span>
0159     opts.electrode.number.show             = false;
0160     opts.electrode.number.font_size        = 10;
0161     opts.electrode.number.font_weight      = <span class="string">'bold'</span>;
0162     opts.electrode.number.color            = [.6 0 0];
0163     opts.electrode.number.background_color = <span class="string">'none'</span>;
0164     opts.electrode.number.scale_position   = 1.15;
0165 
0166     <span class="comment">% Assign default element option values.</span>
0167     opts.element.number.show             = false;
0168     opts.element.number.font_size        = 7;
0169     opts.element.number.font_weight      = <span class="string">'normal'</span>;
0170     opts.element.number.color            = [0 0 0];
0171     opts.element.number.background_color = <span class="string">'none'</span>;
0172 
0173     <span class="comment">% Assign default node option values.</span>
0174     opts.node.number.show             = false;
0175     opts.node.number.font_size        = 7;
0176     opts.node.number.font_weight      = <span class="string">'normal'</span>;
0177     opts.node.number.color            = [0 0 0.5];
0178     opts.node.number.background_color = [1 1 1];
0179 
0180     <span class="comment">% Override some defaults in 2D</span>
0181     <span class="keyword">if</span> <a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>( mdl ) == 2
0182        opts.viewpoint.az = 0;
0183        opts.viewpoint.el = 90;
0184        opts.electrode.number.scale_position= 1.05;
0185     <span class="keyword">end</span>
0186     
0187     <span class="keyword">if</span> (nargin == 2)
0188         <span class="keyword">if</span> (isstruct(src_opts))
0189             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'viewpoint'</span>, <span class="string">'az'</span>);
0190             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'viewpoint'</span>, <span class="string">'el'</span>);
0191             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'edge'</span>, <span class="string">'color'</span>);
0192             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'edge'</span>, <span class="string">'width'</span>);
0193             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'body'</span>, <span class="string">'triangle_alpha'</span>);
0194             
0195             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'body'</span>))
0196             <span class="keyword">end</span>
0197 
0198             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'edge'</span>))
0199                 opts.edge = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge, src_opts.edge, <span class="string">'significant'</span>, <span class="string">'show'</span>);
0200                 opts.edge = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge, src_opts.edge, <span class="string">'significant'</span>, <span class="string">'color'</span>);
0201                 opts.edge = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge, src_opts.edge, <span class="string">'significant'</span>, <span class="string">'width'</span>);
0202                 opts.edge = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge, src_opts.edge, <span class="string">'significant'</span>, <span class="string">'angle'</span>);
0203                 <span class="keyword">if</span> (isfield(src_opts.edge, <span class="string">'significant'</span>))
0204                     opts.edge.significant = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge.significant, src_opts.edge.significant, <span class="string">'viewpoint_dependent'</span>, <span class="string">'show'</span>);
0205                     opts.edge.significant = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge.significant, src_opts.edge.significant, <span class="string">'viewpoint_dependent'</span>, <span class="string">'color'</span>);
0206                     opts.edge.significant = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge.significant, src_opts.edge.significant, <span class="string">'viewpoint_dependent'</span>, <span class="string">'width'</span>);
0207                     opts.edge.significant = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.edge.significant, src_opts.edge.significant, <span class="string">'viewpoint_dependent'</span>, <span class="string">'callback'</span>);
0208                 <span class="keyword">end</span>
0209             <span class="keyword">end</span>
0210 
0211             opts = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts, src_opts, <span class="string">'colorbar'</span>, <span class="string">'show'</span>);
0212 
0213             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'electrode'</span>))
0214                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'show'</span>);
0215                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'font_size'</span>);
0216                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'font_weight'</span>);
0217                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'color'</span>);
0218                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'background_color'</span>);
0219                 opts.electrode = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.electrode, src_opts.electrode, <span class="string">'number'</span>, <span class="string">'scale_position'</span>);                
0220             <span class="keyword">end</span>
0221             
0222             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'element'</span>))
0223                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'show'</span>);
0224                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'font_size'</span>);
0225                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'font_weight'</span>);
0226                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'color'</span>);
0227                 opts.element = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.element, src_opts.element, <span class="string">'number'</span>, <span class="string">'background_color'</span>);               
0228             <span class="keyword">end</span>
0229 
0230             <span class="keyword">if</span> (isfield(src_opts, <span class="string">'node'</span>))
0231                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'show'</span>);
0232                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'font_size'</span>);
0233                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'font_weight'</span>);
0234                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'color'</span>);
0235                 opts.node = <a href="#_sub11" class="code" title="subfunction dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)">copy_field</a>(opts.node, src_opts.node, <span class="string">'number'</span>, <span class="string">'background_color'</span>);               
0236             <span class="keyword">end</span>
0237             
0238             
0239         <span class="keyword">else</span> <span class="comment">% Support options from old version of show_fem for compatibility.</span>
0240             <span class="comment">% fill in default options</span>
0241             optionstr = zeros(1, 100);
0242             optionstr(1:length(src_opts)) = src_opts;
0243 
0244             opts.colorbar.show         = optionstr(1);
0245             opts.electrode.number.show = optionstr(2);
0246             <span class="keyword">switch</span> optionstr(3)
0247                 <span class="keyword">case</span> 1
0248                     opts.element.number.show = 1;
0249                 <span class="keyword">case</span> 2
0250                     opts.node.number.show = 1;
0251                 <span class="keyword">case</span> 3
0252                     opts.element.number.show = 1;
0253                     opts.node.number.show = 1;
0254             <span class="keyword">end</span>
0255         <span class="keyword">end</span>
0256     <span class="keyword">end</span>
0257 
0258     <span class="comment">% Display first image if several images are available.</span>
0259     <span class="keyword">if</span> (numel(mdl) &gt; 1)
0260         <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: show_fem only shows first image'</span>,1);
0261         mdl = mdl(1);
0262     <span class="keyword">end</span>
0263  
0264     <span class="comment">% if we have an img input, define mdl</span>
0265     <span class="keyword">if</span> strcmp(mdl(1).type , <span class="string">'image'</span> )
0266         img = mdl;
0267         mdl = img.fwd_model;
0268     <span class="keyword">else</span>
0269         img = [];
0270     <span class="keyword">end</span>
0271 
0272 <a name="_sub2" href="#_subfunctions" class="code">function refresh_current_axis(obj, evd)</a>
0273 UserData = get(gca, <span class="string">'UserData'</span>);
0274 <span class="keyword">if</span> (all(isfield(UserData, {<span class="string">'name'</span>, <span class="string">'img'</span>, <span class="string">'mdl'</span>, <span class="string">'opts'</span>})) &amp;&amp; <span class="keyword">...</span>
0275         strcmp(UserData.name, <span class="string">'show_fem_data'</span>))
0276     [az, el] = view(gca);
0277     <span class="keyword">if</span> (az ~= UserData.opts.viewpoint.az || el ~= UserData.opts.viewpoint.el)
0278         UserData.opts.viewpoint.az = az;
0279         UserData.opts.viewpoint.el = el;
0280         delete(UserData.handles);
0281         UserData.handles = <a href="#_sub3" class="code" title="subfunction hh = draw_all(img, mdl, opts)">draw_all</a>(UserData.img, UserData.mdl, UserData.opts);
0282         set(gca, <span class="string">'UserData'</span>, UserData);
0283     <span class="keyword">end</span>
0284 <span class="keyword">end</span>
0285 
0286 <a name="_sub3" href="#_subfunctions" class="code">function hh = draw_all(img, mdl, opts)</a>
0287 
0288     hh = <a href="#_sub4" class="code" title="subfunction hh = draw_fem(img, mdl, opts)">draw_fem</a>(img, mdl, opts);
0289 
0290     <span class="comment">% Number elements if necessary.</span>
0291     <span class="keyword">if</span> (opts.element.number.show)
0292         h= <a href="#_sub5" class="code" title="subfunction hh = draw_numbers(positions, opts)">draw_numbers</a>(<a href="../../../eidors/models/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>(mdl), opts.element.number);
0293         hh = [hh; h];
0294     <span class="keyword">end</span>
0295 
0296     <span class="comment">% Number nodes if necessary.</span>
0297     <span class="keyword">if</span> (opts.node.number.show)
0298         h = <a href="#_sub5" class="code" title="subfunction hh = draw_numbers(positions, opts)">draw_numbers</a>(mdl.nodes, opts.node.number);
0299         hh = [hh; h];
0300     <span class="keyword">end</span>
0301 
0302     <span class="comment">% Number electrodes if necessary.</span>
0303     <span class="keyword">if</span> (opts.electrode.number.show &amp;&amp; isfield(mdl, <span class="string">'electrode'</span>))
0304         n_elec = numel(mdl.electrode);
0305         mesh_center = ones(n_elec, 1)*mean(mdl.nodes, 1);
0306 
0307         elec_pos = zeros(n_elec, size(mesh_center, 2));
0308 
0309         <span class="keyword">for</span> i = 1:n_elec
0310             <span class="keyword">if</span> (isfield(mdl.electrode(i), <span class="string">'nodes'</span>))
0311                 elec_pos(i, :) = mean(mdl.nodes(mdl.electrode(i).nodes, :), 1);
0312             <span class="keyword">elseif</span> (isfield(mdl.electrode(i), <span class="string">'pos'</span>))
0313                 elec_pos(i, :) = mean(mdl.electrode(i).pos, 1)*eye(size(<span class="keyword">...</span>
0314                                                         elec_pos(i, :), 2), 3);
0315             <span class="keyword">end</span>
0316         <span class="keyword">end</span>
0317 
0318         <a href="#_sub5" class="code" title="subfunction hh = draw_numbers(positions, opts)">draw_numbers</a>(opts.electrode.number.scale_position*(elec_pos - mesh_center) + mesh_center, opts.electrode.number);
0319     <span class="keyword">end</span>
0320 
0321     <span class="keyword">if</span> (size(mdl.elems, 2) == 4)  
0322         view(opts.viewpoint.az, opts.viewpoint.el);
0323     <span class="keyword">end</span>
0324 
0325     axis image;
0326     
0327 <a name="_sub4" href="#_subfunctions" class="code">function hh = draw_fem(img, mdl, opts)</a>
0328     
0329     <span class="comment">% Assign colors and alpha to elements.</span>
0330     <span class="keyword">if</span> (size(mdl.elems, 2) == 4)
0331         <span class="keyword">if</span> ~isempty(img)
0332             elems = mdl.sub_elements;
0333             electrode_field = <span class="string">'sub_elements'</span>;
0334         <span class="keyword">else</span>
0335             elems = mdl.boundary;
0336             electrode_field = <span class="string">'boundary'</span>;
0337         <span class="keyword">end</span>
0338 
0339         alpha_level = opts.body.triangle_alpha;
0340         triangle_alpha = alpha_level*ones(size(elems, 1), 1);
0341         triangle_edge_color = <span class="string">'none'</span>;
0342         triangle_edge_width = 0.5;
0343         
0344         <span class="comment">% Color mesh edges.</span>
0345         edge_edges = mdl.boundary_edges;
0346         edge_width = ones(size(edge_edges, 1), 1)*opts.edge.width;
0347         edge_color = ones(size(edge_edges, 1), 1)*opts.edge.color;
0348         
0349         <span class="keyword">if</span> opts.edge.significant.show
0350             <span class="keyword">if</span> opts.edge.significant.viewpoint_dependent.show 
0351                 <span class="keyword">if</span> exist(<span class="string">'viewmtx'</span>)
0352                 <span class="comment">% Highlight profile of boundary according to viewing angle.</span>
0353                 T = viewmtx(opts.viewpoint.az, opts.viewpoint.el);
0354                 <span class="keyword">else</span> <span class="comment">% octave doesn't have viewmtx yet</span>
0355                 T = ones(4);
0356                 <span class="keyword">end</span>
0357                 transformed_boundary_normal_vector = mdl.boundary_normal_vector*T(1:3,1:3)';
0358                 boundary_edges_idx2 = (transformed_boundary_normal_vector(mdl.edge2boundary(:, 1), 3).*transformed_boundary_normal_vector(mdl.edge2boundary(:, 2), 3) &lt;= 0);
0359 
0360                 edge_width(boundary_edges_idx2)    = opts.edge.significant.viewpoint_dependent.width;
0361                 edge_color(boundary_edges_idx2, :) = ones(sum(boundary_edges_idx2), 1)*opts.edge.significant.viewpoint_dependent.color;
0362             <span class="keyword">end</span>
0363 
0364             <span class="comment">% Highlight significant edges where boundary shape bends more than</span>
0365             <span class="comment">% 45 degrees.</span>
0366             boundary_edges_idx = dot(mdl.boundary_normal_vector(<span class="keyword">...</span>
0367                                      mdl.edge2boundary(:, 1), :), <span class="keyword">...</span>
0368                                      mdl.boundary_normal_vector(<span class="keyword">...</span>
0369                                      mdl.edge2boundary(:, 2), :), 2) <span class="keyword">...</span>
0370                                      &lt;= cosd(opts.edge.significant.angle);
0371             edge_width(boundary_edges_idx)    = opts.edge.significant.width;
0372             edge_color(boundary_edges_idx, :) = ones(sum(boundary_edges_idx), 1)*opts.edge.significant.color;
0373         <span class="keyword">end</span>
0374     <span class="keyword">else</span>
0375         elems = mdl.elems;
0376         electrode_field = <span class="string">'boundary'</span>;
0377         triangle_alpha = ones(size(elems, 1), 1);
0378         triangle_edge_color = opts.edge.color;
0379         triangle_edge_width = opts.edge.width;
0380         
0381         <span class="comment">% Highlight mesh boundary.</span>
0382         <span class="keyword">if</span> opts.edge.significant.show
0383             edge_edges = mdl.boundary;
0384             edge_width = opts.edge.significant.width*ones(size(edge_edges, 1), 1);
0385             edge_color = ones(size(edge_edges, 1), 1)*opts.edge.significant.color;
0386         <span class="keyword">else</span>
0387             edge_edges = [];
0388         <span class="keyword">end</span>
0389     <span class="keyword">end</span>
0390     
0391     <span class="keyword">if</span> ~isempty(img)
0392         <span class="keyword">if</span> (size(mdl.elems, 2) == 4) 
0393             img_data = <a href="../../../eidors/solvers/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>(img);
0394             <span class="keyword">if</span> size(img_data,1) == size(mdl.elems,1)
0395                 triangle_color = <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(mdl.element2sub_element*<span class="keyword">...</span>
0396                                     img_data, img);
0397             <span class="keyword">elseif</span> size(img_data,1) == size(mdl.nodes,1)
0398                 triangle_color = <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img_data, img);
0399             <span class="keyword">else</span>
0400                 error(<span class="string">'wrong size of data'</span>);
0401             <span class="keyword">end</span>
0402 
0403             factor = 3/8;
0404             
0405             alpha_map = zeros(size(colormap, 1), 1);
0406             alpha = linspace(0, 1, round(size(colormap, 1)*factor))';
0407             alpha_map(1:size(alpha, 1)) = alpha(end:-1:1);
0408             alpha_map(end:-1:(end-size(alpha, 1)+1)) = alpha(end:-1:1);
0409             
0410             factor = 3/8;
0411             alpha_map2 = ones(size(colormap, 1), 1);
0412             alpha2 = linspace(0, 1, round(size(colormap, 1)*factor))';
0413             alpha_map2((1:size(alpha2, 1)) + size(colormap, 1)/2) = alpha2;
0414             alpha_map2((end:-1:(end-size(alpha2, 1)+1)) - size(colormap, 1)/2) = alpha2;
0415             
0416             factor = 3/8;
0417             alpha_map3 = ones(size(colormap, 1), 1);
0418             alpha3 = linspace(0, 1, round(size(colormap, 1)*factor))';
0419             idx1 = (size(colormap, 1)/2 - size(alpha3, 1))/2;
0420             alpha_map3((-idx1:idx1) + size(colormap, 1)/2) = 0;
0421             alpha_map3((1:size(alpha3, 1)) + size(colormap, 1)/2 + (size(colormap, 1)/2 - size(alpha3, 1))/2) = alpha3;
0422             alpha_map3((end:-1:(end-size(alpha3, 1)+1)) - size(colormap, 1)/2 - (size(colormap, 1)/2 - size(alpha3, 1))/2) = alpha3;
0423     
0424             triangle_alpha = alpha_map3(triangle_color);
0425             
0426             <span class="comment">% Restore transparency for boundary elements;</span>
0427             alpha_level = opts.body.triangle_alpha;
0428             <span class="keyword">if</span> size(img_data,1) == size(mdl.elems,1)
0429                 alpha_idx =  triangle_alpha(mdl.boundary_to_sub_element_idx, :) &lt; alpha_level;
0430                 triangle_alpha(mdl.boundary_to_sub_element_idx(alpha_idx), :) = alpha_level;
0431             <span class="keyword">else</span>
0432                 alpha_idx = triangle_alpha(mdl.boundary_node_idx, :) &lt; alpha_level;
0433                 triangle_alpha(mdl.boundary_node_idx(alpha_idx), :) = alpha_level;
0434             <span class="keyword">end</span>
0435         <span class="keyword">else</span>
0436             triangle_color = <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img);
0437         <span class="keyword">end</span>
0438         triangle_color = squeeze(triangle_color(:, 1, :));
0439     <span class="keyword">else</span>
0440         triangle_color = ones(size(elems, 1), 1)*[1 1 1];
0441     <span class="keyword">end</span>
0442     
0443     <span class="comment">% Assign colors for electrodes.</span>
0444     marker_position = [];
0445     marker_color    = [];
0446     
0447     <span class="keyword">if</span> (isfield(mdl, <span class="string">'electrode'</span>))
0448         <span class="keyword">for</span> i = 1:numel(mdl.electrode)
0449             <span class="keyword">if</span> (isfield(mdl.electrode(i), electrode_field) &amp;&amp; <span class="keyword">...</span>
0450                     ~isempty(mdl.electrode(i).(electrode_field)))
0451                 
0452                 <span class="keyword">if</span> (size(mdl.elems, 2) == 4)
0453                     triangle_color(<span class="keyword">...</span>
0454                         mdl.electrode(i).(electrode_field), :) = <span class="keyword">...</span>
0455                         ones(numel(mdl.electrode(i).(electrode_field)), <span class="keyword">...</span>
0456                         1)*<a href="#_sub9" class="code" title="subfunction colour = electr_colour(elec, e, colormap_width)">electr_colour</a>(mdl.electrode(i),i, size(triangle_color, 2));
0457 
0458                     triangle_alpha(mdl.electrode(i).(electrode_field), <span class="keyword">...</span>
0459                                                                     :) = 1;
0460                     <span class="comment">% Highlight electrode edges.</span>
0461                     boundary_edges = [mdl.electrode(i).boundary_inner_edges;
0462                                       mdl.electrode(i).boundary_outer_edges];
0463                     edge_color(boundary_edges, :) = 0.5*ones(size(<span class="keyword">...</span>
0464                         boundary_edges, 1), 1)*<a href="#_sub9" class="code" title="subfunction colour = electr_colour(elec, e, colormap_width)">electr_colour</a>(mdl.electrode(i), i, 3);
0465                     edge_width(mdl.electrode(i).boundary_outer_edges) = 1;
0466                 <span class="keyword">else</span>
0467 
0468                     edge_width(mdl.electrode(i).(electrode_field), :) = 3;
0469                     edge_color(mdl.electrode(i).(electrode_field), :) = <span class="keyword">...</span>
0470                         ones(numel(mdl.electrode(i).(electrode_field)), <span class="keyword">...</span>
0471                         1)*<a href="#_sub9" class="code" title="subfunction colour = electr_colour(elec, e, colormap_width)">electr_colour</a>(mdl.electrode(i),i, 3);
0472                 <span class="keyword">end</span>
0473             <span class="keyword">else</span>
0474                 <span class="keyword">if</span> (isfield(mdl.electrode(i), <span class="string">'nodes'</span>))
0475                     marker_position(end + 1, :) = mean(mdl.nodes(<span class="keyword">...</span>
0476                                             mdl.electrode(i).nodes, :), 1);
0477                 <span class="keyword">elseif</span> (isfield(mdl.electrode(i), <span class="string">'pos'</span>))
0478                     marker_position(end + 1, :) = mean(<span class="keyword">...</span>
0479                                                mdl.electrode(i).pos, 1)*<span class="keyword">...</span>
0480                                   eye(size(marker_position(<span class="keyword">end</span>, :), 2), 3);
0481                 <span class="keyword">end</span>
0482                 marker_color(end + 1, :) = <a href="#_sub9" class="code" title="subfunction colour = electr_colour(elec, e, colormap_width)">electr_colour</a>(mdl.electrode(i), i, 3);
0483             <span class="keyword">end</span>
0484         <span class="keyword">end</span>
0485     <span class="keyword">end</span>
0486 
0487     <span class="comment">% Draw triangles</span>
0488     hh = <a href="#_sub8" class="code" title="subfunction hh = draw_triangles(faces, vertices, color_data, alpha_data, ">draw_triangles</a>(elems, mdl.nodes, <span class="keyword">...</span>
0489                       triangle_color, triangle_alpha, <span class="keyword">...</span>
0490                       triangle_edge_color, triangle_edge_width);
0491 
0492     <span class="comment">% Draw edges if necessary</span>
0493     <span class="keyword">if</span> (~isempty(edge_edges))
0494         h = <a href="#_sub7" class="code" title="subfunction hh = draw_edges(edges, vertices, width_data, color_data)">draw_edges</a>(edge_edges, mdl.nodes, edge_width, edge_color);
0495         hh = [hh; h];
0496     <span class="keyword">end</span>
0497                   
0498     <span class="comment">% Draw markers if necessary.</span>
0499     <span class="keyword">if</span> (~isempty(marker_position))
0500         h = <a href="#_sub6" class="code" title="subfunction hh = draw_markers(points, colour, marker_size)">draw_markers</a>(marker_position, marker_color, 9);
0501         hh = [hh; h];
0502     <span class="keyword">end</span>
0503 
0504     <span class="keyword">if</span> opts.colorbar.show &amp;&amp; ~isempty( img )
0505 <span class="comment">%       psave = get(gca,'position');</span>
0506         <a href="eidors_colourbar.html" class="code" title="function hh= eidors_colourbar(max_scale,ref_lev, cb_shrink_move, greyscale)">eidors_colourbar</a>( img ); 
0507 <span class="comment">%       set(gca,'position',psave); %%% Reset axes after colourbar and move</span>
0508     <span class="keyword">end</span>
0509     
0510 <a name="_sub5" href="#_subfunctions" class="code">function hh = draw_numbers(positions, opts)</a>
0511     hh = text(positions(:,1), positions(:,2), positions(:,3), <span class="keyword">...</span>
0512         arrayfun(@(x){int2str(x)}, 1:size(positions, 1)), <span class="keyword">...</span>
0513         <span class="string">'HorizontalAlignment'</span>, <span class="string">'center'</span>, <span class="keyword">...</span>
0514         <span class="string">'VerticalAlignment'</span>,   <span class="string">'middle'</span>, <span class="keyword">...</span>
0515         <span class="string">'FontSize'</span>,            opts.font_size, <span class="keyword">...</span>
0516         <span class="string">'FontWeight'</span>,          opts.font_weight, <span class="keyword">...</span>
0517         <span class="string">'Color'</span>,               opts.color, <span class="keyword">...</span>
0518         <span class="string">'BackgroundColor'</span>,     opts.background_color);
0519 
0520 <a name="_sub6" href="#_subfunctions" class="code">function hh = draw_markers(points, colour, marker_size)</a>
0521     [unique_colour, unused, colour_idx] = unique(colour, <span class="string">'rows'</span>);
0522     
0523     <span class="keyword">for</span> i = 1:size(unique_colour, 1)
0524         points_idx = colour_idx == i;
0525         hh = line(points(points_idx, 1), points(points_idx, 2), <span class="keyword">...</span>
0526                   points(points_idx, 3), <span class="keyword">...</span>
0527                   <span class="string">'LineStyle'</span>, <span class="string">'none'</span>, <span class="keyword">...</span>
0528                   <span class="string">'Marker'</span>, <span class="string">'o'</span>, <span class="string">'MarkerSize'</span>, marker_size, <span class="keyword">...</span>
0529                   <span class="string">'MarkerFaceColor'</span>, unique_colour(i, :), <span class="keyword">...</span>
0530                   <span class="string">'MarkerEdgeColor'</span>, unique_colour(i, :));
0531     <span class="keyword">end</span>
0532         
0533 <a name="_sub7" href="#_subfunctions" class="code">function hh = draw_edges(edges, vertices, width_data, color_data)</a>
0534     <span class="keyword">if</span> all(width_data==0)
0535        <span class="keyword">return</span> <span class="comment">% don't draw these edges</span>
0536     <span class="keyword">end</span>
0537     [unique_width_color_data, unused, width_color_idx] = <span class="keyword">...</span><span class="comment"> </span>
0538                                    unique([width_data color_data], <span class="string">'rows'</span>); 
0539     hh = [];
0540     <span class="keyword">for</span> i = 1:size(unique_width_color_data, 1)
0541         <span class="keyword">if</span> (unique_width_color_data(i, 1) &gt; 0)
0542             edge_idx = (width_color_idx == i);
0543             points_list = [];
0544             points_list(1:3:3*size(edges(edge_idx, :), 1), :) = <span class="keyword">...</span>
0545                                            vertices(edges(edge_idx, 1), :);
0546             points_list(2:3:3*size(edges(edge_idx, :), 1), :) = <span class="keyword">...</span>
0547                                            vertices(edges(edge_idx, 2), :);
0548             points_list(3:3:3*size(edges(edge_idx, :), 1), :) = <span class="keyword">...</span>
0549                                        nan(size(edges(edge_idx, :), 1), 3);
0550             h = line(points_list(:, 1), points_list(:, 2), <span class="keyword">...</span>
0551                       points_list(:, 3), <span class="string">'LineWidth'</span>, <span class="keyword">...</span>
0552                       unique_width_color_data(i, 1), <span class="string">'LineStyle'</span>, <span class="string">'-'</span>, <span class="keyword">...</span>
0553                       <span class="string">'Color'</span>, unique_width_color_data(i, 2:end));
0554             hh = [hh; h];
0555         <span class="keyword">end</span>
0556     <span class="keyword">end</span>
0557 
0558 <a name="_sub8" href="#_subfunctions" class="code">function hh = draw_triangles(faces, vertices, color_data, alpha_data, </a><span class="keyword">...</span>
0559                              edge_color, edge_width)
0560                          
0561     <span class="keyword">if</span> (size(color_data, 1) == 1)
0562         color_data = ones(size(faces, 1), 1)*color_data;
0563         face_color = <span class="string">'flat'</span>;
0564     <span class="keyword">elseif</span> (size(color_data, 1) == size(faces, 1))
0565         face_color = <span class="string">'flat'</span>;
0566     <span class="keyword">elseif</span> (size(color_data, 1) == size(vertices, 1))
0567         face_color = <span class="string">'interp'</span>;        
0568     <span class="keyword">else</span>
0569         <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: color data and mesh do not match. Showing grey'</span>, 1);
0570         color_data = 0.5*ones(size(faces, 1), 3);
0571         face_color = <span class="string">'flat'</span>;      
0572     <span class="keyword">end</span>
0573     
0574     alpha_data_mapping = <span class="string">'none'</span>;
0575     <span class="keyword">if</span> (size(alpha_data, 1) == 1)
0576         alpha_data = ones(size(faces, 1), 1)*alpha_data;
0577         face_color = <span class="string">'flat'</span>;
0578     <span class="keyword">elseif</span> (size(alpha_data, 1) == size(faces, 1))
0579         face_alpha = <span class="string">'flat'</span>;
0580     <span class="keyword">elseif</span> (size(alpha_data, 1) == size(vertices, 1))
0581         face_alpha = <span class="string">'interp'</span>;  
0582         alpha_data_mapping = <span class="string">'scaled'</span>;  <span class="comment">% why is this needed??</span>
0583     <span class="keyword">else</span>
0584         <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: alpha data and mesh do not match. Showing opaque'</span>, 1);
0585         alpha_data = 1;
0586         face_alpha = <span class="string">'flat'</span>;        
0587     <span class="keyword">end</span>
0588 
0589     hh = patch(<span class="string">'Faces'</span>, faces, <span class="string">'Vertices'</span>, vertices, <span class="keyword">...</span>
0590                <span class="string">'AlphaDataMapping'</span>, alpha_data_mapping, <span class="keyword">...</span>
0591                <span class="string">'CDataMapping'</span>, <span class="string">'direct'</span>, <span class="keyword">...</span>
0592                <span class="string">'FaceVertexCData'</span>, color_data, <span class="keyword">...</span>
0593                <span class="string">'FaceVertexAlphaData'</span>, alpha_data, <span class="keyword">...</span>
0594                <span class="string">'FaceColor'</span>, face_color, <span class="string">'FaceAlpha'</span>, face_alpha, <span class="keyword">...</span>
0595                <span class="string">'EdgeColor'</span>, edge_color, <span class="string">'FaceLighting'</span>, <span class="string">'flat'</span>, <span class="keyword">...</span>
0596                <span class="string">'LineWidth'</span>, edge_width);
0597 
0598 <a name="_sub9" href="#_subfunctions" class="code">function colour = electr_colour(elec, e, colormap_width)</a>
0599     <span class="keyword">if</span> isfield(elec, <span class="string">'colour'</span>)
0600         desired_colour = elec.colour;
0601     <span class="keyword">else</span>
0602         <span class="keyword">switch</span> (e)
0603             <span class="keyword">case</span> 1
0604                 desired_colour = [0 .7 0]; <span class="comment">% light green electrode #1</span>
0605             <span class="keyword">case</span> 2
0606                 desired_colour = [0 .5 0]; <span class="comment">% mid-green electrode #2</span>
0607             <span class="keyword">otherwise</span>
0608                 desired_colour = [0 .3 0]; <span class="comment">% dark green</span>
0609         <span class="keyword">end</span>
0610     <span class="keyword">end</span>
0611     <span class="keyword">switch</span>(colormap_width)
0612         <span class="keyword">case</span> 1
0613             map = colormap;
0614             colormap_idx = find(all(map == ones(size(map, 1), 1)* <span class="keyword">...</span>
0615                                                        desired_colour, 2));
0616             <span class="keyword">if</span> ~isempty(colormap_idx)
0617                 colour = colormap_idx;
0618             <span class="keyword">else</span>
0619                 map = [map; desired_colour];
0620                 colormap(map);
0621                 colour = size(map, 1);
0622             <span class="keyword">end</span>
0623         <span class="keyword">case</span> 3 
0624             colour = desired_colour;
0625         <span class="keyword">otherwise</span>
0626             error(<span class="string">'Invalid colormap width.'</span>);
0627     <span class="keyword">end</span>
0628     
0629 <a name="_sub10" href="#_subfunctions" class="code">function mdl = find_sub_elements(mdl)</a>
0630     <span class="keyword">if</span> (~isfield(mdl, <span class="string">'sub_elements'</span>))
0631         <span class="comment">% Number of nodes per elements.</span>
0632         n_nodes_per_elem = size(mdl.elems, 2);
0633         
0634         <span class="comment">% Find sub-elements.</span>
0635         combos= nchoosek(1:n_nodes_per_elem, n_nodes_per_elem - 1);
0636         mdl.sub_elements = sort( <span class="keyword">...</span>
0637                            reshape(mdl.elems(:, combos')', <span class="keyword">...</span>
0638                                    n_nodes_per_elem - 1, []), <span class="keyword">...</span>
0639                                  1)';
0640                        
0641         <span class="comment">% Vector that associates each sub-element with</span>
0642         <span class="comment">% corresponding element.</span>
0643         sub_element_idx = reshape(ones(n_nodes_per_elem, 1) <span class="keyword">...</span>
0644                                            *(1:size(mdl.elems, 1)),[] , 1);
0645                                        
0646         sub_element_other_node_idx = reshape((n_nodes_per_elem:-1:1)'<span class="keyword">...</span>
0647                                      *ones(1, size(mdl.elems, 1)), [] , 1);
0648                                  
0649         sub_element_other_node = mdl.elems(sub2ind(size(mdl.elems), sub_element_idx, sub_element_other_node_idx));
0650                        
0651         <span class="comment">% Remove duplicate sub-elements.</span>
0652         <span class="comment">% Previously specified &quot;SPORTED&quot; but that is default, and not</span>
0653         <span class="comment">%   available in older versions</span>
0654         [mdl.sub_elements, ia, ic] = unique(<span class="keyword">...</span>
0655                                        mdl.sub_elements, <span class="string">'rows'</span>);
0656                                    
0657          sub_element_other_node = sub_element_other_node(ia, :);                    
0658                                 
0659         <span class="comment">% Compute a matrix that converts a property defined on the elements</span>
0660         <span class="comment">% to a property defined on the sub-elements.</span>
0661         mdl.element2sub_element = <a href="../../../eidors/overloads/sparse/sparse.html" class="code" title="function S = sparse(varargin)">sparse</a>(ic, sub_element_idx, <span class="keyword">...</span>
0662                              ones(n_nodes_per_elem*size(mdl.elems, 1), 1));
0663                          
0664         <span class="comment">% Normalize each row to one to account for boundary sub-elements</span>
0665         <span class="comment">% and internal sub-elements.</span>
0666         mdl.element2sub_element = spdiags(1./sum(<span class="keyword">...</span>
0667                                      mdl.element2sub_element, 2), <span class="keyword">...</span>
0668                                     0, size(mdl.sub_elements, 1), <span class="keyword">...</span>
0669                       size(mdl.sub_elements, 1))*mdl.element2sub_element;
0670                   
0671         <span class="comment">% Extract boundary from sub-elements.</span>
0672         mdl.boundary = mdl.sub_elements;
0673         boundary_other_node = sub_element_other_node;
0674         mdl.boundary_to_sub_element_idx = (1:size(mdl.sub_elements, 1))';
0675 
0676         sorted_ic = sort(ic);
0677 
0678         mdl.boundary(sorted_ic(diff(sorted_ic) == 0), :) = [];
0679         boundary_other_node(sorted_ic(diff(sorted_ic) == 0), :) = [];
0680         mdl.boundary_to_sub_element_idx(sorted_ic(diff(sorted_ic) == 0)) = [];
0681 
0682         <span class="comment">% in case we get vertex data we need the boundary nodes</span>
0683         mdl.boundary_node_idx  = (unique(mdl.boundary(:)));
0684         
0685         
0686         <span class="keyword">if</span> (size(mdl.boundary, 2) == 3)
0687             <span class="comment">% Compute normal vectors.</span>
0688             Node1 = mdl.nodes(mdl.boundary(:, 1), :);
0689             Node2 = mdl.nodes(mdl.boundary(:, 2), :);
0690             Node3 = mdl.nodes(mdl.boundary(:, 3), :);
0691             Node4 = mdl.nodes(boundary_other_node, :);
0692             mdl.boundary_normal_vector = cross(Node1 - Node2, <span class="keyword">...</span>
0693                                                Node3 - Node2, 2);
0694  
0695             <span class="comment">% Normalize normal vectors.</span>
0696             norm = 1./sqrt(sum(mdl.boundary_normal_vector <span class="keyword">...</span>
0697                                          .*mdl.boundary_normal_vector, 2));
0698             mdl.boundary_normal_vector = mdl.boundary_normal_vector <span class="keyword">...</span>
0699                                                         .*[norm norm norm];
0700               
0701             <span class="comment">% Check if normal is outward. If not, invert direction.</span>
0702             normal_vector_idx = dot(mdl.boundary_normal_vector, <span class="keyword">...</span>
0703                                                      Node4 - Node2, 2) &gt; 0;
0704             mdl.boundary_normal_vector(normal_vector_idx, :) = <span class="keyword">...</span>
0705                          -mdl.boundary_normal_vector(normal_vector_idx, :);
0706                                                     
0707             <span class="comment">% Find boundary edges.</span>
0708             mdl.boundary_edges = sort(reshape(mdl.boundary(:, <span class="keyword">...</span>
0709                                             nchoosek(1:3, 2)')', 2, []), 1)';
0710 
0711             <span class="comment">% Vector that associates each edge with its</span>
0712             <span class="comment">% corresponding two boundary elements.</span>
0713             sub_boundary_edges_idx = reshape(ones(3, 1) <span class="keyword">...</span>
0714                                        *(1:size(mdl.boundary, 1)), [] , 1);
0715 
0716             [mdl.boundary_edges, sorted_idx] = sortrows(mdl.boundary_edges);
0717 
0718             mdl.boundary_edges = mdl.boundary_edges(1:2:<span class="keyword">end</span>, :);
0719 
0720             mdl.edge2boundary = reshape(sub_boundary_edges_idx(<span class="keyword">...</span>
0721                                                       sorted_idx), 2, [])';               
0722         <span class="keyword">end</span>
0723 
0724         <span class="comment">% Extract electrode boundary if necessary.</span>
0725         <span class="keyword">if</span> (isfield(mdl, <span class="string">'electrode'</span>))
0726             <span class="keyword">for</span> i = 1:numel(mdl.electrode)
0727                 mdl.electrode(i).boundary = find(all(ismember(<span class="keyword">...</span>
0728                                 mdl.boundary, mdl.electrode(i).nodes), 2));
0729                 mdl.electrode(i).sub_elements = <span class="keyword">...</span>
0730                                     mdl.boundary_to_sub_element_idx( <span class="keyword">...</span>
0731                                                 mdl.electrode(i).boundary);
0732                 
0733                 <span class="comment">% Find electrode edges.</span>
0734                 <span class="keyword">if</span> (isfield(mdl, <span class="string">'boundary_edges'</span>))
0735                     edge_candidates = sum(ismember(mdl.edge2boundary, <span class="keyword">...</span>
0736                                             mdl.electrode(i).boundary), 2);
0737                     mdl.electrode(i).boundary_inner_edges = find(<span class="keyword">...</span>
0738                                                      edge_candidates == 2);
0739                     mdl.electrode(i).boundary_outer_edges = find(<span class="keyword">...</span>
0740                                                      edge_candidates == 1);                                           
0741                 <span class="keyword">end</span>
0742             <span class="keyword">end</span>
0743         <span class="keyword">end</span>
0744     <span class="keyword">end</span>
0745    
0746 <a name="_sub11" href="#_subfunctions" class="code">function dest_struct = copy_field(dest_struct, src_struct, parent_field_name, child_field_name)</a>
0747     <span class="keyword">if</span> (isfield(src_struct, parent_field_name) &amp;&amp; <span class="keyword">...</span>
0748         isfield(dest_struct, parent_field_name) &amp;&amp; <span class="keyword">...</span>
0749         isfield(src_struct.(parent_field_name), child_field_name))
0750             dest_struct.(parent_field_name).(child_field_name) = <span class="keyword">...</span>
0751                 src_struct.(parent_field_name).(child_field_name);
0752     <span class="keyword">end</span>
0753 
0754 <span class="comment">% TESTS:</span>
0755 <a name="_sub12" href="#_subfunctions" class="code">function do_unit_test</a>
0756    ver= <a href="../../../eidors/eidors_obj.html" class="code" title="function [obj_id, extra_out] = eidors_obj(type,name, varargin )">eidors_obj</a>(<span class="string">'interpreter_version'</span>);
0757    clf
0758 
0759    img=<a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(<a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c0'</span>,8)); 
0760    img.elem_data= 3*sin(linspace(-2,2,<a href="../../../eidors/models/num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>(img))');
0761    subplot(4,4,1); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img.fwd_model,[0,0,1]) 
0762    title(<span class="string">'regular mesh numbered'</span>);
0763 
0764 <span class="keyword">if</span> ~ver.isoctave 
0765    imgn = rmfield(img,<span class="string">'elem_data'</span>);
0766    imgn.node_data= 3*sin(linspace(-5,5,<a href="../../../eidors/models/num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>(img))');
0767    subplot(4,4,9); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(imgn) 
0768    title(<span class="string">'interpolated node colours'</span>);
0769 <span class="keyword">end</span>
0770 
0771    img2(1) = img; img2(2) = img;
0772    subplot(4,4,2); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img,[1]);
0773    title(<span class="string">'colours with legend'</span>);
0774    subplot(4,4,3); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img2,[0,1]);
0775    title(<span class="string">'colours with legend'</span>);
0776    img.calc_colours.mapped_colour = 0; <span class="comment">% USE RGB colours</span>
0777    subplot(4,4,4); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img,[0,1,1]);
0778    title(<span class="string">'RGB colours'</span>);
0779    subplot(4,4,4); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img);
0780    title(<span class="string">'RGB colours'</span>);
0781 
0782    img.elem_data = [1:10];
0783    subplot(4,4,12);<a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img); <span class="comment">%Should show grey</span>
0784    title(<span class="string">'error -&gt; show grey'</span>);
0785 
0786 <span class="keyword">if</span> ~ver.isoctave
0787    imgn.calc_colours.mapped_colour = 0; <span class="comment">% USE RGB colours</span>
0788    subplot(4,4,10);<a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(imgn,[0,1]) 
0789    title(<span class="string">'interpolated node colours'</span>);
0790 
0791 
0792    subplot(4,4,11);hh=<a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(imgn); set(hh(1),<span class="string">'EdgeColor'</span>,[0,0,1]);
0793    title(<span class="string">'with edge colours'</span>);
0794 
0795 <span class="keyword">end</span>
0796 
0797    img3=<a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(<a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'n3r2'</span>,[16,2]));
0798    img3.elem_data= randn(828,1);                       
0799    subplot(4,4,5); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img3.fwd_model) 
0800    subplot(4,4,6); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img3,[1])
0801    subplot(4,4,7); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img3,[1,1])
0802    subplot(4,4,8); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img3,[1,1,1])
0803 
0804    img3.elem_data(:) = 1;
0805    opts.viewpoint = struct(<span class="string">'az'</span>,10,<span class="string">'el'</span>,10);
0806    subplot(4,4,13); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img3,opts);
0807    opts.edge.width = 0;
0808    subplot(4,4,14); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img3,opts);
0809    
0810    img3.fwd_model.show_fem_enhanced = opts;
0811    subplot(4,4,15); <a href="show_fem_enhanced.html" class="code" title="function hh = show_fem_enhanced(mdl, options)">show_fem_enhanced</a>(img3);</pre></div>
<hr><address>Generated on Sun 29-Dec-2024 19:54:43 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>