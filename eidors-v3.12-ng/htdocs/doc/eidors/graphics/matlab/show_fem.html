<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of show_fem</title>
  <meta name="keywords" content="show_fem">
  <meta name="description" content="SHOW_FEM: show the EIDORS3D finite element model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">eidors</a> &gt; <a href="#">graphics</a> &gt; <a href="index.html">matlab</a> &gt; show_fem.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/graphics/matlab&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>show_fem
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>SHOW_FEM: show the EIDORS3D finite element model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function hh=show_fem( mdl, options) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> SHOW_FEM: show the EIDORS3D finite element model
 hh=show_fem( mdl, options )
 mdl is a EIDORS3D 'model' or 'image' structure
 hh= handle to the plotted model

 options may be specified by a list

 options specifies a set of options
   options(1) =&gt; show colourbar
   options(2) =&gt; show numbering on electrodes (fontsize can be controlled by
      the fractional part, ie [0,1.012] =&gt; 12pt font)
   options(3) =&gt; number elements (==1) or nodes (==2);
      fontsize can be controlled as above

 for detailed control of colours, use
    img.calc_colours.&quot;parameter&quot; = value
 see help for calc_colours.

 for control of colourbar, use img.calc_colours.cb_shrink_move

 parameters
  img.fwd_model.show_fem.alpha_inhomogeneities
      1 is opaque. A value like 0.02 is transparent     

 to change line properties:
      hh=show_fem(...); set(hh,'EdgeColor',[0,0,1];</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG eidors progress and status messages</li><li><a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>	[colours,scl_data]= calc_colours(img, set_value, do_colourbar)</li><li><a href="num_lights.html" class="code" title="function N = num_lights(ax)">num_lights</a>	NUM_LIGHTS return the number of light objects in an axes</li><li><a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>	SHOW_FEM: show the EIDORS3D finite element model</li><li><a href="../../../eidors/meshing/mat_idx_to_electrode.html" class="code" title="function [fmdl,rm_elems] = mat_idx_to_electrode(fmdl, mat_idxes)">mat_idx_to_electrode</a>	MAT_IDX_TO_ELECTRODE: create electrodes from mat_idx values</li><li><a href="../../../eidors/meshing/order_loop.html" class="code" title="function [p n] = order_loop(pp,clk)">order_loop</a>	ORDER_LOOP Order a list of points on a loop</li><li><a href="../../../eidors/models/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>	INTERP_MESH: calculate interpolation points onto mdl elements</li><li><a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>	MDL_DIM: dimension of model space (are nodes in 2D or 3D space)</li><li><a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="../../../eidors/models/num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>	NUM_ELEMS: number of elemnts in a (fwd or inv model or image)</li><li><a href="../../../eidors/models/num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>	NUM_NODES: number of elemnts in a (fwd or inv model or image)</li><li><a href="../../../eidors/models/remove_instrument_electrodes.html" class="code" title="function fmdl = remove_instrument_electrodes(fmdl)">remove_instrument_electrodes</a>	pre-delete all 'instrument' nodes</li><li><a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>	CALC_JACOBIAN_BKGND: calculate background image around</li><li><a href="../../../eidors/solvers/forward/find_boundary.html" class="code" title="function [srf, idx] = find_boundary(simp);">find_boundary</a>	[srf, idx] = find_boundary(simp);</li><li><a href="../../../eidors/solvers/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>	GET_IMG_DATA: get parameter data from eidors image object</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/deprecated/iso_f_smooth.html" class="code" title="function [Reg] = iso_f_smooth(simp,vtx,deg,w);">iso_f_smooth</a>	function [Reg] = iso_f_smooth(simp,vtx,deg,w);</li><li><a href="../../../eidors/deprecated/manchester_tomography.html" class="code" title="function manchester_tomography( example_no)">manchester_tomography</a>	Example to show reconstructions from</li><li><a href="../../../eidors/deprecated/solve_RM_2Dslice.html" class="code" title="function imdl = select_RM_slice(imdl, sel_fcn)">solve_RM_2Dslice</a>	SELECT_RM_SLICE: cut slices out of an inverse model with a</li><li><a href="../../../eidors/examples/cheating_2d.html" class="code" title="function out=cheating_2d( figno, rand_seed )">cheating_2d</a>	code to simulate inverse crimes in EIT</li><li><a href="../../../eidors/examples/demo_2d_simdata.html" class="code" title="">demo_2d_simdata</a>	Example of using EIDORS to simulate 2D data and to</li><li><a href="../../../eidors/examples/demo_3d_simdata.html" class="code" title="">demo_3d_simdata</a>	How to make simulation data using EIDORS3D</li><li><a href="../../../eidors/examples/demo_complex.html" class="code" title="">demo_complex</a>	This demo function shows how the EIT problem can be formulated in a complex</li><li><a href="../../../eidors/examples/demo_real.html" class="code" title="function [inhomg_img, demo_img] = demo_real;">demo_real</a>	[inhomg_img, demo_img] = demo_real;</li><li><a href="../../../eidors/examples/eidors2d_demo1.html" class="code" title="">eidors2d_demo1</a>	EidorsDemo1 Demonstrates the use of 2D EIT Package with linear basis</li><li><a href="../../../eidors/examples/ex_fwd2d_high_order.html" class="code" title="">ex_fwd2d_high_order</a>	ensure dev/m_crabb/forward_problem is on the path</li><li><a href="../../../eidors/examples/image_2d_algs.html" class="code" title="">image_2d_algs</a>	Based on the 'bubble' data from Eidors2D, use several</li><li><a href="calc_grid_points.html" class="code" title="function [val, c2f] = calc_grid_points(img, xpts, ypts, zpts)">calc_grid_points</a>	CALC_GRID_POINTS - image values at points in grid</li><li><a href="calc_voxels.html" class="code" title="function [V, rimg] = calc_voxels(img, opt, level)">calc_voxels</a>	CALC_VOXELS Calculate volumetric data from an image</li><li><a href="eidors_colourbar.html" class="code" title="function hh= eidors_colourbar(max_scale,ref_lev, cb_shrink_move, greyscale)">eidors_colourbar</a>	EIDORS_COLOURBAR - create an eidors colourbar with scaling to image</li><li><a href="emphasize_electrode_text.html" class="code" title="function emphasize_electrode_text(elecs);">emphasize_electrode_text</a>	EMPHASIZE_ELECTRODE_TEXT: ephazise the electrode</li><li><a href="mdl_slice_mapper.html" class="code" title="function map = mdl_slice_mapper( fmdl, maptype )">mdl_slice_mapper</a>	MDL_SLICE_MAPPER: map pixels to FEM elements or nodes</li><li><a href="mdl_slice_mesher.html" class="code" title="function [nimg out] = mdl_slice_mesher(fmdl,level,varargin)">mdl_slice_mesher</a>	MDL_SLICE_MESHER A slice of a 3D FEM as a 2D FEM</li><li><a href="print_convert.html" class="code" title="function print_convert(filename, varargin)">print_convert</a>	PRINT_CONVERT: print figures with anti-aliasing and trim them</li><li><a href="set_slice.html" class="code" title="function img = set_slice(img, level, spec)">set_slice</a>	SET_SLICE  Set parameters for slice display.</li><li><a href="show_3d_slices.html" class="code" title="function h = show_3d_slices(img, varargin);">show_3d_slices</a>	show_3d_slices(img, z_cuts, x_cuts, y_cuts, any_cuts)</li><li><a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>	SHOW_FEM: show the EIDORS3D finite element model</li><li><a href="show_fem_move.html" class="code" title="function [hf,hh] = show_fem_move( img, move, scale, options )">show_fem_move</a>	SHOW_FEM_MOVE   Plot EIT finite element model (FEM) and movement</li><li><a href="../../../eidors/meshing/crop_model.html" class="code" title="function [fmdl,c2f_idx]= crop_model( axis_handle, fcn_handle );">crop_model</a>	CROP_MODEL: Crop away parts of a fem model</li><li><a href="../../../eidors/meshing/distmesh/dm_2d_circ_pt_elecs.html" class="code" title="function fmdl = dm_2d_circ_pt_elecs( elec_pts, pfix, spacing);">dm_2d_circ_pt_elecs</a>	DM_2D_CIRC_PT_ELECS: Create circle mesh (or radius 1) refined with electrodes</li><li><a href="../../../eidors/meshing/distmesh/dm_2d_pt_elecs.html" class="code" title="function fmdl = dm_2d_pt_elecs( elec_pts, pfix, params, shapefn, bbox);">dm_2d_pt_elecs</a>	DM_2D_PT_ELECS: Create circle mesh (or radius 1) refined</li><li><a href="../../../eidors/meshing/gmsh/create_circle_mesh_gmsh.html" class="code" title="function mdl = create_circle_mesh_gmsh(basename, center, rad, elem_size )">create_circle_mesh_gmsh</a>	Create a 2D Circular FEM using GMSH</li><li><a href="../../../eidors/meshing/gmsh/gmsh_mk_2d_model.html" class="code" title="function mdl = gmsh_mk_2d_model(varargin)">gmsh_mk_2d_model</a>	GMSH_MK_2D_MODEL create a 2D mesh with GMSH</li><li><a href="../../../eidors/meshing/join_models.html" class="code" title="function [fmdlo]= join_models(fmdl1, fmdl2, tol)">join_models</a>	JOIN_MODELS: Join two fmdl structures to create one</li><li><a href="../../../eidors/meshing/mat_idx_to_electrode.html" class="code" title="function [fmdl,rm_elems] = mat_idx_to_electrode(fmdl, mat_idxes)">mat_idx_to_electrode</a>	MAT_IDX_TO_ELECTRODE: create electrodes from mat_idx values</li><li><a href="../../../eidors/meshing/netgen/ng_mk_2d_model.html" class="code" title="function mdl = ng_mk_2d_model(varargin)">ng_mk_2d_model</a>	NG_MG_2D_MODELS create a 2D mesh with Netgen via the in2d interface</li><li><a href="../../../eidors/meshing/netgen/ng_mk_closed_contour.html" class="code" title="function [fmdl,mat_idx] = ng_mk_ellip_models(ellip_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_closed_contour</a>	NG_MK_CLOSED_CONTOUR: fit elliptical model to a contour</li><li><a href="../../../eidors/meshing/netgen/ng_mk_cyl_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_cyl_models(cyl_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_cyl_models</a>	NG_MAKE_CYL_MODELS: create cylindrical models using netgen</li><li><a href="../../../eidors/meshing/netgen/ng_mk_ellip_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_ellip_models(ellip_shape, elec_pos,elec_shape, extra_ng_code);">ng_mk_ellip_models</a>	NG_MAKE_ELLIP_MODELS: create elliptical models using netgen</li><li><a href="../../../eidors/meshing/netgen/ng_mk_extruded_model.html" class="code" title="function [fmdl,mat_idx] = ng_mk_extruded_model(shape, elec_pos, elec_shape,extra_ng_code)">ng_mk_extruded_model</a>	NG_MAKE_EXTRUDED_MODEL: create extruded models using netgen</li><li><a href="../../../eidors/meshing/netgen/ng_mk_gen_models.html" class="code" title="function [fmdl,mat_idx] = ng_mk_gen_models(shape_str, elec_pos,  elec_shape, elec_obj, extra_ng_code, mszpoints);">ng_mk_gen_models</a>	NG_MK_GEN_MODELS: create generic models using netgen</li><li><a href="../../../eidors/meshing/netgen/ng_mk_geometric_models.html" class="code" title="function [fmdl, mat_idx] = ng_mk_geometric_models(body_geometry, electrode_geometry)">ng_mk_geometric_models</a>	NG_MK_GEOMETRIC_MODELS: create geometric mesh models using Netgen. Body</li><li><a href="../../../eidors/meshing/netgen/ng_write_opt.html" class="code" title="function opt = ng_write_opt(varargin)">ng_write_opt</a>	NG_WRITE_OPT Write an ng.opt file in current directory</li><li><a href="../../../eidors/meshing/ng_mk_common_model.html" class="code" title="function fmdl = ng_mk_common_model(mdl_type,mdl_shape, elec_pos, elec_shape);">ng_mk_common_model</a>	NG_MK_COMMON_MODEL: utility to create common models</li><li><a href="../../../eidors/meshing/stl/stl_read.html" class="code" title="function mdl = stl_read(fname)">stl_read</a>	STL_READ  Read in an stl file and output an EIDORS model struct</li><li><a href="../../../eidors/models/GREIT3D_distribution.html" class="code" title="function [imdl,distr] = GREIT3D_distribution(fmdl, vopt)">GREIT3D_distribution</a>	GREIT3D_distribution: create target distributions for 3D GREIT</li><li><a href="../../../eidors/models/GREIT_errors.html" class="code" title="function imdl= GREIT_errors(imdli, opts, data )">GREIT_errors</a>	GREIT_errors: Add Error Compensation to GREIT-type model</li><li><a href="../../../eidors/models/check_c2f_quality.html" class="code" title="function [ f_frac, c_frac ] = check_c2f_quality( f_mdl, c_mdl, c2f )">check_c2f_quality</a>	CHECK_C2F_QUALITY Check the coarse2fine mapping between two models</li><li><a href="../../../eidors/models/convhulln_clean.html" class="code" title="function [K,V] = convhulln_clean(pts,p);">convhulln_clean</a>	CONVHULLN_CLEAN: run convhulln and catch errors</li><li><a href="../../../eidors/models/deform_cylinder.html" class="code" title="function fwd_mdl = deform_cylinder( fwd_mdl, geo);">deform_cylinder</a>	fwd_mdl = deform_cylinder( fwd_mdl, niv);</li><li><a href="../../../eidors/models/map_RM_slice.html" class="code" title="function imdl = map_RM_slice(imdl,varargin)">map_RM_slice</a>	map_RM_slice - map a 3D reconstruction matrix to an arbitrary 2D slice</li><li><a href="../../../eidors/models/merge_meshes.html" class="code" title="function out = merge_meshes(M1, varargin)">merge_meshes</a>	MERGE_MESHES - merges two meshes sharing only boundary nodes</li><li><a href="../../../eidors/models/mk_GREIT_model.html" class="code" title="function [imdl, weight]= mk_GREIT_model( fmdl, radius, weight, options )">mk_GREIT_model</a>	MK_GREIT_MODEL: make EIDORS inverse models using the GREIT approach</li><li><a href="../../../eidors/models/mk_c2f_circ_mapping.html" class="code" title="function [mapping failed] = mk_c2f_circ_mapping( mdl, xyzr );">mk_c2f_circ_mapping</a>	MK_C2F_CIRC_MAPPING: create a mapping matrix from circles/spheres to FEM</li><li><a href="../../../eidors/models/mk_circ_tank.html" class="code" title="function param= mk_circ_tank(rings, levels, elec_spec );">mk_circ_tank</a>	MK_CIRC_TANK: make a cylindrical tank FEM geometry in 2D or 3D</li><li><a href="../../../eidors/models/mk_geophysics_model.html" class="code" title="function imdl = mk_geophysics_model(str, ne, opt);">mk_geophysics_model</a>	imdl = mk_geophysics_model(str, ne, [option])</li><li><a href="../../../eidors/models/mk_grid_c2f.html" class="code" title="function [c2f, m] = mk_grid_c2f(fmdl, rmdl, opt)">mk_grid_c2f</a>	MK_GRID_C2F - calculate a coarse2fine mapping for grid coarse models.</li><li><a href="../../../eidors/models/mk_grid_model.html" class="code" title="function [cmdl, c2f]= mk_grid_model(fmdl, xvec, yvec, zvec, removefn);">mk_grid_model</a>	MK_GRID_MODEL: Create reconstruction model on pixelated grid</li><li><a href="../../../eidors/models/mk_head_model.html" class="code" title="function out = mk_head_model(str, varargin)">mk_head_model</a>	MK_HEAD_MODEL FEM models of the head</li><li><a href="../../../eidors/models/mk_head_model_adult.html" class="code" title="function out = mk_head_model_adult(varargin)">mk_head_model_adult</a>	MK_HEAD_MODEL_ADULT Adult head model</li><li><a href="../../../eidors/models/mk_hollow_electrode.html" class="code" title="function fmdl = mk_hollow_electrode(fmdl, elec_idx)">mk_hollow_electrode</a>	MK_HOLLOW_ELECTRODE: remove nodes with indicated electrdoes</li><li><a href="../../../eidors/models/mk_library_model.html" class="code" title="function out = mk_library_model(shape,elec_pos,elec_shape,maxsz,nfft,scale)">mk_library_model</a>	MK_LIBRARY_MODEL - extruded FEM models based on curves in SHAPE_LIBRARY</li><li><a href="../../../eidors/models/mk_lung_image.html" class="code" title="function img = mk_lung_image(mdl, opt, cmd)">mk_lung_image</a>	MK_LUNG_IMAGE create an image with lung and heart contrasts from a model</li><li><a href="../../../eidors/models/mk_pixel_slice.html" class="code" title="function [imdl fmdl] = mk_pixel_slice(imdl,level,opt)">mk_pixel_slice</a>	MK_PIXEL_SLICE create a pixel model to reconstruct on</li><li><a href="../../../eidors/models/mk_tet_c2f.html" class="code" title="function [c2f] = mk_tet_c2f(fmdl, rmdl, opt)">mk_tet_c2f</a>	MK_TET_C2F - calculate a coarse2fine mapping for two tet-based models.</li><li><a href="../../../eidors/models/mk_thorax_model.html" class="code" title="function out = mk_thorax_model(str, varargin)">mk_thorax_model</a>	MK_THORAX_MODEL FEM models of the thorax</li><li><a href="../../../eidors/models/mk_tri2tet_c2f.html" class="code" title="function c2f = mk_tri2tet_c2f(fmdl,rmdl, opt)">mk_tri2tet_c2f</a>	MK_TRI2TET_C2F - coarse2fine mapping between tri-based and tet-based models</li><li><a href="../../../eidors/models/mk_tri_c2f.html" class="code" title="function c2f = mk_tri_c2f(fmdl,rmdl,opt)">mk_tri_c2f</a>	MK_TRI_C2F - calculate a coarse2fine mapping for triangle-based models.</li><li><a href="../../../eidors/models/mk_voxel_volume.html" class="code" title="function [imdl, fmdl] = mk_voxel_volume(varargin)">mk_voxel_volume</a>	MK_VOXEL_VOLUME create a voxel model to reconstruct on</li><li><a href="../../../eidors/models/place_elec_on_surf.html" class="code" title="function mdl2 = place_elec_on_surf(mdl,elec_pos, elec_spec,ng_opt_file, maxh)">place_elec_on_surf</a>	PLACE_ELEC_ON_SURF Place electrodes on the surface of a model</li><li><a href="../../../eidors/models/select_RM_slice.html" class="code" title="function imdl = select_RM_slice(imdl, sel_fcn)">select_RM_slice</a>	SELECT_RM_SLICE: cut slices out of an inverse model with a</li><li><a href="../../../eidors/models/test_GREIT_model.html" class="code" title="">test_GREIT_model</a>	</li><li><a href="../../../eidors/solvers/forward/fwd_solve_1st_order.html" class="code" title="function data =fwd_solve_1st_order(fwd_model, img)">fwd_solve_1st_order</a>	FWD_SOLVE_1ST_ORDER: data= fwd_solve_1st_order( img)</li><li><a href="../../../eidors/solvers/forward/jacobian_adjoint_2p5d_1st_order.html" class="code" title="function J= jacobian_adjoint_2p5d_1st_order( fwd_model, img)">jacobian_adjoint_2p5d_1st_order</a>	JACOBIAN_ADJOINT_2P5D: J= jacobian_adjoint_2p5d_1st_order( img )</li><li><a href="../../../eidors/solvers/forward/jacobian_movement_2p5d_1st_order.html" class="code" title="function J = jacobian_movement_2p5d_1st_order( fwd_model, img)">jacobian_movement_2p5d_1st_order</a>	JACOBIAN_MOVEMENT_2P5D: J = jacobian_movement_2p5d_1st_order( img )</li><li><a href="../../../eidors/solvers/forward/system_mat_1st_order.html" class="code" title="function s_mat= system_mat_1st_order( fwd_model, img)">system_mat_1st_order</a>	SYSTEM_MAT_1ST_ORDER: SS= system_mat_1st_order( fwd_model, img)</li><li><a href="../../../eidors/solvers/inverse/GREIT_desired_img_FEMmesh.html" class="code" title="function PSF= GREIT_desired_img_FEMmesh(xyc, radius, opt)">GREIT_desired_img_FEMmesh</a>	GREIT_DESIRED_IMG_FEMmesh  GREIT onto a FEM mesh</li><li><a href="../../../eidors/solvers/inverse/calc_GREIT_RM.html" class="code" title="function [RM, PJt, M, noiselev] = calc_GREIT_RM(vh,vi, xyc, radius, weight, options)">calc_GREIT_RM</a>	CALCULATE GREIT reconstruction matrix</li><li><a href="../../../eidors/solvers/inverse/calc_image_SNR.html" class="code" title="function [SNRmean, SE, debug] = calc_image_SNR(imdl, hyperparameter, doPlot)">calc_image_SNR</a>	% CALC_IMAGE_SNR: Calculates the signal-to-noise ratio (SNR) in the image</li><li><a href="../../../eidors/solvers/inverse/inv_solve_cg.html" class="code" title="function img= inv_solve_cg( inv_model, data1, data2);">inv_solve_cg</a>	function img= inv_solve_cg( inv_model, data1);</li><li><a href="../../../eidors/solvers/inverse/inv_solve_conj_grad.html" class="code" title="function img= inv_solve_conj_grad( inv_model, data1, data2)">inv_solve_conj_grad</a>	INV_SOLVE_CONJ_GRAD inverse solver based on the CG</li><li><a href="../../../eidors/solvers/inverse/inv_solve_core.html" class="code" title="function img= inv_solve_core( inv_model, data0, data1);">inv_solve_core</a>	INV_SOLVE_CORE Solver using a generic iterative algorithm</li><li><a href="../../../eidors/solvers/inverse/inv_solve_d_bar.html" class="code" title="function img = inv_solve_d_bar(inv_model, data1, data2)">inv_solve_d_bar</a>	D-Bar reconstruction</li><li><a href="../../../eidors/solvers/inverse/inv_solve_gn.html" class="code" title="function img= inv_solve_gn( inv_model, data1, data2);">inv_solve_gn</a>	function img= inv_solve_gn( inv_model, data1);</li><li><a href="../../../eidors/solvers/inverse/inv_solve_time_prior.html" class="code" title="function img= inv_solve_time_prior( inv_model, data1, data2)">inv_solve_time_prior</a>	INV_SOLVE_TIME_PRIOR inverse solver to account for time differences</li><li><a href="../../../eidors/tests/test_2d_resistor.html" class="code" title="function test_2d_resistor(opt)">test_2d_resistor</a>	Create 2D model of a cylindrical resistor</li><li><a href="../../../eidors/tests/test_3d_resistor.html" class="code" title="function test_3d_resistor(opt)">test_3d_resistor</a>	Create 3D model of a Rectangular resistor</li><li><a href="../../../eidors/tests/test_colour_direction.html" class="code" title="">test_colour_direction</a>	Test colour mapping</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function fix_axis</a></li><li><a href="#_sub2" class="code">function placenumbers(xyzc, fontsize, colour, bgcolour)</a></li><li><a href="#_sub3" class="code">function [img,mdl,opts] = proc_params( mdl, options );</a></li><li><a href="#_sub4" class="code">function hh= show_2d(img,mdl,opts)</a></li><li><a href="#_sub5" class="code">function hh= show_3d(img,mdl,opts)</a></li><li><a href="#_sub6" class="code">function show_electrodes_2d(mdl, number_electrodes)</a></li><li><a href="#_sub7" class="code">function show_electrodes_surf(mdl, number_electrodes)</a></li><li><a href="#_sub8" class="code">function fontsize= getfontsizefromnumber_electrodes(number_electrodes)</a></li><li><a href="#_sub9" class="code">function show_electrodes_3d(mdl, number_electrodes)</a></li><li><a href="#_sub10" class="code">function number_elecs_3d(number_electrodes, e, mdl, el_nodes )</a></li><li><a href="#_sub11" class="code">function show_inhomogeneities( elem_data, mdl, img, opt)</a></li><li><a href="#_sub12" class="code">function paint_electrodes(sel,srf,vtx, colour, show_num);</a></li><li><a href="#_sub13" class="code">function hh= show_3d_fem( mdl, options )</a></li><li><a href="#_sub14" class="code">function hh=show_2d_fem( mdl, colours, imgno )</a></li><li><a href="#_sub15" class="code">function hh=show_2d_fem_oldmatlab( mdl, colours, imgno )</a></li><li><a href="#_sub16" class="code">function old_code_3d_plot</a></li><li><a href="#_sub17" class="code">function plot_2d_mesh(NODE,ELEM,el_pos, S, options)</a></li><li><a href="#_sub18" class="code">function  mes= avg_electrode_posn( mdl )</a></li><li><a href="#_sub19" class="code">function colour = get_elec_colour(elec_struct, elec_num)</a></li><li><a href="#_sub20" class="code">function colour= electr_colour( e);</a></li><li><a href="#_sub21" class="code">function ee= get_boundary( mdl )</a></li><li><a href="#_sub22" class="code">function hh = paint_inho(data, nodes, elems, thresh, img)</a></li><li><a href="#_sub23" class="code">function hh_=repaint_inho(mat,mat_ref,vtx,simp, thresh, clr_def);</a></li><li><a href="#_sub24" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function hh=show_fem( mdl, options)</a>
0002 <span class="comment">% SHOW_FEM: show the EIDORS3D finite element model</span>
0003 <span class="comment">% hh=show_fem( mdl, options )</span>
0004 <span class="comment">% mdl is a EIDORS3D 'model' or 'image' structure</span>
0005 <span class="comment">% hh= handle to the plotted model</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% options may be specified by a list</span>
0008 <span class="comment">%</span>
0009 <span class="comment">% options specifies a set of options</span>
0010 <span class="comment">%   options(1) =&gt; show colourbar</span>
0011 <span class="comment">%   options(2) =&gt; show numbering on electrodes (fontsize can be controlled by</span>
0012 <span class="comment">%      the fractional part, ie [0,1.012] =&gt; 12pt font)</span>
0013 <span class="comment">%   options(3) =&gt; number elements (==1) or nodes (==2);</span>
0014 <span class="comment">%      fontsize can be controlled as above</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% for detailed control of colours, use</span>
0017 <span class="comment">%    img.calc_colours.&quot;parameter&quot; = value</span>
0018 <span class="comment">% see help for calc_colours.</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% for control of colourbar, use img.calc_colours.cb_shrink_move</span>
0021 <span class="comment">%</span>
0022 <span class="comment">% parameters</span>
0023 <span class="comment">%  img.fwd_model.show_fem.alpha_inhomogeneities</span>
0024 <span class="comment">%      1 is opaque. A value like 0.02 is transparent</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% to change line properties:</span>
0027 <span class="comment">%      hh=show_fem(...); set(hh,'EdgeColor',[0,0,1];</span>
0028 
0029 <span class="comment">% (C) 2005-2011 Andy Adler. License: GPL version 2 or version 3</span>
0030 <span class="comment">% $Id: show_fem.m 7029 2024-11-28 20:35:24Z bgrychtol $</span>
0031 
0032 <span class="comment">% TESTS</span>
0033 <span class="keyword">switch</span> nargin
0034    <span class="keyword">case</span> 0;
0035      error(<span class="string">'Insufficient parameters for show_fem'</span>);
0036    <span class="keyword">case</span> 1;
0037      <span class="keyword">if</span> ischar(mdl) &amp;&amp; strcmp(mdl,<span class="string">'UNIT_TEST'</span>); <a href="#_sub24" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0038      options = [];
0039 <span class="keyword">end</span>
0040 [img,mdl,opts] = <a href="#_sub3" class="code" title="subfunction [img,mdl,opts] = proc_params( mdl, options );">proc_params</a>( mdl, options );
0041 
0042 <span class="keyword">if</span> ~ishold
0043     cla;
0044 <span class="keyword">end</span>
0045 
0046 <span class="keyword">switch</span> opts.dims
0047    <span class="keyword">case</span> 2;    hh= <a href="#_sub4" class="code" title="subfunction hh= show_2d(img,mdl,opts)">show_2d</a>(img,mdl,opts); <span class="comment">% 2D nodes</span>
0048    <span class="keyword">case</span> 3;    hh= <a href="#_sub5" class="code" title="subfunction hh= show_3d(img,mdl,opts)">show_3d</a>(img,mdl,opts); <span class="comment">% 3D nodes</span>
0049    <span class="keyword">otherwise</span>; error(<span class="string">'model is not 2D or 3D'</span>);
0050 <span class="keyword">end</span>
0051 
0052 <span class="keyword">if</span> opts.show_elem_numbering
0053    xyzc= <a href="../../../eidors/models/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>(mdl);
0054    <span class="keyword">if</span> opts.show_elem_numbering == 1
0055        fontsize = 7;
0056    <span class="keyword">else</span>
0057        fontsize = 1000*(opts.show_elem_numbering - 1);
0058    <span class="keyword">end</span>
0059    <a href="#_sub2" class="code" title="subfunction placenumbers(xyzc, fontsize, colour, bgcolour)">placenumbers</a>(xyzc, fontsize, [0,0,0],<span class="string">'none'</span>);
0060 <span class="keyword">end</span>
0061 <span class="keyword">if</span> opts.show_node_numbering
0062    xyzc= mdl.nodes;
0063    <span class="keyword">if</span> opts.show_node_numbering == 1
0064        fontsize = 7;
0065    <span class="keyword">else</span>
0066        fontsize = 1000*(opts.show_node_numbering - 1);
0067    <span class="keyword">end</span>
0068    <a href="#_sub2" class="code" title="subfunction placenumbers(xyzc, fontsize, colour, bgcolour)">placenumbers</a>(xyzc, fontsize, [0.0,0,0.5],[1,1,1]);
0069 <span class="keyword">end</span>
0070 
0071 <span class="keyword">if</span> nargout == 0; clear hh; <span class="keyword">end</span>
0072 
0073 <span class="comment">% this is moved to show_2d and show_3d</span>
0074 <span class="comment">% if ~ishold</span>
0075 <span class="comment">%    fix_axis</span>
0076 <span class="comment">% end</span>
0077 
0078 <a name="_sub1" href="#_subfunctions" class="code">function fix_axis</a>
0079    ax = gca;
0080    axis tight
0081    set(ax,<span class="string">'DataAspectRatio'</span>,[1 1 1]);
0082    <span class="comment">% expand the axis limits slightly</span>
0083    [az el] = view;
0084    <span class="keyword">if</span> el==90
0085       <span class="comment">% for 2d plots we need x and y</span>
0086       xl=get(ax,<span class="string">'XLim'</span>); yl=get(ax,<span class="string">'Ylim'</span>);
0087       dx = diff(xl); dy = diff(yl);
0088       <span class="comment">% make sure to expand away from the origin</span>
0089       xb = strcmp(get(ax,<span class="string">'XAxisLocation'</span>),<span class="string">'bottom'</span>);
0090       yn = strcmp(get(ax,<span class="string">'YDir'</span>),<span class="string">'normal'</span>);
0091       <span class="keyword">if</span> xb == yn
0092          set(ax,<span class="string">'YLim'</span>,yl + [0 1]*1e-3*dy);
0093       <span class="keyword">else</span>
0094          set(ax,<span class="string">'YLim'</span>,yl + [-1 0]*1e-3*dy);
0095       <span class="keyword">end</span>
0096       yl = strcmp(get(ax,<span class="string">'XAxisLocation'</span>),<span class="string">'bottom'</span>);
0097       xn = strcmp(get(ax,<span class="string">'XDir'</span>),<span class="string">'normal'</span>);
0098       <span class="keyword">if</span> yl == xn
0099          set(ax,<span class="string">'XLim'</span>,xl + [0 1]*1e-3*dx);
0100       <span class="keyword">else</span>
0101          set(ax,<span class="string">'XLim'</span>,xl + [-1 0]*1e-3*dx);
0102       <span class="keyword">end</span>
0103    <span class="keyword">else</span>
0104       <span class="comment">% for 3d plots it's enough to adjust z</span>
0105       zl = get(ax,<span class="string">'Zlim'</span>); dz = diff(zl);
0106       <span class="keyword">if</span> strcmp(get(ax,<span class="string">'Zdir'</span>),<span class="string">'normal'</span>)
0107          set(ax,<span class="string">'ZLim'</span>,zl + [0 1]*1e-3*dz);
0108       <span class="keyword">else</span>
0109          set(ax,<span class="string">'ZLim'</span>,zl + [-1 0]*1e-3*dz);
0110       <span class="keyword">end</span>
0111    <span class="keyword">end</span>
0112    
0113 
0114 <a name="_sub2" href="#_subfunctions" class="code">function placenumbers(xyzc, fontsize, colour, bgcolour)</a>
0115    xyzc= xyzc * eye(size(xyzc,2),3); <span class="comment">%convert to 3D</span>
0116    <span class="keyword">for</span> i= 1:size(xyzc,1)
0117       text(xyzc(i,1),xyzc(i,2), xyzc(i,3), num2str(i), <span class="keyword">...</span>
0118             <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="keyword">...</span>
0119             <span class="string">'FontSize'</span>,fontsize,<span class="string">'Color'</span>,colour,<span class="string">'BackgroundColor'</span>,bgcolour);
0120    <span class="keyword">end</span>
0121 
0122 <a name="_sub3" href="#_subfunctions" class="code">function [img,mdl,opts] = proc_params( mdl, options );</a>
0123 
0124    opts.do_colourbar=0;
0125    opts.number_electrodes=0;
0126    opts.show_numbering  =0;
0127    opts.show_elem_numbering = 0;
0128    opts.show_node_numbering = 0;
0129    <span class="keyword">if</span> nargin &gt;=2
0130        <span class="comment">% fill in default options</span>
0131        optionstr= zeros(1,100);
0132        optionstr(1:length(options)) = options;
0133 
0134        opts.do_colourbar=      optionstr(1);
0135        opts.number_electrodes= optionstr(2);
0136        <span class="keyword">switch</span> floor(optionstr(3))
0137           <span class="keyword">case</span> 1; opts.show_elem_numbering = 1 + rem(optionstr(3),1);
0138           <span class="keyword">case</span> 2; opts.show_node_numbering = 1 + rem(optionstr(3),1);
0139           <span class="keyword">case</span> 3; opts.show_elem_numbering = 1 + rem(optionstr(3),1);
0140                   opts.show_node_numbering = 1 + rem(optionstr(3),1);
0141        <span class="keyword">end</span>
0142    <span class="keyword">end</span>
0143 
0144    
0145    <span class="comment">% if we have an only img input, then define mdl</span>
0146    <span class="keyword">if</span> strcmp( mdl(1).type , <span class="string">'image'</span> )
0147       img= mdl;
0148       mdl= img(1).fwd_model;
0149    <span class="keyword">else</span> 
0150       img = [];
0151    <span class="keyword">end</span>
0152    <span class="comment">% Remove instrument nodes</span>
0153    mdl = <a href="../../../eidors/models/remove_instrument_electrodes.html" class="code" title="function fmdl = remove_instrument_electrodes(fmdl)">remove_instrument_electrodes</a>(mdl);
0154    
0155    opts.transparency_thresh = <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(<span class="string">'transparency_thresh'</span>);
0156    <span class="keyword">try</span>
0157        opts.transparency_thresh = img.calc_colours.transparency_thresh;
0158    <span class="keyword">end</span>
0159    
0160    opts.dims = size(mdl.nodes,2);
0161 
0162 
0163 <span class="comment">% 2D Case</span>
0164 <a name="_sub4" href="#_subfunctions" class="code">function hh= show_2d(img,mdl,opts)</a>
0165    hax= gca;
0166    pax= get(hax,<span class="string">'position'</span>);
0167    <span class="keyword">if</span> ~isempty(img)
0168       colours= <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img, [] );
0169    <span class="keyword">else</span>
0170       colours= [1,1,1]; <span class="comment">% white elements if no image</span>
0171    <span class="keyword">end</span>
0172    hh= <a href="#_sub14" class="code" title="subfunction hh=show_2d_fem( mdl, colours, imgno )">show_2d_fem</a>( mdl, colours );
0173    <a href="#_sub6" class="code" title="subfunction show_electrodes_2d(mdl, number_electrodes)">show_electrodes_2d</a>(mdl, opts.number_electrodes) 
0174    set(hax,<span class="string">'position'</span>, pax);
0175    view(0, 90); axis(<span class="string">'xy'</span>); grid(<span class="string">'off'</span>);
0176 
0177 <span class="comment">% IN MATLAB 7 WE NEED TO RERUN THIS BECAUSE STUPID STUPID</span>
0178 <span class="comment">% MATLAB WILL RESET THE COLOURBAR EVERY TIME WE RUN PATCH!!!</span>
0179    <span class="keyword">if</span> exist(<span class="string">'img'</span>,<span class="string">'var'</span>) &amp;&amp; opts.do_colourbar;
0180       colours= <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img, [], opts.do_colourbar);
0181       <span class="comment">% Matlab is so weird. It puts the first colorbar in the wrong place</span>
0182       <span class="comment">%   sometimes ...  (tested with 6.5 and with 7.8)</span>
0183       <span class="comment">%   The trick is to never try to move it on the first go</span>
0184       <span class="comment">%   OR we reset it and then replace it. STUPID STUPID</span>
0185 
0186      <span class="comment">% Here's the magic trick I found. Force a drawnow,</span>
0187      <span class="comment">%     then delete and recreate</span>
0188 
0189      <span class="comment">% Because of a change in matlab colorbar somewhere around</span>
0190      <span class="comment">% 2012, none of this compensation code works any more. We</span>
0191      <span class="comment">% don't really understand what to do anymore, but this</span>
0192      <span class="comment">% seems best, for now ...</span>
0193    <span class="keyword">end</span>
0194    <span class="keyword">if</span> ~ishold
0195       <a href="#_sub1" class="code" title="subfunction fix_axis">fix_axis</a>
0196    <span class="keyword">end</span>
0197 
0198    
0199 
0200 <span class="comment">% 3D Case</span>
0201 <a name="_sub5" href="#_subfunctions" class="code">function hh= show_3d(img,mdl,opts)</a>
0202    hh= <a href="#_sub13" class="code" title="subfunction hh= show_3d_fem( mdl, options )">show_3d_fem</a>( mdl );
0203 
0204    <span class="keyword">if</span> ~isempty(img)
0205        elem_data = <a href="../../../eidors/solvers/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>(img);
0206        <a href="#_sub11" class="code" title="subfunction show_inhomogeneities( elem_data, mdl, img, opt)">show_inhomogeneities</a>( elem_data , mdl, img, opts);
0207        <span class="keyword">if</span> opts.do_colourbar
0208            <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(img, [], opts.do_colourbar);
0209        <span class="keyword">end</span>
0210    <span class="keyword">end</span>
0211    <span class="comment">% need to adjust the axis limits before we plot electrodes</span>
0212    <span class="comment">% who have thickness in all dimensions and thus cause 'axis tight' to</span>
0213    <span class="comment">% mess up the z limits</span>
0214    <span class="keyword">if</span> ~ishold
0215       <a href="#_sub1" class="code" title="subfunction fix_axis">fix_axis</a>
0216    <span class="keyword">end</span>
0217    <span class="keyword">if</span> size(mdl.elems,2) == 3
0218       <a href="#_sub7" class="code" title="subfunction show_electrodes_surf(mdl, number_electrodes)">show_electrodes_surf</a>(mdl, opts.number_electrodes);
0219    <span class="keyword">else</span>
0220       <a href="#_sub9" class="code" title="subfunction show_electrodes_3d(mdl, number_electrodes)">show_electrodes_3d</a>(mdl, opts.number_electrodes);
0221    <span class="keyword">end</span>
0222 
0223 
0224 <a name="_sub6" href="#_subfunctions" class="code">function show_electrodes_2d(mdl, number_electrodes)</a>
0225     <span class="keyword">if</span> ~isfield(mdl,<span class="string">'electrode'</span>); <span class="keyword">return</span>; <span class="keyword">end</span>
0226 
0227     ee= <a href="#_sub21" class="code" title="subfunction ee= get_boundary( mdl )">get_boundary</a>( mdl );
0228     ctr_x= mean(mdl.nodes(:,1));
0229     ctr_y= mean(mdl.nodes(:,2));
0230 
0231 <span class="comment">% scale away from model</span>
0232 
0233 <span class="keyword">for</span> e=1:length(mdl.electrode)
0234     elece = mdl.electrode(e);
0235     <span class="keyword">if</span> isfield(elece,<span class="string">'faces'</span>) &amp;&amp; isfield(elece,<span class="string">'nodes'</span>) &amp;&amp; isempty(elece.nodes);
0236         faces= elece.faces;
0237         
0238         S= 1.00;
0239         vx= (reshape(mdl.nodes(faces,1),size(faces))' - ctr_x)*S;
0240         vy= (reshape(mdl.nodes(faces,2),size(faces))' - ctr_y)*S;
0241 
0242     <span class="keyword">elseif</span> isfield(mdl.electrode(e),<span class="string">'nodes'</span>) &amp;&amp; ~isempty(elece.nodes)
0243         elec_nodes= elece.nodes;
0244         
0245         S= 1.00;
0246         vx= (mdl.nodes(elec_nodes,1) - ctr_x)*S;
0247         vy= (mdl.nodes(elec_nodes,2) - ctr_y)*S;
0248         <span class="comment">% sort nodes around the model (to avoid crossed lines)</span>
0249         [jnk,idx] = <a href="../../../eidors/meshing/order_loop.html" class="code" title="function [p n] = order_loop(pp,clk)">order_loop</a>( [vx,vy] );
0250         vx = vx(idx);
0251         vy = vy(idx);
0252     <span class="keyword">elseif</span> isfield(elece,<span class="string">'pos'</span>) &amp;&amp; ~isempty(elece.pos)
0253         vx = elece.pos(:,1) - ctr_x;
0254         vy = elece.pos(:,2) - ctr_y;
0255     <span class="keyword">else</span>
0256        <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'show_fem: WARNING: electrode %d has no nodes/faces/pos. Not showing.'</span>,e,2);
0257        <span class="keyword">continue</span>;
0258     <span class="keyword">end</span>
0259         
0260     ecolour = <a href="#_sub19" class="code" title="subfunction colour = get_elec_colour(elec_struct, elec_num)">get_elec_colour</a>( elece, e );
0261     <span class="keyword">if</span> numel(vx) == 1
0262        <span class="comment">% Point Electrode Models: put a circle around the node</span>
0263        line(vx+ctr_x,vy+ctr_y,  <span class="keyword">...</span>
0264             <span class="string">'LineWidth'</span>, 2, <span class="string">'LineStyle'</span>,<span class="string">'-'</span>,<span class="string">'Color'</span>, ecolour, <span class="keyword">...</span>
0265             <span class="string">'Marker'</span>,<span class="string">'o'</span>,<span class="string">'MarkerSize'</span>, 6,<span class="string">'MarkerEdgeColor'</span>,ecolour);
0266     <span class="keyword">else</span>
0267        <span class="comment">% Complete/Shunt Electrode Models (multiple nodes per electrode)</span>
0268        <span class="comment">%  put a line along the edges that form the electrode</span>
0269        line(vx+ctr_x,vy+ctr_y,  <span class="keyword">...</span>
0270             <span class="string">'LineWidth'</span>, 3, <span class="string">'LineStyle'</span>,<span class="string">'-'</span>,<span class="string">'Color'</span>, ecolour, <span class="keyword">...</span>
0271             <span class="string">'Marker'</span>,<span class="string">'none'</span>,<span class="string">'MarkerSize'</span>, 6,<span class="string">'MarkerEdgeColor'</span>,ecolour);
0272     <span class="keyword">end</span>
0273     <span class="keyword">if</span> number_electrodes
0274        S= 1.05;
0275        vx= vx*S;
0276        vy= vy*S;
0277        <span class="keyword">switch</span> floor(number_electrodes)
0278           <span class="keyword">case</span> {1 true}
0279              txt = num2str(e);
0280           <span class="keyword">case</span> 2
0281              <span class="keyword">try</span>, txt = mdl.electrode(e).label; <span class="keyword">end</span>
0282           <span class="keyword">otherwise</span>; error(<span class="string">'value of number_electrodes not understood'</span>);
0283        <span class="keyword">end</span>
0284        hh= text(mean(vx)+ctr_x, mean(vy)+ctr_y, txt);
0285        fontsize= <a href="#_sub8" class="code" title="subfunction fontsize= getfontsizefromnumber_electrodes(number_electrodes)">getfontsizefromnumber_electrodes</a>(number_electrodes);
0286        set(hh, <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'FontSize'</span>,fontsize);
0287     <span class="keyword">end</span>
0288 <span class="keyword">end</span>
0289 
0290 <a name="_sub7" href="#_subfunctions" class="code">function show_electrodes_surf(mdl, number_electrodes)</a>
0291     <span class="keyword">if</span> ~isfield(mdl,<span class="string">'electrode'</span>); <span class="keyword">return</span>; <span class="keyword">end</span>
0292 
0293     ee= <a href="#_sub21" class="code" title="subfunction ee= get_boundary( mdl )">get_boundary</a>( mdl );
0294     ctr_x= mean(mdl.nodes(:,1));
0295     ctr_y= mean(mdl.nodes(:,2));
0296     ctr_z= mean(mdl.nodes(:,3));
0297 <span class="comment">% scale away from model</span>
0298 
0299 <span class="keyword">for</span> e=1:length(mdl.electrode)
0300     <span class="keyword">if</span> isfield(mdl.electrode(e),<span class="string">'pos'</span>) &amp;&amp; ~isfield(mdl.electrode(e),<span class="string">'nodes'</span>)
0301         vx = mdl.electrode(e).pos(:,1) - ctr_x;
0302         vy = mdl.electrode(e).pos(:,2) - ctr_y;
0303         vz = mdl.electrode(e).pos(:,3) - ctr_z;
0304         idx = 1:length(vx);
0305         S = 1.00;
0306     <span class="keyword">else</span>
0307         elec_nodes= mdl.electrode(e).nodes;
0308         
0309         S= 1.00;
0310         vx= (mdl.nodes(elec_nodes,1) - ctr_x);
0311         vy= (mdl.nodes(elec_nodes,2) - ctr_y);
0312         vz= (mdl.nodes(elec_nodes,3) - ctr_z);
0313     <span class="keyword">end</span>
0314     <span class="keyword">if</span> isempty(vx), <span class="keyword">continue</span>, <span class="keyword">end</span>
0315     
0316     <span class="comment">% sort nodes around the model (to avoid crossed lines)</span>
0317     <span class="comment">% TODO: figure out what to do in different directions</span>
0318     [jnk,idx] = sort(unwrap(atan2( vy, vx )));
0319     
0320     ecolour = <a href="#_sub19" class="code" title="subfunction colour = get_elec_colour(elec_struct, elec_num)">get_elec_colour</a>(mdl.electrode(e), e );
0321     <span class="keyword">if</span> numel(vx) == 1
0322        <span class="comment">% Point Electrode Models: put a circle around the node</span>
0323        line(S*vx(idx)+ctr_x,S*vy(idx)+ctr_y, S*vz(idx)+ctr_z,  <span class="keyword">...</span>
0324             <span class="string">'LineWidth'</span>, 2, <span class="string">'LineStyle'</span>,<span class="string">'-'</span>,<span class="string">'Color'</span>, ecolour, <span class="keyword">...</span>
0325             <span class="string">'Marker'</span>,<span class="string">'o'</span>,<span class="string">'MarkerSize'</span>, 6,<span class="string">'MarkerEdgeColor'</span>,ecolour);
0326     <span class="keyword">else</span>
0327        <span class="comment">% Complete/Shunt Electrode Models (multiple nodes per electrode)</span>
0328        <span class="comment">%  put a line along the edges that form the electrode</span>
0329        line(vx(idx)+ctr_x,vy(idx)+ctr_y, vz(idx)+ctr_z, <span class="keyword">...</span>
0330             <span class="string">'LineWidth'</span>, 3, <span class="string">'LineStyle'</span>,<span class="string">'-'</span>,<span class="string">'Color'</span>, ecolour, <span class="keyword">...</span>
0331             <span class="string">'Marker'</span>,<span class="string">'none'</span>,<span class="string">'MarkerSize'</span>, 6,<span class="string">'MarkerEdgeColor'</span>,ecolour);
0332     <span class="keyword">end</span>
0333     <span class="keyword">if</span> number_electrodes
0334        S= 1.05;
0335 <span class="comment">%        vx= (mdl.nodes(elec_nodes,1) - ctr_x)*S;</span>
0336 <span class="comment">%        vy= (mdl.nodes(elec_nodes,2) - ctr_y)*S;</span>
0337 <span class="comment">%        vz= (mdl.nodes(elec_nodes,3) - ctr_z)*S;</span>
0338        <span class="keyword">switch</span> floor(number_electrodes)
0339           <span class="keyword">case</span> {1 true}
0340             txt = num2str(e);
0341           <span class="keyword">case</span> 2
0342              <span class="keyword">try</span>, txt = mdl.electrode(e).label; <span class="keyword">end</span>
0343           <span class="keyword">otherwise</span>; error(<span class="string">'value of number_electrodes not understood'</span>);
0344        <span class="keyword">end</span>
0345        hh= text(S*mean(vx)+ctr_x, S*mean(vy)+ctr_y,S*mean(vz)+ctr_z,txt);
0346        fontsize= <a href="#_sub8" class="code" title="subfunction fontsize= getfontsizefromnumber_electrodes(number_electrodes)">getfontsizefromnumber_electrodes</a>(number_electrodes);
0347        set(hh, <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>, <span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'FontSize'</span>,fontsize);
0348     <span class="keyword">end</span>
0349 <span class="keyword">end</span>
0350 
0351 <span class="comment">% Fontsize is 8, unless number_electrodes = 1.012 =&gt; 12 etc</span>
0352 <a name="_sub8" href="#_subfunctions" class="code">function fontsize= getfontsizefromnumber_electrodes(number_electrodes)</a>
0353    ne = rem(number_electrodes,1);
0354    <span class="keyword">if</span> ne==0; 
0355      fontsize = 8;
0356    <span class="keyword">else</span>
0357      fontsize = round(ne*1000);
0358    <span class="keyword">end</span>
0359 
0360 <a name="_sub9" href="#_subfunctions" class="code">function show_electrodes_3d(mdl, number_electrodes)</a>
0361 <span class="comment">% show electrode positions on model</span>
0362 <span class="keyword">if</span> ~isfield(mdl,<span class="string">'electrode'</span>); <span class="keyword">return</span>; <span class="keyword">end</span>
0363 
0364 ee= <a href="#_sub21" class="code" title="subfunction ee= get_boundary( mdl )">get_boundary</a>( mdl );
0365 <span class="keyword">for</span> e=1:length(mdl.electrode)
0366     colour = <a href="#_sub19" class="code" title="subfunction colour = get_elec_colour(elec_struct, elec_num)">get_elec_colour</a>(mdl.electrode(e), e);
0367     elece = mdl.electrode(e);
0368     
0369     <span class="keyword">if</span> isfield(elece,<span class="string">'pos'</span>) &amp;&amp; ~isfield(mdl.electrode(e),<span class="string">'nodes'</span>)
0370         <a href="#_sub7" class="code" title="subfunction show_electrodes_surf(mdl, number_electrodes)">show_electrodes_surf</a>(mdl, number_electrodes);
0371         <span class="keyword">return</span>
0372     <span class="keyword">end</span>
0373     elec_nodes= elece.nodes;
0374     
0375     
0376     <span class="keyword">if</span> isfield(elece,<span class="string">'faces'</span>) &amp;&amp; isempty(elec_nodes);
0377         faces= elece.faces;
0378         hh= patch(struct(<span class="string">'vertices'</span>,mdl.nodes,<span class="string">'faces'</span>,faces));
0379         <span class="comment">% need 'direct' otherwise colourmap is screwed up</span>
0380         set(hh,<span class="string">'FaceColor'</span>,colour, <span class="string">'FaceLighting'</span>,<span class="string">'none'</span>, <span class="string">'CDataMapping'</span>, <span class="string">'direct'</span> );
0381         el_nodes = mdl.nodes(unique(faces),:);
0382         <a href="#_sub10" class="code" title="subfunction number_elecs_3d(number_electrodes, e, mdl, el_nodes )">number_elecs_3d</a>(number_electrodes, e, mdl, el_nodes )
0383     <span class="keyword">elseif</span> isempty(elec_nodes)
0384         <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'show_fem: WARNING: electrode %d has no nodes/faces/pos. Not showing.'</span>,e,2);
0385     <span class="keyword">elseif</span> length(elec_nodes) == 1  <span class="comment">% point electrode model</span>
0386         vtx= mdl.nodes(elec_nodes,:);
0387         line(vtx(1),vtx(2),vtx(3), <span class="keyword">...</span>
0388             <span class="string">'Marker'</span>,<span class="string">'o'</span>,<span class="string">'MarkerSize'</span>,12, <span class="keyword">...</span>
0389             <span class="string">'MarkerFaceColor'</span>,colour, <span class="string">'MarkerEdgeColor'</span>, colour);
0390         <span class="keyword">if</span> number_electrodes
0391             hh= text(vtx(1),vtx(2),vtx(3), num2str(e));
0392             set(hh, <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>);
0393             fontsize= <a href="#_sub8" class="code" title="subfunction fontsize= getfontsizefromnumber_electrodes(number_electrodes)">getfontsizefromnumber_electrodes</a>(number_electrodes);
0394             set(hh,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Color'</span>,[.8,.2,0],<span class="string">'FontSize'</span>,fontsize);
0395         <span class="keyword">end</span>
0396     <span class="keyword">else</span>
0397         <span class="comment">% find elems on boundary attached to this electrode</span>
0398         map = zeros(length(mdl.nodes),1);
0399         map(elece.nodes) = 1;
0400         ec = map(ee);
0401         sels= find(all(ec'));
0402         
0403         ee= <a href="#_sub21" class="code" title="subfunction ee= get_boundary( mdl )">get_boundary</a>( mdl );
0404         <a href="#_sub12" class="code" title="subfunction paint_electrodes(sel,srf,vtx, colour, show_num);">paint_electrodes</a>(sels,ee,mdl.nodes,colour,number_electrodes);
0405         
0406         el_nodes= mdl.nodes(unique(ee(sels,:)),:);
0407         <a href="#_sub10" class="code" title="subfunction number_elecs_3d(number_electrodes, e, mdl, el_nodes )">number_elecs_3d</a>(number_electrodes, e, mdl, el_nodes );
0408     <span class="keyword">end</span>
0409 <span class="keyword">end</span>
0410 
0411 <a name="_sub10" href="#_subfunctions" class="code">function number_elecs_3d(number_electrodes, e, mdl, el_nodes )</a>
0412    <span class="keyword">switch</span> floor(number_electrodes)
0413       <span class="keyword">case</span> {0,false}
0414          <span class="keyword">return</span>
0415       <span class="keyword">case</span> {1 true}
0416          txt = num2str(e);
0417       <span class="keyword">case</span> 2
0418          <span class="keyword">try</span>, txt = mdl.electrode(e).label; <span class="keyword">end</span>
0419       <span class="keyword">otherwise</span>; error(<span class="string">'value of number_electrodes not understood'</span>);
0420    <span class="keyword">end</span>
0421    hh=text( mean(el_nodes(:,1)), <span class="keyword">...</span>
0422             mean(el_nodes(:,2)), <span class="keyword">...</span>
0423             mean(el_nodes(:,3)), txt );
0424    fontsize= <a href="#_sub8" class="code" title="subfunction fontsize= getfontsizefromnumber_electrodes(number_electrodes)">getfontsizefromnumber_electrodes</a>(number_electrodes);
0425    set(hh,<span class="string">'FontWeight'</span>,<span class="string">'bold'</span>,<span class="string">'Color'</span>,[.8,.2,0],<span class="string">'FontSize'</span>,fontsize);
0426 
0427 <a name="_sub11" href="#_subfunctions" class="code">function show_inhomogeneities( elem_data, mdl, img, opt)</a>
0428 <span class="comment">% show</span>
0429 <span class="keyword">if</span> size(elem_data,2)&gt;1
0430    q = warning(<span class="string">'query'</span>,<span class="string">'backtrace'</span>);
0431    warning(<span class="string">'on'</span>,<span class="string">'backtrace'</span>);
0432    warning(<span class="string">'EIDORS:FirstImageOnly'</span>,<span class="string">'show_fem only shows first image'</span>);
0433    warning(q.state,<span class="string">'backtrace'</span>);
0434 <span class="comment">%    eidors_msg('warning: show_fem only shows first image',1);</span>
0435 <span class="keyword">end</span>
0436 <span class="keyword">if</span> 0
0437     hh= <a href="#_sub23" class="code" title="subfunction hh_=repaint_inho(mat,mat_ref,vtx,simp, thresh, clr_def);">repaint_inho</a>(elem_data(:,1), <span class="string">'use_global'</span> , <span class="keyword">...</span>
0438         mdl.nodes, mdl.elems, <span class="keyword">...</span>
0439         opt.transparency_thresh, img);
0440 <span class="keyword">else</span>
0441     hh = <a href="#_sub22" class="code" title="subfunction hh = paint_inho(data, nodes, elems, thresh, img)">paint_inho</a>(elem_data(:,1),mdl.nodes, mdl.elems, <span class="keyword">...</span>
0442       opt.transparency_thresh, img);
0443 <span class="keyword">end</span>
0444 
0445 <span class="keyword">try</span>;
0446     set(hh,<span class="string">'FaceAlpha'</span>,mdl.show_fem.alpha_inhomogeneities);
0447 <span class="keyword">end</span>
0448 <span class="keyword">if</span> <a href="num_lights.html" class="code" title="function N = num_lights(ax)">num_lights</a> == 0 <span class="comment">% matlab has a maximum of 8</span>
0449    camlight(<span class="string">'left'</span>);
0450 <span class="keyword">end</span>
0451 lighting(<span class="string">'none'</span>); <span class="comment">% lighting doesn't help much</span>
0452 
0453 
0454 <a name="_sub12" href="#_subfunctions" class="code">function paint_electrodes(sel,srf,vtx, colour, show_num);</a>
0455    <span class="keyword">if</span> isempty(sel); <span class="keyword">return</span>; <span class="keyword">end</span>  <span class="comment">% Not required after matlab 2014</span>
0456 
0457    [u n m] = unique(srf(sel,:));
0458    fv.vertices = vtx(u,:);
0459    fv.faces = reshape(m,[],3);
0460    h = patch(fv,<span class="string">'FaceColor'</span>,colour);
0461    <span class="comment">% need 'direct' otherwise colourmap is screwed up</span>
0462    set(h, <span class="string">'FaceLighting'</span>,<span class="string">'none'</span>, <span class="string">'CDataMapping'</span>, <span class="string">'direct'</span> );
0463 
0464 <a name="_sub13" href="#_subfunctions" class="code">function hh= show_3d_fem( mdl, options )</a>
0465    <span class="keyword">if</span> <a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>(mdl) == 3  <span class="comment">% volume simplices</span>
0466       ee= <a href="#_sub21" class="code" title="subfunction ee= get_boundary( mdl )">get_boundary</a>( mdl );
0467    <span class="keyword">elseif</span> <a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>(mdl) == 2  <span class="comment">% volume simplices</span>
0468       ee= mdl.elems;
0469    <span class="keyword">elseif</span> <a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>(mdl) == 1  <span class="comment">% just lines between elements. Resistors?</span>
0470       ee= mdl.elems;
0471    <span class="keyword">else</span>
0472       error(<span class="string">'Simplices are not 2D or 3D in mdl. Unsure how to display'</span>);
0473    <span class="keyword">end</span>
0474    hh= trimesh(ee, mdl.nodes(:,1), <span class="keyword">...</span>
0475                    mdl.nodes(:,2), <span class="keyword">...</span>
0476                    mdl.nodes(:,3));
0477    set(hh, <span class="string">'EdgeColor'</span>, [0,0,0]);
0478    axis(<span class="string">'image'</span>);
0479    hidden(<span class="string">'off'</span>);
0480 
0481 <a name="_sub14" href="#_subfunctions" class="code">function hh=show_2d_fem( mdl, colours, imgno )</a>
0482   szcolr = size(colours);
0483   <span class="keyword">if</span> nargin&lt;3;
0484       imgno = 1;
0485       <span class="keyword">if</span> szcolr(1:2)&gt;1; 
0486           <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: show_fem only shows first image'</span>,1);
0487       <span class="keyword">end</span>
0488   <span class="keyword">end</span>
0489 
0490   <span class="keyword">if</span> szcolr(1:2) == [1,3]  <span class="comment">% no reconstruction  - just use white</span>
0491      hh= patch(<span class="string">'Faces'</span>,mdl.elems,<span class="string">'Vertices'</span>,mdl.nodes, <span class="string">'facecolor'</span>,colours);
0492   <span class="keyword">elseif</span> size(colours,1) == <a href="../../../eidors/models/num_elems.html" class="code" title="function num = num_elems( mdl );">num_elems</a>(mdl);
0493      colours = squeeze(colours(:,imgno,:));
0494 
0495      hh= patch(<span class="string">'Faces'</span>,mdl.elems,<span class="string">'Vertices'</span>,mdl.nodes, <span class="string">'facecolor'</span>,<span class="string">'flat'</span>, <span class="keyword">...</span>
0496                <span class="string">'facevertexcdata'</span>,colours,<span class="string">'CDataMapping'</span>,<span class="string">'direct'</span>); 
0497   <span class="keyword">elseif</span> size(colours,1) == <a href="../../../eidors/models/num_nodes.html" class="code" title="function num = num_nodes( mdl );">num_nodes</a>(mdl);
0498      colours = squeeze(colours(:,imgno,:));
0499      <span class="comment">% 'interp' not supported in octave</span>
0500      hh= patch(<span class="string">'Faces'</span>,mdl.elems,<span class="string">'Vertices'</span>,mdl.nodes, <span class="string">'facecolor'</span>,<span class="string">'interp'</span>, <span class="keyword">...</span>
0501                <span class="string">'facevertexcdata'</span>,colours,<span class="string">'CDataMapping'</span>,<span class="string">'direct'</span>); 
0502   <span class="keyword">else</span>
0503     <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: image elements and mesh do not match. Showing grey'</span>,1);
0504     colours= [1,1,1]/2; <span class="comment">% Grey to show we're not sure</span>
0505     hh= patch(<span class="string">'Faces'</span>,mdl.elems,<span class="string">'Vertices'</span>,mdl.nodes, <span class="string">'facecolor'</span>,colours);
0506   <span class="keyword">end</span>
0507 
0508   set(hh, <span class="string">'FaceLighting'</span>,<span class="string">'none'</span>, <span class="string">'CDataMapping'</span>, <span class="string">'direct'</span> );
0509 
0510 <a name="_sub15" href="#_subfunctions" class="code">function hh=show_2d_fem_oldmatlab( mdl, colours, imgno )</a>
0511   szcolr = size(colours);
0512   <span class="keyword">if</span> nargin&lt;3;
0513       imgno = 1;
0514       <span class="keyword">if</span> szcolr(1:2)&gt;1;  <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: show_fem only shows first image'</span>,1); <span class="keyword">end</span>
0515   <span class="keyword">end</span>
0516   
0517 <span class="comment">% el_pos= avg_electrode_posn( mdl );</span>
0518 <span class="comment">% plot_2d_mesh(mdl.nodes', mdl.elems', el_pos', .95, [0,0,0]);</span>
0519 
0520   S= 1; <span class="comment">%.95; % shrink factor</span>
0521   elem= mdl.elems'; e= size(elem,2);
0522   node= mdl.nodes'; n= size(node,2);
0523   Xs=zeros(3,e);
0524   Xs(:)=mdl.nodes(elem(:),1);
0525   Xs= S*Xs+ (1-S)*ones(3,1)*mean(Xs);
0526   Ys=zeros(3,e); Ys(:)=mdl.nodes(elem(:),2);
0527   Ys= S*Ys+ (1-S)*ones(3,1)*mean(Ys);
0528   Zs = zeros(size(Xs));
0529   <span class="keyword">if</span> szcolr(1:2) == [1,3]  <span class="comment">% no reconstruction  - just use white</span>
0530      hh= patch(Xs,Ys,zeros(3,e),colours);
0531   <span class="keyword">elseif</span> size(colours,1) == e <span class="comment">% defined on elems</span>
0532 <span class="comment">% THE STUPID MATLAB 7 WILL RESET THE COLOURBAR WHENEVER YOU DO A PATCH. DAMN.</span>
0533      colours = permute(colours(:,imgno,:),[2,1,3]);
0534   <span class="keyword">elseif</span> size(colours,1) == n  <span class="comment">% multiple images</span>
0535      colours = colours(elem(:), imgno, :);
0536      colours = reshape( colours, size(elem,1), size(elem,2), []);
0537   <span class="keyword">else</span>
0538     <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'warning: image elements and mesh do not match. Showing grey'</span>,1);
0539     colours= [1,1,1]/2; <span class="comment">% Grey to show we're not sure</span>
0540   <span class="keyword">end</span>
0541 
0542   hh= patch(Xs,Ys,Zs,colours);
0543   set(hh, <span class="string">'FaceLighting'</span>,<span class="string">'none'</span>, <span class="string">'CDataMapping'</span>, <span class="string">'direct'</span> );
0544   <span class="comment">% FOR NODE RGB MATLAB SCREWS UP THE COLOURS FOR US (ONCE AGAIN). THERE MUST</span>
0545   <span class="comment">% BE SOME KIND OF SECRET FLAG@@@</span>
0546 
0547   max_x= max(mdl.nodes(:,1)); min_x= min(mdl.nodes(:,1));
0548   max_y= max(mdl.nodes(:,2)); min_y= min(mdl.nodes(:,2));
0549   axis([ mean([max_x,min_x]) + 0.55*[-1,1]*(max_x-min_x), <span class="keyword">...</span>
0550          mean([max_y,min_y]) + 0.55*[-1,1]*(max_y-min_y) ]);
0551 
0552 
0553 
0554 <a name="_sub16" href="#_subfunctions" class="code">function old_code_3d_plot</a>
0555   domesnum= 0;
0556   donodenum= 0;
0557   dotext=0;
0558 
0559   xxx=zeros(4,e); xxx(:)=NODE(1,ELEM(:));
0560   xxx= S*xxx+ (1-S)*ones(4,1)*mean(xxx);
0561   yyy=zeros(4,e); yyy(:)=NODE(2,ELEM(:));
0562   yyy= S*yyy+ (1-S)*ones(4,1)*mean(yyy);
0563   zzz=zeros(4,e); zzz(:)=NODE(3,ELEM(:));
0564   zzz= S*zzz+ (1-S)*ones(4,1)*mean(zzz);
0565   plot3( xxx([1 2 3 1 4 2 3 4],:), <span class="keyword">...</span>
0566          yyy([1 2 3 1 4 2 3 4],:), <span class="keyword">...</span>
0567          zzz([1 2 3 1 4 2 3 4],:),<span class="string">'k'</span> );
0568   hold on;
0569   xy=NODE(1:2,MES(1,:));
0570   plot3(arrow*xy,arrow*[0 1;-1 0]*xy,ones(8,1)*NODE(3,MES(1,:)),<span class="string">'b'</span>) 
0571   hold off;
0572   axis([ [-1.1 1.1]*max(NODE(1,:)) [-1.1 1.1]*max(NODE(2,:)) <span class="keyword">...</span>
0573          [-1.1 1.1]*max(NODE(3,:))  ])
0574 
0575 
0576 <a name="_sub17" href="#_subfunctions" class="code">function plot_2d_mesh(NODE,ELEM,el_pos, S, options)</a>
0577 <span class="comment">%  if options(1) -&gt; do mesh num</span>
0578 <span class="comment">%  if options(2) -&gt; do node num</span>
0579 <span class="comment">%  if options(3) -&gt; do text</span>
0580 <span class="comment">%  S=.95; % shrink simplices by this factor</span>
0581 
0582   e=size(ELEM,2);
0583   d=size(ELEM,1);
0584   R= zeros(1,e);
0585 
0586 
0587   arrow= [1.02 0;1.06 .05;1.06 .02;1.1 .02; <span class="keyword">...</span>
0588           1.1 -.02; 1.06 -.02;1.06 -.05;1.02 0];
0589   <span class="comment">% arrow= [1.06 0;1.18 .15;1.18 .06;1.3 .06; ...</span>
0590   <span class="comment">%          1.3 -.06; 1.18 -.06;1.18 -.15;1.06 0];</span>
0591   xxx=zeros(3,e); xxx(:)=NODE(1,ELEM(:));
0592   xxx= S*xxx+ (1-S)*ones(3,1)*mean(xxx);
0593   xxx= [xxx;xxx(1,:)];
0594 
0595   yyy=zeros(3,e); yyy(:)=NODE(2,ELEM(:));
0596   yyy= S*yyy+ (1-S)*ones(3,1)*mean(yyy);
0597   yyy= [yyy;yyy(1,:)];
0598 
0599   <span class="keyword">if</span> isempty(el_pos)
0600       plot(xxx,yyy,<span class="string">'b'</span>);
0601   <span class="keyword">else</span>
0602       xy= el_pos;
0603       hh=plot([xxx;xxx(1,:)],[yyy;yyy(1,:)],<span class="string">'b'</span>, <span class="keyword">...</span>
0604               arrow*xy,arrow*[0 1;-1 0]*xy,<span class="string">'r'</span>);
0605       set(hh(find(R&gt;0)),<span class="string">'Color'</span>,[1 0 0],<span class="string">'LineWidth'</span>,2);
0606       set(hh(find(R&lt;0)),<span class="string">'Color'</span>,[0 0 1],<span class="string">'LineWidth'</span>,2);
0607   <span class="keyword">end</span>
0608 
0609   <span class="keyword">if</span> options(1) <span class="comment">%domesnum</span>
0610     mesnum= reshape(sprintf(<span class="string">' %-2d'</span>,[0:15]),3,16)';
0611     text(NODE(1,MES(1,:))*1.08,NODE(2,MES(1,:))*1.08,mesnum, <span class="keyword">...</span>
0612          <span class="string">'Color'</span>,<span class="string">'green'</span>,<span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>);
0613   <span class="keyword">end</span> <span class="comment">%if domesnum</span>
0614 
0615   <span class="keyword">if</span> options(2) <span class="comment">%donodenum</span>
0616     nodenum= reshape(sprintf(<span class="string">'%3d'</span>,1:length(NODE)),3,length(NODE))';
0617     text(NODE(1,:),NODE(2,:),nodenum, <span class="keyword">...</span>
0618          <span class="string">'Color'</span>,<span class="string">'yellow'</span>,<span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>,<span class="string">'FontSize'</span>,8);
0619   <span class="keyword">end</span> <span class="comment">%if domesnum</span>
0620 
0621   <span class="keyword">if</span> options(3) <span class="comment">%dotext</span>
0622     numeros= reshape(sprintf(<span class="string">'%4d'</span>,[1:e]),4,e)';
0623 <span class="comment">%   decal= ( 2-0.2*floor(log10([1:e]')))*sqrt(axis*axis'/4)/100;</span>
0624     decal= .02;
0625     xcoor=mean(NODE(2*ELEM-1))';
0626     ycoor=mean(NODE(2*ELEM))';
0627     text(xcoor-decal,ycoor,numeros,<span class="string">'FontSize'</span>,8, <span class="keyword">...</span>
0628          <span class="string">'HorizontalAlignment'</span>,<span class="string">'center'</span>);
0629 
0630   <span class="keyword">end</span>  <span class="comment">% if nargin~=0</span>
0631   axis([ [-1.1 1.1]*max(NODE(1,:)) [-1.1 1.1]*max(NODE(2,:)) ])
0632 
0633 <a name="_sub18" href="#_subfunctions" class="code">function  mes= avg_electrode_posn( mdl )</a>
0634    <span class="keyword">if</span> ~isfield(mdl,<span class="string">'electrode'</span>); mes=[]; <span class="keyword">return</span>; <span class="keyword">end</span>
0635    n_elec= length( mdl.electrode );
0636    nodes = mdl.nodes;
0637    mes= zeros( n_elec, <a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>(mdl) )
0638    <span class="keyword">for</span> i= 1:n_elec
0639       e_nodes=  mdl.electrode(i).nodes;
0640       mes(i,:)= mean( nodes(e_nodes,:) , 1 );
0641    <span class="keyword">end</span>
0642    
0643 <a name="_sub19" href="#_subfunctions" class="code">function colour = get_elec_colour(elec_struct, elec_num)</a>
0644     <span class="keyword">try</span>
0645         colour = elec_struct.colour;
0646     <span class="keyword">catch</span>
0647         colour = <a href="#_sub20" class="code" title="subfunction colour= electr_colour( e);">electr_colour</a>(elec_num);
0648     <span class="keyword">end</span>
0649    
0650    
0651    
0652 <a name="_sub20" href="#_subfunctions" class="code">function colour= electr_colour( e);</a>
0653     <span class="keyword">if</span> e==1;
0654        colour = [0,.7,0]; <span class="comment">% light green electrode #1</span>
0655     <span class="keyword">elseif</span> e==2
0656        colour = [0,.5,0]; <span class="comment">% mid-green electrode #2</span>
0657     <span class="keyword">else</span>
0658        colour = [0,.3,0]; <span class="comment">% dark green</span>
0659     <span class="keyword">end</span>
0660 
0661 <a name="_sub21" href="#_subfunctions" class="code">function ee= get_boundary( mdl )</a>
0662    <span class="keyword">if</span> isfield(mdl,<span class="string">'boundary'</span>)
0663        ee= mdl.boundary;
0664    <span class="keyword">else</span>
0665        <span class="comment">% calc and cache boundary</span>
0666        ee = <a href="../../../eidors/solvers/forward/find_boundary.html" class="code" title="function [srf, idx] = find_boundary(simp);">find_boundary</a>( mdl.elems );
0667    <span class="keyword">end</span>
0668 
0669 <a name="_sub22" href="#_subfunctions" class="code">function hh = paint_inho(data, nodes, elems, thresh, img)</a>
0670     <span class="keyword">if</span> isempty(thresh)
0671         thresh = 1/4;
0672     <span class="keyword">end</span>
0673     [colours,scl_data] = <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>( data, img, 0);
0674     ii = find(abs(scl_data) &gt; thresh &amp; not(isnan(data))); <span class="comment">% NaNs are always transparent</span>
0675 
0676     fc = <span class="string">'flat'</span>;
0677     <span class="keyword">if</span> numel(data) == size(nodes,1)
0678         ii = all(ismember(elems, ii),2);
0679         fc = <span class="string">'interp'</span>;
0680     <span class="keyword">else</span>
0681         colours = colours(ii,:);
0682         <span class="keyword">if</span> size(elems,2) == 4
0683             colours = kron(colours,ones(4,1));
0684         <span class="keyword">end</span>
0685     <span class="keyword">end</span>
0686     <span class="keyword">switch</span> size(elems,2)
0687         <span class="keyword">case</span> 3
0688             idx = [1 2 3];
0689         <span class="keyword">case</span> 4
0690             idx = [1 2 3; 1 2 4; 1 3 4; 2 3 4]';
0691             
0692     <span class="keyword">end</span>
0693     faces = reshape(elems(ii,idx)',3,[])';
0694     
0695     hh = NaN;
0696     <span class="keyword">if</span> ~isempty(faces) <span class="comment">% octave cannot draw pathes without faces</span>
0697         hh = patch(<span class="string">'Faces'</span>,faces,<span class="string">'Vertices'</span>,nodes,<span class="string">'facecolor'</span>,fc,<span class="keyword">...</span>
0698             <span class="string">'facevertexcdata'</span>,colours, <span class="string">'EdgeColor'</span>,<span class="string">'none'</span>,<span class="string">'CDataMapping'</span>,<span class="string">'direct'</span>);
0699    <span class="keyword">end</span>
0700    
0701 <span class="comment">% Function copied from dev/n_polydorides/</span>
0702 <a name="_sub23" href="#_subfunctions" class="code">function hh_=repaint_inho(mat,mat_ref,vtx,simp, thresh, clr_def);</a>
0703 <span class="comment">%function repaint_inho(mat,mat_ref,vtx,simp, thresh);</span>
0704 <span class="comment">%</span>
0705 <span class="comment">%Repaints the simulated inhomogeneity according to the reference</span>
0706 <span class="comment">%distribution. (Increase -&gt; Red, Decrease -&gt; Blue)</span>
0707 <span class="comment">%</span>
0708 <span class="comment">%mat     = The simulated (targeted) distribution.</span>
0709 <span class="comment">%mat_ref = The known initial (homogeneous) distribution.</span>
0710 <span class="comment">%        = Override default unless 'use_global'</span>
0711 <span class="comment">%vtx     = The vertices matrix.</span>
0712 <span class="comment">%simp    = The simplices matrix.</span>
0713 <span class="comment">%thresh  = Threshold to show imaged region (or [] for default)</span>
0714 <span class="comment">%clr_def = Colour definitions val.calc_colours.field etc</span>
0715 
0716 
0717 <span class="keyword">if</span> nargin&lt;5
0718     thresh = [];
0719 <span class="keyword">end</span>
0720 <span class="keyword">if</span> nargin&lt;6
0721     clr_def = [];
0722 <span class="keyword">end</span>
0723 <span class="keyword">if</span> strcmp(mat_ref, <span class="string">'use_global'</span>)
0724    img.calc_colours.ref_level = mat_ref;
0725 <span class="keyword">end</span>
0726 
0727 <span class="keyword">if</span> isempty(thresh)
0728     thresh = 1/4;
0729 <span class="keyword">end</span>
0730 
0731 <span class="comment">% looks best if eidors_colours.greylev &lt; 0</span>
0732 [colours,scl_data] = <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>( mat, clr_def, 0);
0733 ii=find( abs(scl_data) &gt; thresh);
0734 colours= permute(colours(ii,:,:),[2,1,3]);
0735 <span class="keyword">if</span> size(scl_data,1) == size(vtx,1)
0736     ii = find(all(ismember(simp, ii),2));
0737     
0738 <span class="keyword">end</span>
0739 this_x = simp(ii,:);
0740 
0741 
0742 ELEM= vtx';
0743 
0744 Xs=   zeros(3,length(ii));
0745 Ys=   zeros(3,length(ii));
0746 Zs=   zeros(3,length(ii));
0747 <span class="keyword">switch</span>(size(this_x,2))
0748     <span class="keyword">case</span> 3
0749         idx_ = [1;2;3];
0750     <span class="keyword">case</span> 4
0751         idx_ = [[1;2;3], <span class="keyword">...</span>
0752                 [1;2;4], <span class="keyword">...</span>
0753                 [1;3;4], <span class="keyword">...</span>
0754                 [2;3;4]];
0755 <span class="keyword">end</span>
0756 hh_=[];
0757 <span class="keyword">for</span> idx=idx_
0758    Xs(:)=vtx(this_x(:,idx)',1);
0759    Ys(:)=vtx(this_x(:,idx)',2);
0760    Zs(:)=vtx(this_x(:,idx)',3);
0761 
0762    <span class="keyword">if</span> size(colours,1)==1 &amp;&amp; size(colours,2)==3
0763       <span class="comment">% need to work around ^%$#%$# matlab bug which</span>
0764       <span class="comment">% forces an incorrect interpretation is colours of this size</span>
0765       hh= patch(Xs(:,[1:3,1]), <span class="keyword">...</span>
0766                 Ys(:,[1:3,1]), <span class="keyword">...</span>
0767                 Zs(:,[1:3,1]), <span class="keyword">...</span>
0768                 colours(:,[1:3,1]), <span class="keyword">...</span>
0769             <span class="string">'EdgeColor'</span>,<span class="string">'none'</span>,<span class="string">'CDataMapping'</span>,<span class="string">'direct'</span>);
0770    <span class="keyword">else</span>
0771       hh= patch(Xs,Ys,Zs,colours, <span class="keyword">...</span>
0772             <span class="string">'EdgeColor'</span>,<span class="string">'none'</span>,<span class="string">'CDataMapping'</span>,<span class="string">'direct'</span>);
0773    <span class="keyword">end</span>
0774    hh_ = [hh_,hh];
0775 <span class="keyword">end</span>
0776 
0777 
0778 <span class="comment">% TESTS:</span>
0779 <a name="_sub24" href="#_subfunctions" class="code">function do_unit_test</a>
0780    clf
0781    rand(<span class="string">'state'</span>,0);
0782 
0783    img=<a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(<a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c0'</span>,8)); 
0784    img.elem_data=rand(size(img.fwd_model.elems,1),1);
0785    subplot(4,4,1); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img.fwd_model,[0,0,1]) 
0786    title(<span class="string">'regular mesh numbered'</span>);
0787 
0788    imgn = rmfield(img,<span class="string">'elem_data'</span>);
0789    imgn.node_data=rand(size(img.fwd_model.nodes,1),1);
0790    subplot(4,4,9); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(imgn) 
0791    title(<span class="string">'interpolated node colours'</span>);
0792 
0793    img2(1) = img; img2(2) = img;
0794    subplot(4,4,2); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img,[1]);
0795    title(<span class="string">'colours with legend'</span>);
0796    subplot(4,4,3); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img2,[0,1]);
0797    title(<span class="string">'colours with legend'</span>);
0798    img.calc_colours.mapped_colour = 0; <span class="comment">% USE RGB colours</span>
0799    subplot(4,4,4); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img,[0,1,1]);
0800    title(<span class="string">'RGB colours'</span>);
0801    subplot(4,4,4); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img);
0802    title(<span class="string">'RGB colours'</span>);
0803 
0804    img.elem_data = [1:10];
0805    subplot(4,4,12);<a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img); <span class="comment">%Should show grey</span>
0806    title(<span class="string">'error -&gt; show grey'</span>);
0807 
0808    imgn.calc_colours.mapped_colour = 0; <span class="comment">% USE RGB colours</span>
0809    subplot(4,4,10);<a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(imgn,[0,1]) 
0810    title(<span class="string">'interpolated node colours'</span>);
0811 
0812 
0813    subplot(4,4,11);hh=<a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(imgn); set(hh,<span class="string">'EdgeColor'</span>,[0,0,1]);
0814    title(<span class="string">'with edge colours'</span>);
0815 
0816    img3=<a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>(<a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'n3r2'</span>,[16,2]));
0817    img3.elem_data= randn(828,1);                       
0818    subplot(4,4,5); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img3.fwd_model) 
0819    subplot(4,4,6); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img3,[1])
0820    subplot(4,4,7); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img3,[1,1])
0821    subplot(4,4,8); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(img3,[1,1,1])
0822 
0823    fmdl=getfield(<a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c0'</span>,8),<span class="string">'fwd_model'</span>); 
0824    fmdl.mat_idx{1} = [3,7,13,14]; fmdl.mat_idx{2} = [14,23];
0825    fmdlA= <a href="../../../eidors/meshing/mat_idx_to_electrode.html" class="code" title="function [fmdl,rm_elems] = mat_idx_to_electrode(fmdl, mat_idxes)">mat_idx_to_electrode</a>(fmdl,{1,2});
0826    subplot(4,4,13); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(fmdlA,[0,0,1]); title <span class="string">'elec faces'</span>; 
0827 
0828    fmdl.mat_idx_to_electrode.nodes_electrode= true;
0829    fmdlB= <a href="../../../eidors/meshing/mat_idx_to_electrode.html" class="code" title="function [fmdl,rm_elems] = mat_idx_to_electrode(fmdl, mat_idxes)">mat_idx_to_electrode</a>(fmdl,{1,2});
0830    subplot(4,4,14); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(fmdlB,[0,0,1]); title <span class="string">'elec nodes'</span>;
0831 
0832    fmdl3=getfield(<a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'n3r2'</span>,[16,2]),<span class="string">'fwd_model'</span>);
0833    fmdl3.electrode(1:16)= [];
0834    fmdl3.mat_idx{1}= [543;546;549;552];
0835    fmdl3.mat_idx{2}= [817;818;819;820;821;822;823;824;825;826;827;828];
0836    fmdlA= <a href="../../../eidors/meshing/mat_idx_to_electrode.html" class="code" title="function [fmdl,rm_elems] = mat_idx_to_electrode(fmdl, mat_idxes)">mat_idx_to_electrode</a>(fmdl3,{1:2});
0837 
0838    subplot(4,4,15); <a href="show_fem.html" class="code" title="function hh=show_fem( mdl, options)">show_fem</a>(fmdlA,[0,1]); view(0,20);</pre></div>
<hr><address>Generated on Sun 29-Dec-2024 19:54:43 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>