<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of calc_slices</title>
  <meta name="keywords" content="calc_slices">
  <meta name="description" content="calc_slices (img, levels, clim  ) show slices at levels of an">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">eidors</a> &gt; <a href="#">graphics</a> &gt; <a href="index.html">matlab</a> &gt; calc_slices.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/graphics/matlab&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>calc_slices
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>calc_slices (img, levels, clim  ) show slices at levels of an</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function rimg = calc_slices( img, levels ); </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> calc_slices (img, levels, clim  ) show slices at levels of an
             using a fast rendering algorithm
 img    = EIDORS image struct, or array of I images
 levels = any level definition accepted by level_model_slice

 PARAMETERS:
   img.calc_slices.filter % Filter to be applied to images
      Example:    img.calc_slices.filter = ones(3)/9
   img.calc_slices.scale  % Scaling to apply to images
   img.get_img_data.frame_select = which frames of image to display

 rimg= np x np x I x L where np is 128 by default

   np can be adjusted by calc_colours('npoints')
     or by setting
   img.fwd_model.mdl_slice_mapper.{npx, npy}
        see help of mdl_slice_mapper for more options

 See also: <a href="level_model_slice.html" class="code" title="function [out, out2, out3, out4] = level_model_slice(varargin)">LEVEL_MODEL_SLICE</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>	EIDORS_MSG eidors progress and status messages</li><li><a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>	[colours,scl_data]= calc_colours(img, set_value, do_colourbar)</li><li><a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>	calc_slices (img, levels, clim  ) show slices at levels of an</li><li><a href="level_model_slice.html" class="code" title="function [out, out2, out3, out4] = level_model_slice(varargin)">level_model_slice</a>	LEVEL_MODEL_SLICE - level 3D points for slicing at z=0</li><li><a href="mdl_slice_mapper.html" class="code" title="function map = mdl_slice_mapper( fmdl, maptype )">mdl_slice_mapper</a>	MDL_SLICE_MAPPER: map pixels to FEM elements or nodes</li><li><a href="../../../eidors/models/data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>	DATA_MAPPER maps img.params data to elem or node data</li><li><a href="../../../eidors/models/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>	INTERP_MESH: calculate interpolation points onto mdl elements</li><li><a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>	MDL_DIM: dimension of model space (are nodes in 2D or 3D space)</li><li><a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>	MK_COMMON_MODEL: make common EIT models</li><li><a href="../../../eidors/models/mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>	MK_IMAGE: create eidors image object</li><li><a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>	CALC_JACOBIAN_BKGND: calculate background image around</li><li><a href="../../../eidors/solvers/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>	GET_IMG_DATA: get parameter data from eidors image object</li><li><a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>	UNIT_TEST_CMP: compare matrices in eidors output</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/algorithms/calc_posn_resolution.html" class="code" title="function [br,pos]= calc_posn_resolution( img, fwd_model)">calc_posn_resolution</a>	CALC_POSN_RESOLUTION: calculate posn and resolution of a target</li><li><a href="../../../eidors/algorithms/eval_GREIT_fig_merit.html" class="code" title="function params = eval_GREIT_fig_merit(imgs, xyzr_pt)">eval_GREIT_fig_merit</a>	EVAL_GREIT_FIG_MERIT: calculate GREIT figures of merit for images</li><li><a href="../../../eidors/deprecated/solve_RM_2Dslice.html" class="code" title="function imdl = select_RM_slice(imdl, sel_fcn)">solve_RM_2Dslice</a>	SELECT_RM_SLICE: cut slices out of an inverse model with a</li><li><a href="animate_reconstructions.html" class="code" title="function fname_out= animate_reconstructions(fname, imgs);">animate_reconstructions</a>	animate_reconstructions(fname, imgs);</li><li><a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>	calc_slices (img, levels, clim  ) show slices at levels of an</li><li><a href="mk_mosaic.html" class="code" title="function r_img = mk_mosaic(rimg, sep, vh, n_col)">mk_mosaic</a>	MK_MOSAIC Arrange multidimensional image matrix for display.</li><li><a href="show_slices.html" class="code" title="function out_img= show_slices( img, levels, vh )">show_slices</a>	out_img = show_slices (img, levels ) show slices at levels of an</li><li><a href="../../../eidors/interface/eidors_saveimg.html" class="code" title="function eidors_saveimg( img, fname, format, pp )">eidors_saveimg</a>	EIDORS saveimg - save reconstructed image files in formats</li><li><a href="../../../eidors/interface/igt2img.html" class="code" title="function img = igt2img(igt)">igt2img</a>	IGT2IMG constructs an EIDORS IMG struct from an IGT frames-by-912 matrix.</li><li><a href="../../../eidors/interface/img2igt.html" class="code" title="function igt = img2igt(img)">img2igt</a>	IMG2IGT returns an IGT-compatible image matrix from any EIDORS</li><li><a href="../../../eidors/interface/write_ibex_mat.html" class="code" title="function write_ibex_mat(fname, fmdl, imgs, frame_rate)">write_ibex_mat</a>	WRITE_IBEX_MAT:  write images to ibex mat file format</li><li><a href="../../../eidors/models/map_RM_slice.html" class="code" title="function imdl = map_RM_slice(imdl,varargin)">map_RM_slice</a>	map_RM_slice - map a 3D reconstruction matrix to an arbitrary 2D slice</li><li><a href="../../../eidors/models/mk_GREIT_model.html" class="code" title="function [imdl, weight]= mk_GREIT_model( fmdl, radius, weight, options )">mk_GREIT_model</a>	MK_GREIT_MODEL: make EIDORS inverse models using the GREIT approach</li><li><a href="../../../eidors/models/mk_pixel_slice.html" class="code" title="function [imdl fmdl] = mk_pixel_slice(imdl,level,opt)">mk_pixel_slice</a>	MK_PIXEL_SLICE create a pixel model to reconstruct on</li><li><a href="../../../eidors/models/select_RM_slice.html" class="code" title="function imdl = select_RM_slice(imdl, sel_fcn)">select_RM_slice</a>	SELECT_RM_SLICE: cut slices out of an inverse model with a</li><li><a href="../../../eidors/solvers/inverse/calc_image_SNR.html" class="code" title="function [SNRmean, SE, debug] = calc_image_SNR(imdl, hyperparameter, doPlot)">calc_image_SNR</a>	% CALC_IMAGE_SNR: Calculates the signal-to-noise ratio (SNR) in the image</li><li><a href="../../../eidors/tests/test_colour_direction.html" class="code" title="">test_colour_direction</a>	Test colour mapping</li><li><a href="../../../eidors/tools/test_performance.html" class="code" title="function [r, params] =  test_performance( imdls, fmdl );">test_performance</a>	TEST_PERFORMANCE: test of difference reconstruction algorithms</li><li><a href="../../../eidors/tools/test_performance_img.html" class="code" title="function [params_img] =  test_performance_img( imdls, fmdl );">test_performance_img</a>	TEST_PERFORMANCE: test of difference reconstruction algorithms</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function rimg = calc_this_slice( img, levels, np)</a></li><li><a href="#_sub2" class="code">function rimg= calc_image_nearestnodes( node_data, fwd_model)</a></li><li><a href="#_sub3" class="code">function rimg= calc_image_nodes( node_data, fwd_model)</a></li><li><a href="#_sub4" class="code">function rimg= calc_image_elems( elem_data, fwd_model)</a></li><li><a href="#_sub5" class="code">function  rimg = filter_image(rimg, filt);</a></li><li><a href="#_sub6" class="code">function do_unit_test</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function rimg = calc_slices( img, levels );</a>
0002 <span class="comment">% calc_slices (img, levels, clim  ) show slices at levels of an</span>
0003 <span class="comment">%             using a fast rendering algorithm</span>
0004 <span class="comment">% img    = EIDORS image struct, or array of I images</span>
0005 <span class="comment">% levels = any level definition accepted by level_model_slice</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% PARAMETERS:</span>
0008 <span class="comment">%   img.calc_slices.filter % Filter to be applied to images</span>
0009 <span class="comment">%      Example:    img.calc_slices.filter = ones(3)/9</span>
0010 <span class="comment">%   img.calc_slices.scale  % Scaling to apply to images</span>
0011 <span class="comment">%   img.get_img_data.frame_select = which frames of image to display</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% rimg= np x np x I x L where np is 128 by default</span>
0014 <span class="comment">%</span>
0015 <span class="comment">%   np can be adjusted by calc_colours('npoints')</span>
0016 <span class="comment">%     or by setting</span>
0017 <span class="comment">%   img.fwd_model.mdl_slice_mapper.{npx, npy}</span>
0018 <span class="comment">%        see help of mdl_slice_mapper for more options</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% See also: LEVEL_MODEL_SLICE</span>
0021 
0022 <span class="comment">% (C) 2006-2024 Andy Adler and Bartek Grychtol.</span>
0023 <span class="comment">% License: GPL version 2 or version 3</span>
0024 <span class="comment">% $Id: calc_slices.m 6964 2024-09-27 13:30:40Z aadler $</span>
0025 
0026 <span class="keyword">if</span> ischar(img) &amp;&amp; strcmp(img,<span class="string">'UNIT_TEST'</span>); <a href="#_sub6" class="code" title="subfunction do_unit_test">do_unit_test</a>; <span class="keyword">return</span>; <span class="keyword">end</span>
0027 
0028 np = <a href="calc_colours.html" class="code" title="function [colours,scl_data]= calc_colours(img, set_value, do_colourbar)">calc_colours</a>(<span class="string">'npoints'</span>);
0029 <span class="keyword">try</span> np = img(1).calc_colours.npoints; <span class="keyword">end</span>
0030 
0031 <span class="keyword">if</span> nargin &lt; 2, levels = []; <span class="keyword">end</span>
0032 
0033 <span class="keyword">if</span> isfield(img, <span class="string">'calc_slices'</span>) &amp;&amp; isfield(img.calc_slices, <span class="string">'levels'</span>)
0034     warning(<span class="string">'EIDORS:CALC_SLICES:DeprecatedInterface'</span>, <span class="keyword">...</span>
0035         [<span class="string">'Ingoring deprecated img.calc_slices.levels definition. '</span><span class="keyword">...</span>
0036         <span class="string">'Use img.fwd_model.mdl_slice_mapper.level instead. '</span><span class="keyword">...</span>
0037         <span class="string">'See help level_model_slice for valid inputs.'</span>])
0038     img.calc_slices = rmfield(img.calc_slices, <span class="string">'levels'</span>);
0039 <span class="keyword">end</span>
0040 
0041 
0042 
0043 img = <a href="../../../eidors/models/data_mapper.html" class="code" title="function img = data_mapper(img, reverse)">data_mapper</a>(img);
0044 
0045 <span class="comment">% Assume all fwd_models are same dimension (all 3D or 2D no mixed dims)</span>
0046 <span class="keyword">if</span> <a href="../../../eidors/models/mdl_dim.html" class="code" title="function num = mdl_dim( mdl );">mdl_dim</a>(img(1))==2 
0047     <span class="keyword">if</span> nargin&gt;1
0048         <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Specified levels ignored for 2D FEM'</span>, 4);
0049     <span class="keyword">end</span>
0050     <span class="keyword">if</span> isfield(img(1).fwd_model,<span class="string">'mdl_slice_mapper'</span>) &amp;&amp; isfield(img(1).fwd_model.mdl_slice_mapper, <span class="string">'level'</span>)
0051         <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'mdl_slice_mapper.level definition ignored for 2D FEM'</span>,4); 
0052         <span class="keyword">for</span> i = 1:numel(img)
0053             img(i).fwd_model.mdl_slice_mapper = rmfield(img(i).fwd_model.mdl_slice_mapper,<span class="string">'level'</span>);
0054         <span class="keyword">end</span>
0055     <span class="keyword">end</span>
0056     levels= [Inf,Inf,0];
0057 <span class="keyword">end</span>
0058 
0059 
0060 warnStruct = warning(<span class="string">'query'</span>,<span class="string">'EIDORS:calc_slices:level_conflict'</span>);
0061 rimg = [];
0062 <span class="keyword">for</span> i=1:length(img)
0063    rimg = cat(3, rimg, <a href="#_sub1" class="code" title="subfunction rimg = calc_this_slice( img, levels, np)">calc_this_slice</a>( img(i), levels, np) );
0064 <span class="keyword">end</span>
0065 warning(warnStruct)
0066 
0067 <a name="_sub1" href="#_subfunctions" class="code">function rimg = calc_this_slice( img, levels, np)</a>
0068     <span class="comment">% If scalar levels then we just create that many cut planes on z-dimension</span>
0069     fwd_model = img.fwd_model;
0070     
0071     <span class="keyword">if</span> ~isfield(fwd_model,<span class="string">'mdl_slice_mapper'</span>) || <span class="keyword">...</span>
0072           nnz(isfield(fwd_model.mdl_slice_mapper, {<span class="string">'x_pts'</span>, <span class="string">'npoints'</span>, <span class="string">'npx'</span>, <span class="string">'resolution'</span>})) == 0
0073 
0074         fwd_model.mdl_slice_mapper.npoints = np;
0075     <span class="keyword">end</span>
0076     <span class="keyword">if</span> isfield(fwd_model.mdl_slice_mapper, <span class="string">'level'</span>)
0077        <span class="keyword">if</span> ~isempty(levels)
0078           warning(<span class="string">'EIDORS:calc_slices:level_conflict'</span>,<span class="keyword">...</span>
0079              <span class="string">'Ignoring provided level definition. Using mdl_slice_mapper.level instead.'</span>);
0080           <span class="comment">% only warn once</span>
0081           warning(<span class="string">'off'</span>, <span class="string">'EIDORS:calc_slices:level_conflict'</span>); 
0082        <span class="keyword">else</span>
0083           <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'Using level definition from the mdl_slice_mapper.level field.'</span>, 3);
0084        <span class="keyword">end</span>
0085        levels = fwd_model.mdl_slice_mapper.level;
0086     <span class="keyword">end</span>
0087     <span class="keyword">if</span> isempty(levels)
0088        z = max(img.fwd_model.nodes(:,3)) - min(img.fwd_model.nodes(:,3));
0089        levels = [Inf Inf z/2];
0090        <a href="../../../eidors/eidors_msg.html" class="code" title="function log_level = eidors_msg( message, varargin )">eidors_msg</a>(<span class="string">'calc_slices: no levels specified, using mid-z xy plane'</span>,2);
0091     <span class="keyword">end</span>
0092 
0093     
0094     nodes = {fwd_model.nodes};
0095     <span class="keyword">if</span> size(fwd_model.nodes,2)==3 &amp;&amp; size(fwd_model.elems,2) &gt; 3 
0096         nodes = <a href="level_model_slice.html" class="code" title="function [out, out2, out3, out4] = level_model_slice(varargin)">level_model_slice</a>(fwd_model.nodes, levels, <span class="string">'all'</span>);
0097         
0098         <span class="comment">% we'll level by replacing nodes. Disable.</span>
0099         lvl = struct(<span class="string">'rotation_matrix'</span>,eye(3), <span class="string">'centre'</span>, zeros(1,3));
0100         fwd_model.mdl_slice_mapper.level = lvl;
0101     <span class="keyword">end</span>
0102     
0103     [data, n_images] = <a href="../../../eidors/solvers/get_img_data.html" class="code" title="function [img_data, n_images]= get_img_data(img)">get_img_data</a>(img);
0104     
0105     <span class="keyword">if</span> ~any(isfield(img, {<span class="string">'elem_data'</span>, <span class="string">'node_data'</span>}))
0106        error(<span class="string">'img does not have a data field'</span>);
0107     <span class="keyword">end</span>
0108     n_levels = numel(nodes);
0109     <span class="keyword">for</span> lev_no = fliplr(1:n_levels)
0110         fwd_model.nodes = nodes{lev_no};
0111         <span class="keyword">if</span> isfield(img,<span class="string">'elem_data'</span>)
0112           rimg(:,:,:,lev_no) = <a href="#_sub4" class="code" title="subfunction rimg= calc_image_elems( elem_data, fwd_model)">calc_image_elems</a>( data, fwd_model);
0113         <span class="keyword">elseif</span> isfield(img,<span class="string">'node_data'</span>)
0114           rimg(:,:,:,lev_no) = <a href="#_sub3" class="code" title="subfunction rimg= calc_image_nodes( node_data, fwd_model)">calc_image_nodes</a>( data, fwd_model);
0115         <span class="keyword">end</span>
0116     <span class="keyword">end</span>
0117     
0118     <span class="comment">% FILTER IMAGE</span>
0119     <span class="keyword">try</span>   
0120         filt = img.calc_slices.filter; 
0121     <span class="keyword">catch</span>
0122         filt = 1; 
0123     <span class="keyword">end</span>
0124     <span class="keyword">try</span>   
0125         scal = img.calc_slices.scale; 
0126     <span class="keyword">catch</span>
0127         scal = 1; 
0128     <span class="keyword">end</span>
0129 
0130     filt = scal * ( filt/sum(filt(:)) );
0131     rimg = <a href="#_sub5" class="code" title="subfunction  rimg = filter_image(rimg, filt);">filter_image</a>(rimg, filt);
0132 
0133 <span class="comment">% Calculate an image by mapping it onto the node_ptr matrix</span>
0134 <span class="comment">% This makes a blocky image to nearest node -&gt; no longer used</span>
0135 <a name="_sub2" href="#_subfunctions" class="code">function rimg= calc_image_nearestnodes( node_data, fwd_model)</a>
0136 
0137    node_ptr = <a href="mdl_slice_mapper.html" class="code" title="function map = mdl_slice_mapper( fmdl, maptype )">mdl_slice_mapper</a>( fwd_model, <span class="string">'node'</span> );
0138 
0139    backgnd= NaN;
0140    n_images= size(node_data,2);
0141    rval= [backgnd*ones(1,n_images); node_data];
0142    rimg= reshape( rval(node_ptr+1,:), [size(node_ptr), n_images]);
0143 
0144 <span class="comment">% Calculate an image by interpolating it onto the elem_ptr matrix</span>
0145 <a name="_sub3" href="#_subfunctions" class="code">function rimg= calc_image_nodes( node_data, fwd_model)</a>
0146 
0147    nd_interp= <a href="mdl_slice_mapper.html" class="code" title="function map = mdl_slice_mapper( fmdl, maptype )">mdl_slice_mapper</a>( fwd_model, <span class="string">'nodeinterp'</span> );
0148    elem_ptr = <a href="mdl_slice_mapper.html" class="code" title="function map = mdl_slice_mapper( fmdl, maptype )">mdl_slice_mapper</a>( fwd_model, <span class="string">'elem'</span> );
0149    [sx,sy]= size(elem_ptr);
0150 
0151    node_ptr = fwd_model.elems; node_ptr = [0*node_ptr(1,:);node_ptr];
0152    node_ptr = reshape( node_ptr( elem_ptr+1, :), sx, sy, []);
0153 
0154    n_images = size(node_data,2);
0155    rimg= zeros(sx, sy, n_images);
0156    backgnd= NaN;
0157    
0158    <span class="keyword">for</span> ni = 1:n_images
0159      znd = [backgnd;node_data(:,ni)]; <span class="comment">% add NaN for background</span>
0160      rimg(:,:,ni) = sum( znd(node_ptr+1) .* nd_interp, 3); 
0161    <span class="keyword">end</span>
0162 
0163 
0164 <span class="comment">% Calculate an image by mapping it onto the elem_ptr matrix</span>
0165 <a name="_sub4" href="#_subfunctions" class="code">function rimg= calc_image_elems( elem_data, fwd_model)</a>
0166 
0167    elem_ptr = <a href="mdl_slice_mapper.html" class="code" title="function map = mdl_slice_mapper( fmdl, maptype )">mdl_slice_mapper</a>( fwd_model, <span class="string">'elem'</span>);
0168 
0169    backgnd= NaN;
0170    n_images= size(elem_data,2);
0171    rval= backgnd*ones(size(elem_data)+[1,0]);
0172    rval(2:<span class="keyword">end</span>,:) = elem_data;
0173    rimg= reshape( rval(elem_ptr+1,:), [size(elem_ptr), n_images]);
0174 
0175 
0176 <a name="_sub5" href="#_subfunctions" class="code">function  rimg = filter_image(rimg, filt);</a>
0177     
0178    <span class="comment">%%% Total MATLAB BS )(*&amp;#$)(*#&amp;@</span>
0179    <span class="comment">%%% the &amp;&amp; operator used to short circuit. Now it doesn't</span>
0180    <span class="comment">%%% How the (*&amp;)(*&amp; can anyone take this language seriously</span>
0181    <span class="comment">% all(size(filt*scal) == [1,1]) &amp;&amp; filt*scal == 1</span>
0182    <span class="keyword">if</span> all(size(filt)==1) <span class="keyword">if</span> filt == 1; <span class="keyword">return</span>; <span class="keyword">end</span> ; <span class="keyword">end</span>
0183 
0184    [sz1,sz2,sz3,sz4] = size(rimg);
0185    <span class="keyword">for</span> j1 = 1:sz3; <span class="keyword">for</span> j2 = 1:sz4; 
0186       rsl = rimg(:,:,j1,j2);
0187 
0188       rna = isnan(rsl);
0189       rsl(rna) = 0;
0190       rsl = conv2(rsl, filt, <span class="string">'same'</span>);
0191       rsl(rna) = NaN;
0192 
0193       rimg(:,:,j1,j2) = rsl;
0194    <span class="keyword">end</span>; <span class="keyword">end</span>
0195 
0196 <a name="_sub6" href="#_subfunctions" class="code">function do_unit_test</a>
0197    img = <a href="../../../eidors/models/mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>( <a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c2'</span>,8));
0198    img.calc_colours.npoints = 8; 
0199 
0200    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img);
0201    imt = NaN*ones(8); imt(2:7,2:7) = 1; imt(3:6,:) = 1; imt(:,3:6) = 1; 
0202    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 2d 1'</span>, imc, imt);
0203 
0204    imn = rmfield(img,<span class="string">'elem_data'</span>);
0205    imn.node_data = ones(size(imn.fwd_model.nodes,1),1);
0206    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(imn);
0207    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 2d 2'</span>, imc, imt, 1e-14);
0208 
0209    img.elem_data(1:4) = 2;
0210    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img);
0211    imt(4:5,4:5) = 2; 
0212    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 2d 3'</span>, imc, imt);
0213 
0214    imn.node_data(1:5) = 2;
0215    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(imn);
0216    imt(3:6,3:6) = 1; imt(4:5,3:6) = 1.292893218813452;
0217    imt(3:6,4:5) = 1.292893218813452; imt(4:5,4:5) = 2;
0218    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 2d 4'</span>, imc, imt, 1e-14);
0219 
0220    imn.node_data(:) = 1; imn.node_data(1) = 4;
0221    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(imn);
0222    imt(3:6,3:6) = 1; imt(4:5,4:5) = 1.878679656440358; 
0223    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 2d 5'</span>, imc, imt, 1e-14);
0224 
0225    imn.calc_colours.npoints = 7; 
0226    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(imn);
0227    imt = NaN*ones(7); imt(3:5,:) = 1; imt(:,3:5)= 1; imt(2:6,2:6)= 1;imt(4,4) = 4; 
0228    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 2d 6'</span>, imc, imt, 1e-14);
0229 
0230 
0231 <span class="comment">% 3D Tests</span>
0232    img = <a href="../../../eidors/solvers/calc_jacobian_bkgnd.html" class="code" title="function img_bkgnd = calc_jacobian_bkgnd( inv_model )">calc_jacobian_bkgnd</a>( <a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'n3r2'</span>,[16,2]));
0233    xyz = <a href="../../../eidors/models/interp_mesh.html" class="code" title="function mdl_pts = interp_mesh( mdl, n_interp)">interp_mesh</a>(img);
0234    img.calc_colours.npoints = 8; 
0235    imn = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img,[inf,inf,1]);
0236 
0237    imt = NaN*ones(8); imt(3:6,:) = 1; imt(:,3:6) = 1; imt(2:7,2:7) = 1; 
0238    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 3d 1'</span>, imn, imt);
0239 
0240    imgx= img;
0241    imgx.elem_data(xyz(:,3)&gt;1.5) = 2;
0242    imn = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(imgx,[inf,inf,0.5;inf,inf,2.5]);
0243    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 3d 2'</span>, imn, cat(4,imt,2*imt));
0244 
0245    imgx.elem_data = imgx.elem_data*[1,2,3];
0246    imn = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(imgx,[inf,inf,0.5]);
0247    imtx = cat(3,imt,2*imt,3*imt);
0248    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 3d 3'</span>, imn, imtx);
0249 
0250    imn = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(imgx,[inf,inf,0.5;inf,inf,2.5]);
0251    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 3d 3'</span>, imn, cat(4,imtx,2*imtx));
0252 
0253    imgx.fwd_model.mdl_slice_mapper=struct(<span class="string">'x_pts'</span>,(-1:1)/2,<span class="string">'y_pts'</span>,(-1:1)/2, <span class="keyword">...</span>
0254          <span class="string">'level'</span>,[inf,inf,0.5;inf,inf,2.5]);
0255    imn = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(imgx);
0256    imt = ones(3); imtx = cat(3,imt,2*imt,3*imt);
0257    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 3d 3'</span>, imn, cat(4,imtx,2*imtx));
0258 
0259 
0260    img.calc_colours.npoints = 12; 
0261    imn = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img,[inf,0,inf]);
0262    imt = NaN*ones(12); imt(:,3:10) = 1; 
0263    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 3d 4'</span>, imn, imt);
0264 
0265    <span class="comment">% Should have no effect</span>
0266    img.fwd_model.nodes(:,3) = img.fwd_model.nodes(:,3)-1;
0267    imn = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img,[inf,0,inf]); 
0268    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs 3d 5'</span>, imn, imt);
0269    
0270 
0271    <span class="comment">% Default level</span>
0272    imt = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img, [inf inf 0.5]);
0273    imn = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img);
0274    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'default'</span>, imn, imt);
0275 
0276     <span class="comment">% Default level</span>
0277    img.fwd_model.mdl_slice_mapper.level = [inf inf 0.5];
0278    imn = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img);
0279    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'no message'</span>, imn, imt);  
0280 
0281    <span class="comment">% Warning test</span>
0282    warning(<span class="string">'off'</span>, <span class="string">'EIDORS:calc_slices:level_conflict'</span>);  <span class="comment">%don't need to print</span>
0283    [old, old_id] = lastwarn;
0284    lastwarn(<span class="string">''</span>,<span class="string">''</span>);
0285    img.fwd_model.mdl_slice_mapper.level = [inf,inf, 1.5];
0286    imt = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img,[inf,inf, .5]); 
0287    [~,id] = lastwarn;
0288    lastwarn(old, old_id);
0289    warning(<span class="string">'on'</span>, <span class="string">'EIDORS:calc_slices:level_conflict'</span>); 
0290    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'warning'</span>, id, <span class="string">'EIDORS:calc_slices:level_conflict'</span>);
0291 
0292 
0293 <span class="comment">% multi image struct</span>
0294    img = <a href="../../../eidors/models/mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>( <a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'a2c2'</span>,8));
0295    img.calc_colours.npoints = 8; 
0296    img(2) = img;
0297    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img); 
0298    imt = NaN*ones(8); imt(3:6,:) = 1; imt(:,3:6) = 1; imt(2:7,2:7) = 1; 
0299    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs mult 1'</span>, imc, cat(3,imt,imt));
0300 
0301    imgb = <a href="../../../eidors/models/mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>( <a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'b2c2'</span>,8));
0302    imgb.calc_colours.npoints = 8; 
0303    img(3)=imgb;
0304    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img); 
0305    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'cs mult 2'</span>, imc, cat(3,imt,imt,imt));
0306 
0307    imdl = <a href="../../../eidors/models/mk_common_model.html" class="code" title="function inv_mdl= mk_common_model( str, n_elec, varargin )">mk_common_model</a>(<span class="string">'c2t2'</span>,16);
0308    img = <a href="../../../eidors/models/mk_image.html" class="code" title="function img= mk_image(mdl, elem_data, params, name)">mk_image</a>(imdl,1);
0309    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img);
0310    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'size e  1'</span>, size(imc), [64,64]);
0311 
0312    img.calc_colours.npoints = 40;
0313    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img);
0314    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'size e  2'</span>, size(imc), [40,40]);
0315 
0316    img.fwd_model.mdl_slice_mapper.npx = 22;
0317    img.fwd_model.mdl_slice_mapper.npy = 32;
0318    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img);
0319    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'size e  3'</span>, size(imc), [32,22]);
0320 
0321    img.fwd_model = rmfield(img.fwd_model,<span class="string">'mdl_slice_mapper'</span>);
0322    img.fwd_model.mdl_slice_mapper.x_pts = linspace(-150,150,20);
0323    img.fwd_model.mdl_slice_mapper.y_pts =-linspace(-150,150,23);
0324    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img); 
0325    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'size e  4'</span>, size(imc), [23,20]);
0326 
0327    img = rmfield(img,<span class="string">'elem_data'</span>);
0328    img.node_data =  ones(size(img.fwd_model.nodes,1),1);
0329    img.node_data =  (1:size(img.fwd_model.nodes,1))';
0330    img.fwd_model = rmfield(img.fwd_model,<span class="string">'mdl_slice_mapper'</span>);
0331    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img);
0332    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'size n  1'</span>, size(imc), [40,40]);
0333 
0334    im2= img;
0335    im2.node_data =  ones(size(img.fwd_model.nodes,1),5);
0336    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(im2);
0337    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'size n x5'</span>, size(imc), [40,40,5]);
0338    im2.get_img_data.frame_select = 2:3;
0339    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(im2);
0340    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'size n x2'</span>, size(imc), [40,40,2]);
0341 
0342    img.fwd_model.mdl_slice_mapper.x_pts = linspace(-150,150,20);
0343    img.fwd_model.mdl_slice_mapper.y_pts =-linspace(-150,150,23);
0344    imc = <a href="calc_slices.html" class="code" title="function rimg = calc_slices( img, levels );">calc_slices</a>(img);
0345    <a href="../../../eidors/tools/unit_test_cmp.html" class="code" title="function res = unit_test_cmp(txt,a,b,tol)">unit_test_cmp</a>(<span class="string">'size n  2'</span>, size(imc), [23,20]);</pre></div>
<hr><address>Generated on Sun 29-Dec-2024 19:54:43 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>