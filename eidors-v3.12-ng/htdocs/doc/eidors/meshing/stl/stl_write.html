<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of stl_write</title>
  <meta name="keywords" content="stl_write">
  <meta name="description" content="STL_WRITE Create an STL file from a patch struct">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../index.html">Home</a> &gt;  <a href="../../index.html">eidors</a> &gt; <a href="../index.html">meshing</a> &gt; <a href="index.html">stl</a> &gt; stl_write.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../index.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for eidors/meshing/stl&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>stl_write
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>STL_WRITE Create an STL file from a patch struct</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function stl_write(fv, name, type) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">STL_WRITE Create an STL file from a patch struct

 STL_WRITE(mdl, name) where:
  mdl is an eidors fwd_model structure. 
  name is the file name (character string), if no extension given, 'stl'
  assumed.
  STL_WRITE will use mdl.elems if they are triangles. Otherwise, it will
  use mdl.boundary or, if absent, call find_boundary.

 STL_WRITE(fv, name) where:
  fv is face-vertex (patch) structure (fv.faces, fv.vertices)
  name is the file name (character string), if no extension given, 'stl'
  assumed.

 STL_WRITE(fv, name, type) specifies the type of file to write:
  'bin'  - binary file (default)
  'txt'  - ASCII file

 See also: <a href="stl_read.html" class="code" title="function mdl = stl_read(fname)">STL_READ</a>, FIND_BOUNDARY</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/solvers/forward/find_boundary.html" class="code" title="function [srf, idx] = find_boundary(simp);">find_boundary</a>	[srf, idx] = find_boundary(simp);</li><li><a href="../../../eidors/tools/cross3.html" class="code" title="function c = cross3(a,b)">cross3</a>	CROSS3  3D cross parallel cross product</li><li><a href="../../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>	PROGRESS_MSG Progress messages and timing.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../eidors/meshing/gmsh/gmsh_stl2tet.html" class="code" title="function mdl = gmsh_stl2tet(stlfile, mesh_size, extra, nopt)">gmsh_stl2tet</a>	GMSH_STL2TET creates a tetrahedral mesh from an stl file</li><li><a href="../../../eidors/meshing/netgen/ng_stl2tet.html" class="code" title="function mdl = ng_stl2tet(stlfile, varargin)">ng_stl2tet</a>	NG_STL2TET creates a tetrahedral mesh from an stl file</li><li><a href="stl_read.html" class="code" title="function mdl = stl_read(fname)">stl_read</a>	STL_READ  Read in an stl file and output an EIDORS model struct</li><li><a href="../../../eidors/models/mk_thorax_model.html" class="code" title="function out = mk_thorax_model(str, varargin)">mk_thorax_model</a>	MK_THORAX_MODEL FEM models of the thorax</li><li><a href="../../../eidors/models/place_elec_on_surf.html" class="code" title="function mdl2 = place_elec_on_surf(mdl,elec_pos, elec_spec,ng_opt_file, maxh)">place_elec_on_surf</a>	PLACE_ELEC_ON_SURF Place electrodes on the surface of a model</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function write_bin_stl(name, label, Norms, v1, v2, v3)</a></li><li><a href="#_sub2" class="code">function write_txt_stl(name, label, Norms, v1, v2, v3)</a></li><li><a href="#_sub3" class="code">function M=cross3(r,F)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function stl_write(fv, name, type)</a>
0002 <span class="comment">%STL_WRITE Create an STL file from a patch struct</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% STL_WRITE(mdl, name) where:</span>
0005 <span class="comment">%  mdl is an eidors fwd_model structure.</span>
0006 <span class="comment">%  name is the file name (character string), if no extension given, 'stl'</span>
0007 <span class="comment">%  assumed.</span>
0008 <span class="comment">%  STL_WRITE will use mdl.elems if they are triangles. Otherwise, it will</span>
0009 <span class="comment">%  use mdl.boundary or, if absent, call find_boundary.</span>
0010 <span class="comment">%</span>
0011 <span class="comment">% STL_WRITE(fv, name) where:</span>
0012 <span class="comment">%  fv is face-vertex (patch) structure (fv.faces, fv.vertices)</span>
0013 <span class="comment">%  name is the file name (character string), if no extension given, 'stl'</span>
0014 <span class="comment">%  assumed.</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% STL_WRITE(fv, name, type) specifies the type of file to write:</span>
0017 <span class="comment">%  'bin'  - binary file (default)</span>
0018 <span class="comment">%  'txt'  - ASCII file</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% See also: STL_READ, FIND_BOUNDARY</span>
0021 
0022 <span class="comment">% (C) 2006 Eric Carlson: Public Domain</span>
0023 <span class="comment">% Adapted by Bartlomiej Grychtol from:</span>
0024 <span class="comment">% http://www.mathworks.com/matlabcentral/newsreader/view_thread/126215</span>
0025 <span class="comment">% $Id: stl_write.m 6836 2024-05-02 08:24:41Z bgrychtol $</span>
0026 
0027 
0028 [folder, label, ext] = fileparts(name);
0029 <span class="keyword">if</span> isempty(ext), ext = <span class="string">'.stl'</span>; <span class="keyword">end</span>
0030 <span class="keyword">if</span> isempty(folder)
0031    name = [label ext];
0032 <span class="keyword">else</span>
0033    name = [folder filesep label ext];
0034 <span class="keyword">end</span>
0035 
0036 <span class="keyword">if</span> isfield(fv, <span class="string">'type'</span>) &amp;&amp; strcmp(fv.type, <span class="string">'fwd_model'</span>)
0037    fv.vertices = fv.nodes;
0038    <span class="keyword">if</span> size(fv.elems,2)== 3
0039        fv.faces = fv.elems;
0040    <span class="keyword">else</span>
0041        <span class="keyword">try</span>
0042            fv.faces = fv.boundary;
0043        <span class="keyword">catch</span>
0044            fv.faces = <a href="../../../eidors/solvers/forward/find_boundary.html" class="code" title="function [srf, idx] = find_boundary(simp);">find_boundary</a>(fv);
0045        <span class="keyword">end</span>
0046    <span class="keyword">end</span>
0047 <span class="keyword">end</span>
0048 fv.vertices = double(fv.vertices);
0049 v1 = fv.vertices(fv.faces(:,2),:)-fv.vertices(fv.faces(:,1),:);
0050 v2 = fv.vertices(fv.faces(:,3),:)-fv.vertices(fv.faces(:,2),:);
0051 Norms = <a href="../../../eidors/tools/cross3.html" class="code" title="function c = cross3(a,b)">cross3</a>(v1,v2);
0052 clear v1 v2
0053 fv.vertices = single(fv.vertices);
0054 v1(:,1:3) = fv.vertices(fv.faces(:,1),1:3);
0055 v2(:,1:3) = fv.vertices(fv.faces(:,2),1:3);
0056 v3(:,1:3) = fv.vertices(fv.faces(:,3),1:3);
0057 
0058 <span class="keyword">if</span> nargin &lt; 3 
0059     type = <span class="string">'bin'</span>;
0060 <span class="keyword">end</span>
0061 <span class="keyword">switch</span> type
0062     <span class="keyword">case</span> <span class="string">'bin'</span>
0063         <a href="#_sub1" class="code" title="subfunction write_bin_stl(name, label, Norms, v1, v2, v3)">write_bin_stl</a>(name, label, Norms, v1, v2, v3);
0064     <span class="keyword">case</span> <span class="string">'txt'</span> 
0065         <a href="#_sub2" class="code" title="subfunction write_txt_stl(name, label, Norms, v1, v2, v3)">write_txt_stl</a>(name, label, Norms, v1, v2, v3);
0066     <span class="keyword">otherwise</span>
0067         error(<span class="string">'EIDORS:WrongInput'</span>,<span class="string">'Type can only be ''bin'' or ''txt'''</span>);
0068 <span class="keyword">end</span>
0069 
0070 
0071 <a name="_sub1" href="#_subfunctions" class="code">function write_bin_stl(name, label, Norms, v1, v2, v3)</a>
0072 <a href="../../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Writing binary STL file...'</span>)
0073 fid = fopen(name,<span class="string">'wb'</span>,<span class="string">'ieee-le'</span>);
0074 header = label;
0075 <span class="keyword">if</span> length(header) &gt; 80
0076     header = header(1:80);
0077 <span class="keyword">else</span>
0078     header(end+1:80) = <span class="string">'-'</span>;
0079 <span class="keyword">end</span>
0080 fwrite(fid, header, <span class="string">'char'</span>);
0081 nf = size(v1,1);
0082 fwrite(fid, uint32(nf), <span class="string">'uint32'</span>);
0083 <span class="keyword">for</span> k = 1:nf
0084     <span class="keyword">if</span> mod(k,100)==0, <a href="../../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(k/nf); <span class="keyword">end</span>
0085     fwrite(fid, [Norms(k,:), v1(k,:), v2(k,:), v3(k,:)], <span class="string">'float32'</span>);
0086     fwrite(fid, 0,<span class="string">'uint16'</span>);
0087 <span class="keyword">end</span>
0088 fclose(fid);
0089 <a href="../../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(Inf)
0090 
0091 
0092 <a name="_sub2" href="#_subfunctions" class="code">function write_txt_stl(name, label, Norms, v1, v2, v3)</a>
0093 <a href="../../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(<span class="string">'Writing ASCII STL file...'</span>)
0094 fid = fopen(name,<span class="string">'w'</span>);
0095 fprintf(fid,<span class="string">'solid %s\n'</span>,label);
0096 nf = size(v1,1);
0097 <span class="keyword">for</span> k = 1:nf
0098     <span class="keyword">if</span> mod(k,100)==0, <a href="../../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(k/nf); <span class="keyword">end</span>
0099     fprintf(fid,[<span class="string">'facet normal %.12g %.12g %.12g\n'</span> <span class="keyword">...</span><span class="comment"> </span>
0100                  <span class="string">'\t'</span> <span class="string">'outer loop\n'</span> <span class="keyword">...</span><span class="comment"> </span>
0101                  <span class="string">'\t\t'</span> <span class="string">'vertex %.12g %.12g %.12g\n'</span> <span class="keyword">...</span>
0102                  <span class="string">'\t\t'</span> <span class="string">'vertex %.12g %.12g %.12g\n'</span> <span class="keyword">...</span>
0103                  <span class="string">'\t\t'</span> <span class="string">'vertex %.12g %.12g %.12g\n'</span> <span class="keyword">...</span>
0104                  <span class="string">'\t'</span> <span class="string">'endloop\n'</span> <span class="keyword">...</span>
0105                  <span class="string">'endfacet\n'</span>], <span class="keyword">...</span>
0106         Norms(k,1),Norms(k,2),Norms(k,3), <span class="keyword">...</span>
0107         v1(k,1), v1(k,2), v1(k,3), <span class="keyword">...</span>
0108         v2(k,1), v2(k,2), v2(k,3), <span class="keyword">...</span>
0109         v3(k,1), v3(k,2), v3(k,3) );
0110 <span class="keyword">end</span>
0111 fprintf(fid,<span class="string">'endsolid %s\n'</span>,label);
0112 fclose(fid);
0113 <a href="../../../eidors/tools/progress_msg.html" class="code" title="function progress_msg(varargin)">progress_msg</a>(Inf)
0114 
0115 <a name="_sub3" href="#_subfunctions" class="code">function M=cross3(r,F)</a>
0116 <span class="comment">% function to calculate normalized cross product rxF/|rxF|</span>
0117 <span class="comment">% handles (same-size) arrays (n by 3) for r and F</span>
0118 <span class="comment">%</span>
0119        M = [(r(:,2).*F(:,3) - r(:,3).*F(:,2)) <span class="keyword">...</span>
0120             (r(:,3).*F(:,1) - r(:,1).*F(:,3)) <span class="keyword">...</span>
0121             (r(:,1).*F(:,2) - r(:,2).*F(:,1))];
0122        M_mag = sqrt(sum((M.*M)')');
0123        M(:,1) = M(:,1)./M_mag;
0124        M(:,2) = M(:,2)./M_mag;
0125        M(:,3) = M(:,3)./M_mag;</pre></div>
<hr><address>Generated on Sun 29-Dec-2024 19:54:43 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>